<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>TriSports — Fléchettes • Ping-pong • Palet</title>

<!-- Garde-fou : certaines extensions injectent du React minifié qui loggue "Minified React error #...".
     On évite que ça remonte et perturbe l'app (ça n'affecte PAS ton site). -->
<script>
  window.addEventListener('error', function (e) {
    const msg = (e.message || '') + '';
    if (msg.includes('Minified React error #')) {
      e.stopImmediatePropagation?.();
      return false;
    }
  }, true);

function ensureParamWrapper(){
  const fields = id('capitaine-fields'); if(!fields) return null;
  let wrap=id('cap-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='cap-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureTaupeWrapper(){
  const fields = id('taupe-fields'); if(!fields) return null;
  let wrap=id('taupe-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='taupe-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureLeftHandWrapper(){
  const fields = id('lefthand-fields'); if(!fields) return null;
  let wrap=id('lefthand-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='lefthand-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureMelonWrapper(){
  const fields = id('melon-fields'); if(!fields) return null;
  let wrap = id('melon-params');
  if (!wrap){
    wrap = document.createElement('div');
    wrap.id = 'melon-params';
    wrap.setAttribute('role','region');
    wrap.setAttribute('aria-live','polite');
    wrap.setAttribute('aria-label','Paramètres Melon d’or');

    wrap.className = 'bonus-params';
    fields.parentNode.insertBefore(wrap, fields);
    wrap.appendChild(fields);
  }
  return wrap;
}


function setParamsOpen(openCap, openTaupe, openLeft, openMelon){
  const wC = ensureParamWrapper();    if (wC){ wC.style.maxHeight = openCap   ? (wC.scrollHeight+'px') : '0px'; }
  const wT = ensureTaupeWrapper();    if (wT){ wT.style.maxHeight = openTaupe ? (wT.scrollHeight+'px') : '0px'; }
  const wL = ensureLeftHandWrapper(); if (wL){ wL.style.maxHeight = openLeft  ? (wL.scrollHeight+'px') : '0px'; }
  const wM = ensureMelonWrapper();    if (wM){ wM.style.maxHeight = openMelon ? (wM.scrollHeight+'px') : '0px'; }
}

function selectBonusType(t){
  // lock guard per category
  try{
    const teamId = (window.bonusCTX && window.bonusCTX.teamId);
    if (teamId && typeof getTeamCategoryLocks==='function'){
      const locks = getTeamCategoryLocks(teamId);
      const cat = BONUS_CATEGORY[t];
      const round = (window.bonusCTX && window.bonusCTX.round);
      const currentSel = (typeof getBonusSelection==='function' && round!=null) ? (getBonusSelection(round, teamId) || null) : null;
      const allowCurrent = !!(currentSel && currentSel.type === t);
      if (cat && locks.has(cat) && !allowCurrent) return; // blocked
    }
  }catch(_){}

  // 1) type valide (inclut 'melon')
  window._bonusType = (['capitaine','miroir','braquage','taupe','lefthand','melon'].includes(t) ? t : 'capitaine');

  // 2) cartes (5 cartes désormais)
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  const cap   = cards[0],
        mir   = cards[1],
        braq  = cards[2],
        tau   = cards[3],
        leftc = cards[4],
        melon = cards[5];

  // 3) reset + sélection
  [cap, mir, braq, tau, leftc, melon].forEach(c => c && c.classList.remove('selected'));
  if (cap   && window._bonusType === 'capitaine') cap.classList.add('selected');
  if (mir   && window._bonusType === 'miroir')    mir.classList.add('selected');
  if (braq  && window._bonusType === 'braquage') braq.classList.add('selected');
  if (tau   && window._bonusType === 'taupe')     tau.classList.add('selected');
  if (leftc && window._bonusType === 'lefthand')  leftc.classList.add('selected');
  if (melon && window._bonusType === 'melon')     melon.classList.add('selected');

  
  // 3bis) a11y state
  [cap, mir, tau, leftc, melon].forEach((c,i)=>{
    if(!c) return;
    const pressed =
      (i===0 && window._bonusType==='capitaine') ||
      (i===1 && window._bonusType==='miroir')    ||
      (i===2 && window._bonusType==='braquage') ||
      (i===3 && window._bonusType==='taupe')     ||
      (i===4 && window._bonusType==='lefthand')  ||
      (i===5 && window._bonusType==='melon');
    c.setAttribute('aria-pressed', pressed ? 'true' : 'false');
  });
// 4) texte d’aide
  const ctx = id('bonus-context');
  if (ctx) {
    ctx.textContent =
      window._bonusType === 'miroir'   ? "Miroir : inverse le bonus adverse sur tout le match." :
      window._bonusType === 'braquage' ? "Braquage : vole les points bonus (positif ou négatif) du bonus Melon/Capitaine adverse ; Vole 5 pts contre Taupe/Main gauche si l'équipe adverse a au moins 5pts ; aucun effet face à Miroir." :
      window._bonusType === 'taupe'    ? "René la taupe : choisissez le sport." :
      window._bonusType === 'lefthand' ? "10 pouces 2 mains gauche : choisissez le sport." :
      window._bonusType === 'melon'    ? "Melon d'or : choisissez le sport." :
                                          "Capitaine : aucun réglage. +2/manche gagnée ; +2 si palet.";
  }

  // 5) affichage des paramètres (Capitaine n’a plus de champs)
  setParamsOpen(window._bonusType==='capitaine', window._bonusType==='taupe', window._bonusType==='lefthand', window._bonusType==='melon');
}

function prepareBonusOptions(){
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  const map   = ['capitaine','miroir','braquage','taupe','lefthand','melon']; // 6 cartes

  cards.forEach((c, i)=>{
    c.classList.add('selectable');
    c.tabIndex = 0;
    c.setAttribute('role','button');
    c.setAttribute('aria-pressed','false');

    const type = map[i] || 'capitaine';
    c.addEventListener('click', ()=>selectBonusType(type));
    c.addEventListener('keydown', ev=>{
      if(ev.key===' '||ev.key==='Enter'){
        ev.preventDefault();
        selectBonusType(type);
      }
    });
  });

  // déplacer/afficher les panneaux de paramètres (Capitaine n’en a plus)
  const cap = cards[0], mir = cards[1], braq = cards[2], tau = cards[3], leftc = cards[4], melon = cards[5];
  const capTxt = cap?.querySelector('.bonus-text');
  const tauTxt = tau?.querySelector('.bonus-text');
  const leftTxt = leftc?.querySelector('.bonus-text');
  const melonTxt = melon?.querySelector('.bonus-text');

  const wC = ensureParamWrapper();    if (capTxt   && wC && wC.parentElement   !== capTxt)   capTxt.appendChild(wC);
  const wT = ensureTaupeWrapper();    if (tauTxt   && wT && wT.parentElement   !== tauTxt)   tauTxt.appendChild(wT);
  const wL = ensureLeftHandWrapper(); if (leftTxt  && wL && wL.parentElement   !== leftTxt)  leftTxt.appendChild(wL);
  const wM = ensureMelonWrapper();    if (melonTxt && wM && wM.parentElement !== melonTxt) melonTxt.appendChild(wM);

  // init sélection
  selectBonusType(window._bonusType || 'capitaine');
}

</script>
<style>
.bonus-card.disabled{opacity:.45;filter:grayscale(1);pointer-events:none}
.bonus-card.disabled:after{content:"✖";position:absolute;right:10px;top:10px;opacity:.8}
.pos{color:#34d399;font-weight:600}
.neg{color:#f87171;font-weight:600}
:root{--bg:#0f1220;--border:#2b315f;--text:#e7e9f7;--muted:#8b94b8;--chip:#242b55;--card:#1b2242}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;background:radial-gradient(1200px 800px at 20% -10%,#1c2040,transparent),radial-gradient(1000px 600px at 120% 0%,#1b2550,transparent),var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(130%) blur(8px);background:linear-gradient(180deg,rgba(15,18,32,.9),rgba(15,18,32,.6));border-bottom:1px solid var(--border)}
.container{max-width:1100px;margin:0 auto;padding:18px 16px}.brand{display:flex;gap:12px;align-items:center}
.logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 210deg,#6ee7b7,#7aa2ff);display:grid;place-items:center;font-weight:900;color:#0a0d1c}
.tabs{display:flex;gap:8px;flex-wrap:wrap}.tab{background:var(--chip);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:999px;cursor:pointer}
.tab[aria-selected="true"]{background:linear-gradient(180deg,#1d2a57,#1a2450);border-color:#3a4aa0}
main .container{padding-top:22px}section{display:none}section.active{display:block}
.card{background:linear-gradient(180deg,#171d3a,#121632);border:1px solid var(--border);border-radius:16px}
.card .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:12px}
.card .bd{padding:16px}
.help{font-size:13px;color:var(--muted)}.muted{color:var(--muted)}
.btn{appearance:none;border:1px solid var(--border);background:var(--chip);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#2f3da2,#25337d);border-color:#3a4aa0}.btn.small{padding:6px 10px;border-radius:10px;font-size:13px}.btn.danger{background:linear-gradient(180deg,#7a2b2b,#5c2222);border-color:#8a2b2b}
.btn.toggle[aria-pressed="true"]{background:linear-gradient(180deg,#2b3a99,#22307c);border-color:#3a4aa0}
.grid{display:grid;gap:12px}.grid.cols-2{grid-template-columns:repeat(2,1fr)}.grid.cols-3{grid-template-columns:repeat(3,1fr)}.grid.cols-4{grid-template-columns:repeat(4,1fr)}.grid.responsive{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
input[type=text],input[type=number],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1331;color:#fff}
label{font-size:13px;color:var(--muted)}
table{width:100%;border-collapse:collapse}th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left}th{color:var(--muted);font-weight:600}
/* Base: compacter les marges des titres (impacte "Journée X") */
h1, h2, h3, h4, h5, h6{
  margin-top: 6px;
  margin-bottom: 8px;
  line-height: 1.2;
}

.match-card{border-radius:14px;border:1px solid var(--border);background:var(--card);overflow:hidden}
.match-card[aria-expanded="false"] .bd{display:none}.match-card[aria-expanded="true"] .bd{display:block}
.chip{font-size:12px;padding:4px 8px;background:var(--chip);border:1px solid var(--border);border-radius:999px;color:var(--muted)}
.pill{padding:4px 8px;border-radius:999px;background:#0f1331;border:1px solid var(--border);color:var(--muted);font-size:12px}
.pill.red{border-color:#ef4444;color:#fecaca;background:rgba(239,68,68,.08)}
.pill.yellow{border-color:#eab308;color:#fde68a;background:rgba(234,179,8,.10)}
.pill.green{border-color:#22c55e;color:#a7f3d0;background:rgba(34,197,94,.10)}
.pill.blue{border-color:#3b82f6;color:#bfdbfe;background:rgba(59,130,246,.10)} /* bonus BLEU */
.team-name{display:inline-flex;align-items:center;gap:8px;line-height:1.25;vertical-align:middle}
.match-card .hd .teams{display:flex;align-items:center;gap:10px}
.avatar{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:#0f1331;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;color:#cbd5ff;font-weight:700;font-size:14px;flex:0 0 auto}
.avatar img{width:100%;height:100%;object-fit:cover}.avatar .avatar-initials{display:inline-block;line-height:40px}
.avatar-lg{width:48px;height:48px;font-size:15px}.avatar-lg .avatar-initials{line-height:48px}
.avatar-sm{width:32px;height:32px;font-size:12px}.avatar-sm .avatar-initials{line-height:32px}
.h2h-pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-weight:600}
.h2h-win{border:1px solid #22c55e;color:#a7f3d0;background:rgba(34,197,94,.08)}
.h2h-loss{border:1px solid #ef4444;color:#fecaca;background:rgba(239,68,68,.08)}
.h2h-draw{border:1px solid #eab308;color:#fde68a;background:rgba(234,179,8,.08)}
.score-compact{font-variant-numeric:tabular-nums}

/* Bonus */
.bonus-btn{border:1px dashed #4b5bd7;background:transparent;color:#7aa2ff;padding:8px 10px;border-radius:12px;font-weight:700}.bonus-btn[disabled]{opacity:.45;cursor:not-allowed}
#bonus-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9998}
#bonus-modal.show{display:flex}
.bonus-dialog{width:min(560px,92vw);background:#141938;border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.5)}
.bonus-dialog .hd{padding:14px 16px; /* keep existing shadow */border-bottom:1px solid var(--border);font-weight:700}
.bonus-dialog .bd{padding:16px}.bonus-dialog .ft{padding:12px 16px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border)}
.bonus-card{display:flex;gap:12px;align-items:center;margin:6px 0 12px;padding:10px;border:1px dashed #4b5bd7;border-radius:12px;background:#111636}
.bonus-illu{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;background:#0f1331;border:1px solid var(--border)}
.bonus-illu svg{width:36px;height:36px}

/* Couleur du badge #n selon l’état de journée */
.round-chip{font-weight:700}
.round-chip.red{border-color:#ef4444;color:#fecaca;background:rgba(239,68,68,.08)}
.round-chip.yellow{border-color:#eab308;color:#fde68a;background:rgba(234,179,8,.10)}
.round-chip.green{border-color:#22c55e;color:#a7f3d0;background:rgba(34,197,94,.10)}

#storage-warning{position:fixed;right:12px;bottom:12px;display:none;background:#0f1331;border:1px solid var(--border);color:var(--muted);border-radius:10px;padding:8px 10px;z-index:99;box-shadow:0 6px 24px rgba(0,0,0,.35)}
#js-ok{position:fixed; /* keep existing shadow */right:12px;top:12px;background:#7a2525;color:#fff;padding:6px 10px;border-radius:10px;z-index:9999;font:600 12px system-ui,Segoe UI,Roboto}

/* --------- RELOOK MATCH: 2 colonnes + encarts de sport --------- */
.match-two-col{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(340px,1fr));
  gap:16px;
}
.sport-group{
  background:linear-gradient(180deg,#151c3b,#131734);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
}
.sport-title{
  display:flex;align-items:center;gap:8px;
  font-weight:700;margin:0 0 10px;
}
.sport-title .sport-icon{width:18px;height:18px;display:grid;place-items:center;font-size:16px;line-height:1}
.sport-item{margin:0 0 10px}
.sport-item label{display:block;margin:0 0 6px;color:var(--muted)}
.ping-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ping-row input{width:100%}

.bonus-illu img{width:100%;height:100%;object-fit:cover;border-radius:12px}
.pill .mini-bonus{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;overflow:hidden;margin-left:6px;vertical-align:middle}
.pill .mini-bonus img{width:100%;height:100%;object-fit:cover}
.compact td.details{ white-space:normal; vertical-align:top; }
.compact td.details br{ line-height:1.2; }
.compact td:nth-child(5){ white-space:normal; overflow:visible; text-overflow:clip; }
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
window.FIREBASE_CONFIG={apiKey:"AIzaSyBSxiTryd0T1Flv15LBdzu31UFvU_I2J7Q",authDomain:"trisport-9a7b2.firebaseapp.com",databaseURL:"https://trisport-9a7b2-default-rtdb.europe-west1.firebasedatabase.app",projectId:"trisport-9a7b2",messagingSenderId:"132024051367",appId:"1:132024051367:web:f9aa39785a3d4a43875d82"};
</script>




<style id="capitaine-teamwide-v2">
/* Capitaine : suppression des champs joueur/sport dans l'UI (masqués) */
#capitaine-fields,
#cap-params,
#capitaine-params .grid,
#capitaine-params .row { display: none !important; }
</style>




<link href="trisports-theme-pack.css" rel="stylesheet"/>
<body>
<header>
<div class="container flex items-center gap-16 justify-between" style="flex-wrap:nowrap">
  <div class="brand"></div>
  <nav aria-label="Sections" class="tabs" id="tabs" role="tablist">
<button aria-selected="true" class="tab gta gta" data-tab="setup" role="tab" type="button">Tournoi</button>
<button aria-selected="false" class="tab gta gta" data-tab="equipes" role="tab" type="button">Équipes</button>
<button aria-selected="false" class="tab gta gta" data-tab="calendrier" role="tab" type="button">Rencontres</button>
<button aria-selected="false" class="tab gta gta" data-tab="classement" role="tab" type="button">Classement</button>
<button aria-selected="false" class="tab gta gta" data-tab="options" role="tab" type="button">Options</button>
</nav>
  <div class="flex items-center gap-8">
<span class="pill" id="tname-top" style="display:none"></span>
<span class="pill" id="whoami-top" style="">visiteur</span>
<button class="btn small header-chip gta header-chip gta" id="btn-fullscreen" type="button">⛶ Plein écran</button>
</div>
</div>
</header>
<main>
<div class="container">
<div class="help" id="storage-warning" style="display:none"></div>
<!-- TOURNOI -->
<section class="active" id="setup">
<div style="display:flex;justify-content:flex-end;gap:8px;margin:4px 0 8px">
<button class="btn small" id="btn-admin-on-setup" type="button">Se connecter admin</button>
<span class="pill" id="whoami-setup">visiteur</span>
</div>
<div class="card">
<div class="hd"><strong>Créer un tournoi (Cloud)</strong></div>
<div class="bd grid cols-4">
<div><label>Code cloud (ex: apero2025)</label><input id="tcode-input" placeholder="code unique" type="text"/></div>
<div><label>Nom du tournoi</label><input id="tname-input" placeholder="ex : Tournoi de la plage" type="text"/></div>
<div><label>Nombre d’équipes</label><input id="teams-count-input" max="64" min="2" step="1" type="number" value="4"/></div>
<div></div>
<div><label>Fléchettes – Simples (#)</label><input id="rule-d-s" max="9" min="0" type="number" value="2"/></div>
<div><label>Fléchettes – Doubles (#)</label><input id="rule-d-d" max="9" min="0" type="number" value="1"/></div>
<div><label>Points / victoire fléchettes</label><input id="rule-d-p" max="50" min="1" type="number" value="5"/></div>
<div></div>
<div><label>Ping – Simples (#)</label><input id="rule-p-s" max="9" min="0" type="number" value="2"/></div>
<div><label>Ping – Doubles (#)</label><input id="rule-p-d" max="9" min="0" type="number" value="1"/></div>
<div><label>Points / victoire ping</label><input id="rule-p-p" max="50" min="1" type="number" value="5"/></div>
<div></div>
<div><label>Palet – Score cible (victoire)</label><input id="rule-l-target" max="50" min="1" type="number" value="11"/>
<div><label>Bonus max par équipe (saison)</label>
  <input id="rule-bonus-max" type="number" min="0" max="50" value="2"/>
</div>
</div>
<div style="grid-column:1/-1;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
<button class="btn primary" id="btn-create-tournament" type="button">Créer et ouvrir</button>
<span class="help">Création réservée à l’<b>administrateur</b> (PIN requis).</span>
</div>
</div>
</div>
<div class="card" style="margin-top:12px">
<div class="hd"><strong>Ouvrir un tournoi existant (Cloud)</strong></div>
<div class="bd" class="flex gap-8 flex-wrap items-center">
<input id="join-code" placeholder="code du tournoi" style="max-width:220px" type="text"/>
<button class="btn primary" id="btn-join-code" type="button">Rejoindre</button>
<button class="btn" id="btn-copy-link" type="button">Copier lien ?id=code</button>
<span class="help">Statut : <span id="cloud-status">hors ligne</span></span>
</div>
</div>
<div class="card" style="margin-top:12px">
<div class="hd"><strong>Tournois Cloud récents (ce navigateur)</strong></div>
<div class="bd" id="recent-list"><div class="help">Aucun tournoi cloud listé pour l’instant.</div></div>
</div>
</section>
<!-- EQUIPES -->
<section id="equipes">
<div class="card">
<div class="hd">
<div>
<strong>Équipes</strong>
<div class="help">L’<b>administrateur</b> crée et édite les équipes. Les joueurs se connectent à leur équipe pour saisir <b>leurs scores</b> uniquement.</div>
</div>
<div class="flex gap-8 items-center flex-wrap">
<span class="pill" id="lock-pill" style="display:none">Calendrier figé 🔒</span>
<button class="btn primary" id="btn-generate" type="button">Générer le calendrier</button>
</div>
</div>
<div class="bd"><div class="grid responsive" id="team-list"></div></div>
</div>
</section>
<!-- RENCONTRES -->
<section id="calendrier">
<div class="card">
<div class="hd">
<div class="flex items-center gap-8 flex-wrap">
<strong>Rencontres</strong>
<span class="pill" id="round-status">—</span>
</div>
<div class="flex gap-8 items-center flex-wrap">
<span class="pill" id="stats-matches">0 / 0 matches complets</span>
<button class="btn small" id="btn-start-round" style="display:none" type="button">Démarrer journée</button>
<button class="btn small" id="btn-end-round" style="display:none" type="button">Fin de journée</button>
<button class="btn small" id="btn-refresh-standings" type="button">Mise à jour Score</button>
<button class="btn small" id="btn-collapse" type="button">Tout replier</button>
</div>
</div>
<div class="bd"><div class="grid" id="match-list"></div></div>
</div>
</section>
<!-- CLASSEMENT -->
<section id="classement">
<div class="card">
<div class="hd">
<strong>Classement</strong>
<div class="flex gap-8 items-center flex-wrap">
<span class="pill" id="teams-count">0 équipes</span>
<span class="pill" id="rounds-count">0 matchs par équipe</span>
<button aria-pressed="true" class="btn small toggle" id="btn-show-summary" type="button">Classement général</button>
<button aria-pressed="false" class="btn small toggle" id="btn-show-h2h" type="button">Face à face</button>
<button class="btn small" id="btn-refresh-standings-2" type="button">Mettre à jour</button>
</div>
</div>
<div class="bd" style="overflow:auto">
<div id="view-summary">

<table id="table-classement">
<thead>
<tr>
<th>#</th><th>Équipe</th><th>Points</th>
<th>Fléchettes</th><th>Ping-pong</th><th>Palet (PF–PA)</th>
<th>Bonus</th><th>Malus</th>
<th>Matchs complets</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="view-h2h" style="display:none">
<div class="help" style="margin-bottom:10px">Face-à-face : cliquez sur une cellule pour ouvrir la rencontre.</div>
<table class="h2h-table" id="table-h2h"><thead></thead><tbody></tbody></table>
</div>
</div>
</div>
</section>
<!-- OPTIONS -->
<section id="options">
<div class="grid cols-2">
<div class="card"><div class="hd"><strong>Exporter / Importer</strong></div>
<div class="bd grid" style="gap:10px">
<button class="btn" id="btn-export" type="button">Exporter en JSON</button>
<input accept="application/json" id="file-import" type="file"/>
<button class="btn" id="btn-import" type="button">Importer le fichier JSON</button>
<button class="btn" id="btn-export-pdf" type="button">📄 Exporter le résumé (PDF)</button>
</div>
</div>
<div class="card"><div class="hd"><strong>Accès administrateur</strong></div>
<div class="bd" class="flex gap-8 flex-wrap items-center">
<button class="btn" id="btn-admin-on" type="button">Activer admin</button>
<button class="btn" id="btn-admin-off" type="button">Désactiver admin</button>
<span class="pill" id="whoami">vous : visiteur (lecture seule)</span>
</div>
<div class="row" style="margin:8px 0 0 0"><button id="btn-open-logs" style="display:none" class="btn small" type="button" title="Ouvrir le journal">📜 Ouvrir le journal</button></div>
</div>
</div>
<div class="card" style="margin-top:12px">
<div class="hd"><strong>Gestion Cloud</strong></div>
<div class="bd" class="flex gap-8 flex-wrap items-center">
<span class="pill">Statut : <span id="cloud-status-2">hors ligne</span></span>
<button class="btn" id="btn-cloud-copy" type="button">Copier le lien de partage</button>
<button class="btn danger" id="btn-cloud-delete" type="button">Supprimer ce tournoi du cloud</button>
</div>
</div>
<div class="card" style="margin-top:12px">
<div class="hd"><strong>Tournois Cloud récents</strong></div>
<div class="bd" id="manage-list"><div class="help">Aucun tournoi mémorisé.</div></div>
</div>
<div class="card" style="margin-top:12px">
<div class="hd"><strong>Maintenance</strong></div>
<div class="bd grid" style="gap:10px">
<button class="btn" id="btn-reset-scores" type="button">Réinitialiser les scores (garde équipes + calendrier)</button>
<button class="btn" id="btn-unlock" type="button">🔓 Déverrouiller le calendrier</button>
</div>
</div>
</section>
</div>
</main>
<!-- MODAL BONUS -->
<div aria-hidden="true" id="bonus-modal">
<div class="bonus-panel bonus-dialog">
<div class="hd">Choisir un bonus</div>
<div class="bd">
<div class="bonus-select">
<!-- Capitaine -->
<div class="bonus-card">
<div aria-hidden="true" class="bonus-illu">
<img alt="" src="img/capitaine.jpg"/>
</div>
<div class="bonus-text">
<div class="bonus-title">Capitaine</div>
<div class="help">
              Sur l'ensemble des 3 sports :<br/>
<b>+2 points par manche gagnée</b> (fléchettes &amp; ping, simples et doubles)
              et <b>+2pts</b> si <b>palet</b> gagné.
            </div>
</div>
</div>
<div class="bonus-sep"></div>
<!-- Miroir -->
<div class="bonus-card">
<div aria-hidden="true" class="bonus-illu">
<img alt="" src="img/miroir.jpg"/>
</div>
<div class="bonus-text">
<div class="bonus-title">Miroir</div>
<div class="help">
				Sur l'ensemble des 3 sports :<br/>
              Inverse le bonus adverse.<br/>
			  <br/>
            </div>
</div>
</div>
<div class="bonus-sep"></div>
<!-- Braquage -->
<div class="bonus-card" data-bonus-type="braquage">
  <div aria-hidden="true" class="bonus-illu">
    <img alt="" src="img/braquage.png"/>
  </div>
  <div class="bonus-text">
    <div class="bonus-title">Braquage</div>
    <div class="help">
      Sur l’ensemble des 3 sports :<br/>
      • <b>Vole</b> le total du bonus <b>Melon d’or</b> ou <b>Capitaine</b> adverse (positif ou négatif).<br/>
      • Face à <b>10 pouces 2 mains gauche</b> ou <b>René la taupe</b> : <b>+5pts</b> pour vous et <b>-5pts</b> pour l’adversaire si score ≥5.<br/>
      • Face à <b>Miroir</b> : <b>aucun effet</b>.
    </div>
  </div>
</div>
<div class="bonus-sep"></div>

<!-- René la taupe -->
<div class="bonus-card">
<div aria-hidden="true" class="bonus-illu">
<img alt="" src="img/taupe.png"/>
</div>
<div class="bonus-text">
<div class="bonus-title">René la taupe</div>
<div class="help">
              Impose des lunettes troublant la vision à l’adversaire dans un sport choisi.<br/>
			  • Aux <b>fléchettes</b> et <b>Ping</b> : Le joueur 1 porte les lunettes. Le joueur 2 a le choix entre son simple ou son double.<br/>
			  • Au <b>palet</b> : Un seul joueur porte les lunettes. Le choix du joueur se fera au shifumi avec l'adversaire.<br/>  
            </div>
</div>
</div>
<div class="bonus-sep"></div>
<!-- 10 pouces 2 mains gauche -->
<div class="bonus-card">
<div aria-hidden="true" class="bonus-illu">
<img alt="" src="img/main-gauche.png"/>
</div>
<div class="bonus-text">
<div class="bonus-title">10 pouces 2 mains gauche</div>
<div class="help">
              L’adversaire doit jouer avec sa <b>mauvaise main</b><br/>
			  • Aux <b>fléchettes</b> et <b>Ping</b> : Le joueur 1 fait le simple de sa mauvaise main. Le joueur 2 a le choix entre son simple ou son double.<br/>
			  • Au <b>palet</b> : Un seul joueur joue de sa mauvaise main. Le choix du joueur se fera au shifumi avec l'adversaire.<br/> 
              Choisissez le sport concerné.
            </div>
</div>
</div>
<div class="bonus-sep"></div>
<!-- Melon d'or -->
<div class="bonus-card" data-bonus-type="melon">
<div aria-hidden="true" class="bonus-illu">
<img alt="Melon d'or" src="img/melon.png"/>
</div>
<div class="bonus-text">
<div class="bonus-title">Melon d'or</div>
<div class="help">• En cas de <b>victoire</b> : double le nombre de points.<br/>
					• En cas de <b>défaite</b> : Au fléchettes/ping soustrait le nbr de points de l'équipe adverse.<br/>
					Au palet soustrait la différence de points.<br/>
				Choisissez le sport concerné.
				</div>
</div>
</div>
</div>
<!-- Texte d'aide dynamique -->
<div class="help" id="bonus-context">
        Capitaine : +2pts/manche gagnée ; +2pts sur le match au palet.
      </div>
<!-- Paramètres (insérés sous la carte correspondante) -->
<!-- Capitaine n’a plus de paramètres -->
<div class="grid cols-2" id="taupe-fields" style="margin-top:10px">
<div>
<label>Sport</label>
<select id="taupe-sport">
<option value="darts">Fléchettes</option>
<option value="ping">Ping</option>
<option value="palet">Palet</option>
</select>
</div>
</div>
<div class="grid cols-2" id="lefthand-fields" style="margin-top:10px">
<div>
<label>Sport</label>
<select id="lefthand-sport">
<option value="darts">Fléchettes</option>
<option value="ping">Ping</option>
<option value="palet">Palet</option>
</select>
</div>
</div>
<div class="grid cols-2" id="melon-fields" style="margin-top:10px">
<div>
<label>Sport</label>
<select id="melon-sport">
<option value="darts">Fléchettes</option>
<option value="ping">Ping</option>
<option value="palet">Palet</option>
</select>
</div>
</div>
</div>
<div class="ft">
<button class="btn" id="bonus-cancel" type="button">Annuler</button>
<button class="btn primary" id="bonus-save" type="button">Valider</button>
</div>
</div>
</div>
<script>
'use strict';
/* ===== Helpers ===== */

/**
 * @typedef {Object} RoundCtl
 * @property {boolean} started
 * @property {boolean} finished
 *
 * @typedef {Object.<string, any>} Team
 *
 * @typedef {Object} AppState
 * @property {number} version
 * @property {string} tid
 * @property {string|null} cloudId
 * @property {string} tournamentName
 * @property {Object} rules
 * @property {Array<Team>} teams
 * @property {Array<any>} matches
 * @property {Object.<number, RoundCtl>} roundCtl
 * @property {Object.<number, Object.<string, any>>} bonusSelections
 * @property {Object.<number, Object.<string, number>>} bonusApplied
 * @property {Object.<number, Object.<string, boolean>>} bonusUsed
 */


// Centralise libellés/images pour les bonus (évite les erreurs de frappe)
const BONUS = {
  /** @param {"capitaine"|"miroir"|"taupe"|"lefthand"|"melon"|string} type */
  labelForType(type){
    switch(type){
      case "miroir":   return "Miroir";
      case "taupe":    return "René la taupe";
      case "lefthand": return "10 pouces 2 mains gauche";
      case "melon":    return "Melon d'or";
      case "braquage": return "Braquage";
      default:         return "Capitaine";
    }
  },
  imgForType(type){
    switch(type){
      case "miroir":   return "miroir.jpg";
      case "taupe":    return "taupe.png";
      case "lefthand": return "main-gauche.png";
      case "melon":    return "melon.png";
      case "braquage": return "braquage.png";
      default:         return "capitaine.jpg";
    }
  },
  sportLabel(s){ return s==="darts" ? "Fléchettes" : (s==="ping" ? "Ping" : "Palet"); },
  playerLabel(p){ return p==="p1" ? "J1" : "J2"; }
};

// Helpers sûrs pour initialiser les containers imbriqués
function ensure(obj, key, defFactory){
  if(!obj[key]) obj[key] = defFactory();
  return obj[key];
}

const id=x=>document.getElementById(x), qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const esc=s=>(s==null?"":String(s)).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","\"":"&quot;","'":"&#39;"}[c]));
const uid=()=>Math.random().toString(36).slice(2,10);
const clampInt=(v,min,max)=>{v=parseInt(v,10);if(isNaN(v))return null;return Math.max(min,Math.min(max,v));}
const help=t=>{const d=document.createElement("div");d.className="help";d.textContent=t;return d;}
function hashPass(s){s=(s||"").trim();let h=0x811c9dc5>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,0x01000193)>>>0}return("00000000"+h.toString(16)).slice(-8)}
const hy=(a,b)=>`${a}\u2011${b}`;
const BONUS_VAL=5;

/* ===== Erreurs visibles ===== */
window.onerror=(msg,src,line,col)=>{const el=id("storage-warning");if(el){el.style.display="block";el.textContent="Erreur JS : "+msg+" @"+(src||"")+":"+(line||0)+":"+(col||0)} const p=id("js-ok");if(p){p.textContent='JS chargé avec erreurs ⚠️';p.style.background='#8a2a2a'}};

/* ===== Index Cloud (local) ===== */
const STORAGE_KEY="trisports_cloud_only_v1"; const IDX_KEY="trisports_cloud_index_v1";
function getIndex(){try{return JSON.parse(localStorage.getItem(IDX_KEY)||"[]")}catch(_){return[]}}
function setIndex(a){try{localStorage.setItem(IDX_KEY,JSON.stringify(a||[]))}catch(_){}}
function upsertIndex(e){const i=getIndex();const k=i.findIndex(x=>x.id===e.id);if(k>=0)i[k]=Object.assign({},i[k],e);else i.unshift(e);setIndex(i)}
function nameExistsLocally(n){n=(n||"").trim().toLowerCase();if(!n)return false;return getIndex().some(e=>(e.name||"").trim().toLowerCase()===n)}
function codeExistsLocally(c){return getIndex().some(e=>e.id===c)}
function renderSetupRecent(){const wrap=id("recent-list");wrap.innerHTML="";const idx=getIndex().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));if(!idx.length){wrap.appendChild(help("Aucun tournoi cloud listé pour l’instant."));return}const box=document.createElement("div");box.style.display="flex";box.style.flexWrap="wrap";box.style.gap="8px";idx.forEach(e=>{const btn=document.createElement("button");btn.className="btn";btn.type="button";btn.textContent="☁ "+e.name+" ("+e.id+")";btn.dataset.openId="cloud:"+e.id;const del=document.createElement("button");del.className="btn danger";del.type="button";del.textContent="Supprimer du cloud";del.dataset.deleteId=e.id;const w=document.createElement("div");w.style.display="flex";w.style.gap="6px";w.append(btn,del);box.appendChild(w)});wrap.appendChild(box)}
function renderManageList(){renderSetupRecent()}

/* ===== État ===== */
let state={version:40,tid:uid(),cloudId:null,tournamentName:"",rules:{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11,
  bonusMaxPerTeam: 99,},teams:[],matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};
let ui={open:{},h2h:false}; let session={admin:false,claims:{}};
// === Session persistence (admin & team claims) ===
(function(){
  // safety: define rewriteCapitaineHelp if missing
  if (typeof window.rewriteCapitaineHelp !== 'function') { window.rewriteCapitaineHelp = function(){}; }

  const SESSION_KEY = 'trisports.session.v1';
  const MAX_AGE_MS = 7 * 24 * 60 * 60 * 1000; // 7 jours

  function loadPersisted(){
    try{
      const raw = localStorage.getItem(SESSION_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(!obj || !obj.t || (Date.now() - obj.t) > MAX_AGE_MS) return;
      if (typeof obj.admin === 'boolean') session.admin = obj.admin;
      if (obj.claims && typeof obj.claims === 'object') session.claims = obj.claims;
    }catch(e){ /* ignore */ }
  }

  function persistNow(){
    try{
      const payload = { t: Date.now(), admin: !!session.admin, claims: session.claims || {} };
      localStorage.setItem(SESSION_KEY, JSON.stringify(payload));
    }catch(e){ /* ignore */ }
  }

  // Load once on boot
  loadPersisted();

  // Persist on unload and also whenever we detect a change
  window.addEventListener('beforeunload', persistNow);

  // Optional helper APIs for your code
  window.persistSessionNow = persistNow;
  window.clearSessionPersistence = function(){
    try{ localStorage.removeItem(SESSION_KEY); }catch(e){}
  };
})();
function isAdmin(){return !!session.admin} function hasClaim(tid){return !!session.claims[tid]}
// === Droits de saisie des scores selon l'état de la journée ===
function _iAmTeamOf(m){ return hasClaim(m.a) || hasClaim(m.b); }
function canEditScores(m, rCtl){
  if (!rCtl.started && !rCtl.finished) return false; // pas commencé -> personne
  if (rCtl.finished) return isAdmin();               // terminé -> admin seul
  return isAdmin() || _iAmTeamOf(m);                 // en cours -> admin + équipe du match
}

function teamObj(tid){return state.teams.find(t=>t.id===tid)||null} function teamName(tid){const t=teamObj(tid);return t?t.name:"—"}
function initials(name){const s=(name||"").trim();if(!s)return"?";const p=s.split(/\s+/);return(p[0][0]+(p[1]?.[0]||"")).toUpperCase()}
function avatarHtml(tid,size,attrs){const t=teamObj(tid)||{name:"?"};const url=t.avatar;const cls=size==='lg'?'avatar-lg':(size==='sm'?'avatar-sm':'');const extra=attrs?(' '+attrs):'';const content=url?('<img src="'+esc(url)+'" alt="avatar">'):('<span class="avatar-initials">'+esc(initials(t.name))+'</span>');return '<span class="avatar '+cls+'" title="'+esc(t.name)+'"'+extra+'>'+content+'</span>'}
function updateWho(){try{var lb=document.getElementById("btn-open-logs");if(lb)lb.style.display=isAdmin()?"inline-block":"none"}catch(e){};const names=Object.keys(session.claims||{}).map(teamName).filter(Boolean);const who=isAdmin()?(names.length?("Admin · "+names.join(", ")):"Admin"):(names[0]||"visiteur");id("whoami").textContent="vous : "+who;id("whoami-top").textContent=who;const s=id("whoami-setup");if(s)s.textContent=who;const b=id("btn-add-team");if(b)b.style.display=isAdmin()?"inline-block":"none";const ba=id("btn-admin-on-setup");if(ba)ba.style.display=isAdmin()?"none":"inline-block"}
function renderTitle(){const name=(state.tournamentName||"").trim();document.title=(name?name+" — ":"")+"TriSports — Fléchettes • Ping-pong • Palet";const pill=id("tname-top");if(name){pill.style.display="inline-block";pill.textContent=name}else{pill.style.display="none";pill.textContent=""}}
function dartsTotal(){return (state.rules?.dartsSingles||0)+(state.rules?.dartsDoubles||0)}
function pingTotal(){return (state.rules?.pingSingles||0)+(state.rules?.pingDoubles||0)}
function ensureLengths(m){const dN=dartsTotal(),pN=pingTotal();m.darts=Array.isArray(m.darts)?m.darts.slice(0,dN):[];while(m.darts.length<dN)m.darts.push(null);if(!Array.isArray(m.pingPts))m.pingPts=[];m.pingPts=m.pingPts.slice(0,pN);while(m.pingPts.length<pN)m.pingPts.push({a:null,b:null});}
function _normMatch(m){m=m||{};m.id=m.id||uid();m.a=m.a||"";m.b=m.b||"";ensureLengths(m);m.palet=m.palet||{a:null,b:null};m.palet.a=(m.palet.a==null?null:+m.palet.a);m.palet.b=(m.palet.b==null?null:+m.palet.b);m.round=m.round||1;m.order=m.order||0;return m}
function normalize(){state.rules=state.rules||{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11};state.teams=Array.isArray(state.teams)?state.teams:[];state.matches=Array.isArray(state.matches)?state.matches.map(_normMatch):[];state.protect=state.protect||{};state.protect.teamPassHash=state.protect.teamPassHash||{};state.roundCtl=state.roundCtl||{};state.bonusSelections=state.bonusSelections||{};state.bonusApplied=state.bonusApplied||{};state.bonusUsed=state.bonusUsed||{};state.bonusUsed=state.bonusUsed||{}}

/* ===== Firebase ===== */
const cloud={enabled:false,db:null,id:null,ref:null,timer:null}; const hasFB=!!(window.firebase&&window.FIREBASE_CONFIG&&window.FIREBASE_CONFIG.apiKey);
function initFB(){try{if(!hasFB)return null;if(!firebase.apps||firebase.apps.length===0)firebase.initializeApp(window.FIREBASE_CONFIG);return firebase.database()}catch(_){return null}}
// If Firebase Auth is present, ensure local persistence
try{
  if (window.firebase && firebase.auth){
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
  }
}catch(e){}
function setCloudTxt(t){id("cloud-status").textContent=t;id("cloud-status-2").textContent=t}
function unsubscribeCloud(){try{if(cloud.ref)cloud.ref.off('value')}catch(_){ }cloud.ref=null;cloud.enabled=false;cloud.id=null;setCloudTxt('hors ligne')}
function resetState(){state={version:40,tid:uid(),cloudId:null,tournamentName:"",rules:{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11,
  bonusMaxPerTeam: 99,},teams:[],matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};try{localStorage.removeItem(STORAGE_KEY)}catch(_){}} 
function joinCloud(code){if(!hasFB){showToast("Firebase non configuré.");return}if(!cloud.db){cloud.db=initFB();if(!cloud.db){showToast("Init Firebase impossible.");return}}unsubscribeCloud();cloud.id=(code||"").trim();if(!cloud.id){showToast("Saisis un code tournoi.");return}cloud.ref=cloud.db.ref("tournaments/"+cloud.id+"/payload");cloud.enabled=true;setCloudTxt("connexion");cloud.ref.on("value",snap=>{const val=snap.val();if(!val){setCloudTxt("connecté (vide)");return}safeSetStateFromCloud(val);normalize();state.cloudId=cloud.id;localStorage.setItem(STORAGE_KEY,JSON.stringify(state));upsertIndex({id:cloud.id,name:state.tournamentName||"Sans titre",updatedAt:Date.now()});renderAll();setCloudTxt("connecté ("+cloud.id+")")});try{history.replaceState(null,"",location.pathname+"?id="+encodeURIComponent(cloud.id))}catch(_){}}

function safeSetStateFromCloud(val){
  try{
    if(!val || typeof val!=="object" || !val.state || typeof val.state!=="object"){
      // pas d'état valide côté cloud : on laisse l'état local tel quel
      return;
    }
    state = val.state;
  }catch(_){ /* on ignore, on garde l'état local */ }
}

function pushCloud(immediate){if(!cloud.enabled||!cloud.ref)return;clearTimeout(cloud.timer);cloud.timer=setTimeout(()=>cloud.ref.set({state,updatedAt:Date.now()}),immediate?0:250)}
function deleteCloud(code){if(!cloud.db){cloud.db=initFB()}return cloud.db.ref("tournaments/"+code).remove()}
function saveState(){normalize();localStorage.setItem(STORAGE_KEY,JSON.stringify(state));upsertIndex({id:state.cloudId||cloud.id||"?",name:state.tournamentName||"Sans titre",updatedAt:Date.now()});renderTitle();renderSetupRecent();renderManageList();if(cloud.enabled)pushCloud()}

/* Plein écran */
document.addEventListener("fullscreenchange",()=>{const b=id("btn-fullscreen");if(!b)return;b.textContent=document.fullscreenElement?"Quitter plein écran":"⛶ Plein écran"});

/* ===== Calendrier ===== */
function generateSchedule(){const ids=state.teams.map(t=>t.id);if(ids.length<2){state.matches=[];saveState();renderMatches();return}const BYE="__BYE__";if(ids.length%2===1)ids.push(BYE);const fixed=ids[0],rest=ids.slice(1);for(let i=rest.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[rest[i],rest[j]]=[rest[j],rest[i]]}const n=ids.length,rounds=n-1;const out=[];let order=0;for(let r=0;r<rounds;r++){const arr=[fixed].concat(rest),half=n/2,pairs=[];for(let k=0;k<half;k++){const a=arr[k],b=arr[n-1-k];if(a!==BYE&&b!==BYE)pairs.push((r%2===0)?[a,b]:[b,a])}rest.unshift(rest.pop());if(pairs.length>1){let shift=r%pairs.length;while(shift-->0)pairs.unshift(pairs.pop())}for(const pr of pairs){out.push(_normMatch({id:uid(),a:pr[0],b:pr[1],darts:Array(dartsTotal()).fill(null),pingPts:Array(pingTotal()).fill({a:null,b:null}),palet:{a:null,b:null},round:r+1,order:order++}))}}out.sort((x,y)=>(x.round-y.round)||(x.order-y.order));state.matches=out;ui.open={};state.roundCtl={};state.bonusSelections={};state.bonusApplied={};saveState();renderMatches()}
function renderTeams(){const el=id("team-list");el.innerHTML="";if(!state.teams.length){el.appendChild(help("Aucune équipe. Utilisez l’onglet « Tournoi » pour créer/rejoindre un tournoi cloud."));updateCounts();updateLock();return}state.teams.forEach((t,idx)=>{const iOwn=hasClaim(t.id),admin=isAdmin(),hasHash=!!(state.protect?.teamPassHash?.[t.id]);const dis=admin?'':' disabled';const delBtn=(admin&&!state.locked)?`<button type="button" class="btn small danger" data-act="del" data-id="${t.id}">Supprimer</button>`:'';const protectInfo=hasHash?(iOwn?'🔒 vous êtes connecté à cette équipe':'🔒 protégée par mot de passe'):'🔓 non protégée — demandez à l’admin de définir un mot de passe';const protectBtns=(admin?`<button type="button" class="btn small" data-act="setpass" data-id="${t.id}">Définir / changer mot de passe</button>`:'')+(!iOwn?`<button type="button" class="btn small" data-act="login" data-id="${t.id}">Se connecter à cette équipe</button>`:`<button type="button" class="btn small" data-act="logout" data-id="${t.id}">Se déconnecter</button>`);const avatarBtn=(admin||iOwn)?`<button type="button" class="btn small" data-act="avatar" data-id="${t.id}">Changer avatar</button>`:'';const avatarClr=((admin||iOwn)&&t.avatar)?`<button type="button" class="btn small" data-act="avatar-clear" data-id="${t.id}">Retirer avatar</button>`:'';const card=document.createElement("div");card.className="match-card";card.setAttribute("aria-expanded","true");card.innerHTML=`<div class="hd team-header" style="border:none;border-bottom:1px solid var(--border)"><div class="teams"><span class="chip">#${idx+1}</span><span class="team-name">${avatarHtml(t.id,'lg','data-click-avatar="'+t.id+'"')}<input type="text"${dis} value="${esc(t.name)}" data-field="name" data-id="${t.id}"/></span></div></div><div class="bd"><input type="file" accept="image/*" data-avatar="${t.id}" style="display:none"/><div class="grid cols-2"><div><label>Joueur·se 1</label><input type="text"${dis} value="${esc(t.p1)}" data-field="p1" data-id="${t.id}"/></div><div><label>Joueur·se 2</label><input type="text"${dis} value="${esc(t.p2)}" data-field="p2" data-id="${t.id}"/></div></div><div class="help" style="margin-top:6px">${protectInfo}</div><div class="team-actions">${avatarBtn}${avatarClr}${protectBtns}</div><div style="display:flex;justify-content:flex-end;margin-top:10px">${delBtn}</div></div>`;el.appendChild(card)});qsa('#team-list input[data-field]').forEach(inp=>{const tid=inp.getAttribute("data-id"),f=inp.getAttribute("data-field");inp.addEventListener("input",()=>{if(!isAdmin())return;const t=teamObj(tid);if(!t)return;t[f]=inp.value;localStorage.setItem(STORAGE_KEY,JSON.stringify(state))});inp.addEventListener("blur",()=>{if(!isAdmin())return;const t=teamObj(tid);if(!t)return;t[f]=inp.value;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()})});qsa('#team-list input[type="file"][data-avatar]').forEach(inp=>{inp.addEventListener("change",async()=>{const tid=inp.getAttribute("data-avatar");if(!(isAdmin()||hasClaim(tid)))return;const file=inp.files?.[0];if(!file)return;try{const url=await fileToSquareDataURL(file,160);const t=teamObj(tid);if(!t)return;t.avatar=url;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}catch{showToast("Échec du chargement de l’avatar.")}finally{inp.value=""}})});updateCounts();updateLock()}
function fileToSquareDataURL(file,size){return new Promise((resolve,reject)=>{const r=new FileReader();r.onerror=()=>reject(new Error("read"));r.onload=()=>{const img=new Image();img.onload=()=>{try{const m=Math.min(img.width,img.height),sx=(img.width-m)/2,sy=(img.height-m)/2;const c=document.createElement("canvas");c.width=size;c.height=size;c.getContext('2d').drawImage(img,sx,sy,m,m,0,0,size,size);resolve(c.toDataURL('image/jpeg',0.9))}catch(e){reject(e)}};img.onerror=()=>reject(new Error("img"));img.src=r.result};r.readAsDataURL(file)})}
function updateCounts(){id("teams-count").textContent=state.teams.length+" "+(state.teams.length>1?"équipes":"équipe");const per=Math.max(0,state.teams.length-1);id("rounds-count").textContent=per+" "+(per>1?"matchs":"match")+" par équipe"}
function updateLock(){const pill=id("lock-pill");if(pill)pill.style.display=state.locked?"inline-block":"none";const gen=id("btn-generate");if(gen){gen.disabled=!!state.locked;gen.textContent=state.locked?"Calendrier figé":"Générer le calendrier"}}

/* ===== Rencontres & Scores ===== */
const getPingPts = m => { return Array.isArray(m.ping) ? m.ping.map(v => (v===0?{a:1,b:0} : (v===1?{a:0,b:1}:{a:null,b:null}))) : (Array.isArray(m.pingPts)?m.pingPts:Array(pingTotal()).fill({a:null,b:null})); };
const isPingValid=(a,b)=>{ if(a==null||b==null) return false; if((a===1&&b===0)||(a===0&&b===1)) return true; if(isNaN(a)||isNaN(b)) return false; const max=Math.max(a,b), diff=Math.abs(a-b); return (max>=11)&&(diff>=2); }
function computeSetWins(m){ensureLengths(m);const aw={darts:0,ping:0},bw={darts:0,ping:0};m.darts.forEach(v=>{if(v===0)aw.darts++;else if(v===1)bw.darts++});getPingPts(m).forEach(s=>{const a=(s.a==null?null:+s.a),b=(s.b==null?null:+s.b);if(isPingValid(a,b)){if(a>b)aw.ping++;else if(b>a)bw.ping++}});return{aw,bw}}
function isMatchComplete(m){ensureLengths(m);const okD=m.darts.every(v=>v===0||v===1);const okP=getPingPts(m).every(s=>isPingValid(+s.a,+s.b));const T=+state.rules.paletTarget||11,pa=(m.palet?.a==null?null:+m.palet?.a),pb=(m.palet?.b==null?null:+m.palet?.b);const okL=(pa!=null&&pb!=null)&&((pa===T&&pb>=0&&pb<=T-1)||(pb===T&&pa>=0&&pa<=T-1));return okD&&okP&&okL}
// UI completeness stricter check
function uiIsComplete(m){
  const dN = dartsTotal();

  // Fléchettes : longueur exacte + valeurs 0/1
  const okD = Array.isArray(m.darts) &&
              m.darts.length === dN &&
              m.darts.every(v => v === 0 || v === 1);

  // Ping : TOUJOURS 3 sets (S1, S2, D1) et 0/1 partout
  const okP = Array.isArray(m.ping) &&
              m.ping.length === 3 &&
              m.ping.every(v => v === 0 || v === 1);

  // Palet : deux entiers
  const okL = Number.isInteger(m.palet?.a) && Number.isInteger(m.palet?.b);

  return okD && okP && okL;
}

const findMatch=mid=>state.matches.find(x=>x.id===mid);
function clearMatch(mid){
  const m = findMatch(mid);
  if (!m) return;
  if (!isAdmin()) return;

  // Reset Fléchettes
  m.darts = Array(dartsTotal()).fill(null);

  // Reset Ping (choix set gagnant ET scores chiffrés)
  m.ping = Array(pingTotal()).fill(null);
  m.pingPts = Array(pingTotal()).fill({ a: null, b: null });

  // Reset Palet
  m.palet = { a: null, b: null };

  saveState();
  renderMatches();
  if (typeof renderLeaderboard === 'function') renderLeaderboard();
  if (typeof renderH2H === 'function') renderH2H();
}

/* ===== Bonus ===== */
function roundState(r){state.roundCtl[r]=state.roundCtl[r]||{started:false,finished:false};return state.roundCtl[r]}
function setBonusSelection(r,tid,sel){state.bonusSelections[r]=state.bonusSelections[r]||{};state.bonusSelections[r][tid]=sel}
function getBonusSelection(r,tid){return(state.bonusSelections[r]||{})[tid]||null}
function setBonusApplied(r,tid,pts){state.bonusApplied[r]=state.bonusApplied[r]||{};state.bonusApplied[r][tid]=pts}
function getBonusAppliedSum(tid){let s=0;for(const r in state.bonusApplied){const v=state.bonusApplied[r]?.[tid];if(v)s+=v}return s}
function teamBonusUsed(tid){const t=teamObj(tid);return !!(t&&t.bonusCapitaineUsed)}function markTeamBonusUsed(tid){const t=teamObj(tid);if(t)t.bonusCapitaineUsed=true}

/* Capitaine — calcul robuste */
function computeCapitaineBonusForMatch(match, teamId/*, _player, _sport */){
  try{
    let wins = 0;
    const isA = (match.a === teamId), isB = (match.b === teamId);
    if (!isA && !isB) return 0;

    // Fléchettes
    if (Array.isArray(match.darts)) {
      match.darts.forEach(v=>{
        if (v===0 && isA) wins++;
        else if (v===1 && isB) wins++;
      });
    }

    // Ping (0/1 ou score valide ≥11 avec 2 pts d’écart)
    const getPingPts = (m) => Array.isArray(m.ping)
      ? m.ping.map(v => (v===0?{a:1,b:0} : (v===1?{a:0,b:1}:{a:null,b:null})))
      : (Array.isArray(m.pingPts) ? m.pingPts : []);
    const isPingValid = (a,b) => {
      if(a==null||b==null) return false;
      if((a===1&&b===0)||(a===0&&b===1)) return true;
      if(isNaN(a)||isNaN(b)) return false;
      const max=Math.max(a,b), diff=Math.abs(a-b);
      return (max>=11)&&(diff>=2);
    };

/* Points de l'équipe dans un sport donné (hors bonus) — robuste */
function pointsForTeamInSport(m, tid, sport){
  try{
    if(!m || !tid) return 0;
    const isA = (m.a === tid);
    const s = (sport || 'darts');
    if (s === 'darts'){
      let aw=0, bw=0;
      const arr = Array.isArray(m.darts) ? m.darts : [];
      arr.forEach(v=>{ if(v===0) aw++; else if(v===1) bw++; });
      return (isA ? aw : bw) * 5;
    } else if (s === 'ping'){
      let aw=0, bw=0;
      const pts = (typeof getPingPts === 'function') ? (getPingPts(m) || []) : [];
      pts.forEach(scor=>{
        if(!scor) return;
        const a = (scor.a!=null) ? +scor.a : null;
        const b = (scor.b!=null) ? +scor.b : null;
        if (!isPingValid(a,b)) return;
        if (a>b) aw++; else if (b>a) bw++;
      });
      return (isA ? aw : bw) * 5;
    } else if (s === 'palet'){
      const pa = (m.palet && m.palet.a!=null) ? +m.palet.a : null;
      const pb = (m.palet && m.palet.b!=null) ? +m.palet.b : null;
      if (pa==null || pb==null) return 0;
      return isA ? pa : pb;
    }
    return 0;
  }catch(_){ return 0; }
}

    (getPingPts(match) || []).forEach(s=>{
      const a = (s && s.a!=null) ? +s.a : null;
      const b = (s && s.b!=null) ? +s.b : null;
      if (!isPingValid(a,b)) return;
      if (a>b && isA) wins++;
      else if (b>a && isB) wins++;
    });

    // Palet
    const target = +((window.state && state.rules && state.rules.paletTarget) ?? 11);
    const pa = (match.palet && match.palet.a!=null) ? +match.palet.a : null;
    const pb = (match.palet && match.palet.b!=null) ? +match.palet.b : null;
    if (pa!=null && pb!=null){
      if (pa>=target && pa>pb && isA) wins++;
      else if (pb>=target && pb>pa && isB) wins++;
    }

    return 2 * wins;
  }catch(e){ return 0; }
}

/* Melon d’or — ±2 × différence en POINTS sur le sport choisi (1 manche = 5 pts au ping & fléchettes) */

function computeMelonBonusForMatch(m, tid, sport){
  try{
    const isA = (m.a === tid);
    const isB = (m.b === tid);
    if(!isA && !isB) return 0;

    if (sport === 'darts') {
      // Manches gagnées -> points (×5)
      let aw=0, bw=0;
      (m.darts||[]).forEach(v=>{ if(v===0) aw++; else if(v===1) bw++; });
      const myPts  = (isA ? aw : bw) * 5;
      const oppPts = (isA ? bw : aw) * 5;
      if (myPts > oppPts) return myPts;
      if (myPts < oppPts) return -oppPts;
      return 0;
    } else if (sport === 'ping') {
      // Manches gagnées par set -> points (×5)
      let aw=0, bw=0;
      (getPingPts(m) || []).forEach(s=>{
        const a = (s && s.a!=null) ? +s.a : null;
        const b = (s && s.b!=null) ? +s.b : null;
        if (!isPingValid(a,b)) return;
        if (a>b) aw++; else if (b>a) bw++;
      });
      const myPts  = (isA ? aw : bw) * 5;
      const oppPts = (isA ? bw : aw) * 5;
      if (myPts > oppPts) return myPts;
      if (myPts < oppPts) return -oppPts;
      return 0;
    } else { // palet
      const a = (m.palet && m.palet.a!=null) ? +m.palet.a : null;
      const b = (m.palet && m.palet.b!=null) ? +m.palet.b : null;
      if (a==null || b==null) return 0;
      const myPF  = isA ? a : b;
      const oppPF = isA ? b : a;
      // target from rules (fallback to 11)
      const R = (window.state && state.rules) || {};
      const target = +(R.paletTarget ?? 11);
      if (myPF > oppPF) return myPF;                 // victoire => +PF
      if (myPF < oppPF) return - (1 * Math.max(0, target - myPF));  // défaite => -1×(T−PF équipe)
      return 0;
    }
  }catch(e){ return 0; }
}
/* === Recompute all bonuses for finished rounds (used when admin edits scores after closure) === */
function recomputeAllBonuses(){
  try{
    const rounds = (state.matches || []).map(m=>m.round).filter((v,i,a)=>a.indexOf(v)===i).sort((a,b)=>a-b);
    state.bonusApplied = state.bonusApplied || {};
    rounds.forEach(r=>{
      const rs = roundState(r);
      if (!rs || !rs.finished) return;
      const matches = (state.matches || []).filter(m=>m.round===r);
      const sels = (state.bonusSelections && state.bonusSelections[r]) || {};
      // reset applied
      state.bonusApplied[r] = state.bonusApplied[r] || {};
      Object.keys(sels).forEach(tid=>{ state.bonusApplied[r][tid]=0; });

      Object.keys(sels).forEach(tid=>{
        const sel = sels[tid]; if (!sel) return;
        let total = 0;
        if (sel.type === 'capitaine'){
          const m = matches.find(x=>x.a===tid || x.b===tid);
          if (m){
            const oppId = (m.a===tid ? m.b : m.a);
            const oppSel = sels[oppId];
            if (oppSel && (oppSel.type === 'miroir' || oppSel.type === 'braquage')){
              total = 0; // Capitaine transféré : l'effet sera appliqué côté Miroir adverse
            } else {
              matches.forEach(m=>{ total += computeCapitaineBonusForMatch(m, tid, sel.player, sel.sport); });
            }
          } else {
            matches.forEach(m=>{ total += computeCapitaineBonusForMatch(m, tid, sel.player, sel.sport); });
          }
        } else if (sel.type === 'melon'){
          const m = matches.find(x=>x.a===tid || x.b===tid);
          if (m){
            const oppId = (m.a===tid ? m.b : m.a);
            const oppSel = sels[oppId];
            if (oppSel && (oppSel.type === 'miroir' || oppSel.type === 'braquage')){
              total = 0; // sera ajouté côté Miroir
            } else {
              const sport = sel.sport || 'darts';
              total = computeMelonBonusForMatch(m, tid, sport);
            }
          }
        } else if (sel.type === 'miroir'){
          const m = matches.find(x=>x.a===tid || x.b===tid);
          if (m){
            const oppId = (m.a===tid ? m.b : m.a);
            const oppSel = sels[oppId];
            if (oppSel && oppSel.type === 'melon'){
              const sport = oppSel.sport || 'darts';
              total = computeMelonBonusForMatch(m, tid, sport);
            } else if (oppSel && oppSel.type === 'capitaine'){
              // Transfert du Capitaine : applique le calcul Capitaine au camp Miroir
              total = 0;
              total += computeCapitaineBonusForMatch(m, tid, oppSel.player, oppSel.sport);
            }
          }
                } else if (sel.type === 'braquage'){
  const m = matches.find(x=>x.a===tid || x.b===tid);
  if (m){
    const oppId = (m.a===tid ? m.b : m.a);
    const oppSel = sels[oppId];
    if (!oppSel || oppSel.type === 'miroir'){
      total = 0;
    } else if (oppSel.type === 'melon'){
      const sport = oppSel.sport || 'darts';
      total = computeMelonBonusForMatch(m, oppId, sport);
    } else if (oppSel.type === 'capitaine'){
      total = computeCapitaineBonusForMatch(m, oppId, oppSel.player, oppSel.sport);
    } else if (oppSel.type === 'taupe' || oppSel.type === 'lefthand'){
      const sport = oppSel.sport || 'darts';
      const oppPts = pointsForTeamInSport(m, oppId, sport);
      if (oppPts >= 5){
        total = 5; // +5 braqueur
        state.bonusApplied[r] = state.bonusApplied[r] || {}}
        } else if (sel.type === 'braquage') {
          const m = matchesOfRound.find(x => x.a===tid || x.b===tid);
          if (m){
            const oppId = (m.a===tid ? m.b : m.a);
            const oppSel = sels[oppId];
            if (!oppSel || oppSel.type === 'miroir') {
              total = 0;
            } else if (oppSel.type === 'melon') {
              const sport = oppSel.sport || 'darts';
              total = computeMelonBonusForMatch(m, oppId, sport);
            } else if (oppSel.type === 'capitaine') {
              total = computeCapitaineBonusForMatch(m, oppId, oppSel.player, oppSel.sport);
                        } else if (oppSel.type === 'taupe' || oppSel.type === 'lefthand') {
              const sport = oppSel.sport || 'darts';
              const myPtsInSport = pointsForTeamInSport(m, oppId, sport);
              if (myPtsInSport >= 5) {
                total = 5;
                state.bonusApplied[r] = state.bonusApplied[r] || {}} else {
              total = 0;
            }
          }
        
        } else {
          total = 0; // autres
        }

        setBonusApplied(r, tid, total); 
        state.bonusUsed = state.bonusUsed || {}; state.bonusUsed[r] = state.bonusUsed[r] || {}; state.bonusUsed[r][tid]=true; 
        markTeamBonusUsed(tid);
        } catch (e) {
          console.error('bonus compute failed', e);
          try { setBonusApplied(r, tid, 0); } catch(_){ }
        }
      });

      rs.finished = true; saveState(); renderMatches(); renderLeaderboard();
      showToast(`Journée #${r} terminée — bonus appliqués et révélés.`); break;
    }
  }}
  const openBtn=e.target.closest("[data-open-id]");if(openBtn){const code=openBtn.getAttribute("data-open-id").replace(/^cloud:/,"");id("join-code").value=code;joinCloud(code);goto("equipes")}
  const delBtn=e.target.closest("[data-delete-id]");if(delBtn){if(!isAdmin())return alert("Suppression cloud réservée à l’admin.");const code=delBtn.getAttribute("data-delete-id");if(!confirm("Supprimer le tournoi '"+code+"' du cloud ?"))return;deleteCloud(code).then(()=>{setIndex(getIndex().filter(e=>e.id!==code));if(state.cloudId===code||cloud.id===code){unsubscribeCloud();resetState();renderAll();history.replaceState(null,"",location.pathname);goto('setup')}showToast("Supprimé.");renderSetupRecent()})}
  const av=e.target.closest('.avatar[data-click-avatar]');if(av){const tid=av.getAttribute('data-click-avatar');if(isAdmin()||hasClaim(tid)){const input=document.querySelector('input[type="file"][data-avatar="'+tid+'"]');if(input)input.click()}return}
  const tab=e.target.closest(".tab");if(tab){let t=tab.getAttribute("data-tab");if(guardTab(t))t='setup';qsa(".tab").forEach(b=>b.setAttribute("aria-selected","false"));qs('.tab[data-tab="'+t+'"]').setAttribute("aria-selected","true");qsa("main section").forEach(s=>s.classList.remove("active"));id(t).classList.add("active")}
  const actBtn=e.target.closest("[data-act]");if(actBtn){const act=actBtn.getAttribute("data-act"),tid=actBtn.getAttribute("data-id");if(act==="del"){if(!isAdmin()||state.locked)return;if(!confirm("Supprimer cette équipe ?"))return;state.teams=state.teams.filter(tt=>tt.id!==tid);state.matches=state.matches.filter(m=>m.a!==tid&&m.b!==tid);if(state.protect?.teamPassHash)delete state.protect.teamPassHash[tid];saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
    if(act==="setpass"){if(!isAdmin())return alert("Réservé à l’admin.");let pass=prompt("Mot de passe pour l’équipe « "+teamName(tid)+" » :");if(pass==null)return;pass=pass.trim();if(!pass)return alert("Mot de passe vide.");state.protect=state.protect||{};state.protect.teamPassHash=state.protect.teamPassHash||{};state.protect.teamPassHash[tid]=hashPass(pass);saveState();renderTeams();showToast("Mot de passe défini.")}
    if(act==="login"){const hashes=(state.protect&&state.protect.teamPassHash)?state.protect.teamPassHash:null;if(!hashes||!hashes[tid])return alert("Cette équipe n’a pas encore de mot de passe (demandez à l’admin).");let pass=prompt("Mot de passe de l’équipe « "+teamName(tid)+" » :");if(pass==null)return;pass=pass.trim();if(!pass)return alert("Mot de passe vide.");if(hashPass(pass)===hashes[tid]){ session.admin=false; session.claims={}; session.claims[tid]=true; updateWho(); renderAll(); showToast("Connexion réussie. Mode admin désactivé sur cet appareil."); }
      else showToast("Mot de passe incorrect.") }
    if(act==="logout"){session.claims={};updateWho();renderAll()}
    if(act==="avatar"){const input=qs('[data-avatar="'+tid+'"]');if(input)input.click()}
    if(act==="avatar-clear"){const t=teamObj(tid);if(!t)return;t.avatar=null;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
  }
});

/* ===== Modal bonus ===== */
let bonusCTX={round:null,teamId:null};



/* === Bonus categories & locks === */
function rebuildCategoryLocksFromSelections(){
  try{
    const S = state.bonusSelections || {};
    const teams = (state.teams||[]).map(t=>t.id);
    state.categoryLocks = {};
    teams.forEach(tid => { state.categoryLocks[tid] = {}; });
    Object.keys(S).forEach(r=>{
      const perTeam = S[r] || {};
      Object.keys(perTeam).forEach(tid=>{
        const type = perTeam[tid] && perTeam[tid].type;
        const cat = BONUS_CATEGORY[type];
        if (cat) { state.categoryLocks[tid] = state.categoryLocks[tid] || {}; state.categoryLocks[tid][cat] = true; }
      });
    });
  }catch(_){}
}

const BONUS_CATEGORY = { capitaine:'score', melon:'score', taupe:'physique', lefthand:'physique', miroir:'miroir', braquage:'miroir' };

function markCategoryLocked(teamId, type){
  const cat = BONUS_CATEGORY[type];
  if (!cat) return;
  state.categoryLocks = state.categoryLocks || {};
  state.categoryLocks[teamId] = state.categoryLocks[teamId] || {};
  state.categoryLocks[teamId][cat] = true;
  if (typeof saveState==='function') saveState();
}

function getTeamCategoryLocks(teamId){
  // Returns a Set of categories already validated (locked) by THIS team for the whole tournament
  const locks = new Set();
  const CL = state.categoryLocks && state.categoryLocks[teamId];
  if (CL) Object.keys(CL).forEach(cat => { if (CL[cat]) locks.add(cat); });
  return locks;
}

function applyBonusLocks(teamId){
  if (typeof rebuildCategoryLocksFromSelections==='function') rebuildCategoryLocksFromSelections();
  try{
    const locks = getTeamCategoryLocks(teamId);
    const round = (window.bonusCTX && window.bonusCTX.round);
    const currentSel = (typeof getBonusSelection==='function' && round!=null) ? (getBonusSelection(round, teamId) || null) : null;

    const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
    const map   = ['capitaine','miroir','braquage','taupe','lefthand','melon'];
    cards.forEach((c,i)=>{
      const type = map[i] || 'capitaine';
      const cat = BONUS_CATEGORY[type];
      const locked = !!(cat && locks.has(cat));
      // Autoriser la carte du type déjà sélectionné pour CETTE journée
      const allowCurrentType = !!(currentSel && currentSel.type === type);
      const disable = locked && !allowCurrentType;

      c.classList.toggle('disabled', disable);
      c.setAttribute('aria-disabled', disable ? 'true' : 'false');
      c.title = disable ? "Déjà utilisé pour cette catégorie (tournoi)" : "";
    });

    // Si la sélection courante est désormais illégale (catégorie lockée et type différent), forcer un type autorisé
    if (window._bonusType){
      const curCat = BONUS_CATEGORY[window._bonusType];
      const curSelCat = currentSel ? BONUS_CATEGORY[currentSel.type] : null;
      if (curCat && locks.has(curCat) && (!currentSel || currentSel.type !== window._bonusType)){
        const first = map.find(t => {
          const c = BONUS_CATEGORY[t];
          const isLocked = locks.has(c);
          const isCurrent = currentSel && currentSel.type === t;
          return !isLocked || isCurrent;
        });
        if (first) selectBonusType(first);
      }
    }
  }catch(_){}
}

function openBonusModal(round, teamId){
  
// Limite saisonnière : bonusMaxPerTeam
try {
  const max = +(((state && state.rules) ? state.rules.bonusMaxPerTeam : undefined) ?? Infinity);
  if (isFinite(max)) {
    const S = state.bonusSelections || {};
    let total = 0;
    Object.keys(S).forEach(function(r){ if (S[r] && S[r][teamId]) total++; });
    const dejaIci = !!(S[round] && S[round][teamId]);
    if (!dejaIci && total >= max) {
      alert(`Limite atteinte : ${max} bonus pour cette équipe sur la saison.`);
      return;
    }
  }
} catch(_){}
const rCtl = roundState(round);
  if (rCtl.started) return alert("La journée a démarré : bonus verrouillés.");
  if (state.bonusUsed?.[round]?.[teamId]) return alert("Ce bonus a déjà été utilisé une fois.");
  if (!hasClaim(teamId)) return alert("Connectez-vous à cette équipe pour choisir son bonus.");

  bonusCTX.round = round;
  bonusCTX.teamId = teamId;
  const sel = getBonusSelection(round, teamId) || {};

  // Prépare et sélectionne la carte
  if (typeof prepareBonusOptions === 'function') {
    prepareBonusOptions();
    selectBonusType(sel.type || 'capitaine');
    if (typeof applyBonusLocks==='function') applyBonusLocks(teamId);
  }

  // Préremplissage des champs spécifiques si disponibles
  const sport = sel.sport || 'darts';
  if (document.getElementById('taupe-sport'))     document.getElementById('taupe-sport').value = sport;
  if (document.getElementById('lefthand-sport'))  document.getElementById('lefthand-sport').value = sport;
  if (document.getElementById('melon-sport'))     document.getElementById('melon-sport').value = sport;

  const modal = document.getElementById('bonus-modal');
  if (modal) {
    const ctx = document.getElementById('bonus-context');
    if (ctx) ctx.textContent = `Équipe : ${teamName(teamId)} — Journée #${round}`;
    modal.classList.add('show');
  }
}

id('bonus-cancel').addEventListener('click',()=>id('bonus-modal').classList.remove('show'));
id('bonus-save').addEventListener('click',()=>{
  const r=bonusCTX.round, t=bonusCTX.teamId;

 const type =
  (window._bonusType === 'miroir')   ? 'miroir'   :
  (window._bonusType === 'taupe')    ? 'taupe'    :
  (window._bonusType === 'lefthand') ? 'lefthand' :
  (window._bonusType === 'melon')    ? 'melon'    :
  (window._bonusType === 'braquage') ? 'braquage' :
                                       'capitaine';

  // Block saving if category already used this season
  try{
    const locks = getTeamCategoryLocks(t);
    const cat = BONUS_CATEGORY[type];
    if (cat && locks.has(cat)) { showToast("Bonus déjà utilisé pour cette catégorie."); return; }
  }catch(_){}

// Nouveau : 'capitaine' et 'melon' n'ont pas de paramètres à lire
if (type === 'capitaine') {
  setBonusSelection(r, t, { type });
} else if (type === 'melon') {
  const sport = document.getElementById('melon-sport')?.value || 'darts';
  setBonusSelection(r, t, { type: 'melon', sport });
} else if (type === 'taupe') {
  const sport = document.getElementById('taupe-sport')?.value || 'darts';
  setBonusSelection(r, t, { type: 'taupe', sport });
  if (typeof markCategoryLocked==='function') markCategoryLocked(t, 'taupe');
  if (typeof applyBonusLocks==='function') applyBonusLocks(t);
} else if (type === 'lefthand') {
  const sport = document.getElementById('lefthand-sport')?.value || 'darts';
  setBonusSelection(r, t, { type: 'lefthand', sport });
  if (typeof markCategoryLocked==='function') markCategoryLocked(t, 'lefthand');
  if (typeof applyBonusLocks==='function') applyBonusLocks(t);
} else if (type === 'miroir') {
  setBonusSelection(r, t, { type: 'miroir' });
  if (typeof markCategoryLocked==='function') markCategoryLocked(t, 'miroir');
  if (typeof applyBonusLocks==='function') applyBonusLocks(t);
} else if (type === 'braquage') {
  setBonusSelection(r, t, { type: 'braquage' });
  if (typeof markCategoryLocked==='function') markCategoryLocked(t, 'miroir');
  if (typeof applyBonusLocks==='function') applyBonusLocks(t);
} else {
  // garde-fou
  setBonusSelection(r, t, { type: 'capitaine' });
  if (typeof markCategoryLocked==='function') markCategoryLocked(t, 'capitaine');
  if (typeof applyBonusLocks==='function') applyBonusLocks(t);
}

  id('bonus-modal').classList.remove('show');
  if(typeof renderPills==='function') renderPills();
  if(typeof renderMatches==='function') renderMatches();
});

/* ===== Boot ===== */
function renderAll(){renderTitle();updateWho();renderSetupRecent();renderManageList();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
document.addEventListener("DOMContentLoaded",()=>{ try { renderAll(); } catch(e) {} });</script>
<script>
(function(){
  function withFallback(img, primary, fall1, fall2){
    img.src = primary;
    img.onerror = function(){
      img.onerror = function(){
        img.onerror = function(){
          img.onerror = null;
          img.src = fall2;
        };
        img.src = fall1;
      };
      img.src = 'img/' + primary.split('/').pop();
    };
  }
  function ensureBrandImages(){
    var brand = document.querySelector('header .brand') || document.querySelector('.brand');
    if(!brand) return;
    if(!brand.querySelector('img.brand-logo')){
      var logo = document.createElement('img');
      logo.className = 'brand-logo';
      logo.alt = 'TriSports logo';
      brand.prepend(logo);
      withFallback(logo, 'tripsort/img/logo.png', 'trisport/img/logo.png', 'img/logo.png');
    }
    if(!brand.querySelector('img.brand-title')){
      var title = document.createElement('img');
      title.className = 'brand-title';
      title.alt = 'TriSports';
      var ref = brand.querySelector('img.brand-logo');
      if(ref && ref.nextSibling){ brand.insertBefore(title, ref.nextSibling); }
      else { brand.appendChild(title); }
      withFallback(title, 'tripsort/img/titre.png', 'trisport/img/titre.png', 'img/titre.png');
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureBrandImages);
  }else{
    ensureBrandImages();
  }
  // garder la réécriture d'aide capitaine en async léger
  document.addEventListener('click', function(){ if (typeof rewriteCapitaineHelp==='function') setTimeout(rewriteCapitaineHelp,0); }, true);
  
  // --- Affichage après révélation : ne pas afficher joueur/sport pour Capitaine ---
  if (typeof window.bonusChip === 'function'){
    const _origChip = window.bonusChip;
    window.bonusChip = function(r, mTeam, rs){
      const html = _origChip(r, mTeam, rs);
      if (typeof html === 'string' && /Capitaine\s*:?\s*J\d/i.test(html)){
        return html.replace(/Capitaine\s*:?\s*J\d\s*\/\s*(Fléchettes|Ping|Palet)/i, 'Capitaine');
      }
      return html;
    };
  }
})();
</script>
<script id="matchcard-animations-js">
(function(){
  function getPanel(card){
    return card && card.querySelector('.bd');
  }
  function animateOpen(card){
    const panel = getPanel(card);
    if(!panel) return;
    // Ensure visible style before measuring
    panel.style.display = 'block';
    // From current height (0 || set) to scrollHeight
    panel.style.maxHeight = panel.scrollHeight + 'px';
    panel.style.opacity = '1';
    panel.style.paddingTop = '';
    panel.style.paddingBottom = '';
    function onEnd(e){
      if(e.propertyName === 'max-height'){
        panel.style.maxHeight = 'none'; // natural height
        panel.removeEventListener('transitionend', onEnd);
      }
    }
    panel.addEventListener('transitionend', onEnd);
  }
  function animateClose(card){
    const panel = getPanel(card);
    if(!panel) return;
    // If currently 'none', set to current measured height for transition start
    if(getComputedStyle(panel).maxHeight === 'none'){
      panel.style.maxHeight = panel.scrollHeight + 'px';
    }
    // Force reflow to apply starting height
    panel.getBoundingClientRect();
    // Then animate to 0
    panel.style.maxHeight = '0px';
    panel.style.opacity = '0';
    panel.style.paddingTop = '0px';
    panel.style.paddingBottom = '0px';
  }

  // Observe aria-expanded changes to trigger animation
  const cards = Array.from(document.querySelectorAll('.match-card'));
  const obs = new MutationObserver((mutations)=>{
    mutations.forEach(m=>{
      if(m.type === 'attributes' && m.attributeName === 'aria-expanded'){
        const card = m.target;
        const isOpen = card.getAttribute('aria-expanded') === 'true';
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches){
          // No animation, just set styles minimally
          const p = getPanel(card);
          if(!p) return;
          if(isOpen){
            p.style.maxHeight = 'none'; p.style.opacity = '1'; p.style.paddingTop=''; p.style.paddingBottom=''; p.style.display='block';
          }else{
            p.style.maxHeight = '0px'; p.style.opacity = '0'; p.style.paddingTop='0'; p.style.paddingBottom='0'; p.style.display='block';
          }
          return;
        }
        if (isOpen) animateOpen(card); else animateClose(card);
      }
    });
  });
  cards.forEach(card=>{
    obs.observe(card, { attributes:true, attributeFilter:['aria-expanded'] });
    // Make header clickable/toggleable if not already
    const hd = card.querySelector('.hd');
    if(hd){
      hd.style.cursor = 'pointer';
      hd.setAttribute('tabindex','0');
      hd.setAttribute('role','button');
      const toggle = (ev)=>{
        if(ev && ev.type==='keydown' && !(ev.key==='Enter' || ev.key===' ')) return;
        const open = card.getAttribute('aria-expanded') !== 'true';
        card.setAttribute('aria-expanded', open ? 'true' : 'false');
        if(ev) ev.preventDefault();
      };
      hd.addEventListener('click', toggle);
      hd.addEventListener('keydown', toggle);
    }
    // Initialize panel style according to current state
    const isOpen = card.getAttribute('aria-expanded') === 'true';
    const p = getPanel(card);
    if(p){
      if(isOpen){
        p.style.maxHeight = 'none';
        p.style.opacity = '1';
      }else{
        p.style.maxHeight = '0px';
        p.style.opacity = '0';
        p.style.paddingTop='0';
        p.style.paddingBottom='0';
        p.style.display='block';
      }
    }
  });

  // Hook into "Tout replier" button if present
  const collapseBtn = document.getElementById('btn-collapse');
  if(collapseBtn){
    collapseBtn.addEventListener('click', ()=>{
      document.querySelectorAll('.match-card[aria-expanded="true"]').forEach(c=>c.setAttribute('aria-expanded','false'));
    });
  }
})();
</script>
<script id="standings-count-anim">
(function(){
  const TBL = document.getElementById('table-classement');
  if(!TBL) return;

  const isReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const DURATION = isReduced ? 0 : 600;

  function numFromText(t){
    if(!t) return null;
    const m = (''+t).replace(',', '.').match(/-?\d+(?:\.\d+)?/);
    return m ? parseFloat(m[0]) : null;
  }
  function formatLike(orig, n){
    const hasPlus = /^\s*\+/.test(orig);
    const s = Math.round(n).toString();
    return hasPlus ? (n>=0? '+' : '') + Math.round(n).toString() : s;
  }
  function animateCount(cell, from, to){
    if (DURATION === 0){ cell.textContent = formatLike(cell.textContent, to); return; }
    const start = performance.now();
    function step(now){
      const p = Math.min(1, (now - start) / DURATION);
      const eased = 1 - Math.pow(1 - p, 3);
      const val = from + (to - from) * eased;
      if (cell && cell.isConnected){
        cell.textContent = formatLike(cell.textContent, val);
      }
      if (p < 1 && cell && cell.isConnected) requestAnimationFrame(step);
      else if (cell && cell.isConnected) cell.textContent = formatLike(cell.textContent, to);
    }
    requestAnimationFrame(step);
  }

  const tbody = TBL.querySelector('tbody');
  if(!tbody) return;

  function initRow(tr){
    if (!tr || !tr.children) return;
    const pts = tr.children[2];
    const bon = tr.children[6];
    const mal = tr.children[7];
    if (pts) pts.dataset.prev = pts.textContent.trim();
    if (bon) bon.dataset.prev = bon.textContent.trim();
    if (mal) mal.dataset.prev = mal.textContent.trim();
  }

  Array.from(tbody.querySelectorAll('tr')).forEach(initRow);

  const mo = new MutationObserver((ms)=>{
    ms.forEach(m=>{
      if (m.type === 'characterData'){
        const parent = m.target && m.target.parentElement ? m.target.parentElement : null;
        if (!parent || !parent.parentElement) return;
        const tr = parent.parentElement;
        if (!tr || !tr.children) return;
        const colIndex = Array.from(tr.children).indexOf(parent);
        if (![2,6,7].includes(colIndex)) return;
        const prevText = parent.dataset.prev || '';
        const newText = parent.textContent.trim();
        const from = numFromText(prevText);
        const to = numFromText(newText);
        if (from==null || to==null || from===to){ parent.dataset.prev = newText; return; }
        parent.textContent = prevText;
        animateCount(parent, from, to);
        parent.dataset.prev = newText;
      }
      if (m.type === 'childList'){
        m.addedNodes.forEach(node=>{
          if(!(node && node.nodeType===1)) return;
          if (node.matches && node.matches('tr')){
            const tr = node;
            tr.style.animation = 'slideUpFade .28s ease both';
            const parent = tr.parentElement || (m.target && m.target.nodeType===1 ? m.target : null);
            if (parent && parent.children){
              const idx = Array.from(parent.children).indexOf(tr);
              tr.style.animationDelay = (Math.min(6, Math.max(0, idx)) * 0.03).toFixed(2) + 's';
            }
            initRow(tr);
          }else{
            node.querySelectorAll && node.querySelectorAll('tr').forEach(initRow);
          }
        });
      }
    });
  });
  mo.observe(tbody, { subtree:true, characterData:true, childList:true });

  function pulse(){
    TBL.style.boxShadow='0 0 0 1px rgba(122,162,255,.25) inset';
    setTimeout(()=>{ if (TBL) TBL.style.boxShadow=''; }, 250);
  }
  const r1 = document.getElementById('btn-refresh-standings');
  const r2 = document.getElementById('btn-refresh-standings-2');
  r1 && r1.addEventListener('click', pulse);
  r2 && r2.addEventListener('click', pulse);
})();
</script>
<div aria-hidden="true" id="confirm-overlay"><div class="confirm-card"><div class="hd"><span class="icon"></span>Confirmation</div><div class="bd">Êtes-vous sûr ?</div><div class="ft"><button class="btn" type="button">Annuler</button><button class="btn primary" type="button">Confirmer</button></div></div></div><script id="confirm-modal-logic">
(function(){
  // Build a Promise-based confirm
  window.showConfirm = function(opts){
    opts = opts || {};
    var overlay = document.getElementById('confirm-overlay');
    var icon = overlay.querySelector('.icon');
    var title = overlay.querySelector('.hd');
    var body = overlay.querySelector('.bd');
    var btns = overlay.querySelectorAll('.ft .btn');
    var btnCancel = btns[0], btnOk = btns[1];

    // Title text (keep icon span intact)
    overlay.querySelector('.hd').childNodes[1].nodeValue = opts.title || 'Confirmation';
    icon.textContent = opts.icon || '⚠️';
    body.textContent = opts.message || 'Êtes-vous sûr ?';
    btnOk.textContent = opts.okText || 'Confirmer';
    btnCancel.textContent = opts.cancelText || 'Annuler';
    btnOk.classList.toggle('danger', !!opts.danger);

    return new Promise(function(resolve){
      function close(res){
        overlay.classList.remove('show');
        document.removeEventListener('keydown', esc);
        btnCancel.removeEventListener('click', onCancel);
        btnOk.removeEventListener('click', onOk);
        resolve(res);
      }
      function esc(e){ if(e.key==='Escape') close(false); }
      function onCancel(){ close(false); }
      function onOk(){ close(true); }

      document.addEventListener('keydown', esc);
      btnCancel.addEventListener('click', onCancel);
      btnOk.addEventListener('click', onOk);
      overlay.classList.add('show');
      btnOk.focus();
    });
  };

  // Intercept clicks on sensitive actions with a capturing listener
  var pass = false;
  document.addEventListener('click', function(ev){
    var btn = ev.target.closest && (
      ev.target.closest('[data-clear]') ||
      ev.target.closest('#btn-start-round') ||
      ev.target.closest('#btn-end-round')
    );
    if(!btn) return;
    if(pass){ pass = false; return; } // let it through once

    // Prevent original handlers
    ev.stopImmediatePropagation();
    ev.preventDefault();

    // Derive context
    var isClear = !!btn.closest('[data-clear]');
    var isStart = btn.id === 'btn-start-round';
    var isEnd   = btn.id === 'btn-end-round';

    var cfg = isClear ? {
      title: 'Effacer ce match ?',
      icon: '🗑️',
      message: 'Cette action remettra à zéro Fléchettes, Ping et Palet pour ce match. Continuer ?',
      okText: 'Oui, effacer',
      danger: true
    } : isStart ? {
      title: 'Démarrer la journée ?',
      icon: '🏁',
      message: 'Vous êtes sur le point d’ouvrir la journée. Les équipes pourront saisir leurs scores. Confirmer ?',
      okText: 'Démarrer'
    } : {
      title: 'Clôturer la journée ?',
      icon: '🔒',
      message: 'Vous allez passer la journée en “terminée”. Les équipes ne pourront plus modifier les scores (sauf admin). Confirmer ?',
      okText: 'Clore',
      danger: true
    };

    showConfirm(cfg).then(function(ok){
      if(!ok) return;
      // Allow a single pass-through click to trigger the app's existing handler
      pass = true;
      btn.click();
    });
  }, true); // capture phase to beat existing listeners
})();
</script><div class="toast" id="toast"></div><script id="toast-logic">
(function(){
  window.showToast = function(msg, timeout){
    timeout = timeout || 2600;
    var el = document.getElementById('toast');
    if(!el) return alert(msg);
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(function(){ el.classList.remove('show'); }, timeout);
  };
})();
</script><script id="boot-title-who">
(function(){
  try{
    if (typeof renderTitle === 'function') renderTitle();
    if (typeof updateWho === 'function')  updateWho();
  }catch(e){ /* silent */ }
})();
</script><script id="points-column-script-medallion-hook">
(function(){
  function wrapPoints(){
    var t = document.getElementById('table-classement');
    if(!t) return;
    t.querySelectorAll('tbody td:nth-child(3)').forEach(function(td){
      var v = (td.textContent || "").trim();
      var span = td.querySelector('span.points-medal');
      if (span) {
        span.textContent = v;
      } else if (v) {
        td.textContent = "";
        var s = document.createElement('span');
        s.className = 'points-medal';
        s.textContent = v;
        td.appendChild(s);
      }
    });
  }
  function patch(){
    var orig = window.renderLeaderboard;
    if (typeof orig === 'function'){
      if (!orig._withPointsWrap){
        window.renderLeaderboard = function(){
          var r = orig.apply(this, arguments);
          requestAnimationFrame(wrapPoints);
          return r;
        };
        window.renderLeaderboard._withPointsWrap = true;
      }
      requestAnimationFrame(wrapPoints);
    } else {
      setTimeout(patch, 120);
    }
  }
  // Réappliquer quand on affiche l’onglet Classement
  document.addEventListener('click', function(ev){
    var btn = ev.target.closest && ev.target.closest('.tab[data-tab="classement"]');
    if (btn){ requestAnimationFrame(function(){ setTimeout(wrapPoints, 0); }); }
  });
  patch();
})();
</script>
<script id="bonus-pop-autoplace">
(function(){
  function getScoreRect(root){
    var score = root.closest('.match-card')?.querySelector('.scorewrap .score, .score') ||
                document.querySelector('.scorewrap .score, .score');
    return score ? score.getBoundingClientRect() : null;
  }
  
  function place(pop, pill){
    // reset
    pop.classList.remove('is-above');
    pop.style.setProperty('--x-offset', '0px');

    var popRect   = pop.getBoundingClientRect();
    var pillRect  = pill.getBoundingClientRect();
    var scoreRect = getScoreRect(pill);

    if (!scoreRect){
      if (popRect.top < 8) pop.classList.add('is-above');
      return;
    }

    var overlapVert = !(popRect.bottom < scoreRect.top || popRect.top > scoreRect.bottom);
    if (overlapVert){
      pop.classList.add('is-above');
      popRect = pop.getBoundingClientRect();
    }

    var margin = 8;
    var needLeft  = Math.max(0, scoreRect.left  - popRect.left  + margin);
    var needRight = Math.max(0, popRect.right   - scoreRect.right + margin);

    var dx = 0;
    if (needLeft === 0 && needRight === 0){
      dx = 0;
    } else if (needRight > 0 && needLeft <= 0){
      dx = -needRight;
    } else if (needLeft > 0 && needRight <= 0){
      dx = needLeft;
    } else {
      var scoreCenter = (scoreRect.left + scoreRect.right) / 2;
      dx = (pillRect.left < scoreCenter) ? needLeft : -needRight;
    }

    var newLeft  = popRect.left  + dx;
    var newRight = popRect.right + dx;
    if (newLeft < 16) dx += (16 - newLeft);
    if (newRight > window.innerWidth - 16) dx -= (newRight - (window.innerWidth - 16));

    pop.style.setProperty('--x-offset', dx.toFixed(0) + 'px');
  }

function onEnter(e){
    var pill = (function(t){var el=t; if(el&&el.nodeType&&el.nodeType!==1) el=el.parentElement; while(el){ if(el.matches&&el.matches('.pill.bonus-flashy')) return el; el=el.parentElement; } return null;})(e.target);
    if (!pill) return;
    var pop = pill.querySelector('.bonus-pop');
    if (!pop) return;
    requestAnimationFrame(function(){ place(pop, pill); });
  }
  function onLeave(e){
    var pill = (function(t){var el=t; if(el&&el.nodeType&&el.nodeType!==1) el=el.parentElement; while(el){ if(el.matches&&el.matches('.pill.bonus-flashy')) return el; el=el.parentElement; } return null;})(e.target);
    if (!pill) return;
    var pop = pill.querySelector('.bonus-pop');
    if (!pop) return;
    pop.classList.remove('is-above');
    pop.style.removeProperty('--x-offset');
  }
  document.addEventListener('mouseenter', onEnter, true);
  document.addEventListener('mouseleave', onLeave, true);
})();
</script>


<script>
// === Bonus tooltip — large, hover only (fixed to body) ===================
(function bonusTooltipHoverOnly(){
  const DESCS = {
    "Capitaine": "+2pts par manche gagnée (fléchettes & ping, simples et doubles) et +2pts si match de palet gagné.",
    "Miroir": "Inverse le bonus adverse sur tout le match.",
    "René la taupe": "Lunettes gênantes imposées à l’adversaire dans le sport choisi.",
    "10 pouces 2 mains gauche": "L’adversaire doit jouer avec sa mauvaise main. Choisissez le sport concerné.",
    "Melon d'or": "En cas de victoire : double le nombre de points.	En cas de défaite : au ping/fléchettes -> soustrait le nbr de pts de l'adversaire. Au palet soustrait la différence de points",
	"Braquage" : "Vole les points bonus (positif ou négatif) du bonus Melon/Capitaine adverse ; Vole 5 pts contre Taupe/Main gauche si l'équipe adverse a au moins 5pts ; aucun effet face à Miroir.",
  };

  // Single tooltip node (no backdrop)
  const tip = document.createElement('div');
  tip.className = 'bonus-tip floating';
  tip.style.position = 'fixed';
  tip.style.zIndex = '99999';
  tip.style.display = 'none';
  tip.innerHTML = '<span class="tip-img"></span><span><div class="tip-title"></div><div class="tip-desc"></div></span>';
  document.body.appendChild(tip);

  const imgBox = tip.querySelector('.tip-img');
  const tTitle = tip.querySelector('.tip-title');
  const tDesc  = tip.querySelector('.tip-desc');
  let anchor = null;    // current pill
  let overTip = false;  // track hover inside the tip

  function fill(pill){
    const img = pill.dataset?.bonusImg || pill.querySelector?.('.mini-bonus img')?.getAttribute('src') || '';
    const title = pill.dataset?.bonusTitle || pill.getAttribute?.('aria-label') || (pill.textContent || '').trim();
    const desc  = pill.dataset?.bonusDesc || DESCS[title] || '';
    imgBox.innerHTML = img ? '<img src="'+img+'" alt="" />' : '';
    tTitle.textContent = title || 'Bonus';
    tDesc.textContent  = desc;
  }

  function place(pill){
    const r = pill.getBoundingClientRect();
    tip.style.display = 'grid';
    tip.style.opacity = '0';
    tip.classList.remove('show');
    requestAnimationFrame(()=>{
      const w = tip.offsetWidth;
      const h = tip.offsetHeight;
      let x = Math.round(r.left + r.width/2 - w/2);
      let y = Math.round(r.top - h - 10);
      const margin = 10;
      if (x < margin) x = margin;
      if (x + w > window.innerWidth - margin) x = window.innerWidth - margin - w;
      if (y < margin) y = Math.round(r.bottom + 10);
      tip.style.left = x + 'px';
      tip.style.top  = y + 'px';
      tip.style.opacity = '1';
      tip.classList.add('show');
    });
  }

  function show(pill){ anchor = pill; fill(pill); place(pill); }
  function hide(){
    if (!overTip) { tip.style.display = 'none'; tip.classList.remove('show'); anchor = null; }
  }

  // Keep visible while mouse moves over the tooltip
  tip.addEventListener('mouseenter', ()=>{ overTip = true; });
  tip.addEventListener('mouseleave', ()=>{ overTip = false; hide(); });

  function attach(pill){
    if (!pill || pill.dataset.btipReady) return;
    pill.dataset.btipReady = '1';
    if (!pill.hasAttribute('tabindex')) pill.setAttribute('tabindex','0');
    pill.addEventListener('mouseenter', ()=>show(pill));
    pill.addEventListener('mouseleave', (e)=>{
      const to = e.relatedTarget;
      if (!tip.contains(to)) hide();
    });
    pill.addEventListener('focus', ()=>show(pill));
    pill.addEventListener('blur', hide);
    // No click/touch needed
  }

  function enhanceAll(root){
    (root || document).querySelectorAll('.pill').forEach(p=>{
      if (p.querySelector('.mini-bonus img')) attach(p);
    });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>enhanceAll(document));
  } else {
    enhanceAll(document);
  }

  try{
    const mo = new MutationObserver(()=>enhanceAll(document));
    mo.observe(document.body, { childList:true, subtree:true });
  }catch(_){}

  window.refreshBonusTooltips = enhanceAll;
})();
</script>






<!-- START: Simple action logger (Firebase + local fallback) -->
<style>
#ts-log-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:99999;background:rgba(0,0,0,0.45)}
#ts-log-modal.show{display:flex}
#ts-log-panel{width:min(980px,96vw);max-height:82vh;overflow:auto;background:#0f1331;border-radius:12px;border:1px solid rgba(255,255,255,0.04);padding:12px;box-shadow:0 30px 60px rgba(0,0,0,.6)}
#ts-log-panel .hd{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
#ts-log-panel .list{font-family:monospace;font-size:13px;line-height:1.25;color:#dfe8ff;max-height:64vh;overflow:auto;padding:6px;border-radius:8px;background:linear-gradient(180deg,#0b0f22,#0f1331);border:1px solid rgba(122,162,255,0.05)}
.ts-log-item{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;gap:12px}
.ts-log-item .ts{width:140px;color:#9aa9d8;font-size:12px}
.ts-log-item .meta{flex:1;white-space:pre-wrap}
.ts-log-controls{display:flex;gap:8px}
</style>

<div id="ts-log-modal" aria-hidden="true">
  <div id="ts-log-panel" role="dialog" aria-label="Journal des actions">
    <div class="hd">
      <strong>Journal des actions</strong>
      <div class="ts-log-controls">
        <button id="ts-clear-local" class="btn small">Effacer local</button>
        <button id="ts-download" class="btn small">Télécharger</button>
        <button id="ts-close" class="btn small">Fermer</button>
      </div>
    </div>
    <div class="list" id="ts-log-list" aria-live="polite"></div>
  </div>
</div>

<script>
(function(){
  const LS_KEY = 'trisports_logs_v1';
  const MAX_DISPLAY = 1000;
  const id = (s)=>document.getElementById(s);
  const escape = s => (s==null ? '' : String(s)).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
  const teamNameById = (tid)=>{
    try{
      if(typeof window.teamName === 'function') return window.teamName(tid);
      const t = (window.state && Array.isArray(state.teams)) ? state.teams.find(x=>String(x.id)===String(tid) || String(x.tid)===String(tid)) : null;
      return (t && (t.name || t.n)) || String(tid);
    }catch(e){ return String(tid); }
  };
  const actorLabel = ()=>{
    try{
      if((window.session && window.session.admin)) return 'Admin';
      const who = (document.getElementById('whoami-top') && document.getElementById('whoami-top').textContent)?.trim();
      if(who) return who;
    }catch(e){}
    return 'Utilisateur';
  };
  function describeAction(type, data){
    var who = actorLabel();
    try{
      switch(type){
        case 'team_rename':
          return who + ' a changé le nom de l’équipe « ' + (data && (data.newName||'?')) + ' »' + (data && data.oldName ? ' (avant : « ' + data.oldName + ' »)' : '');
        case 'score_update':
          // data: {team, discipline, value}
          var team = data && data.team != null ? teamNameById(data.team) : null;
          var disc = (data && data.discipline) || 'score';
          var val  = (data && (data.value!=null ? data.value : data.to));
          if(team) return who + ' a changé le score du ' + disc + ' pour « ' + team + ' » à ' + val;
          return who + ' a changé le score du ' + disc + ' à ' + val;
        case 'ping_set':
          // data: {index, team}
          var tP = data && data.team != null ? teamNameById(data.team) : null;
          var idx = (data && typeof data.index==='number') ? data.index : 0;
          try {
            var sSingles = (state && state.rules && +state.rules.pingSingles) || 0;
            var label = (idx < sSingles) ? ('Simple ' + (idx+1)) : ('Double ' + (idx - sSingles + 1));
            return who + ' a enregistré une victoire au ping pour « ' + tP + ' » (' + label + ')';
          } catch(e){
            return who + ' a enregistré une victoire au ping pour « ' + (tP||'') + ' » (set #' + (idx+1) + ')';
          }
        case 'darts_set':
          // data: {index, team}
          var tD = data && data.team != null ? teamNameById(data.team) : null;
          var i2 = (data && typeof data.index==='number') ? data.index : 0;
          try {
            var sD = (state && state.rules && +state.rules.dartsSingles) || 0;
            var lab = (i2 < sD) ? ('Simple ' + (i2+1)) : ('Double ' + (i2 - sD + 1));
            return who + ' a enregistré une victoire aux fléchettes pour « ' + tD + ' » (' + lab + ')';
          } catch(e){
            return who + ' a enregistré une victoire aux fléchettes pour « ' + (tD||'') + ' » (manche #' + (i2+1) + ')';
          }
        case 'bonus_selection':
          // data: { round, team, sel }
          return who + ' a défini le bonus de « ' + teamNameById(data && data.team) + ' » pour la manche ' + (data && data.round);
        case 'clear_match':
          return who + ' a réinitialisé le match ' + (data && data.matchId ? data.matchId : '');
        case 'admin_on':
          return 'Admin activé';
        case 'admin_off':
          return 'Admin désactivé';
        case 'round_start':
          return who + ' a démarré la journée';
        case 'round_end':
          return who + ' a terminé la journée';
        case 'import':
          return who + ' a importé des données';
        case 'export':
          return who + ' a exporté des données';
        case 'cloud_delete':
          return who + ' a supprimé les données cloud';
        default:
          return null; // laisser tomber les types techniques
      }
    }catch(e){
      return null;
    }
  }

  let logs = [];
  function firebaseRef(){
    try{
      if(window.firebase && firebase.database){
        const tid = (window.state && (state.cloudId || state.tid)) || 'local';
        return firebase.database().ref('tournaments/' + tid + '/logs');
      }
    }catch(e){}
    return null;
  }
  function writeFirebase(entry){
    const ref = firebaseRef();
    if(!ref) return Promise.reject(new Error('no firebase'));
    return ref.push(entry);
  }
  function saveLocal(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(logs)); }catch(_){} }
  function loadLocal(){ try{ const raw = localStorage.getItem(LS_KEY); if(raw) logs = JSON.parse(raw) || []; }catch(e){ logs = []; } }
  loadLocal();
  function renderList(){
    const wrap = id('ts-log-list'); if(!wrap) return;
    const out = logs.slice(-MAX_DISPLAY).map(l=>{
      const d = new Date(l.ts || Date.now());
      const ts = d.toLocaleString();
      const msg = escape(l.msg || l.type || 'action');
      return `<div class="ts-log-item"><div class=\"ts\">${ts}</div><div class=\"meta\">${msg}</div></div>`;
    }).join('');
    wrap.innerHTML = out || '<div class="help">Aucun log.</div>';
    wrap.scrollTop = wrap.scrollHeight;
  }
  
  // ---------- State diff helpers for precise logs ----------
  const deepClone = (v)=>{
    try{ return JSON.parse(JSON.stringify(v)); }catch(e){ return null; }
  };
  let __prevState = null;

  function pathMatchesDiscipline(pathStr){
    return /(palet|darts|ping|score)/i.test(pathStr);
  }
  function labelFromPath(pathArr){
    try{
      const pathStr = pathArr.join('.');
      const tIdx = pathArr.findIndex(p=>/^team(Id|id|tid)$/i.test(p));
      let team = null;
      if(tIdx!==-1){
        const tid = pathArr[tIdx+1];
        team = teamNameById(tid);
      }
      const disc = pathArr.find(p=>/palet|darts|ping/i.test(p)) || 'score';
      let base = team ? `Équipe ${team}` : 'Score';
      return `${base} ${disc}`;
    }catch(e){
      return 'Score';
    }
  }

  function walkDiff(a, b, cb, path=[]){
    if(a===b) return;
    const ta = Object.prototype.toString.call(a);
    const tb = Object.prototype.toString.call(b);
    if(ta!==tb){ cb(path, a, b); return; }
    if(typeof a!=='object' || a===null || b===null){
      cb(path, a, b); return;
    }
    const keys = new Set([...(Array.isArray(a)? Object.keys(a): Object.keys(a||{})), ...(Array.isArray(b)? Object.keys(b): Object.keys(b||{}))]);
    for(const k of keys){
      const ka = a ? a[k] : undefined;
      const kb = b ? b[k] : undefined;
      if(typeof ka==='undefined' && typeof kb==='undefined') continue;
      walkDiff(ka, kb, cb, path.concat(String(k)));
    }
  }

  function summarizeChanges(prevS, nextS){
    const out = [];

    // Team renames
    try{
      const prevTeams = Array.isArray((prevS && Array.isArray(prevS.teams) ? prevS.teams : []))? prevS.teams: [];
      const nextTeams = Array.isArray((nextS && Array.isArray(nextS.teams) ? nextS.teams : []))? nextS.teams: [];
      const byKey=function(arr){
      return Object.fromEntries(arr.map(function(t){
        var key = (t && (t.id!=null ? t.id : (t.tid!=null ? t.tid : ((t.name||t.n)||''))));
        return [String(key), t];
      }));
    };
      const A = byKey(prevTeams), B = byKey(nextTeams);
      for(const k of Object.keys(B)){
        if(A[k] && (A[k].name||A[k].n) !== (B[k].name||B[k].n)){
          out.push({type:'team_rename', data:{oldName:(A[k].name||A[k].n), newName:(B[k].name||B[k].n)}});
        }
      }
    }catch(e){}

    // Numeric score-ish changes
    try{
      walkDiff(prevS, nextS, (path, a, b)=>{
        if(a===b) return;
        const bothNum = (typeof a==='number' && typeof b==='number');
        const bothShortStr = (typeof a==='string' && typeof b==='string' && a.length<=3 && b.length<=3);
        const pathStr = path.join('.');
        if((bothNum || bothShortStr) && pathMatchesDiscipline(pathStr)){
          out.push({type:'score_update', data:{path: pathStr, label: labelFromPath(path), from: a, to: b}});
        }
      });
    }catch(e){}

    return out;
  }

  renderList();
  window.logEvent = async function(type, data){
    // masquer les types techniques si pas de message lisible
    var technical = { 'saveState':1, 'pushCloud':1, 'ui_click':1 };
    var message = describeAction(type, data);
    if (message === null || technical[type]) {
      // ne rien afficher si pas de message humain
      // (mais on peut toujours pousser en cloud si besoin plus tard)
      return null;
    }
    const entry = {
      ts: Date.now(),
      who: (window.session && (window.session.claims && Object.keys(window.session.claims).length ? Object.keys(window.session.claims).join(',') : (window.session.admin? 'admin':'visiteur'))) || (document.getElementById('whoami-top') && document.getElementById('whoami-top').textContent) || 'visiteur',
      type: type || 'event',
      path: location.pathname + location.search,
      data: (data === undefined ? null : data),
      msg: message
    };
    logs.push(entry); saveLocal(); renderList();
    try{ var ref = firebaseRef(); if(ref){ await writeFirebase(entry); } }catch(e){}
    return entry;
  };

  // Open/close modal wiring — button lives in Admin card now
  const modal = id('ts-log-modal');
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('btn-open-logs');
    if (btn) {
      btn.addEventListener('click', function(){
        modal.classList.add('show');
        modal.setAttribute('aria-hidden','false');
        renderList();
      });
    }
  });
  document.addEventListener('click', function(e){
    var target = e.target;
    if (target && target.id === 'ts-close') {
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
    }
  });
  if(id('ts-clear-local')) id('ts-clear-local').addEventListener('click', ()=>{ if(!confirm('Effacer les logs locaux ?')) return; logs=[]; saveLocal(); renderList(); });
  if(id('ts-download')) id('ts-download').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(logs, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'trisports-logs-'+(new Date()).toISOString().replace(/[:.]/g,'-')+'.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  (function attachFirebaseListener(){
    try{
      const ref = firebaseRef(); if(!ref) return;
      ref.limitToLast(200).on('child_added', snap=>{
        const v = snap.val(); if(!v) return;
        logs.push(v); saveLocal(); renderList();
      });
    }catch(e){}
  })();

  // Listen to custom events
  document.addEventListener('app:action', function(e){
    try{ window.logEvent(e.detail?.type || 'custom', e.detail?.data || null); }catch(_){}
  });

  // Intercept key UI buttons -> map to simplified types
  document.addEventListener('click', function(ev){
    try{
      const q = (sel)=>ev.target.closest && ev.target.closest(sel);
      if(q('#btn-admin-on')) return window.logEvent('admin_on');
      if(q('#btn-admin-off')) return window.logEvent('admin_off');
      if(q('#btn-start-round')) return window.logEvent('round_start');
      if(q('#btn-end-round')) return window.logEvent('round_end');
      if(q('#btn-import')) return window.logEvent('import');
      if(q('#btn-export')) return window.logEvent('export');
      if(q('#btn-cloud-delete')) return window.logEvent('cloud_delete');
      // generic
      const btn = q('[data-act]') || q('[data-clear]');
      if(btn){
        const act = btn.getAttribute('data-act') || btn.getAttribute('data-clear') || btn.id || btn.dataset.act;
        const meta = { id: btn.dataset.id || btn.getAttribute('data-id') || null, text: (btn.textContent||'').trim() };
        return window.logEvent('ui_click', { action: act, meta });
      }
    }catch(e){}
  }, true);

  // Monkey patches -> simplified types
  function maybeWrap(name, wrapper){
    try{
      if(typeof window[name] === 'function'){
        const orig = window[name];
        window[name] = function(...args){
          try{ wrapper.apply(this, args); }catch(_){}
          return orig.apply(this, args);
        };
      }
    }catch(e){}
  }
  maybeWrap('saveState', function(){
    try{
      const prev = __prevState ?? deepClone(window.state);
      // Wait a tick to let state actually change (in case original mutates after call)
      setTimeout(()=>{
        try{
          const next = deepClone(window.state);
          const changes = summarizeChanges(prev, next);
          if(changes.length){
            changes.forEach(ch => window.logEvent(ch.type, ch.data));
          }else{
            // fallback minimal
            window.logEvent('saveState', { teams: (window.state && state.teams && state.teams.length) || 0 });
          }
          __prevState = deepClone(window.state);
        }catch(e){}
      }, 0);
    }catch(_){}
  });
  maybeWrap('pushCloud', function(immediate){
    try{ window.logEvent('pushCloud', { immediate: !!immediate, cloudId: (window.state && (state.cloudId||null)) || null }); }catch(_){}
  });
  maybeWrap('setBonusSelection', function(round, tid, sel){
    try{ window.logEvent('bonus_selection', { round, team: tid, sel }); }catch(_){}
  });
  maybeWrap('clearMatch', function(mid){
    try{ window.logEvent('clear_match', { matchId: mid }); }catch(_){}
  });

  // Helpers to log from app with friendly types
  window.emitAppLog = (type, data) => document.dispatchEvent(new CustomEvent('app:action',{detail:{type, data}}));
  window.logTeamRename = (oldName, newName)=>window.logEvent('team_rename', {oldName, newName});
  window.logScoreUpdate = (team, discipline, value)=>window.logEvent('score_update', {team, discipline, value});

  renderList();
})();
</script>
<!-- END: Simple action logger -->
<style id="bonus-boost-style">
/* === Bonus posé — visibles UNIQUEMENT pour la journée en cours (chip .yellow) === */
/* On cible les pilules rendues AVANT la fin de journée :
   - '.pill.pill--blue' (aperçu sans valeur)
   ET seulement quand l'en-tête de la journée a le badge .round-chip.yellow
   -> .round-head:has(.round-chip.yellow) + .round-grid ...
*/
.round-head:has(.round-chip.yellow) + .round-grid .pill.pill--blue{
  position: relative;
  color: #f7fbff !important;
  background: linear-gradient(135deg, rgb(35,153,242) 0%, rgb(28,107,224) 100%) !important;
  border: 1px solid rgba(35,153,242,.55) !important;
  text-shadow: 0 0 2px rgba(28,107,224,.35);
  box-shadow:
    0 0 6px rgba(35,153,242,.24),
    0 0 18px rgba(35,153,242,.18),
    inset 0 0 6px rgba(255,255,255,.06) !important;
  animation: neonPulseBlue 1.5s ease-in-out infinite;
}
.round-head:has(.round-chip.yellow) + .round-grid .pill.pill--blue::before{
  content: "";
  position: absolute;
  inset: -6px;
  border-radius: 999px;
  pointer-events: none;
  box-shadow:
    0 0 0 0 rgba(35,153,242,.45),
    0 0 22px rgba(35,153,242,.28);
  animation: neonHaloBlue 1.4s ease-in-out infinite;
  opacity: .7;
}
.round-head:has(.round-chip.yellow) + .round-grid .pill.pill--blue::after{
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  background: radial-gradient(circle at 18% -10%, rgba(255,255,255,.18), transparent 35%);
  pointer-events: none;
}

@keyframes neonPulseBlue{
  0%, 100%{ filter: brightness(1); }
  50%{ filter: brightness(1.08); }
}
@keyframes neonHaloBlue{
  0%{ transform: scale(1); opacity:.6; box-shadow: 0 0 0 0 rgba(35,153,242,.45), 0 0 20px rgba(35,153,242,.25); }
  70%{ transform: scale(1.18); opacity:0; box-shadow: 0 0 0 12px rgba(35,153,242,0), 0 0 28px rgba(35,153,242,.08); }
  100%{ transform: scale(1); opacity:0; }
}
@media (prefers-reduced-motion: reduce){
  .round-head:has(.round-chip.yellow) + .round-grid .pill.pill--blue{ animation: none !important; }
  .round-head:has(.round-chip.yellow) + .round-grid .pill.pill--blue::before{ animation: none !important; opacity: .4; }
}
</style>


<!-- Injected by ChatGPT: Password modal + masked input + action interceptors (v2) -->
<style>
  #pw-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:2147483646;background:rgba(0,0,0,.45)}
  #pw-modal.show{display:flex}
  #pw-panel{width:min(520px,92vw);background:var(--card,#111);border:1px solid rgba(255,255,255,.08);padding:14px 14px 12px;border-radius:12px;box-shadow:0 18px 48px rgba(0,0,0,.5);color:var(--text,#fff);font-family:inherit}
  #pw-panel .hd{font-weight:700;margin-bottom:8px}
  #pw-panel .controls{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  #pw-panel input[type="password"]{width:100%;padding:10px 40px 10px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:transparent;color:inherit}
  #pw-panel .btn{padding:8px 12px;border-radius:10px;cursor:pointer}
  #pw-panel .btn.cancel{background:transparent;border:1px solid rgba(255,255,255,.16);color:inherit}
  #pw-panel .btn.ok{background:linear-gradient(180deg,#2f3da2,#25337d);border:1px solid #3a4aa0;color:#fff}
</style>
<div id="pw-modal" aria-hidden="true">
  <div id="pw-panel" role="dialog" aria-modal="true" aria-label="Saisie du mot de passe">
    <div class="hd" id="pw-title">Mot de passe</div>
    <div>
      <div class="pw-input-wrap" style="position:relative;"><input id="pw-input" type="password" autocomplete="current-password" placeholder="Tapez le mot de passe…" aria-label="Mot de passe"/><button id="pw-toggle" type="button" aria-label="Afficher le mot de passe" title="Afficher le mot de passe" style="position:absolute;right:6px;top:50%;transform:translateY(-50%);border:none;background:transparent;padding:6px;cursor:pointer;font-size:16px;line-height:1;">👁️</button></div>
      <!-- <div class="help" style="margin-top:6px;font-size:12px;opacity:.8"><em>La saisie est masquée.</em></div> -->
    </div>
    <div class="controls">
      <button class="btn cancel" id="pw-cancel" type="button">Annuler</button>
      <button class="btn ok" id="pw-ok" type="button">Valider</button>
    </div>
  </div>
</div>
<script>
(function(){
  const modal = document.getElementById('pw-modal');
  const input = document.getElementById('pw-input');
  const title = document.getElementById('pw-title');
  let resolver = null;
  function openModal(label){
    title.textContent = label || 'Mot de passe';
    input.value = '';
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
    setTimeout(()=>input.focus(), 30);
    document.addEventListener('keydown', onKey);
  }
  function closeModal(){
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', onKey);
  }
  function onKey(e){
    if(e.key === 'Escape'){ closeModal(); if(resolver){ const r=resolver; resolver=null; r(null); } }
    if(e.key === 'Enter'){ e.preventDefault(); document.getElementById('pw-ok').click(); }
  }
  document.getElementById('pw-cancel').addEventListener('click', ()=>{ closeModal(); if(resolver){ const r=resolver; resolver=null; r(null); } });
  document.getElementById('pw-ok').addEventListener('click', ()=>{ const v = input.value.trim(); closeModal(); if(resolver){ const r=resolver; resolver=null; r(v||null); } });


  // Toggle show/hide password eye button
  (function(){
    const toggleBtn = document.getElementById('pw-toggle');
    const pwInput = document.getElementById('pw-input');
    if(toggleBtn && pwInput){
      toggleBtn.addEventListener('click', function(e){
        e.preventDefault();
        if(pwInput.type === 'password'){
          pwInput.type = 'text';
          toggleBtn.setAttribute('aria-label','Masquer le mot de passe');
          toggleBtn.title = 'Masquer le mot de passe';
          toggleBtn.textContent = '🙈';
        } else {
          pwInput.type = 'password';
          toggleBtn.setAttribute('aria-label','Afficher le mot de passe');
          toggleBtn.title = 'Afficher le mot de passe';
          toggleBtn.textContent = '👁️';
        }
        setTimeout(()=>pwInput.focus(),0);
      });
      // Prevent focus loss when clicking the toggle in some browsers
      toggleBtn.addEventListener('mousedown', function(e){ e.preventDefault(); });
    }
  })();
  // Expose a helper
  window.askPassword = function askPassword(label){
    return new Promise(resolve=>{ resolver = resolve; openModal(label); });
  };

  
  // === Admin PIN via masked modal ===
  const ADMIN_PIN = (typeof window.ADMIN_PIN !== 'undefined') ? String(window.ADMIN_PIN) : '30041991';

  let _adminReclick = false;
  document.addEventListener('click', async function(ev){
    const btn = ev.target.closest && ev.target.closest('button');
    if(!btn) return;

    // Handle the explicit "enable admin" buttons
    if(btn.id === 'btn-admin-on-setup' || btn.id === 'btn-admin-on'){
      ev.stopImmediatePropagation();
      ev.preventDefault();
      const pin = await askPassword('PIN administrateur :');
      if(pin===null) return;
      if(String(pin) === ADMIN_PIN){
        session.admin = true;
        session.claims = {};
        updateWho(); renderAll();
        showToast("Mode administrateur activé (déverrouillage sur cet appareil).");
      } else {
        showToast("PIN incorrect.");
      }
      return;
    }

    // For flows that ask for admin PIN only when not admin (e.g. btn-create-tournament),
    // we pre-empt the default handler if not admin, ask PIN, then re-click once.
    if(btn.id === 'btn-create-tournament' && !isAdmin()){
      ev.stopImmediatePropagation();
      ev.preventDefault();
      const pin = await askPassword('PIN administrateur :');
      if(pin===null) return;
      if(String(pin) === ADMIN_PIN){
        session.admin = true;
        session.claims = {};
        updateWho(); renderAll();
        // re-dispatch the click once to continue normal flow
        if(!_adminReclick){
          _adminReclick = true;
          setTimeout(()=>{ btn.click(); _adminReclick = false; }, 0);
        }
      } else {
        showToast("PIN incorrect.");
      }
      return;
    }
  }, true);

  // Intercept clicks for setpass / login to replace native prompt by masked modal
  document.addEventListener('click', async function(ev){
    const btn = ev.target.closest && ev.target.closest('[data-act]');
    if(!btn) return;

    const act = btn.getAttribute('data-act');
    if(act !== 'setpass' && act !== 'login') return;

    // Prevent the app's default handler from running
    ev.stopImmediatePropagation();
    ev.preventDefault();

    const tid = btn.getAttribute('data-id');

    // SET PASSWORD flow (admin only)
    if(act === 'setpass'){
      if(!isAdmin()){ showToast("Réservé à l’administrateur."); return; }
      const pass = await askPassword("Mot de passe pour l'équipe « "+ teamName(tid) +" » :");
      if(pass==null || pass===''){ return; }
      try{
        state.protect = state.protect || {};
        state.protect.teamPassHash = state.protect.teamPassHash || {};
        state.protect.teamPassHash[tid] = hashPass(pass);
        saveState(); renderTeams();
        showToast("Mot de passe défini.");
      }catch(e){
        console.error(e); showToast("Erreur lors de l’enregistrement du mot de passe.");
      }
      return;
    }

    // LOGIN flow
    if(act === 'login'){
      try{
        const hashes = (state && state.protect && state.protect.teamPassHash) ? state.protect.teamPassHash : null;
        if(!hashes || !hashes[tid]){ showToast("Cette équipe n’a pas encore de mot de passe (demandez à l’admin)."); return; }
        const pass = await askPassword("Mot de passe pour l'équipe « "+ teamName(tid) +" » :");
        if(pass==null){ return; }
        if(hashPass(pass) === hashes[tid]){ session.claims = {}; session.claims[tid] = true; session.admin = false;
          updateWho(); renderAll();
          showToast("Connexion réussie. Mode admin désactivé sur cet appareil.");
        }else{
          showToast("Mot de passe incorrect.");
        }
      }catch(e){
        console.error(e); showToast("Erreur de connexion.");
      }
      return;
    }
  }, true); // capture phase to pre-empt the app handler

})();
</script>


<script>
document.addEventListener('click', function(e){
  const t = e.target; if (t && t.id === 'btn-export-pdf'){ try{ exportSummaryPDF(); } catch(err){ console.error(err); alert('Échec de l’export PDF.'); } }
});
function exportSummaryPDF(){
try{window.renderMatches&&window.renderMatches();}catch(_){};try{window.renderLeaderboard&&window.renderLeaderboard();}catch(_){};
const srcTable=document.getElementById('table-classement');let rows=[];if(srcTable&&srcTable.tBodies&&srcTable.tBodies[0]){Array.from(srcTable.tBodies[0].rows).forEach(tr=>{const vals=Array.from(tr.cells||[]).map(td=>(td.innerText||'').replace(/\s+/g,' ').trim());if(vals.join('').trim())rows.push(vals);});}
const headers=['#','Équipe','Pts','Fléchettes','Ping-pong','Palet (PF–PA)','Bonus','Malus','Matchs'];
const compact=(()=>{let th='<thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead>';let tb='<tbody>';rows.forEach(r=>{const v=r.slice(0,headers.length);tb+='<tr>'+v.map((x,i)=>`<td${i===1?' style="text-align:left"':''}>${escapeHtml(x)}</td>`).join('')+'</tr>';});tb+='</tbody>';return `<table class="compact">${th}${tb}</table>`;})();
function teamName(id){try{const t=(window.state&&Array.isArray(state.teams))?state.teams.find(x=>x.id===id):null;return t?(t.name||t.title||t.label||''):String(id||'');}catch(_){return String(id||'');}}
function palW(a,b){const T=+((window.state&&state.rules&&state.rules.paletTarget)??11);if(a==null||b==null)return null;if(a>=T&&a>b)return'A';if(b>=T&&b>a)return'B';return null;}
function matchesFromState(){const out=[];const ms=(window.state&&Array.isArray(state.matches))?state.matches.slice():[];ms.sort((x,y)=>(x.round-y.round)||(x.order-y.order)||((x.id>y.id)?1:-1));ms.forEach(m=>{if(!m)return;const A=teamName(m.a),B=teamName(m.b);let dA=0,dB=0;Array.isArray(m.darts)&&m.darts.forEach(v=>{if(v===0)dA++;else if(v===1)dB++;});let pA=0,pB=0;const P=Array.isArray(m.pingPts)?m.pingPts:[];const ok=(a,b)=>{const max=Math.max(a,b),diff=Math.abs(a-b);return(max>=11)&&(diff>=2)};P.forEach(s=>{const a=(s&&s.a!=null)?+s.a:null,b=(s&&s.b!=null)?+s.b:null;if(!ok(a,b))return;if(a>b)pA++;else if(b>a)pB++;});let lA=null,lB=null;if(m.palet&&m.palet.a!=null&&m.palet.b!=null){lA=+m.palet.a;lB=+m.palet.b;}let gA=0,gB=0;if(dA>dB)gA++;else if(dB>dA)gB++;if(pA>pB)gA++;else if(pB>pA)gB++;const w=palW(lA,lB);if(w==='A')gA++;else if(w==='B')gB++;const det=['Fléchettes '+dA+'–'+dB,'Ping-pong '+pA+'–'+pB];if(lA!=null&&lB!=null)det.push('Palet '+lA+'–'+lB);out.push({round:(m.round!=null)?m.round:'',nameA:A,nameB:B,details:det.join(' · '),global:`${gA}–${gB}`});});return out;}
function matchesFromCards(){const items=[];document.querySelectorAll('#match-list .match-card').forEach(card=>{const r=(card.querySelector('.round-chip')?.textContent||'').trim().replace('#','');const A=(card.querySelector('.team.left .name')?.textContent||'').trim();const B=(card.querySelector('.team.right .name')?.textContent||'').trim();const chips=Array.from(card.querySelectorAll('.sports-row .chip .score-compact')).map(el=>(el.textContent||'').trim());const d=chips[0]||'',p=chips[1]||'',l=chips[2]||'';const parts=[];if(d)parts.push('Fléchettes '+d);if(p)parts.push('Ping-pong '+p);if(l)parts.push('Palet '+l);const det=parts.join(' · ');const big=(card.querySelector('.score-big, .score')?.textContent||'').trim();const glob=(/\d+\s*[–-]\s*\d+/.test(big)?big.match(/\d+\s*[–-]\s*\d+/)[0].replace(/\s+/g,''):'');items.push({round:r,nameA:A,nameB:B,details:det,global:glob});});return items;}
let items=matchesFromState();if(!items.length){try{window.renderMatches&&window.renderMatches();}catch(_){}items=matchesFromCards();}
function buildTable(it){if(!it.length)return'';let h='<table class="compact"><thead><tr><th>J</th><th>Équipe A</th><th></th><th>Équipe B</th><th>Détails</th><th>Score</th></tr></thead><tbody>';it.forEach(m=>{const det=(m.details||'').replace(/\s*·\s*/g,'<br>');h+='<tr>' + `<td style="text-align:center">${escapeHtml(String(m.round||''))}</td>` + `<td style="text-align:right">${escapeHtml(m.nameA||'')}</td>` + `<td style="text-align:center">–</td>` + `<td style="text-align:left">${escapeHtml(m.nameB||'')}</td>` + `<td class="details" style="text-align:left">${det}</td>` + `<td style="text-align:center">${escapeHtml(m.global||'')}</td>` + '</tr>';});h+='</tbody></table>';return h;}
const matchesHTML=buildTable(items);
const title=(window.state&&state.tournamentName)?state.tournamentName:'TriSports';const when=new Date().toLocaleString('fr-FR',{dateStyle:'medium',timeStyle:'short'});
const css=`<style>@page{size:A4;margin:10mm;}body{font:11px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111}h1{font-size:18px;margin:0 0 2mm}h2{font-size:14px;margin:8mm 0 3mm}.muted{color:#555;margin-bottom:4mm}table{width:100%;border-collapse:collapse}table.compact{table-layout:auto}table.compact th,table.compact td{border:1px solid #ddd;padding:4px 6px;text-align:center}table.compact th:nth-child(2),table.compact td:nth-child(2){text-align:left;max-width:160px}table.compact td:nth-child(5){text-align:left;white-space:normal}thead th{background:#f3f4f6}td,th{font-variant-numeric:tabular-nums}.section{break-inside:avoid}</style>`;
const html=`<!doctype html><html lang="fr"><head><meta charset="utf-8"/><title>Résumé — ${escapeHtml(title)}</title>${css}</head><body><h1>Résumé — ${escapeHtml(title)}</h1><div class="muted">Généré le ${escapeHtml(when)}</div><div class="section"><h2>Classement</h2>${compact}</div>${matchesHTML?`<div class="section"><h2>Détail des matchs</h2>${matchesHTML}</div>`:''}</body></html>`;
const blob=new Blob([html],{type:'text/html'});const url=URL.createObjectURL(blob);const f=document.createElement('iframe');f.style.position='fixed';f.style.right='0';f.style.bottom='0';f.style.width='0';f.style.height='0';f.style.border='0';f.src=url;f.onload=function(){try{setTimeout(function(){f.contentWindow&&f.contentWindow.focus();f.contentWindow&&f.contentWindow.print();URL.revokeObjectURL(url);setTimeout(function(){f.remove();},1000);},50);}catch(err){console.error(err);alert('Échec de l’impression.');}};document.body.appendChild(f);
function escapeHtml(s){return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
}
</script>
<script>
// Global fallback (au cas où l'insertion précédente serait dans une portée locale)
if (typeof window.pointsForTeamInSport !== 'function') {
  window.pointsForTeamInSport = function(m, tid, sport){
    try{
      if(!m || !tid) return 0;
      const isA = (m.a === tid);
      const s = (sport || 'darts');
      if (s === 'darts'){
        let aw=0, bw=0;
        const arr = Array.isArray(m.darts) ? m.darts : [];
        arr.forEach(v=>{ if(v===0) aw++; else if(v===1) bw++; });
        return (isA ? aw : bw) * 5;
      } else if (s === 'ping'){
        let aw=0, bw=0;
        const pts = (typeof getPingPts === 'function') ? (getPingPts(m) || []) : [];
        pts.forEach(scor=>{
          if(!scor) return;
          const a = (scor.a!=null) ? +scor.a : null;
          const b = (scor.b!=null) ? +scor.b : null;
          if (!isPingValid(a,b)) return;
          if (a>b) aw++; else if (b>a) bw++;
        });
        return (isA ? aw : bw) * 5;
      } else if (s === 'palet'){
        const pa = (m.palet && m.palet.a!=null) ? +m.palet.a : null;
        const pb = (m.palet && m.palet.b!=null) ? +m.palet.b : null;
        if (pa==null || pb==null) return 0;
        return isA ? pa : pb;
      }
      return 0;
    }catch(_){ return 0; }
  };
}
</script>
</body>
<style id="pretty-confirm-modal">
/* === Pretty Confirm Modal ============================================ */
#confirm-overlay{
  position: fixed; inset: 0; display: none; z-index: 9999;
  background: rgba(10,12,24,.55); -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
}
#confirm-overlay.show{ display: grid; place-items: center; }

.confirm-card{
  width: min(520px, 92vw);
  background: linear-gradient(180deg,#151b39,#121632);
  border: 1px solid #2b315f;
  border-radius: 16px;
  box-shadow: 0 18px 36px rgba(0,0,0,.45); /* keep existing shadow */
  color: #e7e9f7;
  transform: translateY(6px) scale(.98);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#confirm-overlay.show .confirm-card{
  transform: translateY(0) scale(1);
  opacity: 1;
}
.confirm-card .hd{ padding: 14px 16px; border-bottom: 1px solid #2b315f; font-weight: 800; display:flex; gap:10px; align-items:center; }
.confirm-card .bd{ padding: 16px; color: #cbd5ff; }
.confirm-card .ft{ padding: 12px 16px; border-top: 1px solid #2b315f; display:flex; gap:8px; justify-content: flex-end; }
.confirm-card .btn{ padding: 10px 14px; border-radius: 12px; }
.confirm-card .btn.primary{ background: linear-gradient(180deg,#2f3da2,#25337d); border-color:#3a4aa0; }
.confirm-card .btn.danger{ background: linear-gradient(180deg,#7a2b2b,#5c2222); border-color:#8a2b2b; }
.confirm-card .icon{ width: 22px; height: 22px; display:grid; place-items:center; font-size:18px; }
</style><style id="standings-points-emphasis">
/* === Classement: centré + pastille Points discrète + liserets groupés === */

/* Centre tout le tableau */
#table-classement thead th{ text-align:center; }
#table-classement tbody td{ text-align:center; }

/* Centre le contenu "Équipe" */
#table-classement tbody td:nth-child(2) .team-name{ justify-content:center; }

/* Pas de liserets dans l'en-tête */
#table-classement thead th{ border-right:none !important; border-left:none !important; }

/* Liserets groupés :
   - Sports : Fléchettes(4) | Ping(5) | Palet(6)
   - Bonus/Malus : Bonus(7) | Malus(8)
*/
#table-classement tbody td:nth-child(4){ border-left: 1px solid rgba(255,255,255,.10); }
#table-classement tbody td:nth-child(6){ border-right:1px solid rgba(255,255,255,.10); }
#table-classement tbody td:nth-child(7){ border-left: 1px solid rgba(255,255,255,.10); }
#table-classement tbody td:nth-child(8){ border-right:1px solid rgba(255,255,255,.10); }

/* Pastille discrète pour la colonne Points (col 3) */
#table-classement thead th:nth-child(3){ text-align:center; }
#table-classement tbody td:nth-child(3){ position:relative; font-weight:900; }

#table-classement tbody td:nth-child(3) > span.points-medal{
  display:inline-flex; align-items:center; justify-content:center;
  min-width:44px; height:30px; padding:0 10px; border-radius:999px;
  font-size:16px; font-weight:800; letter-spacing:.2px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.18);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.22); /* keep existing shadow */
}

/* Survol : très léger contraste */
#table-classement tbody tr:hover td:nth-child(3) > span.points-medal{
  background:rgba(255,255,255,.06);
  border-color:rgba(255,255,255,.22);
}

/* Mobile */
@media (max-width:520px){
  #table-classement tbody td:nth-child(3) > span.points-medal{
    min-width:40px; height:28px; padding:0 8px; font-size:15px;
  }
}
</style>

<style id="classement-tweaks">
  /* Align everything to the left in the classement table */
  #table-classement th,
  #table-classement td{ text-align:left; }

  /* Keep team row visuals but ensure left alignment with consistent spacing */
  #table-classement td:nth-child(2) .team-name{
    display:inline-flex; align-items:center; gap:8px;
    vertical-align:middle;
  }

  /* Bigger emojis in the rank column */
  #table-classement td:first-child{
    font-size:1.4em; /* larger only for emoji */
    line-height:1.1;
  }

  /* Points pill — more visible without changing base font size */
  #table-classement td.points-cell .points-pill{
    display:inline-block;
    padding:2px 10px;
    border-radius:9999px;
    background:#EEF2FF;          /* soft indigo */
    border:1px solid #C7D2FE;    /* indigo-200 */
    color:#1E3A8A;               /* indigo-900 */
    box-shadow:0 1px 0 rgba(30,58,138,.08), inset 0 0 0 1px rgba(255,255,255,.4);
  }
</style>



<style id="classement-align-left-and-strong-points-v2">
  /* 1) CLASSEMENT — tout à gauche, sauf le rang (#) que l’on garde centré */
  #table-classement thead th,
  #table-classement tbody td{
    text-align: left !important;
  }
  #table-classement tbody td:first-child{
    text-align: center !important; /* garde la colonne # centrée */
  }

  /* Équipe : avatar + nom alignés à gauche */
  #table-classement tbody td:nth-child(2) .team-name{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    justify-content: flex-start !important;
  }

  /* 2) POINTS — pastille bien plus visible */
  #table-classement thead th:nth-child(3){ text-align: left !important; }
  #table-classement tbody td:nth-child(3){ text-align: left !important; }

  #table-classement tbody td:nth-child(3) > span.points-medal{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 56px;
    height: 34px;
    padding: 0 12px;
    border-radius: 999px;
    font-size: 18px;
    font-weight: 900;
    letter-spacing: .3px;
    background: linear-gradient(180deg, #c9d6ff 0%, #a9bbff 100%);
    color: #0b1450;
    border: 1px solid #9ab4ff;
    box-shadow:
      0 4px 12px rgba(75,139,255,.25),
      inset 0 0 0 1px rgba(255,255,255,.6);
  }

  /* Mobile : réduit un peu la taille de la pastille */
  @media (max-width:520px){
    #table-classement tbody td:nth-child(3) > span.points-medal{
      min-width: 48px;
      height: 30px;
      padding: 0 10px;
      font-size: 16px;
    }
  }
</style>

<style id="classement-center-stats-cols">
  /* Garder ces colonnes centrées : fléchettes (4), ping-pong (5), palet (6), bonus (7), malus (8), matchs complets (9) */
  #table-classement thead th:nth-child(4),
  #table-classement thead th:nth-child(5),
  #table-classement thead th:nth-child(6),
  #table-classement thead th:nth-child(7),
  #table-classement thead th:nth-child(8),
  #table-classement thead th:nth-child(9),
  #table-classement tbody td:nth-child(4),
  #table-classement tbody td:nth-child(5),
  #table-classement tbody td:nth-child(6),
  #table-classement tbody td:nth-child(7),
  #table-classement tbody td:nth-child(8),
  #table-classement tbody td:nth-child(9) {
    text-align: center !important;
    justify-content: center !important;
  }
</style>



<style id="gta-tabs">
/* ===== Onglets style "GTA" — version blanche lisible =================== */
@import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');

.tab.gta{
  /* Nouvelle police + lisibilité */
  font-family: "Bangers","Impact","Arial Black",system-ui,sans-serif;
  text-transform: uppercase;
  letter-spacing: .6px;
  font-weight: 900;
  font-size: 16px;

  /* Capsule blanche à contour noir */
  border-radius: 999px;
  padding: 9px 17px;
  background: #ffffff;
  color: #111111;
  border: 3px solid #000000;

  /* Ombres très légères pour le relief, sans altérer le contraste */
  box-shadow:
    0 2px 0 rgba(0,0,0,.35),
    0 8px 18px rgba(0,0,0,.18);
  transition: transform .06s ease, box-shadow .18s ease, background .18s ease, filter .18s ease;
}
.tab.gta:hover{
  transform: translateY(-1px);
  background: #fefefe;
  box-shadow:
    0 3px 0 rgba(0,0,0,.38),
    0 12px 22px rgba(0,0,0,.22);
}
.tab.gta:active{
  transform: translateY(0);
  box-shadow:
    0 2px 0 rgba(0,0,0,.35),
    0 8px 16px rgba(0,0,0,.20);
}

/* Onglet actif : léger halo bleu mais fond reste blanc */
.tab.gta[aria-selected="true"]{
  background: #ffffff;
  box-shadow:
    0 3px 0 rgba(0,0,0,.38),
    0 0 0 3px rgba(59,130,246,.18),
    0 14px 28px rgba(59,130,246,.22);
}

/* Petits boutons/puces à droite du header */
.header-chip.gta{
  font-family: "Bangers","Impact","Arial Black",system-ui,sans-serif;
  text-transform: uppercase;
  font-weight: 900;
  font-size: 14px;

  border-radius: 999px;
  padding: 8px 14px;
  background: #ffffff;
  color: #111111 !important;
  border: 3px solid #000000;
  box-shadow: 0 2px 0 rgba(0,0,0,.35), 0 8px 18px rgba(0,0,0,.18);
  transition: transform .06s ease, box-shadow .18s ease, background .18s ease;
}
.header-chip.gta:hover{
  transform: translateY(-1px);
  background: #fefefe;
  box-shadow: 0 3px 0 rgba(0,0,0,.38), 0 12px 22px rgba(0,0,0,.22);
}

@media (prefers-reduced-motion: reduce){
  .tab.gta, .header-chip.gta{ transition: none; }
}
</style>








<style id="gta-selected-and-classement-dark">
:root{
  /* Rouge-violet désaturé (crimson violet) */
  --gta-active: #c03a8f;        /* crimson-violet */
  --gta-active-strong: #8a2cab; /* purple-lean */
}

/* === GTA tabs — actif crimson-violet + transparence accrue ============ */
.tab.gta[aria-selected="true"]{
  background: linear-gradient(
    180deg,
    rgba(192, 58, 143, .70),
    rgba(138, 44, 171, .70)
  );
  color: #ffffff;
  -webkit-text-fill-color: #ffffff;
  border-color: #000000;
  box-shadow:
    0 2px 0 rgba(0,0,0,.32),
    0 0 0 2px rgba(0,0,0,.12) inset,
    0 10px 18px rgba(192,58,143,.18);
  backdrop-filter: saturate(105%) blur(2px);
}
.tab.gta[aria-selected="true"]:hover{
  background: linear-gradient(
    180deg,
    rgba(192, 58, 143, .78),
    rgba(138, 44, 171, .78)
  );
}

/* === Fonds "noir translucide" — partout (inchangés) ==================== */
.card,
.match-card{
  background: rgba(8, 10, 16, .62) !important;
  border-color: rgba(26, 28, 34, .75) !important;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
  backdrop-filter: blur(6px) saturate(110%);
}
.card .hd,
.match-card .hd{
  background: transparent !important;
  border-bottom-color: rgba(26,28,34,.75) !important;
}
.card table thead th{
  background: rgba(10,12,18,.66) !important;
  border-bottom-color: rgba(26,28,34,.75) !important;
  backdrop-filter: blur(6px) saturate(110%);
}
.card table tbody tr{
  background: rgba(10,12,18,.58) !important;
  box-shadow: 0 1px 0 rgba(0,0,0,.25) inset, 0 0 0 1px rgba(255,255,255,.02);
}
#table-classement tbody tr:nth-child(1){ box-shadow: inset 4px 0 0 0 rgba(212,175,55,.9), 0 1px 0 rgba(0,0,0,.25) inset, 0 0 0 1px rgba(255,255,255,.02); }
#table-classement tbody tr:nth-child(2){ box-shadow: inset 4px 0 0 0 rgba(192,192,192,.9), 0 1px 0 rgba(0,0,0,.25) inset, 0 0 0 1px rgba(255,255,255,.02); }
#table-classement tbody tr:nth-child(3){ box-shadow: inset 4px 0 0 0 rgba(205,127,50,.9), 0 1px 0 rgba(0,0,0,.25) inset, 0 0 0 1px rgba(255,255,255,.02); }
</style>





</head></html>
<style id="rencontres-polish">
/* Card container */
.matches, .calendar, .journees, .games { gap: 20px; }
.scorewrap, .match, .match-card {
  background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px;
  padding: 14px 16px;
  box-shadow: 0 4px 18px rgba(0,0,0,.25); /* keep existing shadow */
}

/* Header line */
.scorewrap .teams-row{
  grid-template-columns: 1.2fr auto 1.2fr !important;
  gap: 20px !important;
}

/* Team cell */
.scorewrap .team{ gap: 12px !important; }
.scorewrap .team .avatar, .scorewrap .team .avatar img{
  width: 56px !important; height: 56px !important; border-radius: 50%;
}

/* Team name */
.scorewrap .team .name{ font-size: 20px; font-weight: 700; line-height: 1.1; }

/* Score core */
.scorewrap .score{
  font-weight: 900 !important;
  font-size: 36px !important;
  letter-spacing: 2px;
  min-width: 120px;
}

/* Little sport pills below */
.scorewrap .meta, .scorewrap .sub {
  display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;
}
.scorewrap .pill{
  padding: 4px 8px !important;
  font-size: 12px !important;
  opacity: .95;
  border-radius: 999px !important;
  box-shadow: 0 0 0 1px rgba(255,255,255,.08) inset; /* keep existing shadow */
}

/* Action row (play / expand) */
.scorewrap .actions{ display:flex; align-items:center; gap:10px; margin-top:8px; }
.scorewrap .actions .btn, .scorewrap .actions button{
  border-radius: 999px;
}

/* Collapsed details panel */
.scorewrap [aria-expanded="true"] + .details,
.match-card[aria-expanded="true"] .details {
  max-height: 600px; transition: max-height .35s ease;
}
.scorewrap [aria-expanded="false"] + .details,
.match-card[aria-expanded="false"] .details {
  max-height: 0; overflow: hidden; transition: max-height .25s ease;
}

/* Hover polish */
.scorewrap:hover{ transform: translateY(-1px); transition: transform .15s ease; }
</style>
<style id="score-entry-compact">
/* Chip état Complet/Incomplet */
.state-chip{font-weight:700;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);}
.state-chip.ok{background:rgba(67,200,89,.15);box-shadow:0 0 0 1px rgba(67,200,89,.25) inset}
.state-chip.warn{background:rgba(255,170,25,.12); /* keep existing shadow */box-shadow:0 0 0 1px rgba(255,170,25,.25) inset}

/* Bandeau de saisie (plus compact) */
.match-two-col{display:grid; /* keep existing shadow */grid-template-columns:1fr 1fr;gap:12px}
.sport-group{background:transparent;border:0;padding:0;margin:0}
.sport-title{font-size:13px;font-weight:700;margin:0 0 6px 0;opacity:.9}
.sport-item{display:grid;grid-template-columns:auto 1fr;align-items:center;gap:8px;margin:4px 0}
.sport-item label{font-size:12px;opacity:.9;white-space:nowrap}
.sport-item select,.sport-item input{height:30px;padding:0 8px;border-radius:10px}

/* Palet ligne compacte */
.palet-inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.palet-inline input{width:52px;text-align:center}

/* Réduire les marges globales du panneau */
.match-card .bd{padding:8px 10px}
</style>
<style id="round-head-style">
.round-head{display:flex;align-items:center;gap:10px;margin:18px 0 10px 0;padding-top:8px;border-top:1px solid rgba(255,255,255,.08)}
.round-head .round-title{font-weight:700;font-size:18px}
/* Séparation visuelle forte entre journées */
.round-grid{margin-bottom:26px;padding-bottom:8px}
/* Masquer la pastille #n dans chaque match (on ne la veut qu'en tête de journée) */
.scorewrap .left-rail .round-chip{display:none !important;}
</style>
<style id="round-grid-divider-and-names">
/* Filet vertical entre les 2 colonnes */
.round-grid{ position:relative; }
.round-grid::before{
  content:"";
  position:absolute; top:0; bottom:0; left:50%;
  width:1px;
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.08), rgba(255,255,255,.04));
  transform: translateX(-0.5px);
  pointer-events:none;
}
@media (max-width: 900px){
  .round-grid::before{ display:none; }
}

/* Noms d'équipe adaptatifs + ellipsis */
.scorewrap .team{ min-width:0; }
.scorewrap .team .name{
  font-size: clamp(14px, 2vw, 18px);  /* s’adapte selon la largeur */
  max-width: 12ch;                    /* borne pour éviter les débordements */
  white-space: nowrap; max-width: calc(100vw - 32px);
  overflow: hidden;
  text-overflow: ellipsis;
}
/* Si l’espace est plus large (grand écran), autoriser un peu plus */
@media (min-width: 1400px){
  .scorewrap .team .name{ max-width: 16ch; font-size: clamp(14px, 1.6vw, 20px); }
}
</style>
<style id="match-cards-equalized">
/* === 1) Tailles identiques des cartes par ligne === */
.round-grid{
  /* chaque ligne prend la hauteur du match le plus grand */
  grid-auto-rows: 1fr;
  align-items: stretch;
}
.round-grid .match-card{
  height: 100%;
  display: flex;
  flex-direction: column;
}
.round-grid .match-card .hd{ /* en-tête */
  padding-bottom: 10px;
}
.round-grid .match-card .bd{ /* contenu extensible */
  margin-top: auto;   /* pousse le bas pour équilibrer */
}

/* === 2) Pilule Complet/Incomplet ne chevauche pas les scores des sports === */
.scorewrap .state-chip{
  display: inline-block;
  margin-top: 10px;   /* sous la ligne des pastilles de sports */
}
/* assure une vraie ligne pour les pastilles sport -> puis la pilule état sous la ligne */
.scorewrap .meta, .scorewrap .sub{
  margin-bottom: 2px;
}

/* === 3) Densifier l'espacement entre journées === */
.round-head{ margin: 4px 0 6px 0; padding-top: 4px; }
.round-grid{ margin-bottom: 4px; padding-bottom: 4px; }
</style>
<style id="match-cards-equal-width">
/* Forcer des largeurs identiques pour chaque carte dans la grille */
.round-grid{
  grid-template-columns: repeat(2, minmax(0, 1fr));
}
.round-grid > .match-card{
  width: 100%;
  min-width: 0;           /* évite que du contenu force la colonne */
  margin: 0 !important;   /* pas de marge parasite */
  box-sizing: border-box;
}
/* s'assurer que le contenu interne ne crée pas une largeur différente */
.round-grid > .match-card .scorewrap{
  width: 100%;
  box-sizing: border-box;
}
/* Mobile: 1 colonne = pleine largeur */
@media (max-width: 900px){
  .round-grid{ grid-template-columns: 1fr; }
}
</style>
<style id="bonus-flashy-pill">
.pill.bonus-flashy{
  background: linear-gradient(180deg, rgba(80,180,255,.25), rgba(80,180,255,.15));
  border: 1px solid rgba(120,200,255,.45);
  box-shadow: 0 6px 18px rgba(0,120,255,.25), 0 0 0 1px rgba(0,120,255,.25) inset; /* keep existing shadow */
  font-weight: 800;
}
.pill.bonus-flashy .pos{ color: #5CF08A; font-weight: 800; margin-left: 6px; }
.pill.bonus-flashy .neg{ color: #FF6B6B; font-weight: 800; margin-left: 6px; }
.pill.bonus-flashy .mini-bonus{ width: 18px; height: 18px; border-radius: 50%; overflow: hidden; vertical-align: -3px; margin-left: 6px; }
.pill.bonus-flashy:hover{ filter: brightness(1.1); box-shadow: 0 8px 22px rgba(0,140,255,.35), 0 0 0 1px rgba(120,200,255,.6) inset; /* keep existing shadow */ }
</style>
<style id="equal-visual-heights">
.scorewrap .teams-row{ align-items:center; min-height: 84px; }
.scorewrap .score{ font-size: clamp(28px, 3.2vw, 34px) !important; line-height:1; }
.scorewrap .team .name{ font-size: clamp(15px, 1.4vw, 18px); }
</style>
<style id="bonus-flashy-anim-tooltip">
/* Pop-in animation */
@keyframes bonusPop { 
  0% { transform: scale(.85); opacity: .0; filter: saturate(0.8) blur(.2px); } 
  60% { transform: scale(1.04); opacity: 1; } 
  100% { transform: scale(1); opacity: 1; } 
}
.pill.bonus-flashy{ animation: bonusPop .26s ease-out; position: relative; z-index: 0; }

/* Color variants */
.pill.bonus-flashy.pos{
  background: linear-gradient(180deg, rgba(40,200,120,.22), rgba(40,200,120,.14));
  border: 1px solid rgba(60,220,140,.55);
  box-shadow: 0 8px 22px rgba(40,200,120,.28), 0 0 0 1px rgba(60,220,140,.55) inset; /* keep existing shadow */
}
.pill.bonus-flashy.neg{
  background: linear-gradient(180deg, rgba(255,120,120,.22), rgba(255,120,120,.14));
  border: 1px solid rgba(255,110,110,.55);
  box-shadow: 0 8px 22px rgba(255,120,120,.30), 0 0 0 1px rgba(255,110,110,.55) inset; /* keep existing shadow */
}

/* Custom tooltip bubble */

</style>
<style id="score-boxes-and-tooltip-align">
/* Score en boîtes blanches */
.score{ display:flex; align-items:center; gap:10px; justify-content:center; }
.score .dash{ font-weight:900; opacity:.85; }
.score .scorebox{
  background: linear-gradient(180deg, #fff, #f1f1f1);
  color:#111;
  border-radius:12px;
  padding: 6px 14px;
  min-width: 54px;
  text-align:center;
  font-weight: 900;
  box-shadow: 0 3px 10px rgba(0,0,0,.15), 0 0 0 1px rgba(0,0,0,.05) inset; /* keep existing shadow */
}

/* Tooltip alignment per column */
.round-grid{ position:relative; }
.round-grid > .match-card:nth-child(odd) 
.round-grid > .match-card:nth-child(odd) 
.round-grid > .match-card:nth-child(even) 
.round-grid > .match-card:nth-child(even) 
/* On mobile, centre le tooltip */
@media (max-width: 900px){
  .round-grid > .match-card 
  .round-grid > .match-card 
}

/* Ajuste la taille des chiffres dans la boîte */
.score .scorebox{ font-size: clamp(22px, 3.2vw, 34px); line-height:1; }
</style>
<style id="scoreboxes-tight-font">
/* Fonts proches d'un tableau de score */
@import url('https://fonts.googleapis.com/css2?family=Anton&family=Roboto+Condensed:wght@700&display=swap');

.score{ display:flex; align-items:center; gap:0; justify-content:center; }
.score .scorebox{
  background: linear-gradient(180deg, #fff, #f2f2f2);
  color:#111;
  padding: 10px 18px;
  min-width: 62px;
  text-align:center;
  font-weight: 900;
  font-family: 'Anton','Roboto Condensed','Impact','Arial Narrow',sans-serif;
  letter-spacing: .5px;
  font-size: clamp(26px, 3.6vw, 40px);
  line-height: 1;
}
.score .scorebox.a{ border-radius: 10px 0 0 10px; }
.score .scorebox.b{ border-radius: 0 10px 10px 0; }
/* couture centrale comme sur la photo */
.score .scorebox.b{ box-shadow: inset 2px 0 0 0 rgba(0,0,0,.35); /* keep existing shadow */ }
.score .scorebox.a{ box-shadow: inset -2px 0 0 0 rgba(0,0,0,.22); /* keep existing shadow */ }
</style>
<style id="bonus-flashy-blue-variant">
.pill.bonus-flashy{
  background: linear-gradient(180deg, rgba(60,120,255,.22), rgba(60,120,255,.14));
  border: 1px solid rgba(110,160,255,.55);
  box-shadow: 0 8px 22px rgba(60,120,255,.28), 0 0 0 1px rgba(110,160,255,.55) inset; /* keep existing shadow */
  font-weight: 800; position:relative;
}
/* halo/bord coloré selon pos/neg */
.pill.bonus-flashy.pos{ border-color: rgba(60,220,140,.85); box-shadow: 0 8px 22px rgba(40,200,120,.28), 0 0 0 2px rgba(60,220,140,.55) inset; /* keep existing shadow */ }
.pill.bonus-flashy.neg{ border-color: rgba(255,110,110,.9); box-shadow: 0 8px 22px rgba(255,120,120,.30), 0 0 0 2px rgba(255,110,110,.55) inset; /* keep existing shadow */ }
.pill.bonus-flashy .pos{ color: #5CF08A; font-weight: 900; margin-left: 6px; }
.pill.bonus-flashy .neg{ color: #FF6B6B; font-weight: 900; margin-left: 6px; }
</style>
<style id="scoreboxes-seam-stronger">
.score{ position:relative; }
.score::before{
  content:""; position:absolute; top:8%; bottom:8%; left:50%;
  width:1px; background: rgba(0,0,0,.45);
  transform: translateX(-0.5px);
  border-radius: 1px;
}
</style>
<style id="score-seam-simple">
/* Simple filet noir au centre du bloc score */
.score .scorebox.a, .score .scorebox.b{ box-shadow: none !important; /* keep existing shadow */ }
.score{ position:relative; }
.score::before{
  content:""; position:absolute; top:10%; bottom:10%; left:50%;
  width:2px; background:#000; transform: translateX(-1px);
  border-radius: 1px;
}
</style>
<style id="bonus-sport-emoji-css">
.pill .sport-emo{ margin: 0 6px 0 4px; font-size: 14px; line-height: 0; vertical-align: -1px; }
</style>
<style id="tooltip-visibility-fix">
.match-card, .scorewrap, .round-grid { overflow: visible !important; }
.pill.bonus-flashy{ position:relative; z-index: 50; }
.pill.bonus-flashy[data-tip]::after,
.pill.bonus-flashy[data-tip]::before{ z-index: 1000; }
</style>
<style id="bonus-pill-compact">
.pill.bonus-flashy{ padding: 4px 8px; white-space: nowrap; font-size: 13px; }
.pill.bonus-flashy .mini-bonus{ width: 14px; height: 14px; margin: 0 4px; vertical-align: -2px; }
.pill .sport-emo{ margin: 0 4px 0 3px; font-size: 13px; vertical-align: -1px; }
.pill.bonus-flashy .pos, .pill.bonus-flashy .neg{ margin-left: 3px; }
</style>
<style id="bonus-pill-order-tight">
.pill.bonus-flashy, .pill.blue{ display:inline-flex; align-items:center; gap:4px; }
.pill.bonus-flashy .mini-bonus, .pill.blue .mini-bonus{ margin:0 2px; }
.pill .sport-emo{ margin:0 2px; }
</style>
<style id="chev-bottom-right">
.match-card .hd{ position: relative; }
.match-card .hd .chev{
  position: absolute; right: 14px; bottom: 12px; top: auto;
  transform: none;
}
.match-card[aria-expanded="true"] .hd .chev{ transform: rotate(90deg); }
</style>
<style id="incomplete-pulse">
@keyframes chipWarnPulse { 0%{ box-shadow:0 0 0 0 rgba(255,180,0,.0); /* keep existing shadow */} 50%{ box-shadow:0 0 0 6px rgba(255,180,0,.22); /* keep existing shadow */} 100%{ box-shadow:0 0 0 0 rgba(255,180,0,.0); /* keep existing shadow */} }
.chip.warn.pulse{ animation: chipWarnPulse .6s ease-out 1; }
</style>

<style id="ts-popover-styles">
/* Accessible Popover (progressive enhancement)
   Upgrades any element with [data-popover] || legacy [data-tip]. */
.ts-popover {
  position: fixed;
  inset: auto auto 0 0;
  max-width: min(92vw, 460px);
  background: #0a0a0a;
  color: #fff;
  font: 500 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  border-radius: 10px;
  padding: 10px 12px;
  box-shadow: 0 10px 28px rgba(0,0,0,.36), 0 0 0 1px rgba(255,255,255,.06) inset; /* keep existing shadow */
  opacity: 0;
  transform: translateY(4px) scale(.98);
  pointer-events: none;
  z-index: 1000;
  transition: opacity .14s ease, transform .14s ease;
}
.ts-popover[data-state="open"]{
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
}
.ts-popover[data-placement^="top"] .ts-popover__arrow{ transform: rotate(180deg); }
.ts-popover[data-placement^="left"] .ts-popover__arrow{ transform: rotate(-90deg); }
.ts-popover[data-placement^="right"] .ts-popover__arrow{ transform: rotate(90deg); }

.ts-popover__arrow {
  position: absolute;
  width: 14px;
  height: 14px;
  left: 50%;
  transform: translateX(-50%);
  bottom: -7px;
  filter: drop-shadow(0 2px 3px rgba(0,0,0,.25));
}
.ts-popover__arrow::before{
  content:"";
  position:absolute;
  inset:0;
  background:#111;
  transform: rotate(45deg);
  border-radius: 3px;
  box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; /* keep existing shadow */
}
/* Reduce motion */
@media (prefers-reduced-motion: reduce){
  .ts-popover{ transition: none; }
}

/* Trigger helpers (optional) */
[aria-haspopup="dialog"][data-popover-state="open"],
[aria-haspopup="tooltip"][data-popover-state="open"]{
  outline: 2px solid rgba(120,160,255,.6);
  outline-offset: 2px;
  border-radius: 10px;
}
</style>

<style id="ts-popover-override-legacy">
.pill.bonus-flashy[data-has-js-popover]::after,
.pill.bonus-flashy[data-has-js-popover]::before{ display:none !important; content:none !important; }
</style>

<script id="ts-popover-script">
(function(){
  const PADDING = 12; // viewport padding
  let current = null;
  const popover = document.createElement('div');
  popover.className = 'ts-popover';
  popover.setAttribute('role', 'tooltip');
  popover.innerHTML = '<div class="ts-popover__content"></div><div class="ts-popover__arrow" aria-hidden="true"></div>';
  const contentEl = popover.querySelector('.ts-popover__content');
  document.addEventListener('DOMContentLoaded', () => {
    // Upgrade legacy [data-tip] to [data-popover]
    document.querySelectorAll('[data-tip]').forEach(el => {
      if(!el.hasAttribute('data-popover')){
        el.setAttribute('data-popover', el.getAttribute('data-tip'));
      }
      // Remove legacy CSS-only tooltip by disabling ::after/::before via marker
      el.setAttribute('data-has-js-popover', 'true');
    });

    // Attach events
    const triggers = Array.from(document.querySelectorAll('[data-popover]'));
    if (!triggers.length) return;
    document.body.appendChild(popover);

    const open = (el, viaClick=false) => {
      if (current === el) return;
      close();
      current = el;
      const text = el.getAttribute('data-popover');
      if (!text) { current = null; return; }
      contentEl.textContent = text;
      // ARIA
      let id = el.getAttribute('aria-describedby');
      if (!id) {
        id = 'ts-popover-' + Math.random().toString(36).slice(2);
        popover.id = id;
        el.setAttribute('aria-describedby', id);
      } else {
        popover.id = id;
      }
      el.setAttribute('data-popover-state','open');
      place(el);
popover.setAttribute('data-placement','bottom');
popover.setAttribute('data-state','open');
      // If opened by click/touch, trap dismissal with outside click
      if (viaClick) {
        setTimeout(()=>document.addEventListener('pointerdown', onDocPointerDown, { once:true }), 0);
      }
    };

    const close = () => {
      if (!current) return;
      current.removeAttribute('data-popover-state');
      current = null;
      popover.removeAttribute('data-state');
    };

    const onDocPointerDown = (e) => {
      if (!popover.contains(e.target) && (!current || !current.contains(e.target))) {
        close();
      }
    };

    
const place = (el) => {
  const rect = el.getBoundingClientRect();
  const vw = document.documentElement.clientWidth;
  const vh = document.documentElement.clientHeight;
  const popW = Math.min(460, vw - PADDING*2);
  popover.style.maxWidth = popW + 'px';
  // Ensure measurable size before positioning
  popover.style.left = '0px';
  popover.style.top = '0px';
  popover.setAttribute('data-placement','bottom');
  // compute content size after setting content
  const margin = 10;
  const popH = popover.offsetHeight || 0;

  // Horizontal centering with clamping
  let left = rect.left + rect.width/2 - popW/2;
  left = Math.max(PADDING, Math.min(left, vw - PADDING - popW));

  // Force below the trigger
  let top = rect.bottom + margin;
  // Clamp to viewport bottom with padding
  top = Math.min(vh - PADDING - popH, top);

  popover.style.transformOrigin = 'center top';
  popover.style.left = left + 'px';
  popover.style.top = top + 'px';

  // Arrow X based on trigger center
  const arrow = popover.querySelector('.ts-popover__arrow');
  const centerX = rect.left + rect.width/2;
  const arrowLeft = Math.max(14, Math.min(popW - 14, centerX - left));
  arrow.style.left = arrowLeft + 'px';
  arrow.style.top = (-7) + 'px';
};


    // Hover/focus show, leave/blur hide
    const show = (e) => open(e.currentTarget, e.type === 'click');
    const hide = () => close();

    triggers.forEach(el => {
      el.setAttribute('tabindex', el.tabIndex >= 0 ? el.tabIndex : 0);
      el.setAttribute('aria-haspopup','tooltip');
      el.addEventListener('mouseenter', show);
      el.addEventListener('focusin', show);
      el.addEventListener('mouseleave', hide);
      el.addEventListener('focusout', hide);
      el.addEventListener('click', (e)=>{
        // Toggle on click/touch
        if (current === el) { close(); }
        else { open(el, true); }
      });
    });

    window.addEventListener('resize', () => { if (current) place(current); });
    window.addEventListener('scroll', () => { if (current) place(current); }, true);

    // Esc to close
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') close();
    });
  });
})();
</script>
</body>
</html>
