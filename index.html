<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TriSports — Fléchettes • Ping-pong • Palet</title>

<!-- Garde-fou : certaines extensions injectent du React minifié qui loggue "Minified React error #...".
     On évite que ça remonte et perturbe l'app (ça n'affecte PAS ton site). -->
<script>
  window.addEventListener('error', function (e) {
    const msg = (e.message || '') + '';
    if (msg.includes('Minified React error #')) {
      e.stopImmediatePropagation?.();
      return false;
    }
  }, true);

function ensureParamWrapper(){
  const f=id('capitaine-fields'); if(!f) return null;
  let wrap=id('cap-params');
  if(!wrap){ wrap=document.createElement('div'); wrap.id='cap-params'; wrap.className='bonus-params'; f.parentNode.insertBefore(wrap,f); wrap.appendChild(f); }
  return wrap;
}
function ensureTaupeWrapper(){
  const f=id('taupe-fields'); if(!f) return null;
  let wrap=id('taupe-params');
  if(!wrap){ wrap=document.createElement('div'); wrap.id='taupe-params'; wrap.className='bonus-params'; f.parentNode.insertBefore(wrap,f); wrap.appendChild(f); }
  return wrap;
}
function ensureLeftHandWrapper(){
  const f=id('lefthand-fields'); if(!f) return null;
  let wrap=id('lefthand-params');
  if(!wrap){ wrap=document.createElement('div'); wrap.id='lefthand-params'; wrap.className='bonus-params'; f.parentNode.insertBefore(wrap,f); wrap.appendChild(f); }
  return wrap;
}
function setParamsOpen(openCap, openTaupe, openLeft){
  const wC=ensureParamWrapper(); if (wC){ wC.style.maxHeight = openCap ? (wC.scrollHeight+'px') : '0px'; }
  const wT=ensureTaupeWrapper(); if (wT){ wT.style.maxHeight = openTaupe ? (wT.scrollHeight+'px') : '0px'; }
  const wL=ensureLeftHandWrapper(); if (wL){ wL.style.maxHeight = openLeft ? (wL.scrollHeight+'px') : '0px'; }
}
function prepareBonusOptions(){
  const cards=[...document.querySelectorAll('#bonus-modal .bonus-select .bonus-card')];
  cards.forEach((c,i)=>{
    c.classList.add('selectable'); c.tabIndex=0; c.setAttribute('role','button');
    c.addEventListener('click',()=> selectBonusType(i===0?'capitaine':(i===1?'miroir':(i===2?'taupe':'lefthand'))));
    c.addEventListener('keydown',e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); selectBonusType(i===0?'capitaine':(i===1?'miroir':(i===2?'taupe':'lefthand'))); }});
  });
  const cap=cards[0], mir=cards[1], tau=cards[2], lef=cards[3];
  const wC=ensureParamWrapper(); if(cap && wC && wC.parentNode!==cap) cap.appendChild(wC);
  const wT=ensureTaupeWrapper(); if(tau && wT && wT.parentNode!==tau) tau.appendChild(wT);
  const wL=ensureLeftHandWrapper(); if(lef && wL && wL.parentNode!==lef) lef.appendChild(wL);
}
function selectBonusType(t){
  window._bonusType = (t==='miroir'||t==='taupe'||t==='lefthand') ? t : 'capitaine';
  const cards=[...document.querySelectorAll('#bonus-modal .bonus-select .bonus-card')];
  const [cap,mir,tau,lef]=[cards[0],cards[1],cards[2],cards[3]];
  cards.forEach(c=>c&&c.classList.remove('selected'));
  if(cap && window._bonusType==='capitaine') cap.classList.add('selected');
  if(mir && window._bonusType==='miroir') mir.classList.add('selected');
  if(tau && window._bonusType==='taupe') tau.classList.add('selected');
  if(lef && window._bonusType==='lefthand') lef.classList.add('selected');

  const ctx=id('bonus-context');
  if(ctx) ctx.textContent = window._bonusType==='miroir' ?
    "Miroir : inverse le bonus adverse sur tout le match." :
    (window._bonusType==='taupe' ? "René la taupe : choisissez le sport." :
      (window._bonusType==='lefthand' ? "10 pouces 2 mains gauche : choisissez le sport." :
        "Capitaine : choisissez le joueur et le sport."));

  setParamsOpen(window._bonusType==='capitaine', window._bonusType==='taupe', window._bonusType==='lefthand');
}



function renderMatches(){
  const list=id("match-list");list.innerHTML="";
  if(!state.matches.length){list.appendChild(help("Aucune rencontre planifiée."));id("stats-matches").textContent="0 / 0 matches complets";id("round-status").textContent="—";id("btn-start-round").style.display="none";id("btn-end-round").style.display="none";return}
  const groups={};state.matches.forEach(m=>(groups[m.round]=groups[m.round]||[]).push(m));
  const rounds=Object.keys(groups).map(Number).sort((a,b)=>a-b);
  CURRENT_ROUND = rounds.find(r=>!roundState(r).finished) ?? rounds[rounds.length-1];
  const rs=roundState(CURRENT_ROUND);
  const roundPill=id("round-status");
  roundPill.textContent=`Journée active : #${CURRENT_ROUND} — ${rs.finished?'Terminée':(rs.started?'En cours':'Préparation')}`;
  roundPill.classList.remove('red','yellow','green');
  setRoundStatusPillClasses(roundPill,rs);
  id("btn-start-round").style.display=(isAdmin()&&!rs.started&&!rs.finished)?'inline-block':'none';
  id("btn-end-round").style.display  =(isAdmin()&& rs.started&&!rs.finished)?'inline-block':'none';

  let complete=0, idx=0;
  rounds.forEach(r=>{
    const hdr=help("Journée "+r);hdr.style.fontWeight="600";hdr.style.margin="8px 0";list.appendChild(hdr);
    const rCtl=roundState(r);
    const badgeClass = rCtl.finished ? 'green' : (rCtl.started ? 'yellow' : 'red');

    groups[r].forEach(m=>{
      ensureLengths(m);
      const wins=computeSetWins(m),pal=m.palet,palScore=(pal.a!=null&&pal.b!=null)?hy(pal.a,pal.b):"—";
      const palChip = `<span class="chip">🥏 Palet: <span class="score-compact">${palScore}</span></span>`;
      const done=isMatchComplete(m);if(done)complete++;
      const el=document.createElement("div");el.className="match-card";el.dataset.id=m.id;const isOpen=!!ui.open[m.id];el.setAttribute("aria-expanded",isOpen?"true":"false");
      const bonusA=bonusChip(r,m.a,rCtl), bonusB=bonusChip(r,m.b,rCtl);
      el.innerHTML=`<div class="hd" data-expand style="border:none;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
        <div class="teams"><span class="chip round-chip ${badgeClass}">#${++idx}</span>
          <span class="team-name">${avatarHtml(m.a,'sm')}${esc(teamName(m.a))}</span> <span class="vs">vs</span>
          <span class="team-name">${avatarHtml(m.b,'sm')}${esc(teamName(m.b))}</span></div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <span class="chip">🎯 Fléchettes: <span class="score-compact">${hy(wins.aw.darts,wins.bw.darts)}</span></span>
          <span class="chip">🏓 Ping: <span class="score-compact">${hy(wins.aw.ping,wins.bw.ping)}</span></span>
          ${palChip}
          ${done?'<span class="pill green">✅ Complet</span>':'<span class="pill yellow">⏳ Incomplet</span>'}
          ${bonusA} ${bonusB}
          <span class="chip">▶</span>
        </div></div>
        <div class="bd">
          <div class="match-two-col">
            ${renderDarts(m)}${renderPing(m)}
          </div>
          ${renderPalet(m)}
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:8px">
            <div class="help">La saisie nécessite d’être connecté·e à une des deux équipes (ou admin).</div>
            <div>${(isAdmin()||hasClaim(m.a)||hasClaim(m.b))?`<button type="button" class="btn small" data-clear="${m.id}">Effacer ce match</button>`:''}</div>
          </div>
        </div>`;
      list.appendChild(el);

      // darts
      qsa('.match-card[data-id="'+m.id+'"] select[data-kind="darts"]').forEach(sel=>{
        const can=(isAdmin()||hasClaim(m.a)||hasClaim(m.b)); sel.disabled=!can;
        sel.addEventListener("change",()=>{const i=parseInt(sel.getAttribute("data-index"),10),v=sel.value===""?null:parseInt(sel.value,10);const mm=findMatch(m.id);mm.darts[i]=v;saveState();renderMatches();renderLeaderboard();renderH2H()});
      });
      // ping
      qsa('.match-card[data-id="'+m.id+'"] input[data-ping]').forEach(inp=>{
        const can=(isAdmin()||hasClaim(m.a)||hasClaim(m.b)); inp.disabled=!can;
        const mid=m.id,idxSet=parseInt(inp.getAttribute("data-index"),10),which=inp.getAttribute("data-ping");
        const updateNote=()=>{const mm=findMatch(mid),s=mm.pingPts[idxSet],ok=isPingValid(+s.a,+s.b);const note=qs('.match-card[data-id="'+mid+'"] [data-note="ping-'+mid+'-'+idxSet+'"]');if(note)note.textContent=ok?'✔️ Score valide':'Saisissez deux scores (11+ et écart ≥ 2).'}
        inp.addEventListener("input",()=>{const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,99);const mm=findMatch(mid);mm.pingPts[idxSet][which]=v;saveState();updateNote()});
        const commit=()=>{const mm=findMatch(mid);const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,99);mm.pingPts[idxSet][which]=v;saveState();renderMatches();renderLeaderboard();renderH2H()};
        inp.addEventListener("change",commit);inp.addEventListener("blur",commit);inp.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();inp.blur()}})
      });
      // palet
      qsa('.match-card[data-id="'+m.id+'"] input[data-palet]').forEach(inp=>{
        const can=(isAdmin()||hasClaim(m.a)||hasClaim(m.b)); inp.disabled=!can;
        const mid=m.id,which=inp.getAttribute("data-palet");
        const updateNote=()=>{const mm=findMatch(mid),T=+state.rules.paletTarget||11,a=(mm.palet?.a==null?null:+mm.palet?.a),b=(mm.palet?.b==null?null:+mm.palet?.b);const ok=(a!=null&&b!=null)&&((a===T&&b>=0&&b<=T-1)||(b===T&&a>=0&&a<=T-1));const note=qs('.match-card[data-id="'+mid+'"] [data-note="pal-'+mid+'"]');if(note)note.textContent=ok?'✔️ Score valide':`Saisissez les deux scores (l’un doit être ${T}).`}
        inp.addEventListener("input",()=>{const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,state.rules.paletTarget||11);const mm=findMatch(mid);mm.palet[which]=v;saveState();updateNote()});
        const commit=()=>{const mm=findMatch(mid);const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,state.rules.paletTarget||11);mm.palet[which]=v;saveState();renderMatches();renderLeaderboard();renderH2H()};
        inp.addEventListener("change",commit);inp.addEventListener("blur",commit);inp.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();inp.blur()}})
      });

      const clr=qs('.match-card[data-id="'+m.id+'"] [data-clear]');if(clr)clr.addEventListener("click",()=>clearMatch(m.id));
      const head=qs('.match-card[data-id="'+m.id+'"] [data-expand]');if(head)head.addEventListener("click",()=>{const open=el.getAttribute("aria-expanded")==="true";el.setAttribute("aria-expanded",open?"false":"true");ui.open[m.id]=!open});
      qsa('.match-card[data-id="'+m.id+'"] [data-bonus]').forEach(b=>b.addEventListener('click',()=>openBonusModal(r,b.getAttribute('data-team'))));
    });
  });
  id("stats-matches").textContent=complete+" / "+state.matches.length+" matches complets";
  renderLeaderboard();
}

/* ---- Rendu des 3 sports (relookés) ---- */
function renderDarts(m){
  const s = state.rules.dartsSingles, N = dartsTotal();
  let html = `<div class="sport-group">
    <div class="sport-title"><span class="sport-icon">${sportIcon('darts')}</span> Fléchettes</div>`;
  for(let i=0;i<N;i++){
    const v = m.darts[i];
    const lab = (i < s ? `Simple ${i+1}` : `Double ${i-s+1}`);
    html += `<div class="sport-item">
      <label>${lab}</label>
      <select data-kind="darts" data-index="${i}">
        <option value="" ${v===null?'selected':''}>Non joué</option>
        <option value="0" ${v===0?'selected':''}>Victoire ${esc(teamName(m.a))}</option>
        <option value="1" ${v===1?'selected':''}>Victoire ${esc(teamName(m.b))}</option>
      </select>
    </div>`;
  }
  html += `</div>`;
  return html;
}
function renderPing(m){
  const s = state.rules.pingSingles, N = pingTotal();
  let html = `<div class="sport-group">
    <div class="sport-title"><span class="sport-icon">${sportIcon('ping')}</span> Ping-pong</div>`;
  for(let i=0;i<N;i++){
    const set = m.pingPts[i] || {a:null,b:null};
    const lab = (i < s ? `Simple ${i+1}` : `Double ${i-s+1}`);
    const ok = isPingValid(+set.a,+set.b);
    html += `<div class="sport-item">
      <label>${lab}</label>
      <div class="ping-row">
        <div>
          <input type="number" min="0" max="99" step="1"
                 value="${set.a==null?'':set.a}"
                 data-ping="a" data-index="${i}"
                 placeholder="${esc(teamName(m.a))}">
        </div>
        <div>
          <input type="number" min="0" max="99" step="1"
                 value="${set.b==null?'':set.b}"
                 data-ping="b" data-index="${i}"
                 placeholder="${esc(teamName(m.b))}">
        </div>
      </div>
      <div class="help" data-note="ping-${m.id}-${i}">${ok?'✔️ Score valide':'Saisissez deux scores (11+ et écart ≥ 2).'}</div>
    </div>`;
  }
  html += `</div>`;
  return html;
}
function renderPalet(m){
  const T = +state.rules.paletTarget || 11;
  const a = (m.palet?.a==null?null:+m.palet?.a),
        b = (m.palet?.b==null?null:+m.palet?.b);
  const ok = (a!=null&&b!=null)&&((a===T&&b>=0&&b<=T-1)||(b===T&&a>=0&&a<=T-1));
  return `<div class="sport-group" style="margin-top:16px">
    <div class="sport-title"><span class="sport-icon">${sportIcon('palet')}</span> Palet</div>
    <div class="ping-row">
      <div>
        <label class="muted">${esc(teamName(m.a))}</label>
        <input type="number" min="0" max="${T}" step="1"
               value="${a==null?'':a}" data-palet="a">
      </div>
      <div>
        <label class="muted">${esc(teamName(m.b))}</label>
        <input type="number" min="0" max="${T}" step="1"
               value="${b==null?'':b}" data-palet="b">
      </div>
    </div>
    <div class="help" data-note="pal-${m.id}">${ok?'✔️ Score valide':`Saisissez les deux scores (l’un doit être ${T}).`}</div>
  </div>`;
}

/* ===== Classement ===== */
function baseLeaderboardStats(){const R=state.rules,stats={};state.teams.forEach(t=>stats[t.id]={teamId:t.id,name:t.name,avatar:t.avatar||null,pointsBase:0,bonus:0,malus:0,dartsW:0,pingW:0,palFor:0,palAg:0,matchesComplete:0});state.matches.forEach(m=>{const A=stats[m.a],B=stats[m.b];ensureLengths(m);m.darts.forEach(v=>{if(v===0){A.dartsW++;A.pointsBase+=R.dartsWinPoints}else if(v===1){B.dartsW++;B.pointsBase+=R.dartsWinPoints}});getPingPts(m).forEach(s=>{const a=(s.a==null?null:+s.a),b=(s.b==null?null:+s.b);if(isPingValid(a,b)){if(a>b){A.pingW++;A.pointsBase+=R.pingWinPoints}else if(b>a){B.pingW++;B.pointsBase+=R.pingWinPoints}}});const pa=(m.palet?.a==null?null:+m.palet?.a),pb=(m.palet?.b==null?null:+m.palet?.b);if(pa!=null&&pb!=null){A.palFor+=pa;B.palFor+=pb;A.palAg+=pb;B.palAg+=pa;A.pointsBase+=pa;B.pointsBase+=pb}if(isMatchComplete(m)){A.matchesComplete++;B.matchesComplete++}});Object.keys(state.bonusApplied||{}).forEach(r=>{const per=state.bonusApplied[r];Object.keys(per).forEach(tid=>{const v=per[tid]||0;if(stats[tid])stats[tid].bonus+=v})});return stats}
function computeLeaderboard(){const stats=baseLeaderboardStats();const rows=Object.values(stats).map(x=>({teamId:x.teamId,name:x.name,avatar:x.avatar,points:x.pointsBase+x.bonus-x.malus,bonus:x.bonus,malus:x.malus,dartsW:x.dartsW,pingW:x.pingW,palFor:x.palFor,palAg:x.palAg,matchesComplete:x.matchesComplete}));rows.sort((x,y)=>(y.points-x.points)||((y.palFor-y.palAg)-(x.palFor-x.palAg))||((y.dartsW+y.pingW)-(x.dartsW+x.pingW))||x.name.localeCompare(y.name));rows.forEach((r,i)=>r.rank=i+1);return rows}
function renderLeaderboard(){const tbody=qs("#table-classement tbody");tbody.innerHTML="";computeLeaderboard().forEach(r=>{const diff=r.palFor-r.palAg;const avatar=r.avatar?(`<span class="avatar avatar-lg"><img src="${esc(r.avatar)}" alt="avatar"></span>`):(`<span class="avatar avatar-lg"><span class="avatar-initials">${esc(initials(r.name))}</span></span>`);const tr=document.createElement("tr");tr.innerHTML=`<td>${r.rank}</td><td><span class="team-name">${avatar} ${esc(r.name)}</span></td><td><b>${r.points}</b></td><td>${r.dartsW}</td><td>${r.pingW}</td><td><span class="score-compact">${hy(r.palFor,r.palAg)}</span> <span class="muted">(${diff>=0?'+':''}${diff})</span></td><td>${r.bonus}</td><td>${r.malus||0}</td><td>${r.matchesComplete}</td>`;tbody.appendChild(tr)})}

/* ===== H2H ===== */
function pointsForTeamInMatch(m,tid){const R=state.rules;ensureLengths(m);const isA=m.a===tid,isB=m.b===tid;if(!isA&&!isB)return 0;let pts=0;m.darts.forEach(v=>{if(v===0&&isA)pts+=R.dartsWinPoints;else if(v===1&&isB)pts+=R.dartsWinPoints});getPingPts(m).forEach(s=>{const a=(s.a==null?null:+s.a),b=(s.b==null?null:+s.b);if(isPingValid(a,b)){if(a>b&&isA)pts+=R.pingWinPoints;else if(b>a&&isB)pts+=R.pingWinPoints}});if(m.palet&&m.palet.a!=null&&m.palet.b!=null)pts+=isA?+m.palet.a:+m.palet.b;return pts}
function renderH2H(){const thead=qs("#table-h2h thead"),tbody=qs("#table-h2h tbody");thead.innerHTML="";tbody.innerHTML="";const teams=state.teams.slice();if(!teams.length){tbody.appendChild(help("Ajoutez des équipes pour voir la matrice."));return}const trH=document.createElement("tr");trH.appendChild(document.createElement("th")).textContent="Équipe";teams.forEach(t=>{const th=document.createElement("th");th.innerHTML='<span class="team-name">'+avatarHtml(t.id,'sm')+esc(t.name)+'</span>';trH.appendChild(th)});thead.appendChild(trH);const byPair={};state.matches.forEach(m=>{byPair[[m.a,m.b].sort().join("|")]=m});teams.forEach(ti=>{const tr=document.createElement("tr");const th=document.createElement("th");th.innerHTML='<span class="team-name">'+avatarHtml(ti.id,'sm')+esc(ti.name)+'</span>';tr.appendChild(th);teams.forEach(tj=>{const td=document.createElement("td");if(ti.id===tj.id){td.textContent="—";tr.appendChild(td);return}const m=byPair[[ti.id,tj.id].sort().join("|")];if(!m){td.innerHTML='<span class="chip">—</span>';tr.appendChild(td);return}const pI=pointsForTeamInMatch(m,ti.id),pJ=pointsForTeamInMatch(m,tj.id);let cls="h2h-draw",icon="≡";if(pI>pJ){cls="h2h-win";icon="✔"}else if(pI<pJ){cls="h2h-loss";icon="✖"}td.innerHTML='<span class="h2h-pill '+cls+'">'+icon+' <span class="score-compact">'+hy(pI,pJ)+'</span></span>';td.style.cursor="pointer";td.dataset.matchId=m.id;tr.appendChild(td)});tbody.appendChild(tr)});tbody.addEventListener("click",e=>{let n=e.target;while(n&&n!==tbody&&!(n.tagName==="TD"&&n.dataset.matchId))n=n.parentNode;if(!n||n===tbody)return;goto("calendrier");ui.open[n.dataset.matchId]=true;setTimeout(()=>{const card=qs('.match-card[data-id="'+n.dataset.matchId+'"]');if(card){card.setAttribute("aria-expanded","true");card.scrollIntoView({behavior:"smooth",block:"start"})}},0)})}

/* ===== Tabs & clicks ===== */
function guardTab(t){const no=(!cloud.enabled&&!state.cloudId);return(t==='equipes'||t==='calendrier'||t==='classement'||t==='options')&&(no&&state.teams.length===0)}
function goto(tabId){if(guardTab(tabId)){alert("Aucun tournoi ouvert. Créez ou rejoignez un code Cloud.");tabId='setup'}qsa(".tab").forEach(b=>b.setAttribute("aria-selected","false"));const b=qs('.tab[data-tab="'+tabId+'"]');if(b)b.setAttribute("aria-selected","true");qsa("main section").forEach(s=>s.classList.remove("active"));id(tabId).classList.add("active")}

document.addEventListener("click",async(e)=>{
  const btn=e.target.closest("button");if(btn){switch(btn.id){
    case "btn-fullscreen":(document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen())?.catch?.(()=>{});break;

    /* --- ADMIN : activation => re-render immédiat --- */
    case "btn-admin-on-setup":
    case "btn-admin-on":{const pin=prompt("PIN administrateur :");if(pin==="30041991"){session.admin=true;session.claims={};updateWho();renderAll();alert("Mode administrateur activé (déconnexion des équipes sur cet appareil).")}else alert("PIN incorrect.");break}
    case "btn-admin-off":{session.admin=false;updateWho();renderAll();break}

    case "btn-create-tournament":{if(!isAdmin()){const pin=prompt("PIN administrateur :");if(pin!=="30041991")return alert("PIN incorrect.");session.admin=true;session.claims={};updateWho();renderAll()}const code=(id("tcode-input").value||"").trim();if(!code)return alert("Code cloud obligatoire.");const name=(id("tname-input").value||"").trim()||"Tournoi";if(nameExistsLocally(name))return alert("Un tournoi portant ce nom existe déjà dans cette liste.");if(codeExistsLocally(code))return alert("Ce code cloud existe déjà dans votre liste.");const exists=await(async()=>{try{const db=cloud.db||initFB();if(!db)return false;const ref=db.ref("tournaments/"+code+"/payload");const snap=await ref.get?.()??await new Promise(res=>ref.once('value',res));return !!(snap&&snap.exists&&snap.exists())}catch(_){return false}})();if(exists)return alert("Ce code cloud existe déjà sur le serveur. Choisissez-en un autre.");const n=clampInt(id("teams-count-input").value,2,64);const R={dartsSingles:clampInt(id("rule-d-s").value,0,9),dartsDoubles:clampInt(id("rule-d-d").value,0,9),dartsWinPoints:clampInt(id("rule-d-p").value,1,50),pingSingles:clampInt(id("rule-p-s").value,0,9),pingDoubles:clampInt(id("rule-p-d").value,0,9),pingWinPoints:clampInt(id("rule-p-p").value,1,50),paletTarget:clampInt(id("rule-l-target").value,1,50)};joinCloud(code);state={version:40,tid:uid(),cloudId:code,tournamentName:name,rules:R,teams:Array.from({length:n},(_,i)=>({id:uid(),name:"Équipe "+(i+1),p1:"",p2:"",avatar:null,bonusCapitaineUsed:false})),matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};saveState();pushCloud(true);renderAll();goto("equipes");break}
    case "btn-join-code":{const code=(id("join-code").value||"").trim();if(!code)return alert("Renseigne un code.");joinCloud(code);goto("equipes");break}
    case "btn-copy-link":{const code=(id("join-code").value||id("tcode-input").value||state.cloudId||"").trim();if(!code)return alert("Aucun code.");const url=location.origin+location.pathname+"?id="+encodeURIComponent(code);navigator.clipboard?.writeText(url);alert("Lien copié !\n"+url);break}

    case "btn-add-team":{if(!isAdmin())return alert("Réservé à l’admin.");if(state.locked)return alert("Calendrier figé.");state.teams.push({id:uid(),name:"Équipe "+(state.teams.length+1),p1:"",p2:"",avatar:null,bonusCapitaineUsed:false});saveState();renderTeams();break}
    case "btn-generate":{if(!isAdmin())return alert("Seul l’admin peut générer.");if(state.locked)return;generateSchedule();state.locked=true;saveState();renderAll();goto("calendrier");break}

    case "btn-refresh-standings":
    case "btn-refresh-standings-2":{renderLeaderboard();renderH2H();if(btn.id==="btn-refresh-standings-2")goto("classement");break}
    case "btn-show-summary":{id("view-summary").style.display="block";id("view-h2h").style.display="none";id("btn-show-summary").setAttribute("aria-pressed","true");id("btn-show-h2h").setAttribute("aria-pressed","false");break}
    case "btn-show-h2h":{id("view-summary").style.display="none";id("view-h2h").style.display="block";id("btn-show-summary").setAttribute("aria-pressed","false");id("btn-show-h2h").setAttribute("aria-pressed","true");break}
    case "btn-collapse":{qsa('#match-list .match-card').forEach(c=>c.setAttribute('aria-expanded','false'));ui.open={};break}

    case "btn-export":{const data=JSON.stringify(state,null,2);const url=URL.createObjectURL(new Blob([data],{type:"application/json"}));const a=document.createElement("a");a.href=url;a.download=("tournoi-"+(state.tournamentName||"TriSports")).replace(/\s+/g,'_')+".json";a.click();URL.revokeObjectURL(url);break}
    case "btn-import":{const f=id("file-import").files?.[0];if(!f)return alert("Sélectionnez un fichier JSON.");f.text().then(t=>{try{const data=JSON.parse(t);state=data;normalize();saveState();renderAll();alert("Import réussi !")}catch(_){alert("Fichier invalide.")}});break}

    case "btn-cloud-copy":{const code=state.cloudId||cloud.id;if(!code)return alert("Pas de code cloud.");const url=location.origin+location.pathname+"?id="+encodeURIComponent(code);navigator.clipboard?.writeText(url);alert("Lien copié !\n"+url);break}
    case "btn-cloud-delete":{if(!isAdmin())return alert("Suppression cloud réservée à l’admin.");const code=state.cloudId||cloud.id;if(!code)return alert("Aucun code actif.");if(!confirm("Supprimer définitivement ce tournoi du cloud ?"))return;deleteCloud(code).then(()=>{setIndex(getIndex().filter(e=>e.id!==code));unsubscribeCloud();resetState();renderSetupRecent();renderAll();history.replaceState(null,"",location.pathname);alert("Tournoi supprimé.");goto('setup')});break}

    /* ---- Réinitialiser scores => réinitialise aussi BONUS + journées ---- */
    case "btn-reset-scores":{if(!isAdmin())return alert("Réservé à l’admin.");if(!confirm("Réinitialiser les SCORES et les BONUS ?"))return;state.matches.forEach(m=>{m.darts=Array(dartsTotal()).fill(null);m.pingPts=Array(pingTotal()).fill({a:null,b:null});m.palet={a:null,b:null}});state.roundCtl={};state.bonusSelections={};state.bonusApplied={};state.teams.forEach(t=>t.bonusCapitaineUsed=false);saveState();renderAll();goto("calendrier");break}

    case "btn-unlock":{if(!isAdmin())return alert("Réservé à l’admin.");if(!confirm("Déverrouiller le calendrier ?"))return;state.locked=false;saveState();renderTeams();renderMatches();updateLock();break}

    case "btn-start-round":{if(!isAdmin())return;const r=CURRENT_ROUND,rs=roundState(r);if(rs.started||rs.finished)return;rs.started=true;saveState();renderMatches();alert("Journée #"+r+" démarrée. Les bonus sont verrouillés.");break}

    /* ---- Fin de journée : blocage si incomplet + bonus appliqués ---- */
    case "btn-end-round": {
      if (!isAdmin()) return;
      const r  = CURRENT_ROUND;
      const rs = roundState(r);
      if (!rs.started || rs.finished) return;

      const matchesOfRound = state.matches.filter(m => m.round === r);
      const incomplets = matchesOfRound.filter(m => !isMatchComplete(m));
      if (incomplets.length) { alert(`Impossible de terminer la journée #${r} : ${incomplets.length} match(s) incomplet(s).`); return; }

      const sels = state.bonusSelections[r] || {};
      Object.keys(sels).forEach(tid=>{
        const sel = sels[tid]; if (!sel) return;
        if (teamBonusUsed(tid)) { setBonusApplied(r, tid, 0); return; }
        let total = 0;
        matchesOfRound.forEach(m=>{ total += computeCapitaineBonusForMatch(m, tid, sel.player, sel.sport); });
        setBonusApplied(r, tid, total); markTeamBonusUsed(tid);
      });

      rs.finished = true; saveState(); renderMatches(); renderLeaderboard();
      alert(`Journée #${r} terminée. Les bonus sont appliqués et révélés.`); break;
    }
  }}
  const openBtn=e.target.closest("[data-open-id]");if(openBtn){const code=openBtn.getAttribute("data-open-id").replace(/^cloud:/,"");id("join-code").value=code;joinCloud(code);goto("equipes")}
  const delBtn=e.target.closest("[data-delete-id]");if(delBtn){if(!isAdmin())return alert("Suppression cloud réservée à l’admin.");const code=delBtn.getAttribute("data-delete-id");if(!confirm("Supprimer le tournoi '"+code+"' du cloud ?"))return;deleteCloud(code).then(()=>{setIndex(getIndex().filter(e=>e.id!==code));if(state.cloudId===code||cloud.id===code){unsubscribeCloud();resetState();renderAll();history.replaceState(null,"",location.pathname);goto('setup')}alert("Supprimé.");renderSetupRecent()})}
  const av=e.target.closest('.avatar[data-click-avatar]');if(av){const tid=av.getAttribute('data-click-avatar');if(isAdmin()||hasClaim(tid)){const input=document.querySelector('input[type="file"][data-avatar="'+tid+'"]');if(input)input.click()}return}
  const tab=e.target.closest(".tab");if(tab){let t=tab.getAttribute("data-tab");if(guardTab(t))t='setup';qsa(".tab").forEach(b=>b.setAttribute("aria-selected","false"));qs('.tab[data-tab="'+t+'"]').setAttribute("aria-selected","true");qsa("main section").forEach(s=>s.classList.remove("active"));id(t).classList.add("active")}
  const actBtn=e.target.closest("[data-act]");if(actBtn){const act=actBtn.getAttribute("data-act"),tid=actBtn.getAttribute("data-id");if(act==="del"){if(!isAdmin()||state.locked)return;if(!confirm("Supprimer cette équipe ?"))return;state.teams=state.teams.filter(tt=>tt.id!==tid);state.matches=state.matches.filter(m=>m.a!==tid&&m.b!==tid);if(state.protect?.teamPassHash)delete state.protect.teamPassHash[tid];saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
    if(act==="setpass"){if(!isAdmin())return alert("Réservé à l’admin.");let pass=prompt("Mot de passe pour l’équipe « "+teamName(tid)+" » :");if(pass==null)return;pass=pass.trim();if(!pass)return alert("Mot de passe vide.");state.protect=state.protect||{};state.protect.teamPassHash=state.protect.teamPassHash||{};state.protect.teamPassHash[tid]=hashPass(pass);saveState();renderTeams();alert("Mot de passe défini.")}
    if(act==="login"){const hashes=(state.protect&&state.protect.teamPassHash)?state.protect.teamPassHash:null;if(!hashes||!hashes[tid])return alert("Cette équipe n’a pas encore de mot de passe (demandez à l’admin).");let pass=prompt("Mot de passe de l’équipe « "+teamName(tid)+" » :");if(pass==null)return;pass=pass.trim();if(!pass)return alert("Mot de passe vide.");if(hashPass(pass)===hashes[tid]){ session.admin=false; session.claims={}; session.claims[tid]=true; updateWho(); renderAll(); alert("Connexion réussie. Mode admin désactivé sur cet appareil."); }
      else alert("Mot de passe incorrect.") }
    if(act==="logout"){session.claims={};updateWho();renderAll()}
    if(act==="avatar"){const input=qs('[data-avatar="'+tid+'"]');if(input)input.click()}
    if(act==="avatar-clear"){const t=teamObj(tid);if(!t)return;t.avatar=null;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
  }
});

/* ===== Modal bonus ===== */
let bonusCTX={round:null,teamId:null};
function openBonusModal(round,teamId){
  const rCtl=roundState(round);
  if(rCtl.started) return alert("La journée a démarré : bonus verrouillés.");
  if(teamBonusUsed(teamId)) return alert("Ce bonus a déjà été utilisé une fois.");
  if(!hasClaim(teamId)) return alert("Connectez-vous à cette équipe pour choisir son bonus.");
  bonusCTX.round=round;bonusCTX.teamId=teamId;
  const sel=getBonusSelection(round,teamId);
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine'); }
  if(id('taupe-sport')) id('taupe-sport').value = (sel?.sport||'darts'); if(id('lefthand-sport')) id('lefthand-sport').value = (sel?.sport||'darts');
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine'); }
  if(id('taupe-sport')) id('taupe-sport').value = (sel?.sport||'darts'); if(id('lefthand-sport')) id('lefthand-sport').value = (sel?.sport||'darts');
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine'); }
  if(id('taupe-sport')) id('taupe-sport').value = (sel?.sport||'darts'); if(id('lefthand-sport')) id('lefthand-sport').value = (sel?.sport||'darts');
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine'); }
  if(id('taupe-sport')) id('taupe-sport').value = (sel?.sport||'darts');
  if(id('lefthand-sport')) id('lefthand-sport').value = (sel?.sport||'darts');
  id('bonus-player').value=sel?.player||'p1';
  id('bonus-sport').value=sel?.sport||'darts';
  id('bonus-context').textContent=`Équipe : ${teamName(teamId)} — Journée #${round}`;
  document.body.classList.add('modal-open'); id('bonus-modal').classList.add('show');
}
id('bonus-cancel').addEventListener('click',()=>id('bonus-modal').classList.remove('show'));
id('bonus-save').addEventListener('click',()=>{
  const r=bonusCTX.round, t=bonusCTX.teamId;
  const type=(window._bonusType==='miroir')?'miroir':(window._bonusType==='taupe'?'taupe':(window._bonusType==='lefthand'?'lefthand':'capitaine'));
  if(type==='capitaine') setBonusSelection(r,t,{type:'capitaine',player:id('bonus-player').value,sport:id('bonus-sport').value});
  else if(type==='taupe') setBonusSelection(r,t,{type:'taupe',sport:id('taupe-sport').value||'darts'});
  else if(type==='lefthand') setBonusSelection(r,t,{type:'lefthand',sport:id('lefthand-sport').value||'darts'});
  else setBonusSelection(r,t,{type:'miroir'});
  id('bonus-modal').classList.remove('show'); document.body.classList.remove('modal-open');
  if(typeof renderPills==='function') renderPills();
  if(typeof renderMatches==='function') renderMatches();
});

/* ===== Boot ===== */
function renderAll(){renderTitle();updateWho();renderSetupRecent();renderManageList();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
document.addEventListener("DOMContentLoaded",()=>{ try { renderAll(); } catch(e) {} });</script>
</body>
</html>
