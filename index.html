<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TriSports — Fléchettes • Ping-pong • Palet</title>

<!-- Garde-fou : certaines extensions injectent du React minifié qui loggue "Minified React error #...".
     On évite que ça remonte et perturbe l'app (ça n'affecte PAS ton site). -->
<script>
  window.addEventListener('error', function (e) {
    const msg = (e.message || '') + '';
    if (msg.includes('Minified React error #')) {
      e.stopImmediatePropagation?.();
      return false;
    }
  }, true);

function ensureParamWrapper(){
  const fields = id('capitaine-fields'); if(!fields) return null;
  let wrap=id('cap-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='cap-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureTaupeWrapper(){
  const fields = id('taupe-fields'); if(!fields) return null;
  let wrap=id('taupe-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='taupe-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureLeftHandWrapper(){
  const fields = id('lefthand-fields'); if(!fields) return null;
  let wrap=id('lefthand-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='lefthand-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureMelonWrapper(){
  const fields = id('melon-fields'); if(!fields) return null;
  let wrap = id('melon-params');
  if(!wrap){
    wrap = document.createElement('div');
    wrap.id = 'melon-params';
    wrap.className = 'bonus-params';
    fields.parentNode.insertBefore(wrap, fields);
    wrap.appendChild(fields);
  }
  return wrap;
}

function setParamsOpen(openCap, openTaupe, openLeft, openMelon){
  const wC = (typeof ensureParamWrapper==='function') ? ensureParamWrapper() : null; if(wC){ wC.style.maxHeight = openCap ? (wC.scrollHeight+'px') : '0px'; }
  const wT = (typeof ensureTaupeWrapper==='function') ? ensureTaupeWrapper() : null; if(wT){ wT.style.maxHeight = openTaupe ? (wT.scrollHeight+'px') : '0px'; }
  const wL = (typeof ensureLeftHandWrapper==='function') ? ensureLeftHandWrapper() : null; if(wL){ wL.style.maxHeight = openLeft ? (wL.scrollHeight+'px') : '0px'; }
  const wM = (typeof ensureMelonWrapper==='function') ? ensureMelonWrapper() : null; if(wM){ wM.style.maxHeight = openMelon ? (wM.scrollHeight+'px') : '0px'; }
}
const wL = ensureLeftHandWrapper(); if (wL){ wL.style.maxHeight = openLeft ? (wL.scrollHeight+'px') : '0px'; }
}
function selectBonusType(t){
  window._bonusType = (t==='miroir'||t==='taupe'||t==='lefthand'||t==='melon') ? t : 'capitaine';
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  const cap=cards[0], mir=cards[1], tau=cards[2], leftc=cards[3], melon=cards[4];
  [cap,mir,tau,leftc,melon].forEach(c=>c&&c.classList.remove('selected'));
  if(cap && window._bonusType==='capitaine') cap.classList.add('selected');
  if(mir && window._bonusType==='miroir') mir.classList.add('selected');
  if(tau && window._bonusType==='taupe') tau.classList.add('selected');
  if(leftc && window._bonusType==='lefthand') leftc.classList.add('selected');
  if(melon && window._bonusType==='melon') melon.classList.add('selected');
  const ctx=id('bonus-context');
  if(ctx) ctx.textContent = window._bonusType==='miroir' ? "Miroir : inverse le bonus adverse sur tout le match." : (window._bonusType==='taupe' ? "René la taupe : choisissez le sport." : (window._bonusType==='lefthand' ? "10 pouces 2 mains gauche : choisissez le sport." : (window._bonusType==='melon' ? "Melon d’or : choisissez le sport et le sous‑match." : "Capitaine : choisissez le joueur et le sport.")));
    "Miroir : inverse le bonus adverse sur tout le match." :
    (window._bonusType==='taupe' ? "René la taupe : choisissez le sport." :
      (window._bonusType==='lefthand' ? "10 pouces 2 mains gauche : choisissez le sport." :
        "Capitaine : choisissez le joueur et le sport."));
  setParamsOpen(window._bonusType==='capitaine', window._bonusType==='taupe', window._bonusType==='lefthand', window._bonusType==='melon');
}
function prepareBonusOptions(){
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  cards.forEach((c,i)=>{
    c.classList.add('selectable'); c.tabIndex=0; c.setAttribute('role','button');
    c.addEventListener('click', ()=>selectBonusType(i===0?'capitaine':(i===1?'miroir':(i===2?'taupe':(i===3?'lefthand':'melon')))));
    c.addEventListener('keydown', ev=>{
      if(ev.key===' '||ev.key==='Enter'){ ev.preventDefault(); selectBonusType(i===0?'capitaine':(i===1?'miroir':(i===2?'taupe':(i===3?'lefthand':'melon')))); }
    });
  });
  const cap=cards[0], tau=cards[2], leftc=cards[3], melon=cards[4];
  const wC=ensureParamWrapper(); if(cap && wC && wC.previousElementSibling!==cap) cap.appendChild(wC);
  const wT=ensureTaupeWrapper(); if(tau && wT && wT.previousElementSibling!==tau) tau.appendChild(wT);
  const wL=ensureLeftHandWrapper(); if(leftc && wL && wL.previousElementSibling!==leftc) leftc.appendChild(wL);
  const wM=ensureMelonWrapper(); if(melon && wM && wM.previousElementSibling!==melon) melon.appendChild(wM);
}
function updateMelonOptions(){
  try{
    const r = state?.rules || {};
    const sport = document.getElementById('melon-sport')?.value || 'darts';
    const sel = document.getElementById('melon-index');
    if(!sel) return;
    const out = [];
    if(sport==='darts'){
      const N = (r.dartsSingles||2) + (r.dartsDoubles||1);
      for(let i=1;i<=N;i++) out.push(`<option value="${i}">Sous‑match ${i}</option>`);
    }else if(sport==='ping'){
      const N = (r.pingSingles||2) + (r.pingDoubles||1);
      for(let i=1;i<=N;i++) out.push(`<option value="${i}">Sous‑match ${i}</option>`);
    }else{
      out.push('<option value="1">Unique sous‑match</option>');
    }
    sel.innerHTML = out.join('');
  }catch(_){}
}

 }); selectBonusType(i===0?'capitaine':(i===1?'miroir':(i===2?'taupe':'lefthand'))); } });
  });
  const cap=cards[0], tau=cards[2], leftc=cards[3], melon=cards[4];
  const wC=ensureParamWrapper(); if(cap && wC && wC.previousElementSibling!==cap) cap.appendChild(wC);
  const wT=ensureTaupeWrapper(); if(tau && wT && wT.previousElementSibling!==tau) tau.appendChild(wT);
  const wL=ensureLeftHandWrapper(); if(leftc && wL && wL.previousElementSibling!==leftc) leftc.appendChild(wL);
  const wM=ensureMelonWrapper(); if(melon && wM && wM.previousElementSibling!==melon) melon.appendChild(wM);
}

</script>

<style>
:root{--bg:#0f1220;--border:#2b315f;--text:#e7e9f7;--muted:#8b94b8;--chip:#242b55;--card:#1b2242}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;background:radial-gradient(1200px 800px at 20% -10%,#1c2040,transparent),radial-gradient(1000px 600px at 120% 0%,#1b2550,transparent),var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(130%) blur(8px);background:linear-gradient(180deg,rgba(15,18,32,.9),rgba(15,18,32,.6));border-bottom:1px solid var(--border)}
.container{max-width:1100px;margin:0 auto;padding:18px 16px}.brand{display:flex;gap:12px;align-items:center}
.logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 210deg,#6ee7b7,#7aa2ff);display:grid;place-items:center;font-weight:900;color:#0a0d1c}
.tabs{display:flex;gap:8px;flex-wrap:wrap}.tab{background:var(--chip);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:999px;cursor:pointer}
.tab[aria-selected="true"]{background:linear-gradient(180deg,#1d2a57,#1a2450);border-color:#3a4aa0}
main .container{padding-top:22px}section{display:none}section.active{display:block}
.card{background:linear-gradient(180deg,#171d3a,#121632);border:1px solid var(--border);border-radius:16px}
.card .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:12px}
.card .bd{padding:16px}
.help{font-size:13px;color:var(--muted)}.muted{color:var(--muted)}
.btn{appearance:none;border:1px solid var(--border);background:var(--chip);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#2f3da2,#25337d);border-color:#3a4aa0}.btn.small{padding:6px 10px;border-radius:10px;font-size:13px}.btn.danger{background:linear-gradient(180deg,#7a2b2b,#5c2222);border-color:#8a2b2b}
.btn.toggle[aria-pressed="true"]{background:linear-gradient(180deg,#2b3a99,#22307c);border-color:#3a4aa0}
.grid{display:grid;gap:12px}.grid.cols-2{grid-template-columns:repeat(2,1fr)}.grid.cols-3{grid-template-columns:repeat(3,1fr)}.grid.cols-4{grid-template-columns:repeat(4,1fr)}.grid.responsive{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
input[type=text],input[type=number],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1331;color:#fff}
label{font-size:13px;color:var(--muted)}
table{width:100%;border-collapse:collapse}th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left}th{color:var(--muted);font-weight:600}
.match-card{border-radius:14px;border:1px solid var(--border);background:var(--card);overflow:hidden}
.match-card[aria-expanded="false"] .bd{display:none}.match-card[aria-expanded="true"] .bd{display:block}
.chip{font-size:12px;padding:4px 8px;background:var(--chip);border:1px solid var(--border);border-radius:999px;color:var(--muted)}
.pill{padding:4px 8px;border-radius:999px;background:#0f1331;border:1px solid var(--border);color:var(--muted);font-size:12px}
.pill.red{border-color:#ef4444;color:#fecaca;background:rgba(239,68,68,.08)}
.pill.yellow{border-color:#eab308;color:#fde68a;background:rgba(234,179,8,.10)}
.pill.green{border-color:#22c55e;color:#a7f3d0;background:rgba(34,197,94,.10)}
.pill.blue{border-color:#3b82f6;color:#bfdbfe;background:rgba(59,130,246,.10)} /* bonus BLEU */
.team-name{display:inline-flex;align-items:center;gap:8px;line-height:1.25;vertical-align:middle}
.match-card .hd .teams{display:flex;align-items:center;gap:10px}
.avatar{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:#0f1331;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;color:#cbd5ff;font-weight:700;font-size:14px;flex:0 0 auto}
.avatar img{width:100%;height:100%;object-fit:cover}.avatar .avatar-initials{display:inline-block;line-height:40px}
.avatar-lg{width:48px;height:48px;font-size:15px}.avatar-lg .avatar-initials{line-height:48px}
.avatar-sm{width:32px;height:32px;font-size:12px}.avatar-sm .avatar-initials{line-height:32px}
.h2h-pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-weight:600}
.h2h-win{border:1px solid #22c55e;color:#a7f3d0;background:rgba(34,197,94,.08)}
.h2h-loss{border:1px solid #ef4444;color:#fecaca;background:rgba(239,68,68,.08)}
.h2h-draw{border:1px solid #eab308;color:#fde68a;background:rgba(234,179,8,.08)}
.score-compact{font-variant-numeric:tabular-nums}

/* Bonus */
.bonus-btn{border:1px dashed #4b5bd7;background:transparent;color:#7aa2ff;padding:8px 10px;border-radius:12px;font-weight:700}.bonus-btn[disabled]{opacity:.45;cursor:not-allowed}
#bonus-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9998}
#bonus-modal.show{display:flex}
.bonus-dialog{width:min(560px,92vw);background:#141938;border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.5)}
.bonus-dialog .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700}
.bonus-dialog .bd{padding:16px}.bonus-dialog .ft{padding:12px 16px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border)}
.bonus-card{display:flex;gap:12px;align-items:center;margin:6px 0 12px;padding:10px;border:1px dashed #4b5bd7;border-radius:12px;background:#111636}
.bonus-illu{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;background:#0f1331;border:1px solid var(--border)}
.bonus-illu svg{width:36px;height:36px}

/* Couleur du badge #n selon l’état de journée */
.round-chip{font-weight:700}
.round-chip.red{border-color:#ef4444;color:#fecaca;background:rgba(239,68,68,.08)}
.round-chip.yellow{border-color:#eab308;color:#fde68a;background:rgba(234,179,8,.10)}
.round-chip.green{border-color:#22c55e;color:#a7f3d0;background:rgba(34,197,94,.10)}

#storage-warning{position:fixed;right:12px;bottom:12px;display:none;background:#0f1331;border:1px solid var(--border);color:var(--muted);border-radius:10px;padding:8px 10px;z-index:99;box-shadow:0 6px 24px rgba(0,0,0,.35)}
#js-ok{position:fixed;right:12px;top:12px;background:#7a2525;color:#fff;padding:6px 10px;border-radius:10px;z-index:9999;font:600 12px system-ui,Segoe UI,Roboto}

/* --------- RELOOK MATCH: 2 colonnes + encarts de sport --------- */
.match-two-col{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(340px,1fr));
  gap:16px;
}
.sport-group{
  background:linear-gradient(180deg,#151c3b,#131734);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
}
.sport-title{
  display:flex;align-items:center;gap:8px;
  font-weight:700;margin:0 0 10px;
}
.sport-title .sport-icon{width:18px;height:18px;display:grid;place-items:center;font-size:16px;line-height:1}
.sport-item{margin:0 0 10px}
.sport-item label{display:block;margin:0 0 6px;color:var(--muted)}
.ping-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ping-row input{width:100%}

.bonus-illu img{width:100%;height:100%;object-fit:cover;border-radius:12px}
.pill .mini-bonus{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;overflow:hidden;margin-left:6px;vertical-align:middle}
.pill .mini-bonus img{width:100%;height:100%;object-fit:cover}
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
window.FIREBASE_CONFIG={apiKey:"AIzaSyBSxiTryd0T1Flv15LBdzu31UFvU_I2J7Q",authDomain:"trisport-9a7b2.firebaseapp.com",databaseURL:"https://trisport-9a7b2-default-rtdb.europe-west1.firebasedatabase.app",projectId:"trisport-9a7b2",messagingSenderId:"132024051367",appId:"1:132024051367:web:f9aa39785a3d4a43875d82"};
</script>



<style id="bonus-scroll-fix">
.bonus-panel{ max-height:90vh; overflow:hidden; display:flex; flex-direction:column; }
.bonus-panel .hd{ position:sticky; top:0; background:var(--card); z-index:3; padding-bottom:8px; }
.bonus-panel .bd{ flex:1 1 auto; overflow:auto; -webkit-overflow-scrolling:touch; padding-right:6px; padding-bottom:calc(84px + env(safe-area-inset-bottom)); }
.bonus-panel .ft{ position:sticky; bottom:0; background:var(--card); padding-top:8px; z-index:3; box-shadow:0 -8px 12px rgba(0,0,0,.25); }
.bonus-select{ gap:8px; }
.bonus-dialog .bonus-card{ grid-template-columns:80px 1fr; padding:10px; border:2px dashed var(--border); border-radius:12px; }
.bonus-dialog .bonus-card .bonus-illu img{ width:72px; height:72px; border-radius:12px; }
.bonus-dialog .bonus-card.selected{ border-color: var(--blue); box-shadow: 0 0 0 2px rgba(75,139,255,.35) inset; }
</style>



<style id="brand-image-header">

/* ===== Header compact + brand images (reliable) ===== */
header, .topbar, .app-header{
  padding-block: 10px !important;
}
header .brand{ display:flex; align-items:center; gap:12px; }

/* Hide old text-based logo/title if present */
header .brand > .logo{ display:none !important; }
header .brand > h1{ display:none !important; }

/* Our real images */
.brand-logo{ width:64px; height:64px; border-radius:14px; display:block; }
.brand-title{ height:72px; width:auto; display:block; }

@media (max-width: 640px){
  .brand-title{ height:60px; }
}
@media (max-width: 420px){
  .brand-title{ height:48px; }
}

</style>
<style id="header-compact-keepimage">

/* ===== Ultra-compact header — keep logo/title sizes ===== */
header, .app-header, .topbar{
  padding-block: 6px !important;   /* reduce vertical padding without touching images */
  min-height: unset !important;
}
/* ensure children don't add extra vertical margins */
header *{
  margin-block: 0 !important;
}
/* layout + baseline fixes to avoid extra line-height space */
header .brand{ display:flex; align-items:center; gap:12px; }
header .brand img{ display:block; }             /* remove inline baseline gap */
header nav, header .tabs, header .menu{ display:flex; align-items:center; }
/* optional: slightly tighten chip/button vertical padding */
header .btn, header .chip, header .pill, header .tab{
  padding-top: 8px !important;
  padding-bottom: 8px !important;
}

/* keep the image sizes exactly as they are */
.brand-logo{ width:64px !important; height:64px !important; }
.brand-title{ height:72px !important; width:auto !important; }

/* fine-tune on small screens */
@media (max-width: 640px){
  header, .app-header, .topbar{ padding-block: 4px !important; }
}


/* --- Bonus panel: put params under the card text (minimal, scoped) --- */
#bonus-modal .bonus-dialog .bonus-card{display:grid!important;grid-template-columns:96px 1fr;gap:12px;align-items:start}
#bonus-modal .bonus-dialog .bonus-card .bonus-illu{grid-column:1;grid-row:1}
#bonus-modal .bonus-dialog .bonus-card .bonus-text{grid-column:2;grid-row:1}
#bonus-modal .bonus-dialog .bonus-card .bonus-params{grid-column:2;grid-row:2;margin-top:8px;max-height:0;overflow:hidden;transition:max-height .25s ease,opacity .2s;opacity:.0}
/* When JS opens the wrapper by setting max-height, fade in */
#bonus-modal .bonus-dialog .bonus-card .bonus-params[style*="max-height:"][style*="px"]{opacity:1}
</style>
</head>
<body>
<div id="js-ok">JS non chargé</div>
<script>(function(){const p=document.getElementById('js-ok');if(p){p.textContent='JS chargé ✅';p.style.background='#14532d';}})();</script>

<header>
  <div class="container" style="display:flex;align-items:center;gap:16px;justify-content:space-between;flex-wrap:wrap">
    <div class="brand"><div class="logo">T</div><h1 style="font-size:18px;margin:0">TriSports</h1></div>
    <nav class="tabs" role="tablist" aria-label="Sections" id="tabs">
      <button type="button" class="tab" role="tab" aria-selected="true" data-tab="setup">Tournoi</button>
      <button type="button" class="tab" role="tab" aria-selected="false" data-tab="equipes">Équipes</button>
      <button type="button" class="tab" role="tab" aria-selected="false" data-tab="calendrier">Rencontres</button>
      <button type="button" class="tab" role="tab" aria-selected="false" data-tab="classement">Classement</button>
      <button type="button" class="tab" role="tab" aria-selected="false" data-tab="options">Options</button>
    </nav>
    <div style="display:flex;align-items:center;gap:8px">
      <span id="tname-top" class="pill" style="display:none"></span>
      <span id="whoami-top" class="pill">visiteur</span>
      <button type="button" class="btn small" id="btn-fullscreen">⛶ Plein écran</button>
    </div>
  </div>
</header>

<main>
  <div class="container">
    <div id="storage-warning" class="help" style="display:none"></div>

    <!-- TOURNOI -->
    <section id="setup" class="active">
      <div style="display:flex;justify-content:flex-end;gap:8px;margin:4px 0 8px">
        <button type="button" class="btn small" id="btn-admin-on-setup">Se connecter admin</button>
        <span class="pill" id="whoami-setup">visiteur</span>
      </div>

      <div class="card">
        <div class="hd"><strong>Créer un tournoi (Cloud)</strong></div>
        <div class="bd grid cols-4">
          <div><label>Code cloud (ex: apero2025)</label><input type="text" id="tcode-input" placeholder="code unique"/></div>
          <div><label>Nom du tournoi</label><input type="text" id="tname-input" placeholder="ex : Tournoi de la plage"/></div>
          <div><label>Nombre d’équipes</label><input type="number" id="teams-count-input" min="2" max="64" step="1" value="4"/></div>
          <div></div>
          <div><label>Fléchettes – Simples (#)</label><input type="number" id="rule-d-s" min="0" max="9" value="2"/></div>
          <div><label>Fléchettes – Doubles (#)</label><input type="number" id="rule-d-d" min="0" max="9" value="1"/></div>
          <div><label>Points / victoire fléchettes</label><input type="number" id="rule-d-p" min="1" max="50" value="5"/></div>
          <div></div>
          <div><label>Ping – Simples (#)</label><input type="number" id="rule-p-s" min="0" max="9" value="2"/></div>
          <div><label>Ping – Doubles (#)</label><input type="number" id="rule-p-d" min="0" max="9" value="1"/></div>
          <div><label>Points / victoire ping</label><input type="number" id="rule-p-p" min="1" max="50" value="5"/></div>
          <div></div>
          <div><label>Palet – Score cible (victoire)</label><input type="number" id="rule-l-target" min="1" max="50" value="11"/></div>
          <div style="grid-column:1/-1;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button type="button" class="btn primary" id="btn-create-tournament">Créer et ouvrir</button>
            <span class="help">Création réservée à l’<b>administrateur</b> (PIN requis).</span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>Ouvrir un tournoi existant (Cloud)</strong></div>
        <div class="bd" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input type="text" id="join-code" placeholder="code du tournoi" style="max-width:220px"/>
          <button type="button" class="btn primary" id="btn-join-code">Rejoindre</button>
          <button type="button" class="btn" id="btn-copy-link">Copier lien ?id=code</button>
          <span class="help">Statut : <span id="cloud-status">hors ligne</span></span>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>Tournois Cloud récents (ce navigateur)</strong></div>
        <div class="bd" id="recent-list"><div class="help">Aucun tournoi cloud listé pour l’instant.</div></div>
      </div>
    </section>

    <!-- EQUIPES -->
    <section id="equipes">
      <div class="card">
        <div class="hd">
          <div>
            <strong>Équipes</strong>
            <div class="help">L’<b>administrateur</b> crée et édite les équipes. Les joueurs se connectent à leur équipe pour saisir <b>leurs scores</b> uniquement.</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="pill" id="lock-pill" style="display:none">Calendrier figé 🔒</span>
            <button type="button" class="btn" id="btn-add-team" style="display:none">+ Ajouter équipe (admin)</button>
            <button type="button" class="btn primary" id="btn-generate">Générer le calendrier</button>
          </div>
        </div>
        <div class="bd"><div id="team-list" class="grid responsive"></div></div>
      </div>
    </section>

    <!-- RENCONTRES -->
    <section id="calendrier">
      <div class="card">
        <div class="hd">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <strong>Rencontres</strong>
            <span class="pill" id="round-status">—</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="pill" id="stats-matches">0 / 0 matches complets</span>
            <button type="button" class="btn small" id="btn-start-round" style="display:none">Démarrer journée</button>
            <button type="button" class="btn small" id="btn-end-round" style="display:none">Fin de journée</button>
            <button type="button" class="btn small" id="btn-refresh-standings">Mettre à jour le classement</button>
            <button type="button" class="btn small" id="btn-collapse">Tout replier</button>
          </div>
        </div>
        <div class="bd"><div id="match-list" class="grid"></div></div>
      </div>
    </section>

    <!-- CLASSEMENT -->
    <section id="classement">
      <div class="card">
        <div class="hd">
          <strong>Classement</strong>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="pill" id="teams-count">0 équipes</span>
            <span class="pill" id="rounds-count">0 matchs par équipe</span>
            <button type="button" class="btn small toggle" id="btn-show-summary" aria-pressed="true">Classement général</button>
            <button type="button" class="btn small toggle" id="btn-show-h2h" aria-pressed="false">Face à face</button>
            <button type="button" class="btn small" id="btn-refresh-standings-2">Mettre à jour</button>
          </div>
        </div>
        <div class="bd" style="overflow:auto">
          <div id="view-summary">
            <div class="help" style="margin-bottom:10px">Points = base + Bonus − Malus. Le bonus “Capitaine” est révélé à la fin de la journée.</div>
            <table id="table-classement">
              <thead>
                <tr>
                  <th>#</th><th>Équipe</th><th>Points</th>
                  <th>Fléchettes</th><th>Ping-pong</th><th>Palet (PF–PA)</th>
                  <th>Bonus</th><th>Malus</th>
                  <th>Matchs complets</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="view-h2h" style="display:none">
            <div class="help" style="margin-bottom:10px">Face-à-face : cliquez sur une cellule pour ouvrir la rencontre.</div>
            <table id="table-h2h" class="h2h-table"><thead></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <!-- OPTIONS -->
    <section id="options">
      <div class="grid cols-2">
        <div class="card"><div class="hd"><strong>Exporter / Importer</strong></div>
          <div class="bd grid" style="gap:10px">
            <button type="button" class="btn" id="btn-export">Exporter en JSON</button>
            <input type="file" id="file-import" accept="application/json"/>
            <button type="button" class="btn" id="btn-import">Importer le fichier JSON</button>
          </div>
        </div>
        <div class="card"><div class="hd"><strong>Accès administrateur</strong></div>
          <div class="bd" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button type="button" class="btn" id="btn-admin-on">Activer admin</button>
            <button type="button" class="btn" id="btn-admin-off">Désactiver admin</button>
            <span class="pill" id="whoami">vous : visiteur (lecture seule)</span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>Gestion Cloud</strong></div>
        <div class="bd" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <span class="pill">Statut : <span id="cloud-status-2">hors ligne</span></span>
          <button type="button" class="btn" id="btn-cloud-copy">Copier le lien de partage</button>
          <button type="button" class="btn danger" id="btn-cloud-delete">Supprimer ce tournoi du cloud</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>Tournois Cloud récents</strong></div>
        <div class="bd" id="manage-list"><div class="help">Aucun tournoi mémorisé.</div></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>Maintenance</strong></div>
        <div class="bd grid" style="gap:10px">
          <button type="button" class="btn" id="btn-reset-scores">Réinitialiser les scores (garde équipes + calendrier)</button>
          <button type="button" class="btn" id="btn-unlock">🔓 Déverrouiller le calendrier</button>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- MODAL BONUS -->
<div id="bonus-modal" aria-hidden="true">
  <div class="bonus-panel bonus-dialog">
    <div class="hd">Choisir un bonus</div>
    <div class="bd">

      <div class="bonus-select">
        <!-- Capitaine -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/capitaine.jpg" alt=""></div>
          <div class="bonus-text">
            <div class="bonus-title">Capitaine</div>
            <div class="help">Choisissez un joueur (J1/J2) et un sport.<br/>À la fin de la journée : <b>+5 pts par victoire</b> du capitaine dans ce sport (les doubles comptent).</div>
          </div>
        </div>

        <div class="bonus-sep"></div>

        <!-- Miroir -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/miroir.jpg" alt=""></div>
          <div class="bonus-text">
            <div class="bonus-title">Miroir</div>
            <div class="help">Inverse le bonus adverse sur <b>tout le match</b>.<br/>Ex : si l’adversaire choisit <b>Capitaine</b>, son Capitaine s’applique à votre équipe.</div>
          </div>
        </div>

        <div class="bonus-sep"></div>

        <!-- René la taupe -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/taupe.png" alt=""></div>
          <div class="bonus-text">
            <div class="bonus-title">René la taupe</div>
            <div class="help">Impose des lunettes troublant la vision à l’adversaire dans un sport choisi.<br/>Si l’adversaire joue <b>Miroir</b>, <i>vous</i> portez les lunettes.</div>
          </div>
        </div>

        <div class="bonus-sep"></div>

        <!-- 10 pouces 2 mains gauche -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/main gauche.png" alt=""></div>
          <div class="bonus-text">
            <div class="bonus-title">10 pouces 2 mains gauche</div>
            <div class="help">L’adversaire doit jouer un sous‑match avec sa <b>mauvaise main</b> (droitier → main gauche, gaucher → main droite).<br/>Choisissez le sport concerné.</div>
          </div>
        </div>
      </div>

      
        <div class="bonus-sep"></div>

        <!-- Melon d'or -->
        <div class="bonus-card" tabindex="0" role="button" aria-label="Bonus Melon d’or">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/melon.png" alt="Melon d’or"></div>
          <div class="bonus-text">
            <div class="bonus-title">Melon d’or</div>
            <div class="help">Cible un <b>sous‑match</b> (fléchettes, ping ou palet). Victoire : <b>double les points</b>. Défaite : <b>−2× l’écart</b> des scores.</div>
          </div>
        </div>
<div class="help" id="bonus-context">Capitaine : choisissez le joueur et le sport concernés.</div>

      <!-- Paramètres (insérés sous la carte correspondante) -->
      <div id="capitaine-fields" class="grid cols-2" style="margin-top:10px">
        <div><label>Capitaine (joueur)</label>
          <select id="bonus-player"><option value="p1">Joueur 1</option><option value="p2">Joueur 2</option></select>
        </div>
        <div><label>Sport</label>
          <select id="bonus-sport"><option value="darts">Fléchettes</option><option value="ping">Ping</option><option value="palet">Palet</option></select>
        </div>
      </div>

      <div id="taupe-fields" class="grid cols-2" style="margin-top:10px">
        <div><label>Sport</label>
          <select id="taupe-sport"><option value="darts">Fléchettes</option><option value="ping">Ping</option><option value="palet">Palet</option></select>
        </div>
      </div>

      <div id="lefthand-fields" class="grid cols-2" style="margin-top:10px">
        <div><label>Sport</label>
          <select id="lefthand-sport"><option value="darts">Fléchettes</option><option value="ping">Ping</option><option value="palet">Palet</option></select>
        </div>
      </div>
      <div id="melon-fields" class="grid cols-3" style="margin-top:10px">
        <div><label>Sport</label>
          <select id="melon-sport"><option value="darts">Fléchettes</option><option value="ping">Ping</option><option value="palet">Palet</option></select>
        </div>
        <div><label>Sous‑match</label>
          <select id="melon-index"></select>
        </div>
      </div>


    </div>
    <div class="ft">
      <button type="button" class="btn" id="bonus-cancel">Annuler</button>
      <button type="button" class="btn primary" id="bonus-save">Valider</button>
    </div>
  </div>
</div>

<script>
'use strict';
/* ===== Helpers ===== */

/**
 * @typedef {Object} RoundCtl
 * @property {boolean} started
 * @property {boolean} finished
 *
 * @typedef {Object.<string, any>} Team
 *
 * @typedef {Object} AppState
 * @property {number} version
 * @property {string} tid
 * @property {string|null} cloudId
 * @property {string} tournamentName
 * @property {Object} rules
 * @property {Array<Team>} teams
 * @property {Array<any>} matches
 * @property {Object.<number, RoundCtl>} roundCtl
 * @property {Object.<number, Object.<string, any>>} bonusSelections
 * @property {Object.<number, Object.<string, number>>} bonusApplied
 * @property {Object.<number, Object.<string, boolean>>} bonusUsed
 */


// Centralise libellés/images pour les bonus (évite les erreurs de frappe)
const BONUS = {
  /** @param {"capitaine"|"miroir"|"taupe"|"lefthand"|string} type */
  labelForType(type){
    switch(type){
      case "miroir": return "Miroir";
      case "taupe": return "René la taupe";
      case "lefthand": return "Main gauche";
      default: return "Capitaine";
    }
  },
  imgForType(type){
    switch(type){
      case "miroir": return "miroir.jpg";
      case "taupe": return "taupe.png";
      case "lefthand": return "main gauche.png";
      default: return "capitaine.jpg";
    }
  },
  sportLabel(s){ return s==="darts"?"Fléchettes":(s==="ping"?"Ping":"Palet"); },
  playerLabel(p){ return p==="p1"?"J1":"J2"; }
};
// Helpers sûrs pour initialiser les containers imbriqués
function ensure(obj, key, defFactory){
  if(!obj[key]) obj[key] = defFactory();
  return obj[key];
}

const id=x=>document.getElementById(x), qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const esc=s=>(s==null?"":String(s)).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","\"":"&quot;","'":"&#39;"}[c]));
const uid=()=>Math.random().toString(36).slice(2,10);
const clampInt=(v,min,max)=>{v=parseInt(v,10);if(isNaN(v))return null;return Math.max(min,Math.min(max,v));}
const help=t=>{const d=document.createElement("div");d.className="help";d.textContent=t;return d;}
function hashPass(s){s=(s||"").trim();let h=0x811c9dc5>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,0x01000193)>>>0}return("00000000"+h.toString(16)).slice(-8)}
const hy=(a,b)=>`${a}\u2011${b}`;
const BONUS_VAL=5;

/* ===== Erreurs visibles ===== */
window.onerror=(msg,src,line,col)=>{const el=id("storage-warning");if(el){el.style.display="block";el.textContent="Erreur JS : "+msg+" @"+(src||"")+":"+(line||0)+":"+(col||0)} const p=id("js-ok");if(p){p.textContent='JS chargé avec erreurs ⚠️';p.style.background='#8a2a2a'}};

/* ===== Index Cloud (local) ===== */
const STORAGE_KEY="trisports_cloud_only_v1"; const IDX_KEY="trisports_cloud_index_v1";
function getIndex(){try{return JSON.parse(localStorage.getItem(IDX_KEY)||"[]")}catch(_){return[]}}
function setIndex(a){try{localStorage.setItem(IDX_KEY,JSON.stringify(a||[]))}catch(_){}}
function upsertIndex(e){const i=getIndex();const k=i.findIndex(x=>x.id===e.id);if(k>=0)i[k]=Object.assign({},i[k],e);else i.unshift(e);setIndex(i)}
function nameExistsLocally(n){n=(n||"").trim().toLowerCase();if(!n)return false;return getIndex().some(e=>(e.name||"").trim().toLowerCase()===n)}
function codeExistsLocally(c){return getIndex().some(e=>e.id===c)}
function renderSetupRecent(){const wrap=id("recent-list");wrap.innerHTML="";const idx=getIndex().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));if(!idx.length){wrap.appendChild(help("Aucun tournoi cloud listé pour l’instant."));return}const box=document.createElement("div");box.style.display="flex";box.style.flexWrap="wrap";box.style.gap="8px";idx.forEach(e=>{const btn=document.createElement("button");btn.className="btn";btn.type="button";btn.textContent="☁ "+e.name+" ("+e.id+")";btn.dataset.openId="cloud:"+e.id;const del=document.createElement("button");del.className="btn danger";del.type="button";del.textContent="Supprimer du cloud";del.dataset.deleteId=e.id;const w=document.createElement("div");w.style.display="flex";w.style.gap="6px";w.append(btn,del);box.appendChild(w)});wrap.appendChild(box)}
function renderManageList(){renderSetupRecent()}

/* ===== État ===== */
let state={version:40,tid:uid(),cloudId:null,tournamentName:"",rules:{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11},teams:[],matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};
let ui={open:{},h2h:false}; let session={admin:false,claims:{}};
function isAdmin(){return !!session.admin} function hasClaim(tid){return !!session.claims[tid]}
// === Droits de saisie des scores selon l'état de la journée ===
function _iAmTeamOf(m){ return hasClaim(m.a) || hasClaim(m.b); }
function canEditScores(m, rCtl){
  if (!rCtl.started && !rCtl.finished) return false; // pas commencé -> personne
  if (rCtl.finished) return isAdmin();               // terminé -> admin seul
  return isAdmin() || _iAmTeamOf(m);                 // en cours -> admin + équipe du match
}

function teamObj(tid){return state.teams.find(t=>t.id===tid)||null} function teamName(tid){const t=teamObj(tid);return t?t.name:"—"}
function initials(name){const s=(name||"").trim();if(!s)return"?";const p=s.split(/\s+/);return(p[0][0]+(p[1]?.[0]||"")).toUpperCase()}
function avatarHtml(tid,size,attrs){const t=teamObj(tid)||{name:"?"};const url=t.avatar;const cls=size==='lg'?'avatar-lg':(size==='sm'?'avatar-sm':'');const extra=attrs?(' '+attrs):'';const content=url?('<img src="'+esc(url)+'" alt="avatar">'):('<span class="avatar-initials">'+esc(initials(t.name))+'</span>');return '<span class="avatar '+cls+'" title="'+esc(t.name)+'"'+extra+'>'+content+'</span>'}
function updateWho(){const names=Object.keys(session.claims||{}).map(teamName).filter(Boolean);const who=isAdmin()?(names.length?("Admin · "+names.join(", ")):"Admin"):(names[0]||"visiteur");id("whoami").textContent="vous : "+who;id("whoami-top").textContent=who;const s=id("whoami-setup");if(s)s.textContent=who;const b=id("btn-add-team");if(b)b.style.display=isAdmin()?"inline-block":"none";const ba=id("btn-admin-on-setup");if(ba)ba.style.display=isAdmin()?"none":"inline-block"}
function renderTitle(){const name=(state.tournamentName||"").trim();document.title=(name?name+" — ":"")+"TriSports — Fléchettes • Ping-pong • Palet";const pill=id("tname-top");if(name){pill.style.display="inline-block";pill.textContent=name}else{pill.style.display="none";pill.textContent=""}}
function dartsTotal(){return (state.rules?.dartsSingles||0)+(state.rules?.dartsDoubles||0)}
function pingTotal(){return (state.rules?.pingSingles||0)+(state.rules?.pingDoubles||0)}
function ensureLengths(m){const dN=dartsTotal(),pN=pingTotal();m.darts=Array.isArray(m.darts)?m.darts.slice(0,dN):[];while(m.darts.length<dN)m.darts.push(null);if(!Array.isArray(m.pingPts))m.pingPts=[];m.pingPts=m.pingPts.slice(0,pN);while(m.pingPts.length<pN)m.pingPts.push({a:null,b:null});}
function _normMatch(m){m=m||{};m.id=m.id||uid();m.a=m.a||"";m.b=m.b||"";ensureLengths(m);m.palet=m.palet||{a:null,b:null};m.palet.a=(m.palet.a==null?null:+m.palet.a);m.palet.b=(m.palet.b==null?null:+m.palet.b);m.round=m.round||1;m.order=m.order||0;return m}
function normalize(){state.rules=state.rules||{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11};state.teams=Array.isArray(state.teams)?state.teams:[];state.matches=Array.isArray(state.matches)?state.matches.map(_normMatch):[];state.protect=state.protect||{};state.protect.teamPassHash=state.protect.teamPassHash||{};state.roundCtl=state.roundCtl||{};state.bonusSelections=state.bonusSelections||{};state.bonusApplied=state.bonusApplied||{};state.bonusUsed=state.bonusUsed||{};state.bonusUsed=state.bonusUsed||{}}

/* ===== Firebase ===== */
const cloud={enabled:false,db:null,id:null,ref:null,timer:null}; const hasFB=!!(window.firebase&&window.FIREBASE_CONFIG&&window.FIREBASE_CONFIG.apiKey);
function initFB(){try{if(!hasFB)return null;if(!firebase.apps||firebase.apps.length===0)firebase.initializeApp(window.FIREBASE_CONFIG);return firebase.database()}catch(_){return null}}
function setCloudTxt(t){id("cloud-status").textContent=t;id("cloud-status-2").textContent=t}
function unsubscribeCloud(){try{if(cloud.ref)cloud.ref.off('value')}catch(_){ }cloud.ref=null;cloud.enabled=false;cloud.id=null;setCloudTxt('hors ligne')}
function resetState(){state={version:40,tid:uid(),cloudId:null,tournamentName:"",rules:{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11},teams:[],matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};try{localStorage.removeItem(STORAGE_KEY)}catch(_){}} 
function joinCloud(code){if(!hasFB){alert("Firebase non configuré.");return}if(!cloud.db){cloud.db=initFB();if(!cloud.db){alert("Init Firebase impossible.");return}}unsubscribeCloud();cloud.id=(code||"").trim();if(!cloud.id){alert("Saisis un code tournoi.");return}cloud.ref=cloud.db.ref("tournaments/"+cloud.id+"/payload");cloud.enabled=true;setCloudTxt("connexion");cloud.ref.on("value",snap=>{const val=snap.val();if(!val){setCloudTxt("connecté (vide)");return}safeSetStateFromCloud(val);normalize();state.cloudId=cloud.id;localStorage.setItem(STORAGE_KEY,JSON.stringify(state));upsertIndex({id:cloud.id,name:state.tournamentName||"Sans titre",updatedAt:Date.now()});renderAll();setCloudTxt("connecté ("+cloud.id+")")});try{history.replaceState(null,"",location.pathname+"?id="+encodeURIComponent(cloud.id))}catch(_){}}

function safeSetStateFromCloud(val){
  try{
    if(!val || typeof val!=="object" || !val.state || typeof val.state!=="object"){
      // pas d'état valide côté cloud : on laisse l'état local tel quel
      return;
    }
    state = val.state;
  }catch(_){ /* on ignore, on garde l'état local */ }
}

function pushCloud(immediate){if(!cloud.enabled||!cloud.ref)return;clearTimeout(cloud.timer);cloud.timer=setTimeout(()=>cloud.ref.set({state,updatedAt:Date.now()}),immediate?0:250)}
function deleteCloud(code){if(!cloud.db){cloud.db=initFB()}return cloud.db.ref("tournaments/"+code).remove()}
function saveState(){normalize();localStorage.setItem(STORAGE_KEY,JSON.stringify(state));upsertIndex({id:state.cloudId||cloud.id||"?",name:state.tournamentName||"Sans titre",updatedAt:Date.now()});renderTitle();renderSetupRecent();renderManageList();if(cloud.enabled)pushCloud()}

/* Plein écran */
document.addEventListener("fullscreenchange",()=>{const b=id("btn-fullscreen");if(!b)return;b.textContent=document.fullscreenElement?"Quitter plein écran":"⛶ Plein écran"});

/* ===== Calendrier ===== */
function generateSchedule(){const ids=state.teams.map(t=>t.id);if(ids.length<2){state.matches=[];saveState();renderMatches();return}const BYE="__BYE__";if(ids.length%2===1)ids.push(BYE);const fixed=ids[0],rest=ids.slice(1);for(let i=rest.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[rest[i],rest[j]]=[rest[j],rest[i]]}const n=ids.length,rounds=n-1;const out=[];let order=0;for(let r=0;r<rounds;r++){const arr=[fixed].concat(rest),half=n/2,pairs=[];for(let k=0;k<half;k++){const a=arr[k],b=arr[n-1-k];if(a!==BYE&&b!==BYE)pairs.push((r%2===0)?[a,b]:[b,a])}rest.unshift(rest.pop());if(pairs.length>1){let shift=r%pairs.length;while(shift-->0)pairs.unshift(pairs.pop())}for(const pr of pairs){out.push(_normMatch({id:uid(),a:pr[0],b:pr[1],darts:Array(dartsTotal()).fill(null),pingPts:Array(pingTotal()).fill({a:null,b:null}),palet:{a:null,b:null},round:r+1,order:order++}))}}out.sort((x,y)=>(x.round-y.round)||(x.order-y.order));state.matches=out;ui.open={};state.roundCtl={};state.bonusSelections={};state.bonusApplied={};saveState();renderMatches()}
function renderTeams(){const el=id("team-list");el.innerHTML="";if(!state.teams.length){el.appendChild(help("Aucune équipe. Utilisez l’onglet « Tournoi » pour créer/rejoindre un tournoi cloud."));updateCounts();updateLock();return}state.teams.forEach((t,idx)=>{const iOwn=hasClaim(t.id),admin=isAdmin(),hasHash=!!(state.protect?.teamPassHash?.[t.id]);const dis=admin?'':' disabled';const delBtn=(admin&&!state.locked)?`<button type="button" class="btn small danger" data-act="del" data-id="${t.id}">Supprimer</button>`:'';const protectInfo=hasHash?(iOwn?'🔒 vous êtes connecté à cette équipe':'🔒 protégée par mot de passe'):'🔓 non protégée — demandez à l’admin de définir un mot de passe';const protectBtns=(admin?`<button type="button" class="btn small" data-act="setpass" data-id="${t.id}">Définir / changer mot de passe</button>`:'')+(!iOwn?`<button type="button" class="btn small" data-act="login" data-id="${t.id}">Se connecter à cette équipe</button>`:`<button type="button" class="btn small" data-act="logout" data-id="${t.id}">Se déconnecter</button>`);const avatarBtn=(admin||iOwn)?`<button type="button" class="btn small" data-act="avatar" data-id="${t.id}">Changer avatar</button>`:'';const avatarClr=((admin||iOwn)&&t.avatar)?`<button type="button" class="btn small" data-act="avatar-clear" data-id="${t.id}">Retirer avatar</button>`:'';const card=document.createElement("div");card.className="match-card";card.setAttribute("aria-expanded","true");card.innerHTML=`<div class="hd team-header" style="border:none;border-bottom:1px solid var(--border)"><div class="teams"><span class="chip">#${idx+1}</span><span class="team-name">${avatarHtml(t.id,'lg','data-click-avatar="'+t.id+'"')}<input type="text"${dis} value="${esc(t.name)}" data-field="name" data-id="${t.id}"/></span></div></div><div class="bd"><input type="file" accept="image/*" data-avatar="${t.id}" style="display:none"/><div class="grid cols-2"><div><label>Joueur·se 1</label><input type="text"${dis} value="${esc(t.p1)}" data-field="p1" data-id="${t.id}"/></div><div><label>Joueur·se 2</label><input type="text"${dis} value="${esc(t.p2)}" data-field="p2" data-id="${t.id}"/></div></div><div class="help" style="margin-top:6px">${protectInfo}</div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${avatarBtn}${avatarClr}${protectBtns}</div><div style="display:flex;justify-content:flex-end;margin-top:10px">${delBtn}</div></div>`;el.appendChild(card)});qsa('#team-list input[data-field]').forEach(inp=>{const tid=inp.getAttribute("data-id"),f=inp.getAttribute("data-field");inp.addEventListener("input",()=>{if(!isAdmin())return;const t=teamObj(tid);if(!t)return;t[f]=inp.value;localStorage.setItem(STORAGE_KEY,JSON.stringify(state))});inp.addEventListener("blur",()=>{if(!isAdmin())return;const t=teamObj(tid);if(!t)return;t[f]=inp.value;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()})});qsa('#team-list input[type="file"][data-avatar]').forEach(inp=>{inp.addEventListener("change",async()=>{const tid=inp.getAttribute("data-avatar");if(!(isAdmin()||hasClaim(tid)))return;const file=inp.files?.[0];if(!file)return;try{const url=await fileToSquareDataURL(file,160);const t=teamObj(tid);if(!t)return;t.avatar=url;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}catch{alert("Échec du chargement de l’avatar.")}finally{inp.value=""}})});updateCounts();updateLock()}
function fileToSquareDataURL(file,size){return new Promise((resolve,reject)=>{const r=new FileReader();r.onerror=()=>reject(new Error("read"));r.onload=()=>{const img=new Image();img.onload=()=>{try{const m=Math.min(img.width,img.height),sx=(img.width-m)/2,sy=(img.height-m)/2;const c=document.createElement("canvas");c.width=size;c.height=size;c.getContext('2d').drawImage(img,sx,sy,m,m,0,0,size,size);resolve(c.toDataURL('image/jpeg',0.9))}catch(e){reject(e)}};img.onerror=()=>reject(new Error("img"));img.src=r.result};r.readAsDataURL(file)})}
function updateCounts(){id("teams-count").textContent=state.teams.length+" "+(state.teams.length>1?"équipes":"équipe");const per=Math.max(0,state.teams.length-1);id("rounds-count").textContent=per+" "+(per>1?"matchs":"match")+" par équipe"}
function updateLock(){const pill=id("lock-pill");if(pill)pill.style.display=state.locked?"inline-block":"none";const gen=id("btn-generate");if(gen){gen.disabled=!!state.locked;gen.textContent=state.locked?"Calendrier figé":"Générer le calendrier"}}

/* ===== Rencontres & Scores ===== */
const getPingPts=m=>Array.isArray(m.pingPts)?m.pingPts:Array(pingTotal()).fill({a:null,b:null});
const isPingValid=(a,b)=>{if(a==null||b==null)return false;if(isNaN(a)||isNaN(b))return false;const max=Math.max(a,b),diff=Math.abs(a-b);return(max>=11)&&(diff>=2)}
function computeSetWins(m){ensureLengths(m);const aw={darts:0,ping:0},bw={darts:0,ping:0};m.darts.forEach(v=>{if(v===0)aw.darts++;else if(v===1)bw.darts++});getPingPts(m).forEach(s=>{const a=(s.a==null?null:+s.a),b=(s.b==null?null:+s.b);if(isPingValid(a,b)){if(a>b)aw.ping++;else if(b>a)bw.ping++}});return{aw,bw}}
function isMatchComplete(m){ensureLengths(m);const okD=m.darts.every(v=>v===0||v===1);const okP=getPingPts(m).every(s=>isPingValid(+s.a,+s.b));const T=+state.rules.paletTarget||11,pa=(m.palet?.a==null?null:+m.palet?.a),pb=(m.palet?.b==null?null:+m.palet?.b);const okL=(pa!=null&&pb!=null)&&((pa===T&&pb>=0&&pb<=T-1)||(pb===T&&pa>=0&&pa<=T-1));return okD&&okP&&okL}
const findMatch=mid=>state.matches.find(x=>x.id===mid);
function clearMatch(mid){const m=findMatch(mid);if(!m)return;if(!(isAdmin()||hasClaim(m.a)||hasClaim(m.b)))return;if(!confirm("Effacer tous les scores de ce match ?"))return;m.darts=Array(dartsTotal()).fill(null);m.pingPts=Array(pingTotal()).fill({a:null,b:null});m.palet={a:null,b:null};saveState();renderMatches()}

/* ===== Bonus ===== */
function roundState(r){state.roundCtl[r]=state.roundCtl[r]||{started:false,finished:false};return state.roundCtl[r]}
function setBonusSelection(r,tid,sel){state.bonusSelections[r]=state.bonusSelections[r]||{};state.bonusSelections[r][tid]=sel}
function getBonusSelection(r,tid){return(state.bonusSelections[r]||{})[tid]||null}
function setBonusApplied(r,tid,pts){state.bonusApplied[r]=state.bonusApplied[r]||{};state.bonusApplied[r][tid]=pts}
function getBonusAppliedSum(tid){let s=0;for(const r in state.bonusApplied){const v=state.bonusApplied[r]?.[tid];if(v)s+=v}return s}
function teamBonusUsed(tid){const t=teamObj(tid);return !!(t&&t.bonusCapitaineUsed)}function markTeamBonusUsed(tid){const t=teamObj(tid);if(t)t.bonusCapitaineUsed=true}

/* Capitaine — calcul robuste */
function computeCapitaineBonusForMatch(m, tid, player, sport){
  let gain = 0;
  const isA = (m.a === tid), isB = (m.b === tid);
  if (!isA && !isB) return 0;

  if (sport === 'darts') {
    const sSingles = state.rules.dartsSingles || 0;
    m.darts.forEach((v,i)=>{
      if (v!==0 && v!==1) return;
      const won = isA ? (v===0) : (v===1);
      if (!won) return;
      if (i < sSingles) {
        const which = (i===0 ? 'p1' : 'p2');
        if (which === player) gain += BONUS_VAL;
      } else {
        gain += BONUS_VAL;
      }
    });
  } else if (sport === 'ping') {
    const sSingles = state.rules.pingSingles || 0;
    getPingPts(m).forEach((s,i)=>{
      const a = (s.a==null?null:+s.a);
      const b = (s.b==null?null:+s.b);
      if (!isPingValid(a,b)) return;
      const won = isA ? (a>b) : (b>a);
      if (!won) return;
      if (i < sSingles) {
        const which = (i===0 ? 'p1' : 'p2');
        if (which === player) gain += BONUS_VAL;
      } else {
        gain += BONUS_VAL;
      }
    });
  } else if (sport === 'palet') {
    const T = +state.rules.paletTarget || 11;
    const a = (m.palet?.a==null?null:+m.palet.a);
    const b = (m.palet?.b==null?null:+m.palet.b);
    if ((isA && a===T) || (isB && b===T)) gain += BONUS_VAL;
  }
  return gain;
}
/* Melon d’or — double si victoire sur un sous‑match ; sinon malus = 2× l’écart */
function computeMelonBonusForMatch(m, tid, sel){
  try{
    const R = state.rules||{};
    const sport = sel?.sport || 'darts';
    const idx = Math.max(1, +sel?.index||1);
    const isA = (m.a===tid), isB = (m.b===tid);
    if(!isA && !isB) return 0;
    if(sport==='ping'){
      const sets = (typeof getPingPts==='function') ? (getPingPts(m)||[]) : [];
      const s = sets[idx-1]; if(!s) return 0;
      const a = (s.a==null?null:+s.a), b = (s.b==null?null:+s.b);
      if(!isPingValid(a,b)) return 0;
      const my = isA ? a : b, opp = isA ? b : a;
      if(my>opp) return +R.pingWinPoints||0;
      if(my<opp) return -2*Math.abs(my-opp);
      return 0;
    } else if(sport==='palet'){
      const T = +R.paletTarget || 11;
      const a = (m.palet?.a==null?null:+m.palet.a);
      const b = (m.palet?.b==null?null:+m.palet.b);
      if(a==null || b==null) return 0;
      const my = isA ? a : b, opp = isA ? b : a;
      if((isA && a===T) || (isB && b===T)) return my||0;
      return -2*Math.abs(my-opp);
    } else { // darts
      const v = Array.isArray(m.darts) ? m.darts[idx-1] : null;
      if(v==null) return 0;
      const win = (isA && v===0) || (isB && v===1);
      return win ? (+R.dartsWinPoints||0) : (-2*(+R.dartsWinPoints||0));
    }
  }catch(e){}
  return 0;
}


/* Icônes pour titres de sport */
function sportIcon(name){
  if(name==='darts'){ return `<span class="sport-icon" role="img" aria-label="fléchettes">🎯</span>`; }
  if(name==='ping'){  return `<span class="sport-icon" role="img" aria-label="ping-pong">🏓</span>`; }
  return `<span class="sport-icon" role="img" aria-label="palet">🥏</span>`;
}

/* ===== Rendu Rencontres ===== */
let CURRENT_ROUND=null;
function setRoundStatusPillClasses(pill,rs){
  pill.classList.remove('red','yellow','green');
  if(rs.finished) pill.classList.add('green');
  else if(rs.started) pill.classList.add('yellow');
  else pill.classList.add('red');
}
function bonusChip(r,mTeam,rs){
  const sel = getBonusSelection(r, mTeam);
  const iAmTeam = hasClaim(mTeam);
  const roundFinished = !!rs.finished;

  // Admin : ne voit rien avant la fin de journée
  if (isAdmin() && !roundFinished) return '';

  // Rien choisi → afficher un bouton uniquement pour l'équipe concernée, avant le début.
  const canChoose = (!rs.started && !rs.finished && !(state.bonusUsed?.[r]?.[mTeam]) && iAmTeam);
  if (!sel) {
    return canChoose ? `<button type="button" class="bonus-btn" data-bonus data-team="${mTeam}">🎖 Bonus</button>` : '';
  }

  // Déjà choisi : avant fin, visible UNIQUEMENT pour l'équipe concernée
  if (!roundFinished && !iAmTeam) return '';

  // Affichage
  if (!roundFinished) {
    // Secret: pilule "Capitaine" + mini image
    const __lbl = sel.type==='miroir'?'Miroir':(sel.type==='taupe'?'René la taupe':(sel.type==='lefthand'?'10 pouces 2 mains gauche':'Capitaine')); const __img = sel.type==='miroir'?'miroir.jpg':(sel.type==='taupe'?'taupe.png':(sel.type==='lefthand'?'main gauche.png':'capitaine.jpg')); return `<span class="pill blue">${__lbl}<span class="mini-bonus"><img src="img/${__img}" alt=""></span></span>`;
  } else {
    // Révélé à tout le monde
    const labelPlayer = sel.player === 'p1' ? 'J1' : 'J2';
    const labelSport = sel.sport === 'darts' ? 'Fléchettes' : (sel.sport === 'ping' ? 'Ping' : 'Palet');
    const applied = (state.bonusApplied?.[r]?.[mTeam]) || 0; const type = sel.type || 'capitaine'; const lblType = type==='miroir' ? 'Miroir' : (type==='taupe' ? 'René la taupe' : (type==='lefthand' ? 'Main gauche' : 'Capitaine')); const img = type==='miroir' ? 'miroir.jpg' : (type==='taupe' ? 'taupe.png' : (type==='lefthand' ? 'main gauche.png' : 'capitaine.jpg')); return `<span class="pill blue">${lblType} ${type==='capitaine' ? labelPlayer+' / '+labelSport : (sel.sport ? ' / '+labelSport : '')} : +${applied}<span class="mini-bonus"><img src="img/${img}" alt=""></span></span>`;
  }
}


function renderMatches(){
  const list=id("match-list");list.innerHTML="";
  if(!state.matches.length){list.appendChild(help("Aucune rencontre planifiée."));id("stats-matches").textContent="0 / 0 matches complets";id("round-status").textContent="—";id("btn-start-round").style.display="none";id("btn-end-round").style.display="none";return}
  const groups={};state.matches.forEach(m=>(groups[m.round]=groups[m.round]||[]).push(m));
  const rounds=Object.keys(groups).map(Number).sort((a,b)=>a-b);
  CURRENT_ROUND = rounds.find(r=>!roundState(r).finished) ?? rounds[rounds.length-1];
  const rs=roundState(CURRENT_ROUND);
  const roundPill=id("round-status");
  roundPill.textContent=`Journée active : #${CURRENT_ROUND} — ${rs.finished?'Terminée':(rs.started?'En cours':'Préparation')}`;
  roundPill.classList.remove('red','yellow','green');
  setRoundStatusPillClasses(roundPill,rs);
  id("btn-start-round").style.display=(isAdmin()&&!rs.started&&!rs.finished)?'inline-block':'none';
  id("btn-end-round").style.display  =(isAdmin()&& rs.started&&!rs.finished)?'inline-block':'none';

  let complete=0, idx=0;
  rounds.forEach(r=>{
    const hdr=help("Journée "+r);hdr.style.fontWeight="600";hdr.style.margin="8px 0";list.appendChild(hdr);
    const rCtl=roundState(r);
    const badgeClass = rCtl.finished ? 'green' : (rCtl.started ? 'yellow' : 'red');

    groups[r].forEach(m=>{
      ensureLengths(m);
      const wins=computeSetWins(m),pal=m.palet,palScore=(pal.a!=null&&pal.b!=null)?hy(pal.a,pal.b):"—";
      const palChip = `<span class="chip">🥏 Palet: <span class="score-compact">${palScore}</span></span>`;
      const done=isMatchComplete(m);if(done)complete++;
      const el=document.createElement("div");el.className="match-card";el.dataset.id=m.id;const isOpen=!!ui.open[m.id];el.setAttribute("aria-expanded",isOpen?"true":"false");
      const bonusA=bonusChip(r,m.a,rCtl), bonusB=bonusChip(r,m.b,rCtl);
      el.innerHTML=`<div class="hd" data-expand style="border:none;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
        <div class="teams"><span class="chip round-chip ${badgeClass}">#${++idx}</span>
          <span class="team-name">${avatarHtml(m.a,'sm')}${esc(teamName(m.a))}</span> <span class="vs">vs</span>
          <span class="team-name">${avatarHtml(m.b,'sm')}${esc(teamName(m.b))}</span></div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <span class="chip">🎯 Fléchettes: <span class="score-compact">${hy(wins.aw.darts,wins.bw.darts)}</span></span>
          <span class="chip">🏓 Ping: <span class="score-compact">${hy(wins.aw.ping,wins.bw.ping)}</span></span>
          ${palChip}
          ${done?'<span class="pill green">✅ Complet</span>':'<span class="pill yellow">⏳ Incomplet</span>'}
          ${bonusA} ${bonusB}
          <span class="chip">▶</span>
        </div></div>
        <div class="bd">
          <div class="match-two-col">
            ${renderDarts(m)}${renderPing(m)}
          </div>
          ${renderPalet(m)}
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:8px">
            <div class="help">La saisie nécessite d’être connecté·e à une des deux équipes (ou admin).</div>
            <div>${(isAdmin()||hasClaim(m.a)||hasClaim(m.b))?`<button type="button" class="btn small" data-clear="${m.id}">Effacer ce match</button>`:''}</div>
          </div>
        </div>`;
      list.appendChild(el);

      // darts
      qsa('.match-card[data-id="'+m.id+'"] select[data-kind="darts"]').forEach(sel=>{
        const can=(isAdmin()||hasClaim(m.a)||hasClaim(m.b)); sel.disabled=!(can && canEditScores(m,rCtl));
        sel.addEventListener("change",()=>{const i=parseInt(sel.getAttribute("data-index"),10),v=sel.value===""?null:parseInt(sel.value,10);const mm=findMatch(m.id);mm.darts[i]=v;saveState();renderMatches();renderLeaderboard();renderH2H()});
      });
      // ping
      qsa('.match-card[data-id="'+m.id+'"] input[data-ping]').forEach(inp=>{
        const can=(isAdmin()||hasClaim(m.a)||hasClaim(m.b)); inp.disabled=!(can && canEditScores(m,rCtl));
        const mid=m.id,idxSet=parseInt(inp.getAttribute("data-index"),10),which=inp.getAttribute("data-ping");
        const updateNote=()=>{const mm=findMatch(mid),s=mm.pingPts[idxSet],ok=isPingValid(+s.a,+s.b);const note=qs('.match-card[data-id="'+mid+'"] [data-note="ping-'+mid+'-'+idxSet+'"]');if(note)note.textContent=ok?'✔️ Score valide':'Saisissez deux scores (11+ et écart ≥ 2).'}
        inp.addEventListener("input",()=>{const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,99);const mm=findMatch(mid);mm.pingPts[idxSet][which]=v;saveState();updateNote()});
        const commit=()=>{const mm=findMatch(mid);const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,99);mm.pingPts[idxSet][which]=v;saveState();renderMatches();renderLeaderboard();renderH2H()};
        inp.addEventListener("change",commit);inp.addEventListener("blur",commit);inp.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();inp.blur()}})
      });
      // palet
      qsa('.match-card[data-id="'+m.id+'"] input[data-palet]').forEach(inp=>{
        const can=(isAdmin()||hasClaim(m.a)||hasClaim(m.b)); inp.disabled=!(can && canEditScores(m,rCtl));
        const mid=m.id,which=inp.getAttribute("data-palet");
        const updateNote=()=>{const mm=findMatch(mid),T=+state.rules.paletTarget||11,a=(mm.palet?.a==null?null:+mm.palet?.a),b=(mm.palet?.b==null?null:+mm.palet?.b);const ok=(a!=null&&b!=null)&&((a===T&&b>=0&&b<=T-1)||(b===T&&a>=0&&a<=T-1));const note=qs('.match-card[data-id="'+mid+'"] [data-note="pal-'+mid+'"]');if(note)note.textContent=ok?'✔️ Score valide':`Saisissez les deux scores (l’un doit être ${T}).`}
        inp.addEventListener("input",()=>{const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,state.rules.paletTarget||11);const mm=findMatch(mid);mm.palet[which]=v;saveState();updateNote()});
        const commit=()=>{const mm=findMatch(mid);const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,state.rules.paletTarget||11);mm.palet[which]=v;saveState();renderMatches();renderLeaderboard();renderH2H()};
        inp.addEventListener("change",commit);inp.addEventListener("blur",commit);inp.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();inp.blur()}})
      });

      const clr=qs('.match-card[data-id="'+m.id+'"] [data-clear]');if(clr)clr.addEventListener("click",()=>clearMatch(m.id));
      const head=qs('.match-card[data-id="'+m.id+'"] [data-expand]');if(head)head.addEventListener("click",()=>{const open=el.getAttribute("aria-expanded")==="true";el.setAttribute("aria-expanded",open?"false":"true");ui.open[m.id]=!open});
      qsa('.match-card[data-id="'+m.id+'"] [data-bonus]').forEach(b=>b.addEventListener('click',()=>openBonusModal(r,b.getAttribute('data-team'))));
    });
  });
  id("stats-matches").textContent=complete+" / "+state.matches.length+" matches complets";
  renderLeaderboard();
}

/* ---- Rendu des 3 sports (relookés) ---- */
function renderDarts(m){
  const s = state.rules.dartsSingles, N = dartsTotal();
  let html = `<div class="sport-group">
    <div class="sport-title"><span class="sport-icon">${sportIcon('darts')}</span> Fléchettes</div>`;
  for(let i=0;i<N;i++){
    const v = m.darts[i];
    const lab = (i < s ? `Simple ${i+1}` : `Double ${i-s+1}`);
    html += `<div class="sport-item">
      <label>${lab}</label>
      <select data-kind="darts" data-index="${i}">
        <option value="" ${v===null?'selected':''}>Non joué</option>
        <option value="0" ${v===0?'selected':''}>Victoire ${esc(teamName(m.a))}</option>
        <option value="1" ${v===1?'selected':''}>Victoire ${esc(teamName(m.b))}</option>
      </select>
    </div>`;
  }
  html += `</div>`;
  return html;
}
function renderPing(m){
  const s = state.rules.pingSingles, N = pingTotal();
  let html = `<div class="sport-group">
    <div class="sport-title"><span class="sport-icon">${sportIcon('ping')}</span> Ping-pong</div>`;
  for(let i=0;i<N;i++){
    const set = m.pingPts[i] || {a:null,b:null};
    const lab = (i < s ? `Simple ${i+1}` : `Double ${i-s+1}`);
    const ok = isPingValid(+set.a,+set.b);
    html += `<div class="sport-item">
      <label>${lab}</label>
      <div class="ping-row">
        <div>
          <input type="number" min="0" max="99" step="1"
                 value="${set.a==null?'':set.a}"
                 data-ping="a" data-index="${i}"
                 placeholder="${esc(teamName(m.a))}">
        </div>
        <div>
          <input type="number" min="0" max="99" step="1"
                 value="${set.b==null?'':set.b}"
                 data-ping="b" data-index="${i}"
                 placeholder="${esc(teamName(m.b))}">
        </div>
      </div>
      <div class="help" data-note="ping-${m.id}-${i}">${ok?'✔️ Score valide':'Saisissez deux scores (11+ et écart ≥ 2).'}</div>
    </div>`;
  }
  html += `</div>`;
  return html;
}
function renderPalet(m){
  const T = +state.rules.paletTarget || 11;
  const a = (m.palet?.a==null?null:+m.palet?.a),
        b = (m.palet?.b==null?null:+m.palet?.b);
  const ok = (a!=null&&b!=null)&&((a===T&&b>=0&&b<=T-1)||(b===T&&a>=0&&a<=T-1));
  return `<div class="sport-group" style="margin-top:16px">
    <div class="sport-title"><span class="sport-icon">${sportIcon('palet')}</span> Palet</div>
    <div class="ping-row">
      <div>
        <label class="muted">${esc(teamName(m.a))}</label>
        <input type="number" min="0" max="${T}" step="1"
               value="${a==null?'':a}" data-palet="a">
      </div>
      <div>
        <label class="muted">${esc(teamName(m.b))}</label>
        <input type="number" min="0" max="${T}" step="1"
               value="${b==null?'':b}" data-palet="b">
      </div>
    </div>
    <div class="help" data-note="pal-${m.id}">${ok?'✔️ Score valide':`Saisissez les deux scores (l’un doit être ${T}).`}</div>
  </div>`;
}

/* ===== Classement ===== */
function baseLeaderboardStats(){const R=state.rules,stats={};state.teams.forEach(t=>stats[t.id]={teamId:t.id,name:t.name,avatar:t.avatar||null,pointsBase:0,bonus:0,malus:0,dartsW:0,pingW:0,palFor:0,palAg:0,matchesComplete:0});state.matches.forEach(m=>{const A=stats[m.a],B=stats[m.b];ensureLengths(m);m.darts.forEach(v=>{if(v===0){A.dartsW++;A.pointsBase+=R.dartsWinPoints}else if(v===1){B.dartsW++;B.pointsBase+=R.dartsWinPoints}});getPingPts(m).forEach(s=>{const a=(s.a==null?null:+s.a),b=(s.b==null?null:+s.b);if(isPingValid(a,b)){if(a>b){A.pingW++;A.pointsBase+=R.pingWinPoints}else if(b>a){B.pingW++;B.pointsBase+=R.pingWinPoints}}});const pa=(m.palet?.a==null?null:+m.palet?.a),pb=(m.palet?.b==null?null:+m.palet?.b);if(pa!=null&&pb!=null){A.palFor+=pa;B.palFor+=pb;A.palAg+=pb;B.palAg+=pa;A.pointsBase+=pa;B.pointsBase+=pb}if(isMatchComplete(m)){A.matchesComplete++;B.matchesComplete++}});Object.keys(state.bonusApplied||{}).forEach(r=>{const per=state.bonusApplied[r];Object.keys(per).forEach(tid=>{const v=per[tid]||0;if(stats[tid])stats[tid].bonus+=v})});return stats}
function computeLeaderboard(){const stats=baseLeaderboardStats();const rows=Object.values(stats).map(x=>({teamId:x.teamId,name:x.name,avatar:x.avatar,points:x.pointsBase+x.bonus-x.malus,bonus:x.bonus,malus:x.malus,dartsW:x.dartsW,pingW:x.pingW,palFor:x.palFor,palAg:x.palAg,matchesComplete:x.matchesComplete}));rows.sort((x,y)=>(y.points-x.points)||((y.palFor-y.palAg)-(x.palFor-x.palAg))||((y.dartsW+y.pingW)-(x.dartsW+x.pingW))||x.name.localeCompare(y.name));rows.forEach((r,i)=>r.rank=i+1);return rows}
function renderLeaderboard(){const tbody=qs("#table-classement tbody");tbody.innerHTML="";computeLeaderboard().forEach(r=>{const diff=r.palFor-r.palAg;const avatar=r.avatar?(`<span class="avatar avatar-lg"><img src="${esc(r.avatar)}" alt="avatar"></span>`):(`<span class="avatar avatar-lg"><span class="avatar-initials">${esc(initials(r.name))}</span></span>`);const tr=document.createElement("tr");tr.innerHTML=`<td>${r.rank}</td><td><span class="team-name">${avatar} ${esc(r.name)}</span></td><td><b>${r.points}</b></td><td>${r.dartsW}</td><td>${r.pingW}</td><td><span class="score-compact">${hy(r.palFor,r.palAg)}</span> <span class="muted">(${diff>=0?'+':''}${diff})</span></td><td>${r.bonus}</td><td>${r.malus||0}</td><td>${r.matchesComplete}</td>`;tbody.appendChild(tr)})}

/* ===== H2H ===== */
function pointsForTeamInMatch(m,tid){const R=state.rules;ensureLengths(m);const isA=m.a===tid,isB=m.b===tid;if(!isA&&!isB)return 0;let pts=0;m.darts.forEach(v=>{if(v===0&&isA)pts+=R.dartsWinPoints;else if(v===1&&isB)pts+=R.dartsWinPoints});getPingPts(m).forEach(s=>{const a=(s.a==null?null:+s.a),b=(s.b==null?null:+s.b);if(isPingValid(a,b)){if(a>b&&isA)pts+=R.pingWinPoints;else if(b>a&&isB)pts+=R.pingWinPoints}});if(m.palet&&m.palet.a!=null&&m.palet.b!=null)pts+=isA?+m.palet.a:+m.palet.b;return pts}
function renderH2H(){const thead=qs("#table-h2h thead"),tbody=qs("#table-h2h tbody");thead.innerHTML="";tbody.innerHTML="";const teams=state.teams.slice();if(!teams.length){tbody.appendChild(help("Ajoutez des équipes pour voir la matrice."));return}const trH=document.createElement("tr");trH.appendChild(document.createElement("th")).textContent="Équipe";teams.forEach(t=>{const th=document.createElement("th");th.innerHTML='<span class="team-name">'+avatarHtml(t.id,'sm')+esc(t.name)+'</span>';trH.appendChild(th)});thead.appendChild(trH);const byPair={};state.matches.forEach(m=>{byPair[[m.a,m.b].sort().join("|")]=m});teams.forEach(ti=>{const tr=document.createElement("tr");const th=document.createElement("th");th.innerHTML='<span class="team-name">'+avatarHtml(ti.id,'sm')+esc(ti.name)+'</span>';tr.appendChild(th);teams.forEach(tj=>{const td=document.createElement("td");if(ti.id===tj.id){td.textContent="—";tr.appendChild(td);return}const m=byPair[[ti.id,tj.id].sort().join("|")];if(!m){td.innerHTML='<span class="chip">—</span>';tr.appendChild(td);return}const pI=pointsForTeamInMatch(m,ti.id),pJ=pointsForTeamInMatch(m,tj.id);let cls="h2h-draw",icon="≡";if(pI>pJ){cls="h2h-win";icon="✔"}else if(pI<pJ){cls="h2h-loss";icon="✖"}td.innerHTML='<span class="h2h-pill '+cls+'">'+icon+' <span class="score-compact">'+hy(pI,pJ)+'</span></span>';td.style.cursor="pointer";td.dataset.matchId=m.id;tr.appendChild(td)});tbody.appendChild(tr)});tbody.addEventListener("click",e=>{let n=e.target;while(n&&n!==tbody&&!(n.tagName==="TD"&&n.dataset.matchId))n=n.parentNode;if(!n||n===tbody)return;goto("calendrier");ui.open[n.dataset.matchId]=true;setTimeout(()=>{const card=qs('.match-card[data-id="'+n.dataset.matchId+'"]');if(card){card.setAttribute("aria-expanded","true");card.scrollIntoView({behavior:"smooth",block:"start"})}},0)})}

/* ===== Tabs & clicks ===== */
function guardTab(t){const no=(!cloud.enabled&&!state.cloudId);return(t==='equipes'||t==='calendrier'||t==='classement'||t==='options')&&(no&&state.teams.length===0)}
function goto(tabId){if(guardTab(tabId)){alert("Aucun tournoi ouvert. Créez ou rejoignez un code Cloud.");tabId='setup'}qsa(".tab").forEach(b=>b.setAttribute("aria-selected","false"));const b=qs('.tab[data-tab="'+tabId+'"]');if(b)b.setAttribute("aria-selected","true");qsa("main section").forEach(s=>s.classList.remove("active"));id(tabId).classList.add("active")}

document.addEventListener("click",async(e)=>{
  const btn=e.target.closest("button");if(btn){switch(btn.id){
    case "btn-fullscreen":(document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen())?.catch?.(()=>{});break;

    /* --- ADMIN : activation => re-render immédiat --- */
    case "btn-admin-on-setup":
    case "btn-admin-on":{const pin=prompt("PIN administrateur :");if(pin==="30041991"){session.admin=true;session.claims={};updateWho();renderAll();alert("Mode administrateur activé (déconnexion des équipes sur cet appareil).")}else alert("PIN incorrect.");break}
    case "btn-admin-off":{session.admin=false;updateWho();renderAll();break}

    case "btn-create-tournament":{if(!isAdmin()){const pin=prompt("PIN administrateur :");if(pin!=="30041991")return alert("PIN incorrect.");session.admin=true;session.claims={};updateWho();renderAll()}const code=(id("tcode-input").value||"").trim();if(!code)return alert("Code cloud obligatoire.");const name=(id("tname-input").value||"").trim()||"Tournoi";if(nameExistsLocally(name))return alert("Un tournoi portant ce nom existe déjà dans cette liste.");if(codeExistsLocally(code))return alert("Ce code cloud existe déjà dans votre liste.");const exists=await(async()=>{try{const db=cloud.db||initFB();if(!db)return false;const ref=db.ref("tournaments/"+code+"/payload");const snap=await ref.get?.()??await new Promise(res=>ref.once('value',res));return !!(snap&&snap.exists&&snap.exists())}catch(_){return false}})();if(exists)return alert("Ce code cloud existe déjà sur le serveur. Choisissez-en un autre.");const n=clampInt(id("teams-count-input").value,2,64);const R={dartsSingles:clampInt(id("rule-d-s").value,0,9),dartsDoubles:clampInt(id("rule-d-d").value,0,9),dartsWinPoints:clampInt(id("rule-d-p").value,1,50),pingSingles:clampInt(id("rule-p-s").value,0,9),pingDoubles:clampInt(id("rule-p-d").value,0,9),pingWinPoints:clampInt(id("rule-p-p").value,1,50),paletTarget:clampInt(id("rule-l-target").value,1,50)};joinCloud(code);state={version:40,tid:uid(),cloudId:code,tournamentName:name,rules:R,teams:Array.from({length:n},(_,i)=>({id:uid(),name:"Équipe "+(i+1),p1:"",p2:"",avatar:null,bonusCapitaineUsed:false})),matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};saveState();pushCloud(true);renderAll();goto("equipes");break}
    case "btn-join-code":{const code=(id("join-code").value||"").trim();if(!code)return alert("Renseigne un code.");joinCloud(code);goto("equipes");break}
    case "btn-copy-link":{const code=(id("join-code").value||id("tcode-input").value||state.cloudId||"").trim();if(!code)return alert("Aucun code.");const url=location.origin+location.pathname+"?id="+encodeURIComponent(code);navigator.clipboard?.writeText(url);alert("Lien copié !\n"+url);break}

    case "btn-add-team":{if(!isAdmin())return alert("Réservé à l’admin.");if(state.locked)return alert("Calendrier figé.");state.teams.push({id:uid(),name:"Équipe "+(state.teams.length+1),p1:"",p2:"",avatar:null,bonusCapitaineUsed:false});saveState();renderTeams();break}
    case "btn-generate":{if(!isAdmin())return alert("Seul l’admin peut générer.");if(state.locked)return;generateSchedule();state.locked=true;saveState();renderAll();goto("calendrier");break}

    case "btn-refresh-standings":
    case "btn-refresh-standings-2":{renderLeaderboard();renderH2H();if(btn.id==="btn-refresh-standings-2")goto("classement");break}
    case "btn-show-summary":{id("view-summary").style.display="block";id("view-h2h").style.display="none";id("btn-show-summary").setAttribute("aria-pressed","true");id("btn-show-h2h").setAttribute("aria-pressed","false");break}
    case "btn-show-h2h":{id("view-summary").style.display="none";id("view-h2h").style.display="block";id("btn-show-summary").setAttribute("aria-pressed","false");id("btn-show-h2h").setAttribute("aria-pressed","true");break}
    case "btn-collapse":{qsa('#match-list .match-card').forEach(c=>c.setAttribute('aria-expanded','false'));ui.open={};break}

    case "btn-export":{const data=JSON.stringify(state,null,2);const url=URL.createObjectURL(new Blob([data],{type:"application/json"}));const a=document.createElement("a");a.href=url;a.download=("tournoi-"+(state.tournamentName||"TriSports")).replace(/\s+/g,'_')+".json";a.click();URL.revokeObjectURL(url);break}
    case "btn-import":{const f=id("file-import").files?.[0];if(!f)return alert("Sélectionnez un fichier JSON.");f.text().then(t=>{try{const data=JSON.parse(t);state=data;normalize();saveState();renderAll();alert("Import réussi !")}catch(_){alert("Fichier invalide.")}});break}

    case "btn-cloud-copy":{const code=state.cloudId||cloud.id;if(!code)return alert("Pas de code cloud.");const url=location.origin+location.pathname+"?id="+encodeURIComponent(code);navigator.clipboard?.writeText(url);alert("Lien copié !\n"+url);break}
    case "btn-cloud-delete":{if(!isAdmin())return alert("Suppression cloud réservée à l’admin.");const code=state.cloudId||cloud.id;if(!code)return alert("Aucun code actif.");if(!confirm("Supprimer définitivement ce tournoi du cloud ?"))return;deleteCloud(code).then(()=>{setIndex(getIndex().filter(e=>e.id!==code));unsubscribeCloud();resetState();renderSetupRecent();renderAll();history.replaceState(null,"",location.pathname);alert("Tournoi supprimé.");goto('setup')});break}

    /* ---- Réinitialiser scores => réinitialise aussi BONUS + journées ---- */
    case "btn-reset-scores":{state.bonusSelections={};state.bonusApplied={};state.bonusUsed={};(state.teams||[]).forEach(t=>{if(t)t.bonusCapitaineUsed=false});if(!isAdmin())return alert("Réservé à l’admin.");if(!confirm("Réinitialiser les SCORES et les BONUS ?"))return;state.matches.forEach(m=>{m.darts=Array(dartsTotal()).fill(null);m.pingPts=Array(pingTotal()).fill({a:null,b:null});m.palet={a:null,b:null}});state.roundCtl={};state.bonusSelections={};state.bonusApplied={};state.teams.forEach(t=>t.bonusCapitaineUsed=false);saveState();renderAll();goto("calendrier");break}

    case "btn-unlock":{if(!isAdmin())return alert("Réservé à l’admin.");if(!confirm("Déverrouiller le calendrier ?"))return;state.locked=false;saveState();renderTeams();renderMatches();updateLock();break}

    case "btn-start-round":{if(!isAdmin())return;const r=CURRENT_ROUND,rs=roundState(r);if(rs.started||rs.finished)return;rs.started=true;saveState();renderMatches();alert("Journée #"+r+" démarrée. Les bonus sont verrouillés.");break}

    /* ---- Fin de journée : blocage si incomplet + bonus appliqués ---- */
    case "btn-end-round": {
      if (!isAdmin()) return;
      const r  = CURRENT_ROUND;
      const rs = roundState(r);
      if (!rs.started || rs.finished) return;

      const matchesOfRound = state.matches.filter(m => m.round === r);
      const incomplets = matchesOfRound.filter(m => !isMatchComplete(m));
      if (incomplets.length) { alert(`Impossible de terminer la journée #${r} : ${incomplets.length} match(s) incomplet(s).`); return; }

      const sels = state.bonusSelections[r] || {};
      Object.keys(sels).forEach(tid=>{
        const sel = sels[tid]; if (!sel) return;
        if ((state.bonusUsed?.[r]?.[tid])) { setBonusApplied(r, tid, 0); return; }
        let total = 0;
        matchesOfRound.forEach(m=>{ total += (sel.type==='melon' ? computeMelonBonusForMatch(m, tid, sel) : computeCapitaineBonusForMatch(m, tid, sel.player, sel.sport)); });
        setBonusApplied(r, tid, total); state.bonusUsed=state.bonusUsed||{}; state.bonusUsed[r]=state.bonusUsed[r]||{}; state.bonusUsed[r][tid]=true; markTeamBonusUsed(tid);
      });

      rs.finished = true; saveState(); renderMatches(); renderLeaderboard();
      alert(`Journée #${r} terminée. Les bonus sont appliqués et révélés.`); break;
    }
  }}
  const openBtn=e.target.closest("[data-open-id]");if(openBtn){const code=openBtn.getAttribute("data-open-id").replace(/^cloud:/,"");id("join-code").value=code;joinCloud(code);goto("equipes")}
  const delBtn=e.target.closest("[data-delete-id]");if(delBtn){if(!isAdmin())return alert("Suppression cloud réservée à l’admin.");const code=delBtn.getAttribute("data-delete-id");if(!confirm("Supprimer le tournoi '"+code+"' du cloud ?"))return;deleteCloud(code).then(()=>{setIndex(getIndex().filter(e=>e.id!==code));if(state.cloudId===code||cloud.id===code){unsubscribeCloud();resetState();renderAll();history.replaceState(null,"",location.pathname);goto('setup')}alert("Supprimé.");renderSetupRecent()})}
  const av=e.target.closest('.avatar[data-click-avatar]');if(av){const tid=av.getAttribute('data-click-avatar');if(isAdmin()||hasClaim(tid)){const input=document.querySelector('input[type="file"][data-avatar="'+tid+'"]');if(input)input.click()}return}
  const tab=e.target.closest(".tab");if(tab){let t=tab.getAttribute("data-tab");if(guardTab(t))t='setup';qsa(".tab").forEach(b=>b.setAttribute("aria-selected","false"));qs('.tab[data-tab="'+t+'"]').setAttribute("aria-selected","true");qsa("main section").forEach(s=>s.classList.remove("active"));id(t).classList.add("active")}
  const actBtn=e.target.closest("[data-act]");if(actBtn){const act=actBtn.getAttribute("data-act"),tid=actBtn.getAttribute("data-id");if(act==="del"){if(!isAdmin()||state.locked)return;if(!confirm("Supprimer cette équipe ?"))return;state.teams=state.teams.filter(tt=>tt.id!==tid);state.matches=state.matches.filter(m=>m.a!==tid&&m.b!==tid);if(state.protect?.teamPassHash)delete state.protect.teamPassHash[tid];saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
    if(act==="setpass"){if(!isAdmin())return alert("Réservé à l’admin.");let pass=prompt("Mot de passe pour l’équipe « "+teamName(tid)+" » :");if(pass==null)return;pass=pass.trim();if(!pass)return alert("Mot de passe vide.");state.protect=state.protect||{};state.protect.teamPassHash=state.protect.teamPassHash||{};state.protect.teamPassHash[tid]=hashPass(pass);saveState();renderTeams();alert("Mot de passe défini.")}
    if(act==="login"){const hashes=(state.protect&&state.protect.teamPassHash)?state.protect.teamPassHash:null;if(!hashes||!hashes[tid])return alert("Cette équipe n’a pas encore de mot de passe (demandez à l’admin).");let pass=prompt("Mot de passe de l’équipe « "+teamName(tid)+" » :");if(pass==null)return;pass=pass.trim();if(!pass)return alert("Mot de passe vide.");if(hashPass(pass)===hashes[tid]){ session.admin=false; session.claims={}; session.claims[tid]=true; updateWho(); renderAll(); alert("Connexion réussie. Mode admin désactivé sur cet appareil."); }
      else alert("Mot de passe incorrect.") }
    if(act==="logout"){session.claims={};updateWho();renderAll()}
    if(act==="avatar"){const input=qs('[data-avatar="'+tid+'"]');if(input)input.click()}
    if(act==="avatar-clear"){const t=teamObj(tid);if(!t)return;t.avatar=null;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
  }
});

/* ===== Modal bonus ===== */
let bonusCTX={round:null,teamId:null};
function openBonusModal(round,teamId){
  const rCtl=roundState(round);
  if(rCtl.started) return alert("La journée a démarré : bonus verrouillés.");
  if ((state.bonusUsed?.[round]?.[teamId])) return alert("Ce bonus a déjà été utilisé une fois.");
  if(!hasClaim(teamId)) return alert("Connectez-vous à cette équipe pour choisir son bonus.");
  bonusCTX.round=round;bonusCTX.teamId=teamId;
  const sel=getBonusSelection(round,teamId);
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine');
  if(id('melon-sport')) id('melon-sport').value = (sel?.sport||'darts');
  try{ updateMelonOptions(); if(id('melon-index')) id('melon-index').value = ''+(sel?.index||1); id('melon-sport')?.addEventListener('change', updateMelonOptions); }catch(e){} }
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine');
  if(id('melon-sport')) id('melon-sport').value = (sel?.sport||'darts');
  try{ updateMelonOptions(); if(id('melon-index')) id('melon-index').value = ''+(sel?.index||1); id('melon-sport')?.addEventListener('change', updateMelonOptions); }catch(e){} }
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine');
  if(id('melon-sport')) id('melon-sport').value = (sel?.sport||'darts');
  try{ updateMelonOptions(); if(id('melon-index')) id('melon-index').value = ''+(sel?.index||1); id('melon-sport')?.addEventListener('change', updateMelonOptions); }catch(e){} }
  if(id('taupe-sport')) id('taupe-sport').value = (sel?.sport||'darts');
  id('bonus-player').value=sel?.player||'p1';
  id('bonus-sport').value=sel?.sport||'darts';
  id('bonus-context').textContent=`Équipe : ${teamName(teamId)} — Journée #${round}`;
  id('bonus-modal').classList.add('show');
}
id('bonus-cancel').addEventListener('click',()=>id('bonus-modal').classList.remove('show'));
id('bonus-save').addEventListener('click',()=>{
  const r=bonusCTX.round, t=bonusCTX.teamId;
  const type = (window._bonusType==='miroir') ? 'miroir' :
               (window._bonusType==='taupe') ? 'taupe' :
               (window._bonusType==='lefthand') ? 'lefthand' :
               (window._bonusType==='melon') ? 'melon' : 'capitaine';
  if(type==='capitaine') setBonusSelection(r,t,{type:'capitaine',player:id('bonus-player').value,sport:id('bonus-sport').value});
  else if(type==='taupe') setBonusSelection(r,t,{type:'taupe',sport:id('taupe-sport').value||'darts'});
  else if(type==='lefthand') setBonusSelection(r,t,{type:'lefthand',sport:id('lefthand-sport').value||'darts'});
  else if(type==='melon') setBonusSelection(r,t,{type:'melon',sport:id('melon-sport').value||'darts',index:+(id('melon-index').value||1)});
  else setBonusSelection(r,t,{type:'miroir'});
  id('bonus-modal').classList.remove('show');
});

/* ===== Boot ===== */
function renderAll(){renderTitle();updateWho();renderSetupRecent();renderManageList();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
document.addEventListener("DOMContentLoaded",()=>{ try { renderAll(); } catch(e) {} });</script>

<script>
(function(){
  function withFallback(img, primary, fall1, fall2){
    img.src = primary;
    img.onerror = function(){
      img.onerror = function(){
        img.onerror = function(){
          img.onerror = null;
          img.src = fall2;
        };
        img.src = fall1;
      };
      // try img/ first
      img.src = 'img/' + primary.split('/').pop();
    };
  }
  function ensureBrandImages(){
    var brand = document.querySelector('header .brand') || document.querySelector('.brand');
    if(!brand) return;
    // avoid duplicates
    if(!brand.querySelector('img.brand-logo')){
      var logo = document.createElement('img');
      logo.className = 'brand-logo';
      logo.alt = 'TriSports logo';
      brand.prepend(logo);
      withFallback(logo, 'tripsort/img/logo.png', 'trisport/img/logo.png', 'img/logo.png');
    }
    if(!brand.querySelector('img.brand-title')){
      var title = document.createElement('img');
      title.className = 'brand-title';
      title.alt = 'TriSports';
      // insert after logo
      var ref = brand.querySelector('img.brand-logo');
      if(ref && ref.nextSibling){ brand.insertBefore(title, ref.nextSibling); }
      else { brand.appendChild(title); }
      withFallback(title, 'tripsort/img/titre.png', 'trisport/img/titre.png', 'img/titre.png');
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureBrandImages);
  }else{
    ensureBrandImages();
  }
})();
</script>

</body>
</html>
