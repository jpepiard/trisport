<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TriSports ‚Äî Fl√©chettes ‚Ä¢ Ping-pong ‚Ä¢ Palet</title>
<style id="scoreline-googleish">
.scorewrap .teams-row{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap:16px;
  width:100%;
}
.scorewrap .team{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:8px;
  min-width:0;
}
.scorewrap .team .avatar{ width:64px; height:64px; }
.scorewrap .team .name{ font-weight:700; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.scorewrap .team .bonus-line{ font-size:12px; opacity:.8; display:flex; gap:6px; flex-wrap:wrap; justify-content:center; }
.scorewrap .score{
  font-variant-numeric: tabular-nums;
  font-size:44px;
  line-height:1;
  font-weight:800;
  letter-spacing:.5px;
}
.scorewrap .sports-row{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; padding-top:6px; }
</style>


<!-- Garde-fou : certaines extensions injectent du React minifi√© qui loggue "Minified React error #...".
     On √©vite que √ßa remonte et perturbe l'app (√ßa n'affecte PAS ton site). -->
<script>
  window.addEventListener('error', function (e) {
    const msg = (e.message || '') + '';
    if (msg.includes('Minified React error #')) {
      e.stopImmediatePropagation?.();
      return false;
    }
  }, true);

function ensureParamWrapper(){
  const fields = id('capitaine-fields'); if(!fields) return null;
  let wrap=id('cap-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='cap-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureTaupeWrapper(){
  const fields = id('taupe-fields'); if(!fields) return null;
  let wrap=id('taupe-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='taupe-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureLeftHandWrapper(){
  const fields = id('lefthand-fields'); if(!fields) return null;
  let wrap=id('lefthand-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='lefthand-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureMelonWrapper(){
  const fields = id('melon-fields'); if(!fields) return null;
  let wrap = id('melon-params');
  if (!wrap){
    wrap = document.createElement('div');
    wrap.id = 'melon-params';
    wrap.setAttribute('role','region');
    wrap.setAttribute('aria-live','polite');
    wrap.setAttribute('aria-label','Param√®tres Melon d‚Äôor');

    wrap.className = 'bonus-params';
    fields.parentNode.insertBefore(wrap, fields);
    wrap.appendChild(fields);
  }
  return wrap;
}


function setParamsOpen(openCap, openTaupe, openLeft, openMelon){
  const wC = ensureParamWrapper();    if (wC){ wC.style.maxHeight = openCap   ? (wC.scrollHeight+'px') : '0px'; }
  const wT = ensureTaupeWrapper();    if (wT){ wT.style.maxHeight = openTaupe ? (wT.scrollHeight+'px') : '0px'; }
  const wL = ensureLeftHandWrapper(); if (wL){ wL.style.maxHeight = openLeft  ? (wL.scrollHeight+'px') : '0px'; }
  const wM = ensureMelonWrapper();    if (wM){ wM.style.maxHeight = openMelon ? (wM.scrollHeight+'px') : '0px'; }
}

function selectBonusType(t){
  // lock guard per category
  try{
    const teamId = (window.bonusCTX && window.bonusCTX.teamId);
    if (teamId && typeof getTeamCategoryLocks==='function'){
      const locks = getTeamCategoryLocks(teamId);
      const cat = BONUS_CATEGORY[t];
      const round = (window.bonusCTX && window.bonusCTX.round);
      const currentSel = (typeof getBonusSelection==='function' && round!=null) ? (getBonusSelection(round, teamId) || null) : null;
      const allowCurrent = !!(currentSel && currentSel.type === t);
      if (cat && locks.has(cat) && !allowCurrent) return; // blocked
    }
  }catch(_){}

  // 1) type valide (inclut 'melon')
  window._bonusType = (['capitaine','miroir','taupe','lefthand','melon'].includes(t) ? t : 'capitaine');

  // 2) cartes (5 cartes d√©sormais)
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  const cap   = cards[0],
        mir   = cards[1],
        tau   = cards[2],
        leftc = cards[3],
        melon = cards[4];

  // 3) reset + s√©lection
  [cap, mir, tau, leftc, melon].forEach(c => c && c.classList.remove('selected'));
  if (cap   && window._bonusType === 'capitaine') cap.classList.add('selected');
  if (mir   && window._bonusType === 'miroir')    mir.classList.add('selected');
  if (tau   && window._bonusType === 'taupe')     tau.classList.add('selected');
  if (leftc && window._bonusType === 'lefthand')  leftc.classList.add('selected');
  if (melon && window._bonusType === 'melon')     melon.classList.add('selected');

  
  // 3bis) a11y state
  [cap, mir, tau, leftc, melon].forEach((c,i)=>{
    if(!c) return;
    const pressed =
      (i===0 && window._bonusType==='capitaine') ||
      (i===1 && window._bonusType==='miroir')    ||
      (i===2 && window._bonusType==='taupe')     ||
      (i===3 && window._bonusType==='lefthand')  ||
      (i===4 && window._bonusType==='melon');
    c.setAttribute('aria-pressed', pressed ? 'true' : 'false');
  });
// 4) texte d‚Äôaide
  const ctx = id('bonus-context');
  if (ctx) {
    ctx.textContent =
      window._bonusType === 'miroir'   ? "Miroir : inverse le bonus adverse sur tout le match." :
      window._bonusType === 'taupe'    ? "Ren√© la taupe : choisissez le sport." :
      window._bonusType === 'lefthand' ? "10 pouces 2 mains gauche : choisissez le sport." :
      window._bonusType === 'melon'    ? "Melon d'or : choisissez le sport." :
                                          "Capitaine : aucun r√©glage. +2/manche gagn√©e ; +2 si palet.";
  }

  // 5) affichage des param√®tres (Capitaine n‚Äôa plus de champs)
  setParamsOpen(window._bonusType==='capitaine', window._bonusType==='taupe', window._bonusType==='lefthand', window._bonusType==='melon');
}

function prepareBonusOptions(){
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  const map   = ['capitaine','miroir','taupe','lefthand','melon']; // 5 cartes

  cards.forEach((c, i)=>{
    c.classList.add('selectable');
    c.tabIndex = 0;
    c.setAttribute('role','button');
    c.setAttribute('aria-pressed','false');

    const type = map[i] || 'capitaine';
    c.addEventListener('click', ()=>selectBonusType(type));
    c.addEventListener('keydown', ev=>{
      if(ev.key===' '||ev.key==='Enter'){
        ev.preventDefault();
        selectBonusType(type);
      }
    });
  });

  // d√©placer/afficher les panneaux de param√®tres (Capitaine n‚Äôen a plus)
  const cap = cards[0], tau = cards[2], leftc = cards[3], melon = cards[4];
  const capTxt = cap?.querySelector('.bonus-text');
  const tauTxt = tau?.querySelector('.bonus-text');
  const leftTxt = leftc?.querySelector('.bonus-text');
  const melonTxt = melon?.querySelector('.bonus-text');

  const wC = ensureParamWrapper();    if (capTxt   && wC && wC.parentElement   !== capTxt)   capTxt.appendChild(wC);
  const wT = ensureTaupeWrapper();    if (tauTxt   && wT && wT.parentElement   !== tauTxt)   tauTxt.appendChild(wT);
  const wL = ensureLeftHandWrapper(); if (leftTxt  && wL && wL.parentElement   !== leftTxt)  leftTxt.appendChild(wL);
  const wM = ensureMelonWrapper();    if (melonTxt && wM && wM.parentElement !== melonTxt) melonTxt.appendChild(wM);

  // init s√©lection
  selectBonusType(window._bonusType || 'capitaine');
}

</script>

<style>
.bonus-card.disabled{opacity:.45;filter:grayscale(1);pointer-events:none}
.bonus-card.disabled:after{content:"‚úñ";position:absolute;right:10px;top:10px;opacity:.8}
.pos{color:#34d399;font-weight:600}
.neg{color:#f87171;font-weight:600}
:root{--bg:#0f1220;--border:#2b315f;--text:#e7e9f7;--muted:#8b94b8;--chip:#242b55;--card:#1b2242}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;background:radial-gradient(1200px 800px at 20% -10%,#1c2040,transparent),radial-gradient(1000px 600px at 120% 0%,#1b2550,transparent),var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(130%) blur(8px);background:linear-gradient(180deg,rgba(15,18,32,.9),rgba(15,18,32,.6));border-bottom:1px solid var(--border)}
.container{max-width:1100px;margin:0 auto;padding:18px 16px}.brand{display:flex;gap:12px;align-items:center}
.logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 210deg,#6ee7b7,#7aa2ff);display:grid;place-items:center;font-weight:900;color:#0a0d1c}
.tabs{display:flex;gap:8px;flex-wrap:wrap}.tab{background:var(--chip);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:999px;cursor:pointer}
.tab[aria-selected="true"]{background:linear-gradient(180deg,#1d2a57,#1a2450);border-color:#3a4aa0}
main .container{padding-top:22px}section{display:none}section.active{display:block}
.card{background:linear-gradient(180deg,#171d3a,#121632);border:1px solid var(--border);border-radius:16px}
.card .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:12px}
.card .bd{padding:16px}
.help{font-size:13px;color:var(--muted)}.muted{color:var(--muted)}
.btn{appearance:none;border:1px solid var(--border);background:var(--chip);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#2f3da2,#25337d);border-color:#3a4aa0}.btn.small{padding:6px 10px;border-radius:10px;font-size:13px}.btn.danger{background:linear-gradient(180deg,#7a2b2b,#5c2222);border-color:#8a2b2b}
.btn.toggle[aria-pressed="true"]{background:linear-gradient(180deg,#2b3a99,#22307c);border-color:#3a4aa0}
.grid{display:grid;gap:12px}.grid.cols-2{grid-template-columns:repeat(2,1fr)}.grid.cols-3{grid-template-columns:repeat(3,1fr)}.grid.cols-4{grid-template-columns:repeat(4,1fr)}.grid.responsive{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
input[type=text],input[type=number],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1331;color:#fff}
label{font-size:13px;color:var(--muted)}
table{width:100%;border-collapse:collapse}th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left}th{color:var(--muted);font-weight:600}
.match-card{border-radius:14px;border:1px solid var(--border);background:var(--card);overflow:hidden}
.match-card[aria-expanded="false"] .bd{display:none}.match-card[aria-expanded="true"] .bd{display:block}
.chip{font-size:12px;padding:4px 8px;background:var(--chip);border:1px solid var(--border);border-radius:999px;color:var(--muted)}
.pill{padding:4px 8px;border-radius:999px;background:#0f1331;border:1px solid var(--border);color:var(--muted);font-size:12px}
.pill.red{border-color:#ef4444;color:#fecaca;background:rgba(239,68,68,.08)}
.pill.yellow{border-color:#eab308;color:#fde68a;background:rgba(234,179,8,.10)}
.pill.green{border-color:#22c55e;color:#a7f3d0;background:rgba(34,197,94,.10)}
.pill.blue{border-color:#3b82f6;color:#bfdbfe;background:rgba(59,130,246,.10)} /* bonus BLEU */
.team-name{display:inline-flex;align-items:center;gap:8px;line-height:1.25;vertical-align:middle}
.match-card .hd .teams{display:flex;align-items:center;gap:10px}
.avatar{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:#0f1331;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;color:#cbd5ff;font-weight:700;font-size:14px;flex:0 0 auto}
.avatar img{width:100%;height:100%;object-fit:cover}.avatar .avatar-initials{display:inline-block;line-height:40px}
.avatar-lg{width:48px;height:48px;font-size:15px}.avatar-lg .avatar-initials{line-height:48px}
.avatar-sm{width:32px;height:32px;font-size:12px}.avatar-sm .avatar-initials{line-height:32px}
.h2h-pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-weight:600}
.h2h-win{border:1px solid #22c55e;color:#a7f3d0;background:rgba(34,197,94,.08)}
.h2h-loss{border:1px solid #ef4444;color:#fecaca;background:rgba(239,68,68,.08)}
.h2h-draw{border:1px solid #eab308;color:#fde68a;background:rgba(234,179,8,.08)}
.score-compact{font-variant-numeric:tabular-nums}

/* Bonus */
.bonus-btn{border:1px dashed #4b5bd7;background:transparent;color:#7aa2ff;padding:8px 10px;border-radius:12px;font-weight:700}.bonus-btn[disabled]{opacity:.45;cursor:not-allowed}
#bonus-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9998}
#bonus-modal.show{display:flex}
.bonus-dialog{width:min(560px,92vw);background:#141938;border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.5)}
.bonus-dialog .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700}
.bonus-dialog .bd{padding:16px}.bonus-dialog .ft{padding:12px 16px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border)}
.bonus-card{display:flex;gap:12px;align-items:center;margin:6px 0 12px;padding:10px;border:1px dashed #4b5bd7;border-radius:12px;background:#111636}
.bonus-illu{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;background:#0f1331;border:1px solid var(--border)}
.bonus-illu svg{width:36px;height:36px}

/* Couleur du badge #n selon l‚Äô√©tat de journ√©e */
.round-chip{font-weight:700}
.round-chip.red{border-color:#ef4444;color:#fecaca;background:rgba(239,68,68,.08)}
.round-chip.yellow{border-color:#eab308;color:#fde68a;background:rgba(234,179,8,.10)}
.round-chip.green{border-color:#22c55e;color:#a7f3d0;background:rgba(34,197,94,.10)}

#storage-warning{position:fixed;right:12px;bottom:12px;display:none;background:#0f1331;border:1px solid var(--border);color:var(--muted);border-radius:10px;padding:8px 10px;z-index:99;box-shadow:0 6px 24px rgba(0,0,0,.35)}
#js-ok{position:fixed;right:12px;top:12px;background:#7a2525;color:#fff;padding:6px 10px;border-radius:10px;z-index:9999;font:600 12px system-ui,Segoe UI,Roboto}

/* --------- RELOOK MATCH: 2 colonnes + encarts de sport --------- */
.match-two-col{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(340px,1fr));
  gap:16px;
}
.sport-group{
  background:linear-gradient(180deg,#151c3b,#131734);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
}
.sport-title{
  display:flex;align-items:center;gap:8px;
  font-weight:700;margin:0 0 10px;
}
.sport-title .sport-icon{width:18px;height:18px;display:grid;place-items:center;font-size:16px;line-height:1}
.sport-item{margin:0 0 10px}
.sport-item label{display:block;margin:0 0 6px;color:var(--muted)}
.ping-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ping-row input{width:100%}

.bonus-illu img{width:100%;height:100%;object-fit:cover;border-radius:12px}
.pill .mini-bonus{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;overflow:hidden;margin-left:6px;vertical-align:middle}
.pill .mini-bonus img{width:100%;height:100%;object-fit:cover}
</style>
<style id="round-grid-css">
.round-grid{
  display:grid;
  grid-template-columns:repeat(2, minmax(0,1fr));
  gap:12px;
}
@media (max-width: 900px){
  .round-grid{ grid-template-columns: 1fr; }
}
/* que les items ne rajoutent pas de marge verticale excessive dans la grille */
.round-grid .match-card{ margin:0; }
</style>


<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
window.FIREBASE_CONFIG={apiKey:"AIzaSyBSxiTryd0T1Flv15LBdzu31UFvU_I2J7Q",authDomain:"trisport-9a7b2.firebaseapp.com",databaseURL:"https://trisport-9a7b2-default-rtdb.europe-west1.firebasedatabase.app",projectId:"trisport-9a7b2",messagingSenderId:"132024051367",appId:"1:132024051367:web:f9aa39785a3d4a43875d82"};
</script>



<style id="bonus-scroll-fix">
.bonus-panel{ max-height:90vh; overflow:hidden; display:flex; flex-direction:column; }
.bonus-panel .hd{ position:sticky; top:0; background:var(--card); z-index:3; padding-bottom:8px; }
.bonus-panel .bd{ flex:1 1 auto; overflow:auto; -webkit-overflow-scrolling:touch; padding-right:6px; padding-bottom:calc(84px + env(safe-area-inset-bottom)); }
.bonus-panel .ft{ position:sticky; bottom:0; background:var(--card); padding-top:8px; z-index:3; box-shadow:0 -8px 12px rgba(0,0,0,.25); }
.bonus-select{ gap:8px; }
.bonus-dialog .bonus-card{ grid-template-columns:80px 1fr; padding:10px; border:2px dashed var(--border); border-radius:12px; }
.bonus-dialog .bonus-card .bonus-illu img{ width:72px; height:72px; border-radius:12px; }
.bonus-dialog .bonus-card.selected{ border-color: var(--blue); box-shadow: 0 0 0 2px rgba(75,139,255,.35) inset; }
</style>



<style id="brand-image-header">

/* ===== Header compact + brand images (reliable) ===== */
header, .topbar, .app-header{
  padding-block: 10px !important;
}
header .brand{ display:flex; align-items:center; gap:12px; }

/* Hide old text-based logo/title if present */
header .brand[data-mode="images"] > .logo{ display:none !important; }
header .brand[data-mode="images"] > h1{ display:none !important; }

/* Our real images */
.brand-logo{ width:64px; height:64px; border-radius:14px; display:block; }
.brand-title{ height:72px; width:auto; display:block; }

@media (max-width: 640px){
  .brand-title{ height:60px; }
}
@media (max-width: 420px){
  .brand-title{ height:48px; }
}

</style>
<style id="brand-hide-text">
/* Hide the text title and fallback 'T' bubble in header brand */
header .brand > .logo,
header .brand > h1 { display: none !important; }
</style>

<style id="header-compact-keepimage">

/* ===== Ultra-compact header ‚Äî keep logo/title sizes ===== */
header, .app-header, .topbar{
  padding-block: 6px !important;   /* reduce vertical padding without touching images */
  min-height: unset !important;
}
/* ensure children don't add extra vertical margins */
header *{
  margin-block: 0 !important;
}
/* layout + baseline fixes to avoid extra line-height space */
header .brand{ display:flex; align-items:center; gap:12px; }
header .brand img{ display:block; }             /* remove inline baseline gap */
header nav, header .tabs, header .menu{ display:flex; align-items:center; }
/* optional: slightly tighten chip/button vertical padding */
header .btn, header .chip, header .pill, header .tab{
  padding-top: 8px !important;
  padding-bottom: 8px !important;
}

/* keep the image sizes exactly as they are */
.brand-logo{ width:64px !important; height:64px !important; }
.brand-title{ height:72px !important; width:auto !important; }

/* fine-tune on small screens */
@media (max-width: 640px){
  header, .app-header, .topbar{ padding-block: 4px !important; }
}


/* --- Bonus panel: put params under the card text (minimal, scoped) --- */
#bonus-modal .bonus-dialog .bonus-card{display:grid!important;grid-template-columns:96px 1fr;gap:12px;align-items:start}
#bonus-modal .bonus-dialog .bonus-card .bonus-illu{grid-column:1;grid-row:1}
#bonus-modal .bonus-dialog .bonus-card .bonus-text{grid-column:2;grid-row:1}
#bonus-modal .bonus-dialog .bonus-card .bonus-params{grid-column:2;grid-row:2;margin-top:8px;max-height:0;overflow:hidden;transition:max-height .25s ease,opacity .2s;opacity:.0}
/* When JS opens the wrapper by setting max-height, fade in */
#bonus-modal .bonus-dialog .bonus-card .bonus-params[style*="max-height:"][style*="px"]{opacity:1}
</style>

<style id="capitaine-teamwide-v2">
/* Capitaine : suppression des champs joueur/sport dans l'UI (masqu√©s) */
#capitaine-fields,
#cap-params,
#capitaine-params .grid,
#capitaine-params .row { display: none !important; }
</style>


<style id="tabs-contrast-upgrade">
:root{
  --accent: #7aa2ff;
  --accent-strong: #9ab4ff;
}
.tab{
  position: relative;
  font-weight: 600;
  letter-spacing: .2px;
  transition: background .18s ease, border-color .18s ease, color .18s ease, box-shadow .18s ease;
}
.tab:hover{
  border-color: var(--accent);
  color: #e9edff;
  box-shadow: 0 0 0 1px rgba(122,162,255,.15) inset;
}
.tab[aria-selected="true"]{
  color: #f4f6ff;
  background: linear-gradient(180deg, #2a3aa6, #1f2b86);
  border-color: #4b5bd7;
  box-shadow:
    0 6px 16px rgba(75,139,255,.25),
    0 0 0 1px rgba(75,139,255,.35) inset;
}
.tab[aria-selected="true"]::after{
  content: "";
  position: absolute;
  left: 10px; right: 10px; bottom: -6px;
  height: 3px;
  border-radius: 3px;
  background: linear-gradient(90deg, transparent, var(--accent-strong), transparent);
}
.tab:focus-visible{
  outline: none;
  box-shadow:
    0 0 0 2px rgba(15,18,32,1),
    0 0 0 4px rgba(122,162,255,.8);
}
@media (prefers-contrast: more){
  .tab[aria-selected="true"]{
    background: #2431a0;
    border-color: #9ab4ff;
  }
  .tab[aria-selected="true"]::after{ height: 4px; }
}
@media (prefers-reduced-motion: reduce){
  .tab{ transition: none; }
}
</style>


<style id="matchcard-animations">
/* Smooth expand/collapse for match cards */
.match-card .bd{
  /* default open state */
  transition: max-height .28s ease, opacity .2s ease, padding .2s ease;
  will-change: max-height, opacity;
}
/* Closed state visual without display:none (to allow animation) */
.match-card[aria-expanded="false"] .bd{
  max-height: 0 !important;
  overflow: hidden;
  padding-top: 0 !important;
  padding-bottom: 0 !important;
  opacity: .0;
}
/* When JS finishes opening, we can reset to 'auto' via inline style */
@media (prefers-reduced-motion: reduce){
  .match-card .bd{ transition: none; }
}
</style>


<style id="standings-and-buttons-animations">
/* === Apparition des lignes du classement === */
@keyframes slideUpFade {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}
#table-classement tbody tr {
  animation: slideUpFade .28s ease both;
}
#table-classement tbody tr:nth-child(1){ animation-delay: .00s; }
#table-classement tbody tr:nth-child(2){ animation-delay: .03s; }
#table-classement tbody tr:nth-child(3){ animation-delay: .06s; }
#table-classement tbody tr:nth-child(4){ animation-delay: .09s; }
#table-classement tbody tr:nth-child(5){ animation-delay: .12s; }
#table-classement tbody tr:nth-child(6){ animation-delay: .15s; }
/* r√©duit l'effet si l'utilisateur pr√©f√®re moins d'animation */
@media (prefers-reduced-motion: reduce){
  #table-classement tbody tr{ animation: none !important; }
}

/* === Micro-transitions sur les boutons === */
.btn{
  transition: background .18s ease, border-color .18s ease, color .18s ease, box-shadow .18s ease, transform .06s ease;
  will-change: transform, box-shadow;
}
.btn:hover{
  box-shadow: 0 6px 14px rgba(0,0,0,.25), 0 0 0 1px rgba(122,162,255,.15) inset;
}
.btn:active{
  transform: translateY(1px) scale(.995);
  box-shadow: 0 3px 10px rgba(0,0,0,.25), 0 0 0 1px rgba(122,162,255,.12) inset;
}
.btn.small:active{ transform: translateY(1px) scale(.997); }
.btn.primary:hover{ box-shadow: 0 8px 18px rgba(75,139,255,.25), 0 0 0 1px rgba(75,139,255,.25) inset; }
.btn.danger:hover{ box-shadow: 0 8px 18px rgba(239,68,68,.25), 0 0 0 1px rgba(239,68,68,.25) inset; }
</style>
<style id="chevron-toggle">
/* Chevron d‚Äôouverture/fermeture */
.hd{ position:relative; }
.hd .chev{
  position:absolute; right:12px; top:12px;
  display:inline-block;
  width:1.25em;
  text-align:center;
  opacity:.7;
  transition:transform .18s ease, opacity .18s ease;
}
.hd .chev::before{ content:"‚ñ∂"; display:inline-block; }
.match-card[aria-expanded="true"] .hd .chev{ transform:rotate(90deg); opacity:1; }
/* rendre l'en-t√™te cliquable */
.match-card .hd{ cursor:pointer; }
</style>


<link rel="stylesheet" href="trisports-theme-pack.css" />


<body>
<div id="js-ok">JS non charg√©</div>
<script>(function(){const p=document.getElementById('js-ok');if(p){p.textContent='JS charg√© ‚úÖ';p.style.background='#14532d';}})();</script>

<header>
  <div class="container" style="display:flex;align-items:center;gap:16px;justify-content:space-between;flex-wrap:wrap">
    <div class="brand"><div class="logo">T</div><h1 style="font-size:18px;margin:0">TriSports</h1></div>
    <nav class="tabs" role="tablist" aria-label="Sections" id="tabs">
      <button type="button" class="tab" role="tab" aria-selected="true" data-tab="setup">Tournoi</button>
      <button type="button" class="tab" role="tab" aria-selected="false" data-tab="equipes">√âquipes</button>
      <button type="button" class="tab" role="tab" aria-selected="false" data-tab="calendrier">Rencontres</button>
      <button type="button" class="tab" role="tab" aria-selected="false" data-tab="classement">Classement</button>
      <button type="button" class="tab" role="tab" aria-selected="false" data-tab="options">Options</button>
    </nav>
    <div style="display:flex;align-items:center;gap:8px">
      <span id="tname-top" class="pill" style="display:none"></span>
      <span id="whoami-top" class="pill">visiteur</span>
      <button type="button" class="btn small" id="btn-fullscreen">‚õ∂ Plein √©cran</button>
    </div>
  </div>
</header>

<main>
  <div class="container">
    <div id="storage-warning" class="help" style="display:none"></div>

    <!-- TOURNOI -->
    <section id="setup" class="active">
      <div style="display:flex;justify-content:flex-end;gap:8px;margin:4px 0 8px">
        <button type="button" class="btn small" id="btn-admin-on-setup">Se connecter admin</button>
        <span class="pill" id="whoami-setup">visiteur</span>
      </div>

      <div class="card">
        <div class="hd"><strong>Cr√©er un tournoi (Cloud)</strong></div>
        <div class="bd grid cols-4">
          <div><label>Code cloud (ex: apero2025)</label><input type="text" id="tcode-input" placeholder="code unique"/></div>
          <div><label>Nom du tournoi</label><input type="text" id="tname-input" placeholder="ex : Tournoi de la plage"/></div>
          <div><label>Nombre d‚Äô√©quipes</label><input type="number" id="teams-count-input" min="2" max="64" step="1" value="4"/></div>
          <div></div>
          <div><label>Fl√©chettes ‚Äì Simples (#)</label><input type="number" id="rule-d-s" min="0" max="9" value="2"/></div>
          <div><label>Fl√©chettes ‚Äì Doubles (#)</label><input type="number" id="rule-d-d" min="0" max="9" value="1"/></div>
          <div><label>Points / victoire fl√©chettes</label><input type="number" id="rule-d-p" min="1" max="50" value="5"/></div>
          <div></div>
          <div><label>Ping ‚Äì Simples (#)</label><input type="number" id="rule-p-s" min="0" max="9" value="2"/></div>
          <div><label>Ping ‚Äì Doubles (#)</label><input type="number" id="rule-p-d" min="0" max="9" value="1"/></div>
          <div><label>Points / victoire ping</label><input type="number" id="rule-p-p" min="1" max="50" value="5"/></div>
          <div></div>
          <div><label>Palet ‚Äì Score cible (victoire)</label><input type="number" id="rule-l-target" min="1" max="50" value="11"/></div>
          <div style="grid-column:1/-1;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button type="button" class="btn primary" id="btn-create-tournament">Cr√©er et ouvrir</button>
            <span class="help">Cr√©ation r√©serv√©e √† l‚Äô<b>administrateur</b> (PIN requis).</span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>Ouvrir un tournoi existant (Cloud)</strong></div>
        <div class="bd" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input type="text" id="join-code" placeholder="code du tournoi" style="max-width:220px"/>
          <button type="button" class="btn primary" id="btn-join-code">Rejoindre</button>
          <button type="button" class="btn" id="btn-copy-link">Copier lien ?id=code</button>
          <span class="help">Statut : <span id="cloud-status">hors ligne</span></span>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>Tournois Cloud r√©cents (ce navigateur)</strong></div>
        <div class="bd" id="recent-list"><div class="help">Aucun tournoi cloud list√© pour l‚Äôinstant.</div></div>
      </div>
    </section>

    <!-- EQUIPES -->
    <section id="equipes">
      <div class="card">
        <div class="hd">
          <div>
            <strong>√âquipes</strong>
            <div class="help">L‚Äô<b>administrateur</b> cr√©e et √©dite les √©quipes. Les joueurs se connectent √† leur √©quipe pour saisir <b>leurs scores</b> uniquement.</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="pill" id="lock-pill" style="display:none">Calendrier fig√© üîí</span>
            <button type="button" class="btn" id="btn-add-team" style="display:none">+ Ajouter √©quipe (admin)</button>
            <button type="button" class="btn primary" id="btn-generate">G√©n√©rer le calendrier</button>
          </div>
        </div>
        <div class="bd"><div id="team-list" class="grid responsive"></div></div>
      </div>
    </section>

    <!-- RENCONTRES -->
    <section id="calendrier">
      <div class="card">
        <div class="hd">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <strong>Rencontres</strong>
            <span class="pill" id="round-status">‚Äî</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="pill" id="stats-matches">0 / 0 matches complets</span>
            <button type="button" class="btn small" id="btn-start-round" style="display:none">D√©marrer journ√©e</button>
            <button type="button" class="btn small" id="btn-end-round" style="display:none">Fin de journ√©e</button>
            <button type="button" class="btn small" id="btn-refresh-standings">Mettre √† jour le classement</button>
            <button type="button" class="btn small" id="btn-collapse">Tout replier</button>
          </div>
        </div>
        <div class="bd"><div id="match-list" class="grid"></div></div>
      </div>
    </section>

    <!-- CLASSEMENT -->
    <section id="classement">
      <div class="card">
        <div class="hd">
          <strong>Classement</strong>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="pill" id="teams-count">0 √©quipes</span>
            <span class="pill" id="rounds-count">0 matchs par √©quipe</span>
            <button type="button" class="btn small toggle" id="btn-show-summary" aria-pressed="true">Classement g√©n√©ral</button>
            <button type="button" class="btn small toggle" id="btn-show-h2h" aria-pressed="false">Face √† face</button>
            <button type="button" class="btn small" id="btn-refresh-standings-2">Mettre √† jour</button>
          </div>
        </div>
        <div class="bd" style="overflow:auto">
          <div id="view-summary">
            <div class="help" style="margin-bottom:10px">Points = base + Bonus ‚àí Malus. Le bonus ‚ÄúCapitaine‚Äù est r√©v√©l√© √† la fin de la journ√©e.</div>
            <table id="table-classement">
              <thead>
                <tr>
                  <th>#</th><th>√âquipe</th><th>Points</th>
                  <th>Fl√©chettes</th><th>Ping-pong</th><th>Palet (PF‚ÄìPA)</th>
                  <th>Bonus</th><th>Malus</th>
                  <th>Matchs complets</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="view-h2h" style="display:none">
            <div class="help" style="margin-bottom:10px">Face-√†-face : cliquez sur une cellule pour ouvrir la rencontre.</div>
            <table id="table-h2h" class="h2h-table"><thead></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <!-- OPTIONS -->
    <section id="options">
      <div class="grid cols-2">
        <div class="card"><div class="hd"><strong>Exporter / Importer</strong></div>
          <div class="bd grid" style="gap:10px">
            <button type="button" class="btn" id="btn-export">Exporter en JSON</button>
            <input type="file" id="file-import" accept="application/json"/>
            <button type="button" class="btn" id="btn-import">Importer le fichier JSON</button>
          </div>
        </div>
        <div class="card"><div class="hd"><strong>Acc√®s administrateur</strong></div>
          <div class="bd" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button type="button" class="btn" id="btn-admin-on">Activer admin</button>
            <button type="button" class="btn" id="btn-admin-off">D√©sactiver admin</button>
            <span class="pill" id="whoami">vous : visiteur (lecture seule)</span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>Gestion Cloud</strong></div>
        <div class="bd" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <span class="pill">Statut : <span id="cloud-status-2">hors ligne</span></span>
          <button type="button" class="btn" id="btn-cloud-copy">Copier le lien de partage</button>
          <button type="button" class="btn danger" id="btn-cloud-delete">Supprimer ce tournoi du cloud</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>Tournois Cloud r√©cents</strong></div>
        <div class="bd" id="manage-list"><div class="help">Aucun tournoi m√©moris√©.</div></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>Maintenance</strong></div>
        <div class="bd grid" style="gap:10px">
          <button type="button" class="btn" id="btn-reset-scores">R√©initialiser les scores (garde √©quipes + calendrier)</button>
          <button type="button" class="btn" id="btn-unlock">üîì D√©verrouiller le calendrier</button>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- MODAL BONUS -->
<div id="bonus-modal" aria-hidden="true">
  <div class="bonus-panel bonus-dialog">
    <div class="hd">Choisir un bonus</div>
    <div class="bd">

      <div class="bonus-select">
        <!-- Capitaine -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/capitaine.jpg" alt="">
          </div>
          <div class="bonus-text">
            <div class="bonus-title">Capitaine</div>
            <div class="help">
              Aucun r√©glage.<br>
              <b>+2 points par manche gagn√©e</b> (fl√©chettes & ping, simples et doubles)
              et <b>+2</b> si <b>palet</b> gagn√©.
            </div>
          </div>
        </div>

        <div class="bonus-sep"></div>

        <!-- Miroir -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/miroir.jpg" alt="">
          </div>
          <div class="bonus-text">
            <div class="bonus-title">Miroir</div>
            <div class="help">
              Inverse le bonus adverse sur <b>tout le match</b>.<br>
              Ex&nbsp;: si l‚Äôadversaire choisit <b>Capitaine</b>, son Capitaine s‚Äôapplique √† votre √©quipe.
            </div>
          </div>
        </div>

        <div class="bonus-sep"></div>

        <!-- Ren√© la taupe -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/taupe.png" alt="">
          </div>
          <div class="bonus-text">
            <div class="bonus-title">Ren√© la taupe</div>
            <div class="help">
              Impose des lunettes troublant la vision √† l‚Äôadversaire dans un sport choisi.<br>
              Si l‚Äôadversaire joue <b>Miroir</b>, <i>vous</i> portez les lunettes.
            </div>
          </div>
        </div>

        <div class="bonus-sep"></div>

        <!-- 10 pouces 2 mains gauche -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/main-gauche.png" alt="">
          </div>
          <div class="bonus-text">
            <div class="bonus-title">10 pouces 2 mains gauche</div>
            <div class="help">
              L‚Äôadversaire doit jouer un sous-match avec sa <b>mauvaise main</b> (droitier ‚Üí main gauche, gaucher ‚Üí main droite).<br>
              Choisissez le sport concern√©.
            </div>
          </div>
        </div>

        <div class="bonus-sep"></div>

        <!-- Melon d'or -->
        <div class="bonus-card" data-bonus-type="melon">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/melon.png" alt="Melon d'or">
          </div>
          <div class="bonus-text">
            <div class="bonus-title">Melon d'or</div>
            <div class="help">Nouveau bonus ‚Äî d√©tails √† venir.</div>
          </div>
        </div>
      </div>

      <!-- Texte d'aide dynamique -->
      <div class="help" id="bonus-context">
        Capitaine : aucun r√©glage. +2/manche gagn√©e ; +2 si palet.
      </div>

      <!-- Param√®tres (ins√©r√©s sous la carte correspondante) -->
      <!-- Capitaine n‚Äôa plus de param√®tres -->
      <div id="taupe-fields" class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Sport</label>
          <select id="taupe-sport">
            <option value="darts">Fl√©chettes</option>
            <option value="ping">Ping</option>
            <option value="palet">Palet</option>
          </select>
        </div>
      </div>

      <div id="lefthand-fields" class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Sport</label>
          <select id="lefthand-sport">
            <option value="darts">Fl√©chettes</option>
            <option value="ping">Ping</option>
            <option value="palet">Palet</option>
          </select>
        </div>
      </div>
      <div id="melon-fields" class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Sport</label>
          <select id="melon-sport">
            <option value="darts">Fl√©chettes</option>
            <option value="ping">Ping</option>
            <option value="palet">Palet</option>
          </select>
        </div>
      </div>


    </div>
    <div class="ft">
      <button type="button" class="btn" id="bonus-cancel">Annuler</button>
      <button type="button" class="btn primary" id="bonus-save">Valider</button>
    </div>
  </div>
</div>


<script>
'use strict';
/* ===== Helpers ===== */

/**
 * @typedef {Object} RoundCtl
 * @property {boolean} started
 * @property {boolean} finished
 *
 * @typedef {Object.<string, any>} Team
 *
 * @typedef {Object} AppState
 * @property {number} version
 * @property {string} tid
 * @property {string|null} cloudId
 * @property {string} tournamentName
 * @property {Object} rules
 * @property {Array<Team>} teams
 * @property {Array<any>} matches
 * @property {Object.<number, RoundCtl>} roundCtl
 * @property {Object.<number, Object.<string, any>>} bonusSelections
 * @property {Object.<number, Object.<string, number>>} bonusApplied
 * @property {Object.<number, Object.<string, boolean>>} bonusUsed
 */


// Centralise libell√©s/images pour les bonus (√©vite les erreurs de frappe)
const BONUS = {
  /** @param {"capitaine"|"miroir"|"taupe"|"lefthand"|"melon"|string} type */
  labelForType(type){
    switch(type){
      case "miroir":   return "Miroir";
      case "taupe":    return "Ren√© la taupe";
      case "lefthand": return "10 pouces 2 mains gauche";
      case "melon":    return "Melon d'or";
      default:         return "Capitaine";
    }
  },
  imgForType(type){
    switch(type){
      case "miroir":   return "miroir.jpg";
      case "taupe":    return "taupe.png";
      case "lefthand": return "main-gauche.png";
      case "melon":    return "melon.png";
      default:         return "capitaine.jpg";
    }
  },
  sportLabel(s){ return s==="darts" ? "Fl√©chettes" : (s==="ping" ? "Ping" : "Palet"); },
  playerLabel(p){ return p==="p1" ? "J1" : "J2"; }
};

// Helpers s√ªrs pour initialiser les containers imbriqu√©s
function ensure(obj, key, defFactory){
  if(!obj[key]) obj[key] = defFactory();
  return obj[key];
}

const id=x=>document.getElementById(x), qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const esc=s=>(s==null?"":String(s)).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","\"":"&quot;","'":"&#39;"}[c]));
const uid=()=>Math.random().toString(36).slice(2,10);
const clampInt=(v,min,max)=>{v=parseInt(v,10);if(isNaN(v))return null;return Math.max(min,Math.min(max,v));}
const help=t=>{const d=document.createElement("div");d.className="help";d.textContent=t;return d;}
function hashPass(s){s=(s||"").trim();let h=0x811c9dc5>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,0x01000193)>>>0}return("00000000"+h.toString(16)).slice(-8)}
const hy=(a,b)=>`${a}\u2011${b}`;
const BONUS_VAL=5;

/* ===== Erreurs visibles ===== */
window.onerror=(msg,src,line,col)=>{const el=id("storage-warning");if(el){el.style.display="block";el.textContent="Erreur JS : "+msg+" @"+(src||"")+":"+(line||0)+":"+(col||0)} const p=id("js-ok");if(p){p.textContent='JS charg√© avec erreurs ‚ö†Ô∏è';p.style.background='#8a2a2a'}};

/* ===== Index Cloud (local) ===== */
const STORAGE_KEY="trisports_cloud_only_v1"; const IDX_KEY="trisports_cloud_index_v1";
function getIndex(){try{return JSON.parse(localStorage.getItem(IDX_KEY)||"[]")}catch(_){return[]}}
function setIndex(a){try{localStorage.setItem(IDX_KEY,JSON.stringify(a||[]))}catch(_){}}
function upsertIndex(e){const i=getIndex();const k=i.findIndex(x=>x.id===e.id);if(k>=0)i[k]=Object.assign({},i[k],e);else i.unshift(e);setIndex(i)}
function nameExistsLocally(n){n=(n||"").trim().toLowerCase();if(!n)return false;return getIndex().some(e=>(e.name||"").trim().toLowerCase()===n)}
function codeExistsLocally(c){return getIndex().some(e=>e.id===c)}
function renderSetupRecent(){const wrap=id("recent-list");wrap.innerHTML="";const idx=getIndex().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));if(!idx.length){wrap.appendChild(help("Aucun tournoi cloud list√© pour l‚Äôinstant."));return}const box=document.createElement("div");box.style.display="flex";box.style.flexWrap="wrap";box.style.gap="8px";idx.forEach(e=>{const btn=document.createElement("button");btn.className="btn";btn.type="button";btn.textContent="‚òÅ "+e.name+" ("+e.id+")";btn.dataset.openId="cloud:"+e.id;const del=document.createElement("button");del.className="btn danger";del.type="button";del.textContent="Supprimer du cloud";del.dataset.deleteId=e.id;const w=document.createElement("div");w.style.display="flex";w.style.gap="6px";w.append(btn,del);box.appendChild(w)});wrap.appendChild(box)}
function renderManageList(){renderSetupRecent()}

/* ===== √âtat ===== */
let state={version:40,tid:uid(),cloudId:null,tournamentName:"",rules:{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11},teams:[],matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};
let ui={open:{},h2h:false}; let session={admin:false,claims:{}};
// === Session persistence (admin & team claims) ===
(function(){
  const SESSION_KEY = 'trisports.session.v1';
  const MAX_AGE_MS = 7 * 24 * 60 * 60 * 1000; // 7 jours

  function loadPersisted(){
    try{
      const raw = localStorage.getItem(SESSION_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(!obj || !obj.t || (Date.now() - obj.t) > MAX_AGE_MS) return;
      if (typeof obj.admin === 'boolean') session.admin = obj.admin;
      if (obj.claims && typeof obj.claims === 'object') session.claims = obj.claims;
    }catch(e){ /* ignore */ }
  }

  function persistNow(){
    try{
      const payload = { t: Date.now(), admin: !!session.admin, claims: session.claims || {} };
      localStorage.setItem(SESSION_KEY, JSON.stringify(payload));
    }catch(e){ /* ignore */ }
  }

  // Load once on boot
  loadPersisted();

  // Persist on unload and also whenever we detect a change
  window.addEventListener('beforeunload', persistNow);

  // Optional helper APIs for your code
  window.persistSessionNow = persistNow;
  window.clearSessionPersistence = function(){
    try{ localStorage.removeItem(SESSION_KEY); }catch(e){}
  };
})();
function isAdmin(){return !!session.admin} function hasClaim(tid){return !!session.claims[tid]}
// === Droits de saisie des scores selon l'√©tat de la journ√©e ===
function _iAmTeamOf(m){ return hasClaim(m.a) || hasClaim(m.b); }
function canEditScores(m, rCtl){
  if (!rCtl.started && !rCtl.finished) return false; // pas commenc√© -> personne
  if (rCtl.finished) return isAdmin();               // termin√© -> admin seul
  return isAdmin() || _iAmTeamOf(m);                 // en cours -> admin + √©quipe du match
}

function teamObj(tid){return state.teams.find(t=>t.id===tid)||null} function teamName(tid){const t=teamObj(tid);return t?t.name:"‚Äî"}
function initials(name){const s=(name||"").trim();if(!s)return"?";const p=s.split(/\s+/);return(p[0][0]+(p[1]?.[0]||"")).toUpperCase()}
function avatarHtml(tid,size,attrs){const t=teamObj(tid)||{name:"?"};const url=t.avatar;const cls=size==='lg'?'avatar-lg':(size==='sm'?'avatar-sm':'');const extra=attrs?(' '+attrs):'';const content=url?('<img src="'+esc(url)+'" alt="avatar">'):('<span class="avatar-initials">'+esc(initials(t.name))+'</span>');return '<span class="avatar '+cls+'" title="'+esc(t.name)+'"'+extra+'>'+content+'</span>'}
function updateWho(){const names=Object.keys(session.claims||{}).map(teamName).filter(Boolean);const who=isAdmin()?(names.length?("Admin ¬∑ "+names.join(", ")):"Admin"):(names[0]||"visiteur");id("whoami").textContent="vous : "+who;id("whoami-top").textContent=who;const s=id("whoami-setup");if(s)s.textContent=who;const b=id("btn-add-team");if(b)b.style.display=isAdmin()?"inline-block":"none";const ba=id("btn-admin-on-setup");if(ba)ba.style.display=isAdmin()?"none":"inline-block"}
function renderTitle(){const name=(state.tournamentName||"").trim();document.title=(name?name+" ‚Äî ":"")+"TriSports ‚Äî Fl√©chettes ‚Ä¢ Ping-pong ‚Ä¢ Palet";const pill=id("tname-top");if(name){pill.style.display="inline-block";pill.textContent=name}else{pill.style.display="none";pill.textContent=""}}
function dartsTotal(){return (state.rules?.dartsSingles||0)+(state.rules?.dartsDoubles||0)}
function pingTotal(){return (state.rules?.pingSingles||0)+(state.rules?.pingDoubles||0)}
function ensureLengths(m){const dN=dartsTotal(),pN=pingTotal();m.darts=Array.isArray(m.darts)?m.darts.slice(0,dN):[];while(m.darts.length<dN)m.darts.push(null);if(!Array.isArray(m.pingPts))m.pingPts=[];m.pingPts=m.pingPts.slice(0,pN);while(m.pingPts.length<pN)m.pingPts.push({a:null,b:null});}
function _normMatch(m){m=m||{};m.id=m.id||uid();m.a=m.a||"";m.b=m.b||"";ensureLengths(m);m.palet=m.palet||{a:null,b:null};m.palet.a=(m.palet.a==null?null:+m.palet.a);m.palet.b=(m.palet.b==null?null:+m.palet.b);m.round=m.round||1;m.order=m.order||0;return m}
function normalize(){state.rules=state.rules||{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11};state.teams=Array.isArray(state.teams)?state.teams:[];state.matches=Array.isArray(state.matches)?state.matches.map(_normMatch):[];state.protect=state.protect||{};state.protect.teamPassHash=state.protect.teamPassHash||{};state.roundCtl=state.roundCtl||{};state.bonusSelections=state.bonusSelections||{};state.bonusApplied=state.bonusApplied||{};state.bonusUsed=state.bonusUsed||{};state.bonusUsed=state.bonusUsed||{}}

/* ===== Firebase ===== */
const cloud={enabled:false,db:null,id:null,ref:null,timer:null}; const hasFB=!!(window.firebase&&window.FIREBASE_CONFIG&&window.FIREBASE_CONFIG.apiKey);
function initFB(){try{if(!hasFB)return null;if(!firebase.apps||firebase.apps.length===0)firebase.initializeApp(window.FIREBASE_CONFIG);return firebase.database()}catch(_){return null}}
// If Firebase Auth is present, ensure local persistence
try{
  if (window.firebase && firebase.auth){
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
  }
}catch(e){}
function setCloudTxt(t){id("cloud-status").textContent=t;id("cloud-status-2").textContent=t}
function unsubscribeCloud(){try{if(cloud.ref)cloud.ref.off('value')}catch(_){ }cloud.ref=null;cloud.enabled=false;cloud.id=null;setCloudTxt('hors ligne')}
function resetState(){state={version:40,tid:uid(),cloudId:null,tournamentName:"",rules:{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11},teams:[],matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};try{localStorage.removeItem(STORAGE_KEY)}catch(_){}} 
function joinCloud(code){if(!hasFB){alert("Firebase non configur√©.");return}if(!cloud.db){cloud.db=initFB();if(!cloud.db){alert("Init Firebase impossible.");return}}unsubscribeCloud();cloud.id=(code||"").trim();if(!cloud.id){alert("Saisis un code tournoi.");return}cloud.ref=cloud.db.ref("tournaments/"+cloud.id+"/payload");cloud.enabled=true;setCloudTxt("connexion");cloud.ref.on("value",snap=>{const val=snap.val();if(!val){setCloudTxt("connect√© (vide)");return}safeSetStateFromCloud(val);normalize();state.cloudId=cloud.id;localStorage.setItem(STORAGE_KEY,JSON.stringify(state));upsertIndex({id:cloud.id,name:state.tournamentName||"Sans titre",updatedAt:Date.now()});renderAll();setCloudTxt("connect√© ("+cloud.id+")")});try{history.replaceState(null,"",location.pathname+"?id="+encodeURIComponent(cloud.id))}catch(_){}}

function safeSetStateFromCloud(val){
  try{
    if(!val || typeof val!=="object" || !val.state || typeof val.state!=="object"){
      // pas d'√©tat valide c√¥t√© cloud : on laisse l'√©tat local tel quel
      return;
    }
    state = val.state;
  }catch(_){ /* on ignore, on garde l'√©tat local */ }
}

function pushCloud(immediate){if(!cloud.enabled||!cloud.ref)return;clearTimeout(cloud.timer);cloud.timer=setTimeout(()=>cloud.ref.set({state,updatedAt:Date.now()}),immediate?0:250)}
function deleteCloud(code){if(!cloud.db){cloud.db=initFB()}return cloud.db.ref("tournaments/"+code).remove()}
function saveState(){normalize();localStorage.setItem(STORAGE_KEY,JSON.stringify(state));upsertIndex({id:state.cloudId||cloud.id||"?",name:state.tournamentName||"Sans titre",updatedAt:Date.now()});renderTitle();renderSetupRecent();renderManageList();if(cloud.enabled)pushCloud()}

/* Plein √©cran */
document.addEventListener("fullscreenchange",()=>{const b=id("btn-fullscreen");if(!b)return;b.textContent=document.fullscreenElement?"Quitter plein √©cran":"‚õ∂ Plein √©cran"});

/* ===== Calendrier ===== */
function generateSchedule(){const ids=state.teams.map(t=>t.id);if(ids.length<2){state.matches=[];saveState();renderMatches();return}const BYE="__BYE__";if(ids.length%2===1)ids.push(BYE);const fixed=ids[0],rest=ids.slice(1);for(let i=rest.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[rest[i],rest[j]]=[rest[j],rest[i]]}const n=ids.length,rounds=n-1;const out=[];let order=0;for(let r=0;r<rounds;r++){const arr=[fixed].concat(rest),half=n/2,pairs=[];for(let k=0;k<half;k++){const a=arr[k],b=arr[n-1-k];if(a!==BYE&&b!==BYE)pairs.push((r%2===0)?[a,b]:[b,a])}rest.unshift(rest.pop());if(pairs.length>1){let shift=r%pairs.length;while(shift-->0)pairs.unshift(pairs.pop())}for(const pr of pairs){out.push(_normMatch({id:uid(),a:pr[0],b:pr[1],darts:Array(dartsTotal()).fill(null),pingPts:Array(pingTotal()).fill({a:null,b:null}),palet:{a:null,b:null},round:r+1,order:order++}))}}out.sort((x,y)=>(x.round-y.round)||(x.order-y.order));state.matches=out;ui.open={};state.roundCtl={};state.bonusSelections={};state.bonusApplied={};saveState();renderMatches()}
function renderTeams(){const el=id("team-list");el.innerHTML="";if(!state.teams.length){el.appendChild(help("Aucune √©quipe. Utilisez l‚Äôonglet ¬´ Tournoi ¬ª pour cr√©er/rejoindre un tournoi cloud."));updateCounts();updateLock();return}state.teams.forEach((t,idx)=>{const iOwn=hasClaim(t.id),admin=isAdmin(),hasHash=!!(state.protect?.teamPassHash?.[t.id]);const dis=admin?'':' disabled';const delBtn=(admin&&!state.locked)?`<button type="button" class="btn small danger" data-act="del" data-id="${t.id}">Supprimer</button>`:'';const protectInfo=hasHash?(iOwn?'üîí vous √™tes connect√© √† cette √©quipe':'üîí prot√©g√©e par mot de passe'):'üîì non prot√©g√©e ‚Äî demandez √† l‚Äôadmin de d√©finir un mot de passe';const protectBtns=(admin?`<button type="button" class="btn small" data-act="setpass" data-id="${t.id}">D√©finir / changer mot de passe</button>`:'')+(!iOwn?`<button type="button" class="btn small" data-act="login" data-id="${t.id}">Se connecter √† cette √©quipe</button>`:`<button type="button" class="btn small" data-act="logout" data-id="${t.id}">Se d√©connecter</button>`);const avatarBtn=(admin||iOwn)?`<button type="button" class="btn small" data-act="avatar" data-id="${t.id}">Changer avatar</button>`:'';const avatarClr=((admin||iOwn)&&t.avatar)?`<button type="button" class="btn small" data-act="avatar-clear" data-id="${t.id}">Retirer avatar</button>`:'';const card=document.createElement("div");card.className="match-card";card.setAttribute("aria-expanded","true");card.innerHTML=`<div class="hd team-header" style="border:none;border-bottom:1px solid var(--border)"><div class="teams"><span class="chip">#${idx+1}</span><span class="team-name">${avatarHtml(t.id,'lg','data-click-avatar="'+t.id+'"')}<input type="text"${dis} value="${esc(t.name)}" data-field="name" data-id="${t.id}"/></span></div></div><div class="bd"><input type="file" accept="image/*" data-avatar="${t.id}" style="display:none"/><div class="grid cols-2"><div><label>Joueur¬∑se 1</label><input type="text"${dis} value="${esc(t.p1)}" data-field="p1" data-id="${t.id}"/></div><div><label>Joueur¬∑se 2</label><input type="text"${dis} value="${esc(t.p2)}" data-field="p2" data-id="${t.id}"/></div></div><div class="help" style="margin-top:6px">${protectInfo}</div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${avatarBtn}${avatarClr}${protectBtns}</div><div style="display:flex;justify-content:flex-end;margin-top:10px">${delBtn}</div></div>`;el.appendChild(card)});qsa('#team-list input[data-field]').forEach(inp=>{const tid=inp.getAttribute("data-id"),f=inp.getAttribute("data-field");inp.addEventListener("input",()=>{if(!isAdmin())return;const t=teamObj(tid);if(!t)return;t[f]=inp.value;localStorage.setItem(STORAGE_KEY,JSON.stringify(state))});inp.addEventListener("blur",()=>{if(!isAdmin())return;const t=teamObj(tid);if(!t)return;t[f]=inp.value;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()})});qsa('#team-list input[type="file"][data-avatar]').forEach(inp=>{inp.addEventListener("change",async()=>{const tid=inp.getAttribute("data-avatar");if(!(isAdmin()||hasClaim(tid)))return;const file=inp.files?.[0];if(!file)return;try{const url=await fileToSquareDataURL(file,160);const t=teamObj(tid);if(!t)return;t.avatar=url;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}catch{alert("√âchec du chargement de l‚Äôavatar.")}finally{inp.value=""}})});updateCounts();updateLock()}
function fileToSquareDataURL(file,size){return new Promise((resolve,reject)=>{const r=new FileReader();r.onerror=()=>reject(new Error("read"));r.onload=()=>{const img=new Image();img.onload=()=>{try{const m=Math.min(img.width,img.height),sx=(img.width-m)/2,sy=(img.height-m)/2;const c=document.createElement("canvas");c.width=size;c.height=size;c.getContext('2d').drawImage(img,sx,sy,m,m,0,0,size,size);resolve(c.toDataURL('image/jpeg',0.9))}catch(e){reject(e)}};img.onerror=()=>reject(new Error("img"));img.src=r.result};r.readAsDataURL(file)})}
function updateCounts(){id("teams-count").textContent=state.teams.length+" "+(state.teams.length>1?"√©quipes":"√©quipe");const per=Math.max(0,state.teams.length-1);id("rounds-count").textContent=per+" "+(per>1?"matchs":"match")+" par √©quipe"}
function updateLock(){const pill=id("lock-pill");if(pill)pill.style.display=state.locked?"inline-block":"none";const gen=id("btn-generate");if(gen){gen.disabled=!!state.locked;gen.textContent=state.locked?"Calendrier fig√©":"G√©n√©rer le calendrier"}}

/* ===== Rencontres & Scores ===== */
const getPingPts = m => { return Array.isArray(m.ping) ? m.ping.map(v => (v===0?{a:1,b:0} : (v===1?{a:0,b:1}:{a:null,b:null}))) : (Array.isArray(m.pingPts)?m.pingPts:Array(pingTotal()).fill({a:null,b:null})); };
const isPingValid=(a,b)=>{ if(a==null||b==null) return false; if((a===1&&b===0)||(a===0&&b===1)) return true; if(isNaN(a)||isNaN(b)) return false; const max=Math.max(a,b), diff=Math.abs(a-b); return (max>=11)&&(diff>=2); }
function computeSetWins(m){ensureLengths(m);const aw={darts:0,ping:0},bw={darts:0,ping:0};m.darts.forEach(v=>{if(v===0)aw.darts++;else if(v===1)bw.darts++});getPingPts(m).forEach(s=>{const a=(s.a==null?null:+s.a),b=(s.b==null?null:+s.b);if(isPingValid(a,b)){if(a>b)aw.ping++;else if(b>a)bw.ping++}});return{aw,bw}}
function isMatchComplete(m){ensureLengths(m);const okD=m.darts.every(v=>v===0||v===1);const okP=getPingPts(m).every(s=>isPingValid(+s.a,+s.b));const T=+state.rules.paletTarget||11,pa=(m.palet?.a==null?null:+m.palet?.a),pb=(m.palet?.b==null?null:+m.palet?.b);const okL=(pa!=null&&pb!=null)&&((pa===T&&pb>=0&&pb<=T-1)||(pb===T&&pa>=0&&pa<=T-1));return okD&&okP&&okL}
// UI completeness stricter check
function uiIsComplete(m){
  const dN = dartsTotal();
  const pN = 3; // S1, S2, D1
  const okD = Array.isArray(m.darts) && m.darts.length===dN && m.darts.every(v=>v===0||v===1);
  const okP = Array.isArray(m.ping)  && m.ping.length===pN && m.ping.every(v=>v===0||v===1);
  const a = m.palet?.a, b = m.palet?.b;
  const okL = (typeof a === 'number' && typeof b === 'number');
  return okD && okP && okL;
}catch(e){ return false; }
}

const findMatch=mid=>state.matches.find(x=>x.id===mid);
function clearMatch(mid){const m=findMatch(mid);if(!m)return;if(!(isAdmin()||hasClaim(m.a)||hasClaim(m.b)))return;if(!confirm("Effacer tous les scores de ce match ?"))return;m.darts=Array(dartsTotal()).fill(null);m.pingPts=Array(pingTotal()).fill({a:null,b:null});m.palet={a:null,b:null};saveState();renderMatches()}

/* ===== Bonus ===== */
function roundState(r){state.roundCtl[r]=state.roundCtl[r]||{started:false,finished:false};return state.roundCtl[r]}
function setBonusSelection(r,tid,sel){state.bonusSelections[r]=state.bonusSelections[r]||{};state.bonusSelections[r][tid]=sel}
function getBonusSelection(r,tid){return(state.bonusSelections[r]||{})[tid]||null}
function setBonusApplied(r,tid,pts){state.bonusApplied[r]=state.bonusApplied[r]||{};state.bonusApplied[r][tid]=pts}
function getBonusAppliedSum(tid){let s=0;for(const r in state.bonusApplied){const v=state.bonusApplied[r]?.[tid];if(v)s+=v}return s}
function teamBonusUsed(tid){const t=teamObj(tid);return !!(t&&t.bonusCapitaineUsed)}function markTeamBonusUsed(tid){const t=teamObj(tid);if(t)t.bonusCapitaineUsed=true}

/* Capitaine ‚Äî calcul robuste */
function computeCapitaineBonusForMatch(match, teamId/*, _player, _sport */){
  try{
    let wins = 0;
    const isA = (match.a === teamId), isB = (match.b === teamId);
    if (!isA && !isB) return 0;

    // Fl√©chettes
    if (Array.isArray(match.darts)) {
      match.darts.forEach(v=>{
        if (v===0 && isA) wins++;
        else if (v===1 && isB) wins++;
      });
    }

    // Ping (0/1 ou score valide ‚â•11 avec 2 pts d‚Äô√©cart)
    const getPingPts = (m) => Array.isArray(m.ping)
      ? m.ping.map(v => (v===0?{a:1,b:0} : (v===1?{a:0,b:1}:{a:null,b:null})))
      : (Array.isArray(m.pingPts) ? m.pingPts : []);
    const isPingValid = (a,b) => {
      if(a==null||b==null) return false;
      if((a===1&&b===0)||(a===0&&b===1)) return true;
      if(isNaN(a)||isNaN(b)) return false;
      const max=Math.max(a,b), diff=Math.abs(a-b);
      return (max>=11)&&(diff>=2);
    };
    (getPingPts(match) || []).forEach(s=>{
      const a = (s && s.a!=null) ? +s.a : null;
      const b = (s && s.b!=null) ? +s.b : null;
      if (!isPingValid(a,b)) return;
      if (a>b && isA) wins++;
      else if (b>a && isB) wins++;
    });

    // Palet
    const target = +((window.state && state.rules && state.rules.paletTarget) ?? 11);
    const pa = (match.palet && match.palet.a!=null) ? +match.palet.a : null;
    const pb = (match.palet && match.palet.b!=null) ? +match.palet.b : null;
    if (pa!=null && pb!=null){
      if (pa>=target && pa>pb && isA) wins++;
      else if (pb>=target && pb>pa && isB) wins++;
    }

    return 2 * wins;
  }catch(e){ return 0; }
}

/* Melon d‚Äôor ‚Äî ¬±2 √ó diff√©rence en POINTS sur le sport choisi (1 manche = 5 pts au ping & fl√©chettes) */

function computeMelonBonusForMatch(m, tid, sport){
  try{
    const isA = (m.a === tid);
    const isB = (m.b === tid);
    if(!isA && !isB) return 0;

    if (sport === 'darts') {
      // Manches gagn√©es -> points (√ó5)
      let aw=0, bw=0;
      (m.darts||[]).forEach(v=>{ if(v===0) aw++; else if(v===1) bw++; });
      const myPts  = (isA ? aw : bw) * 5;
      const oppPts = (isA ? bw : aw) * 5;
      if (myPts > oppPts) return myPts;
      if (myPts < oppPts) return -oppPts;
      return 0;
    } else if (sport === 'ping') {
      // Manches gagn√©es par set -> points (√ó5)
      let aw=0, bw=0;
      (getPingPts(m) || []).forEach(s=>{
        const a = (s && s.a!=null) ? +s.a : null;
        const b = (s && s.b!=null) ? +s.b : null;
        if (!isPingValid(a,b)) return;
        if (a>b) aw++; else if (b>a) bw++;
      });
      const myPts  = (isA ? aw : bw) * 5;
      const oppPts = (isA ? bw : aw) * 5;
      if (myPts > oppPts) return myPts;
      if (myPts < oppPts) return -oppPts;
      return 0;
    } else { // palet
      const a = (m.palet && m.palet.a!=null) ? +m.palet.a : null;
      const b = (m.palet && m.palet.b!=null) ? +m.palet.b : null;
      if (a==null || b==null) return 0;
      const myPF  = isA ? a : b;
      const oppPF = isA ? b : a;
      if (myPF > oppPF) return myPF;                 // victoire => +PF
      if (myPF < oppPF) return - (2 * (11 - myPF));  // d√©faite => -2√ó(11‚àíPF √©quipe)
      return 0;
    }
  }catch(e){ return 0; }
}
/* === Recompute all bonuses for finished rounds (used when admin edits scores after closure) === */
function recomputeAllBonuses(){
  try{
    const rounds = (state.matches || []).map(m=>m.round).filter((v,i,a)=>a.indexOf(v)===i).sort((a,b)=>a-b);
    state.bonusApplied = state.bonusApplied || {};
    rounds.forEach(r=>{
      const rs = roundState(r);
      if (!rs || !rs.finished) return;
      const matches = (state.matches || []).filter(m=>m.round===r);
      const sels = (state.bonusSelections && state.bonusSelections[r]) || {};
      // reset applied
      state.bonusApplied[r] = state.bonusApplied[r] || {};
      Object.keys(sels).forEach(tid=>{ state.bonusApplied[r][tid]=0; });

      Object.keys(sels).forEach(tid=>{
        const sel = sels[tid]; if (!sel) return;
        let total = 0;
        if (sel.type === 'capitaine'){
          matches.forEach(m=>{ total += computeCapitaineBonusForMatch(m, tid, sel.player, sel.sport); });
        } else if (sel.type === 'melon'){
          const m = matches.find(x=>x.a===tid || x.b===tid);
          if (m){
            const oppId = (m.a===tid ? m.b : m.a);
            const oppSel = sels[oppId];
            if (oppSel && oppSel.type === 'miroir'){
              total = 0; // sera ajout√© c√¥t√© Miroir
            } else {
              const sport = sel.sport || 'darts';
              total = computeMelonBonusForMatch(m, tid, sport);
            }
          }
        } else if (sel.type === 'miroir'){
          const m = matches.find(x=>x.a===tid || x.b===tid);
          if (m){
            const oppId = (m.a===tid ? m.b : m.a);
            const oppSel = sels[oppId];
            if (oppSel && oppSel.type === 'melon'){
              const sport = oppSel.sport || 'darts';
              total = computeMelonBonusForMatch(m, tid, sport);
            }
          }
        }
        state.bonusApplied[r][tid] = total;
      });
    });
  }catch(e){ /* noop */ }
}




/* Ic√¥nes pour titres de sport */
function sportIcon(name){
  if(name==='darts'){ return `<span class="sport-icon" role="img" aria-label="fl√©chettes">üéØ</span>`; }
  if(name==='ping'){  return `<span class="sport-icon" role="img" aria-label="ping-pong">üèì</span>`; }
  return `<span class="sport-icon" role="img" aria-label="palet">ü•è</span>`;
}

/* ===== Rendu Rencontres ===== */
let CURRENT_ROUND=null;
function setRoundStatusPillClasses(pill,rs){
  pill.classList.remove('red','yellow','green');
  if(rs.finished) pill.classList.add('green');
  else if(rs.started) pill.classList.add('yellow');
  else pill.classList.add('red');
}
function bonusChip(r, mTeam, rs){
  const sel = getBonusSelection(r, mTeam);
  const iAmTeam = hasClaim(mTeam);
  const roundFinished = !!rs.finished;

  // Admin : ne voit rien avant la fin de journ√©e
  if (isAdmin() && !roundFinished) return '';

  // Aucune s√©lection
  const bonusUsed = (state.bonusUsed?.[r]?.[mTeam]) || false;
  const canChoose = (!rs.started && !rs.finished && !bonusUsed && iAmTeam);
  if (!sel) {
    if (!roundFinished) {
      // Avant la fin : seulement un bouton pour l'√©quipe connect√©e ; rien pour l'adversaire
      return canChoose ? (
        '<button type="button" class="bonus-btn" data-bonus data-team="' + mTeam + '">üéñ Bonus</button>'
      ) : '';
    }
    // Apr√®s la fin : pilule Pas de bonus
    return '<span class="pill">Pas de bonus</span>';
  }

  // D√©j√† choisi : avant fin, visible uniquement par l'√©quipe concern√©e
  if (!roundFinished && !iAmTeam) return '';

  const type = sel.type || 'capitaine';
  const lblType =
    type === 'miroir'   ? 'Miroir' :
    type === 'taupe'    ? 'Ren√© la taupe' :
    type === 'lefthand' ? '10 pouces 2 mains gauche' :
    type === 'melon'    ? 'Melon d\'or' :
                          'Capitaine';

  const img =
    type === 'miroir'   ? 'miroir.jpg' :
    type === 'taupe'    ? 'taupe.png' :
    type === 'lefthand' ? 'main-gauche.png' :
    type === 'melon'    ? 'melon.png' :
                          'capitaine.jpg';

  const labelSport = sel.sport ? BONUS.sportLabel(sel.sport) : null;
  const sportEmoji = (labelSport === 'Fl√©chettes' ? 'üéØ' :
                     labelSport === 'Ping'        ? 'üèì' :
                     labelSport === 'Palet'       ? 'ü•è' : '');

  const labelPlayer = sel.player === 'p1' ? 'J1' : (sel.player === 'p2' ? 'J2' : null);

  if (!roundFinished) {
    // Pastille c√¥t√© √©quipe qui a choisi (avant la fin)
    var parts = [lblType];
    if (labelPlayer && type === 'capitaine') parts.push(labelPlayer);
    if (labelSport && (type==='taupe' || type==='lefthand' || type==='melon')) parts.push(labelSport);
    var __lbl = parts.join(' / ');
    return '<span class="pill blue">Bonus' + (sportEmoji?('<span class="sport-emo">'+sportEmoji+'</span>'):'') + '<span class="mini-bonus"><img src="img/' + img + '" alt="' + __lbl + '"></span>' + '</span>';
  } else {
    // R√©v√©l√© √† tous une fois fini, avec points appliqu√©s
    const applied = Math.abs((state.bonusApplied?.[r]?.[mTeam]) || 0);
    const sign = ((state.bonusApplied?.[r]?.[mTeam]) || 0) >= 0 ? '+' : '‚àí';
    const valClass = ((state.bonusApplied?.[r]?.[mTeam]) || 0) >= 0 ? 'pos' : 'neg';
    const extra = (
      type === 'capitaine' ? (labelPlayer ? (' / ' + labelPlayer) : '') :
      ((type==='taupe' || type==='lefthand' || type==='melon') && labelSport ? (' / ' + labelSport) : '')
    );
    return '<span class="pill bonus-flashy ' + valClass + '" ' +
       (sportEmoji?('data-tip="' + (lblType + ' ‚Äî Sport : ' + labelSport) + '"') : ('data-tip="' + lblType + '"')) +
       '>Bonus' +
       '<span class="mini-bonus"><img src="img/' + img + '" alt="' + lblType + '"></span>' +
       (sportEmoji?('<span class="sport-emo">'+sportEmoji+'</span>'):'') +
       '<span class="' + valClass + '\">' + sign + applied + '</span>' +
       '</span>';
  }
}

// === In-place update of the match completeness chip ===
function updateMatchCompleteness(mid){
  try{
    const m = (state.matches || []).find(x=>x.id===mid);
    if(!m) return;
    const card = document.querySelector('.match-card[data-id="'+mid+'"]');
    if(!card) return;
    const chip = card.querySelector('.state-chip');
    if(!chip) return;
    const done = !!uiIsComplete(m); /* strict UI check */
    chip.textContent = done ? 'Complet' : 'Incomplet';
    chip.classList.remove('ok','warn');
    chip.classList.add(done ? 'ok' : 'warn'); if(!done){ chip.classList.add('pulse'); setTimeout(()=>chip.classList.remove('pulse'), 700);}
    card.setAttribute('data-complete', done ? 'true' : 'false');
  }catch(e){/* no-op */}
}
function renderMatches(){
  if (typeof recomputeAllBonuses==='function') recomputeAllBonuses();
  const list=id("match-list");list.innerHTML="";
  if(!state.matches.length){list.appendChild(help("Aucune rencontre planifi√©e."));id("stats-matches").textContent="0 / 0 matches complets";id("round-status").textContent="‚Äî";id("btn-start-round").style.display="none";id("btn-end-round").style.display="none";return}
  const groups={};state.matches.forEach(m=>(groups[m.round]=groups[m.round]||[]).push(m));
  const rounds=Object.keys(groups).map(Number).sort((a,b)=>a-b);
  CURRENT_ROUND = rounds.find(r=>!roundState(r).finished) ?? rounds[rounds.length-1];
  const rs=roundState(CURRENT_ROUND);
  const roundPill=id("round-status");
  roundPill.textContent=`Journ√©e active : #${CURRENT_ROUND} ‚Äî ${rs.finished?'Termin√©e':(rs.started?'En cours':'Pr√©paration')}`;
  roundPill.classList.remove('red','yellow','green');
  setRoundStatusPillClasses(roundPill,rs);
  id("btn-start-round").style.display=(isAdmin()&&!rs.started&&!rs.finished)?'inline-block':'none';
  id("btn-end-round").style.display  =(isAdmin()&& rs.started&&!rs.finished)?'inline-block':'none';

  let complete=0, idx=0;
  rounds.forEach(r=>{
    const rCtl=roundState(r);
    const badgeClass = rCtl.finished ? 'green' : (rCtl.started ? 'yellow' : 'red');const hdr=document.createElement("div");hdr.className="round-head";hdr.innerHTML=`<span class="round-title">Journ√©e ${r}</span> <span class="chip round-chip ${badgeClass}">#${r}</span>`;list.appendChild(hdr);
    const roundWrap=document.createElement("div");roundWrap.className="round-grid";list.appendChild(roundWrap);
    

    groups[r].forEach(m=>{
      ensureLengths(m);
      const wins=computeSetWins(m),pal=m.palet,palScore=(pal.a!=null&&pal.b!=null)?hy(pal.a,pal.b):"‚Äî";
      const palChip = `<span class="chip">ü•è Palet: <span class="score-compact">${palScore}</span></span>`;
      const done=uiIsComplete(m);if(done)complete++;
      const el=document.createElement("div");el.setAttribute("data-id",m.id);el.setAttribute("data-complete",uiIsComplete(m)?"true":"false");el.className="match-card";el.dataset.id=m.id;const isOpen=!!ui.open[m.id];el.setAttribute("aria-expanded",isOpen?"true":"false");
      const bonusA=bonusChip(r,m.a,rCtl), bonusB=bonusChip(r,m.b,rCtl);
      el.innerHTML=`<div class="hd" data-expand>
    <div class="scorewrap">
      <!-- Rail gauche : #Journ√©e -->
      <div class="left-rail">
        <span class="chip round-chip ${badgeClass}">#${r}</span>
      </div>

      <!-- Centre : √©quipes verticales + score g√©n√©ral + scores par sport -->
      <div class="centerlane" style="width:100%">
        <div class="teams-row">
          <div class="team left">
            ${avatarHtml(m.a,'sm').replace('class="avatar','class="avatar')}
            <div class="name">${esc(teamName(m.a))}</div>
            <div class="bonus-line">${bonusA || ''}</div>
          </div>

          <div class="score"><span class="scorebox a">${(wins.aw.darts*5 + wins.aw.ping*5 + (m.palet?.a ?? 0) + ((state.bonusApplied?.[r]?.[m.a]) || 0))}</span><span class="scorebox b">${(wins.bw.darts*5 + wins.bw.ping*5 + (m.palet?.b ?? 0) + ((state.bonusApplied?.[r]?.[m.b]) || 0))}</span></div>

          <div class="team right">
            ${avatarHtml(m.b,'sm').replace('class="avatar','class="avatar')}
            <div class="name">${esc(teamName(m.b))}</div>
            <div class="bonus-line">${bonusB || ''}</div>
          </div>
        </div>

        <div class="sports-row">
          <span class="chip">üéØ <span class="score-compact">${hy(wins.aw.darts*5, wins.bw.darts*5)}</span></span>
          <span class="chip">üèì <span class="score-compact">${hy(wins.aw.ping*5, wins.bw.ping*5)}</span></span>
          ${palChip}
        </div>
      </div>

      
      <!-- √âtat de compl√©tude -->
      <div class="right-rail">
        <span class="chip state-chip ${uiIsComplete(m)?'ok':'warn'}">
          ${uiIsComplete(m)?'Complet':'Incomplet'}
        </span>
      </div>

      <!-- chevron √† droite -->
      <span class="chev" aria-hidden="true"></span>
    </div>
  </div>
  <div class="bd">
          <div class="match-two-col">
            ${renderDarts(m)}${renderPing(m)}
          </div>
          ${renderPalet(m)}
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:8px">
            <div class="help">La saisie n√©cessite d‚Äô√™tre connect√©¬∑e √† une des deux √©quipes (ou admin).</div>
            <div>${(isAdmin()||hasClaim(m.a)||hasClaim(m.b))?`<button type="button" class="btn small" data-clear="${m.id}">Effacer ce match</button>`:''}</div>
          </div>
        </div>`;
      roundWrap.appendChild(el);

      // darts
      qsa('.match-card[data-id="'+m.id+'"] select[data-kind="darts"]').forEach(sel=>{
        const can=(isAdmin()||hasClaim(m.a)||hasClaim(m.b)); sel.disabled=!(can && canEditScores(m,rCtl));
        sel.addEventListener("change",()=>{const i=parseInt(sel.getAttribute("data-index"),10),v=sel.value===""?null:parseInt(sel.value,10);const mm=findMatch(m.id);mm.darts[i]=v;saveState();updateMatchCompleteness(m.id);renderMatches();renderLeaderboard();renderH2H()});
      });
      // ping
      
      // ping (vainqueur A/B)
      qsa('.match-card[data-id="'+m.id+'"] select[data-kind="ping"]').forEach(sel=>{
        const can = (isAdmin() || hasClaim(m.a) || hasClaim(m.b));
        sel.disabled = !(can && canEditScores(m, rCtl));
        sel.addEventListener("change", ()=>{
          const i  = parseInt(sel.getAttribute("data-index"),10);
          const vv = sel.value==="" ? null : parseInt(sel.value,10);
          const mm = findMatch(m.id);
          if (!Array.isArray(mm.ping)) mm.ping = [];
          const TOTAL = 3;
          
          while (mm.ping.length < TOTAL) mm.ping.push(null);
          mm.ping[i] = vv;
          saveState();
          updateMatchCompleteness(m.id);
          renderMatches();
          renderLeaderboard();
          renderH2H();
        });
      });

      // palet
      qsa('.match-card[data-id="'+m.id+'"] input[data-palet]').forEach(inp=>{
        const can=(isAdmin()||hasClaim(m.a)||hasClaim(m.b)); inp.disabled=!(can && canEditScores(m,rCtl));
        const mid=m.id,which=inp.getAttribute("data-palet");
        const updateNote=()=>{const mm=findMatch(mid),T=+state.rules.paletTarget||11,a=(mm.palet?.a==null?null:+mm.palet?.a),b=(mm.palet?.b==null?null:+mm.palet?.b);const ok=(a!=null&&b!=null)&&((a===T&&b>=0&&b<=T-1)||(b===T&&a>=0&&a<=T-1));const note=qs('.match-card[data-id="'+mid+'"] [data-note="pal-'+mid+'"]');if(note)note.textContent=ok?'‚úîÔ∏è Score valide':`Saisissez les deux scores (l‚Äôun doit √™tre ${T}).`}
        inp.addEventListener("input",()=>{const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,state.rules.paletTarget||11);const mm=findMatch(mid);mm.palet[which]=v;saveState();updateNote()});
        const commit=()=>{const mm=findMatch(mid);const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,state.rules.paletTarget||11);mm.palet[which]=v;saveState();updateMatchCompleteness(m.id);renderMatches();renderLeaderboard();renderH2H()};
        inp.addEventListener("change",commit);inp.addEventListener("blur",commit);inp.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();inp.blur()}})
      });

      const clr=qs('.match-card[data-id="'+m.id+'"] [data-clear]');if(clr)clr.addEventListener("click",()=>clearMatch(m.id));
      const head=qs('.match-card[data-id="'+m.id+'"] [data-expand]');if(head)head.addEventListener("click",()=>{const open=el.getAttribute("aria-expanded")==="true";el.setAttribute("aria-expanded",open?"false":"true");ui.open[m.id]=!open});
      qsa('.match-card[data-id="'+m.id+'"] [data-bonus]').forEach(b=>b.addEventListener('click',()=>openBonusModal(r,b.getAttribute('data-team'))));
    });
  });
  id("stats-matches").textContent=complete+" / "+state.matches.length+" matches complets";
  renderLeaderboard();
}

/* ---- Rendu des 3 sports (relook√©s) ---- */
function renderDarts(m){
  const s = state.rules.dartsSingles, N = dartsTotal();
  let html = '<div class="sport-group">'
    + '<div class="sport-title"><span class="sport-icon">' + sportIcon('darts') + '</span> Fl√©chettes</div>';
  for (let i=0; i<N; i++){
    const v = m.darts[i];
    const lab = (i < s ? ('Simple ' + (i+1)) : ('Double ' + (i - s + 1)));
    html += '<div class="sport-item">'
      + '<label>' + lab + '</label>'
      + '<select data-kind="darts" data-index="' + i + '">'
      + '<option value="" ' + (v===null ? 'selected' : '') + '>Non jou√©</option>'
      + '<option value="0" ' + (v===0 ? 'selected' : '') + '>Victoire ' + esc(teamName(m.a)) + '</option>'
      + '<option value="1" ' + (v===1 ? 'selected' : '') + '>Victoire ' + esc(teamName(m.b)) + '</option>'
      + '</select>'
      + '</div>';
  }
  html += '</div>';
  return html;
}
function renderPing(m){
  const sSingles = state.rules.pingSingles || 0;
  const sDoubles = state.rules.pingDoubles || 0;
  const total = sSingles + sDoubles;
  const rCtl = roundState(m.round || 1); // √©tat de la journ√©e

  if (!Array.isArray(m.ping)) m.ping = [];
  m.ping = m.ping.slice(0, total);
  while (m.ping.length < total) m.ping.push(null);

  let html = '<div class="sport-group">'
    + '<div class="sport-title"><span class="sport-icon">' + sportIcon('ping') + '</span> Ping-pong</div>';

  for (let i=0; i<total; i++){
    // Valeur affich√©e : par d√©faut "Non jou√©". Si la journ√©e n'est pas d√©marr√©e, on force l'affichage √† "Non jou√©".
    const raw = (m.ping[i]===0 || m.ping[i]===1) ? m.ping[i] : null;
    const v = raw;
    const label = (i < sSingles) ? ('Simple ' + (i+1)) : ('Double ' + (i - sSingles + 1));
    html += '<div class="sport-item">'
      + '<label class="muted">' + label + '</label>'
      + '<select data-kind="ping" data-index="' + i + '">'
      + '<option value="" ' + (v===null ? 'selected' : '') + '>Non jou√©</option>'
      + '<option value="0" ' + (v===0 ? 'selected' : '') + '>Victoire ' + esc(teamName(m.a)) + '</option>'
      + '<option value="1" ' + (v===1 ? 'selected' : '') + '>Victoire ' + esc(teamName(m.b)) + '</option>'
      + '</select>'
      + '</div>';
  }
  html += '</div>';
  return html;
}
function renderPalet(m){
  const T = +state.rules.paletTarget || 11;
  const a = (m.palet?.a==null?null:+m.palet?.a),
        b = (m.palet?.b==null?null:+m.palet?.b);
  const ok = (a!=null&&b!=null)&&((a===T&&b>=0&&b<=T-1)||(b===T&&a>=0&&a<=T-1));
  return `<div class="sport-group" style="margin-top:16px">
    <div class="sport-title"><span class="sport-icon">${sportIcon('palet')}</span> Palet</div>
    <div class="ping-row">
      <div>
        <label class="muted">${esc(teamName(m.a))}</label>
        <input type="number" min="0" max="${T}" step="1"
               value="${a==null?'':a}" data-palet="a">
      </div>
      <div>
        <label class="muted">${esc(teamName(m.b))}</label>
        <input type="number" min="0" max="${T}" step="1"
               value="${b==null?'':b}" data-palet="b">
      </div>
    </div>
    <div class="help" data-note="pal-${m.id}">${ok?'‚úîÔ∏è Score valide':`Saisissez les deux scores (l‚Äôun doit √™tre ${T}).`}</div>
  </div>`;
}

/* ===== Classement ===== */
function baseLeaderboardStats(){const R=state.rules,stats={};state.teams.forEach(t=>stats[t.id]={teamId:t.id,name:t.name,avatar:t.avatar||null,pointsBase:0,bonus:0,malus:0,dartsW:0,pingW:0,palFor:0,palAg:0,matchesComplete:0});state.matches.forEach(m=>{const A=stats[m.a],B=stats[m.b];ensureLengths(m);m.darts.forEach(v=>{if(v===0){A.dartsW++;A.pointsBase+=R.dartsWinPoints}else if(v===1){B.dartsW++;B.pointsBase+=R.dartsWinPoints}});getPingPts(m).forEach(s=>{const a=(s.a==null?null:+s.a),b=(s.b==null?null:+s.b);if(isPingValid(a,b)){if(a>b){A.pingW++;A.pointsBase+=R.pingWinPoints}else if(b>a){B.pingW++;B.pointsBase+=R.pingWinPoints}}});const pa=(m.palet?.a==null?null:+m.palet?.a),pb=(m.palet?.b==null?null:+m.palet?.b);if(pa!=null&&pb!=null){A.palFor+=pa;B.palFor+=pb;A.palAg+=pb;B.palAg+=pa;A.pointsBase+=pa;B.pointsBase+=pb}if(isMatchComplete(m)){A.matchesComplete++;B.matchesComplete++}});Object.keys(state.bonusApplied||{}).forEach(r=>{const per=state.bonusApplied[r];Object.keys(per).forEach(tid=>{const v=per[tid]||0;if(stats[tid])stats[tid].bonus+=v})});return stats}
function computeLeaderboard(){const stats=baseLeaderboardStats();const rows=Object.values(stats).map(x=>({teamId:x.teamId,name:x.name,avatar:x.avatar,points:x.pointsBase+x.bonus-x.malus,bonus:x.bonus,malus:x.malus,dartsW:x.dartsW,pingW:x.pingW,palFor:x.palFor,palAg:x.palAg,matchesComplete:x.matchesComplete}));rows.sort((x,y)=>(y.points-x.points)||((y.palFor-y.palAg)-(x.palFor-x.palAg))||((y.dartsW+y.pingW)-(x.dartsW+x.pingW))||x.name.localeCompare(y.name));rows.forEach((r,i)=>r.rank=i+1);return rows}

function renderLeaderboard(){
  if (typeof recomputeAllBonuses==='function') recomputeAllBonuses();
  const tbody = qs("#table-classement tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  const teams = state.teams.slice();
  const rows = teams.map(t => {
    const tid = t.id;
    let dartsPF=0, dartsPA=0, pingPF=0, pingPA=0, palPF=0, palPA=0, pts=0, matchesComplete=0;

    state.matches.forEach(m => {
      if (m.a!==tid && m.b!==tid) return;
      const isA = (m.a===tid);

      // Points totaux (base + bonus appliqu√©)
      if (typeof pointsForTeamInMatch === 'function') {
        pts += pointsForTeamInMatch(m, tid) || 0;
      }

      // Stat fl√©chettes (manches gagn√©es ‚Üí points √ó5)
      if (Array.isArray(m.darts)) {
        let aw=0, bw=0;
        m.darts.forEach(v=>{ if(v===0) aw++; else if(v===1) bw++; });
        dartsPF += (isA ? aw : bw) * 5;
        dartsPA += (isA ? bw : aw) * 5;
      }

      // Stat ping (manches gagn√©es ‚Üí points √ó5)
      if (typeof getPingPts === 'function') {
        let aw=0, bw=0;
        (getPingPts(m) || []).forEach(s=>{
          const a = (s && s.a!=null) ? +s.a : null;
          const b = (s && s.b!=null) ? +s.b : null;
          if (!isPingValid(a,b)) return;
          if (a>b) aw++; else if (b>a) bw++;
        });
        pingPF += (isA ? aw : bw) * 5;
        pingPA += (isA ? bw : aw) * 5;
      }

      // Stat palet (PF/PA)
      if (m.palet && m.palet.a!=null && m.palet.b!=null) {
        palPF += isA ? (+m.palet.a||0) : (+m.palet.b||0);
        palPA += isA ? (+m.palet.b||0) : (+m.palet.a||0);
      }

      // Match complet ?
      if (typeof isMatchComplete === 'function' && isMatchComplete(m)) matchesComplete++;
    });

    // Bonus/Malus cumul√©s (toutes journ√©es)
    let bonusPos=0, malusNeg=0;
    const BA = state.bonusApplied || {};
    Object.keys(BA).forEach(r => {
      const v = (BA[r] && BA[r][tid]) || 0;
      if (v>0) bonusPos += v;
      else if (v<0) malusNeg += (-v);
    });

    return {
      id: tid,
      name: t.name,
      avatar: t.avatar,
      points: pts,
      dartsPF, dartsPA, pingPF, pingPA, palPF, palPA,
      bonusPos, malusNeg, matchesComplete
    };
  });

  rows.sort((a,b)=> b.points - a.points || a.name.localeCompare(b.name));

  rows.forEach((r,i)=>{
    const avatar = avatarHtml ? avatarHtml(r.id, 22, '') : '';
    const diffPal = r.palPF - r.palPA;
    const signPal = diffPal>=0?'+':'';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><span class="team-name">${avatar} ${esc(r.name||'')}</span></td>
      <td><b>${r.points}</b></td>
      <td>${r.dartsPF}</td>
      <td>${r.pingPF}</td>
      <td>${r.palPF}-${r.palPA} <span class="muted">(${signPal}${diffPal})</span></td>
      <td>${r.bonusPos?`<span class="pos">+${r.bonusPos}</span>`:'0'}</td>
      <td>${r.malusNeg?`<span class="neg">-${r.malusNeg}</span>`:'0'}</td>
      <td>${r.matchesComplete}</td>
    `;
    tbody.appendChild(tr);
  });
}


/* ===== H2H ===== */

function pointsForTeamInMatch(m, tid){
  // Total de points marqu√©s par l'√©quipe dans ce match (toutes disciplines) + bonus appliqu√©
  const isA = (m.a === tid);
  let pts = 0;

  // Fl√©chettes : 1 manche gagn√©e = 5 points
  if (Array.isArray(m.darts)) {
    let aw=0, bw=0;
    m.darts.forEach(v=>{ if(v===0) aw++; else if(v===1) bw++; });
    pts += (isA ? aw : bw) * 5;
  }

  // Ping : 1 manche gagn√©e = 5 points (on compte les manches gagn√©es par set)
  if (typeof getPingPts === 'function') {
    let aw=0, bw=0;
    (getPingPts(m) || []).forEach(s=>{
      const a = (s && s.a!=null) ? +s.a : null;
      const b = (s && s.b!=null) ? +s.b : null;
      if (!isPingValid(a,b)) return;
      if (a>b) aw++; else if (b>a) bw++;
    });
    pts += (isA ? aw : bw) * 5;
  }

  // Palet : score direct
  if (m.palet && m.palet.a!=null && m.palet.b!=null){
    pts += isA ? (+m.palet.a||0) : (+m.palet.b||0);
  }

  // Bonus appliqu√© sur la journ√©e du match
  const applied = (state.bonusApplied?.[m.round]?.[tid]) || 0;
  return pts + applied;
}

function renderH2H(){const thead=qs("#table-h2h thead"),tbody=qs("#table-h2h tbody");thead.innerHTML="";tbody.innerHTML="";const teams=state.teams.slice();if(!teams.length){tbody.appendChild(help("Ajoutez des √©quipes pour voir la matrice."));return}const trH=document.createElement("tr");trH.appendChild(document.createElement("th")).textContent="√âquipe";teams.forEach(t=>{const th=document.createElement("th");th.innerHTML='<span class="team-name">'+avatarHtml(t.id,'sm')+esc(t.name)+'</span>';trH.appendChild(th)});thead.appendChild(trH);const byPair={};state.matches.forEach(m=>{byPair[[m.a,m.b].sort().join("|")]=m});teams.forEach(ti=>{const tr=document.createElement("tr");const th=document.createElement("th");th.innerHTML='<span class="team-name">'+avatarHtml(ti.id,'sm')+esc(ti.name)+'</span>';tr.appendChild(th);teams.forEach(tj=>{const td=document.createElement("td");if(ti.id===tj.id){td.textContent="‚Äî";tr.appendChild(td);return}const m=byPair[[ti.id,tj.id].sort().join("|")];if(!m){td.innerHTML='<span class="chip">‚Äî</span>';tr.appendChild(td);return}const pI=pointsForTeamInMatch(m,ti.id),pJ=pointsForTeamInMatch(m,tj.id);let cls="h2h-draw",icon="‚â°";if(pI>pJ){cls="h2h-win";icon="‚úî"}else if(pI<pJ){cls="h2h-loss";icon="‚úñ"}td.innerHTML='<span class="h2h-pill '+cls+'">'+icon+' <span class="score-compact">'+hy(pI,pJ)+'</span></span>';td.style.cursor="pointer";td.dataset.matchId=m.id;tr.appendChild(td)});tbody.appendChild(tr)});tbody.addEventListener("click",e=>{let n=e.target;while(n&&n!==tbody&&!(n.tagName==="TD"&&n.dataset.matchId))n=n.parentNode;if(!n||n===tbody)return;goto("calendrier");ui.open[n.dataset.matchId]=true;setTimeout(()=>{const card=qs('.match-card[data-id="'+n.dataset.matchId+'"]');if(card){card.setAttribute("aria-expanded","true");card.scrollIntoView({behavior:"smooth",block:"start"})}},0)})}

/* ===== Tabs & clicks ===== */
function guardTab(t){const no=(!cloud.enabled&&!state.cloudId);return(t==='equipes'||t==='calendrier'||t==='classement'||t==='options')&&(no&&state.teams.length===0)}
function goto(tabId){if(guardTab(tabId)){alert("Aucun tournoi ouvert. Cr√©ez ou rejoignez un code Cloud.");tabId='setup'}qsa(".tab").forEach(b=>b.setAttribute("aria-selected","false"));const b=qs('.tab[data-tab="'+tabId+'"]');if(b)b.setAttribute("aria-selected","true");qsa("main section").forEach(s=>s.classList.remove("active"));id(tabId).classList.add("active")}

document.addEventListener("click",async(e)=>{
  const btn=e.target.closest("button");if(btn){switch(btn.id){
    case "btn-fullscreen":(document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen())?.catch?.(()=>{});break;

    /* --- ADMIN : activation => re-render imm√©diat --- */
    case "btn-admin-on-setup":
    case "btn-admin-on":{const pin=prompt("PIN administrateur :");if(pin==="30041991"){session.admin=true;session.claims={};updateWho();renderAll();alert("Mode administrateur activ√© (d√©connexion des √©quipes sur cet appareil).")}else alert("PIN incorrect.");break}
    case "btn-admin-off":{session.admin=false;updateWho();renderAll();break}

    case "btn-create-tournament":{if(!isAdmin()){const pin=prompt("PIN administrateur :");if(pin!=="30041991")return alert("PIN incorrect.");session.admin=true;session.claims={};updateWho();renderAll()}const code=(id("tcode-input").value||"").trim();if(!code)return alert("Code cloud obligatoire.");const name=(id("tname-input").value||"").trim()||"Tournoi";if(nameExistsLocally(name))return alert("Un tournoi portant ce nom existe d√©j√† dans cette liste.");if(codeExistsLocally(code))return alert("Ce code cloud existe d√©j√† dans votre liste.");const exists=await(async()=>{try{const db=cloud.db||initFB();if(!db)return false;const ref=db.ref("tournaments/"+code+"/payload");const snap=await ref.get?.()??await new Promise(res=>ref.once('value',res));return !!(snap&&snap.exists&&snap.exists())}catch(_){return false}})();if(exists)return alert("Ce code cloud existe d√©j√† sur le serveur. Choisissez-en un autre.");const n=clampInt(id("teams-count-input").value,2,64);const R={dartsSingles:clampInt(id("rule-d-s").value,0,9),dartsDoubles:clampInt(id("rule-d-d").value,0,9),dartsWinPoints:clampInt(id("rule-d-p").value,1,50),pingSingles:clampInt(id("rule-p-s").value,0,9),pingDoubles:clampInt(id("rule-p-d").value,0,9),pingWinPoints:clampInt(id("rule-p-p").value,1,50),paletTarget:clampInt(id("rule-l-target").value,1,50)};joinCloud(code);state={version:40,tid:uid(),cloudId:code,tournamentName:name,rules:R,teams:Array.from({length:n},(_,i)=>({id:uid(),name:"√âquipe "+(i+1),p1:"",p2:"",avatar:null,bonusCapitaineUsed:false})),matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};saveState();pushCloud(true);renderAll();goto("equipes");break}
    case "btn-join-code":{const code=(id("join-code").value||"").trim();if(!code)return alert("Renseigne un code.");joinCloud(code);goto("equipes");break}
    case "btn-copy-link":{const code=(id("join-code").value||id("tcode-input").value||state.cloudId||"").trim();if(!code)return alert("Aucun code.");const url=location.origin+location.pathname+"?id="+encodeURIComponent(code);navigator.clipboard?.writeText(url);alert("Lien copi√© !\n"+url);break}

    case "btn-add-team":{if(!isAdmin())return alert("R√©serv√© √† l‚Äôadmin.");if(state.locked)return alert("Calendrier fig√©.");state.teams.push({id:uid(),name:"√âquipe "+(state.teams.length+1),p1:"",p2:"",avatar:null,bonusCapitaineUsed:false});saveState();renderTeams();break}
    case "btn-generate":{if(!isAdmin())return alert("Seul l‚Äôadmin peut g√©n√©rer.");if(state.locked)return;generateSchedule();state.locked=true;saveState();renderAll();goto("calendrier");break}

    case "btn-refresh-standings":
    case "btn-refresh-standings-2":{renderLeaderboard();renderH2H();if(btn.id==="btn-refresh-standings-2")goto("classement");break}
    case "btn-show-summary":{id("view-summary").style.display="block";id("view-h2h").style.display="none";id("btn-show-summary").setAttribute("aria-pressed","true");id("btn-show-h2h").setAttribute("aria-pressed","false");break}
    case "btn-show-h2h":{id("view-summary").style.display="none";id("view-h2h").style.display="block";id("btn-show-summary").setAttribute("aria-pressed","false");id("btn-show-h2h").setAttribute("aria-pressed","true");break}
    case "btn-collapse":{qsa('#match-list .match-card').forEach(c=>c.setAttribute('aria-expanded','false'));ui.open={};break}

    case "btn-export":{const data=JSON.stringify(state,null,2);const url=URL.createObjectURL(new Blob([data],{type:"application/json"}));const a=document.createElement("a");a.href=url;a.download=("tournoi-"+(state.tournamentName||"TriSports")).replace(/\s+/g,'_')+".json";a.click();URL.revokeObjectURL(url);break}
    case "btn-import":{const f=id("file-import").files?.[0];if(!f)return alert("S√©lectionnez un fichier JSON.");f.text().then(t=>{try{const data=JSON.parse(t);state=data;normalize();saveState();renderAll();alert("Import r√©ussi !")}catch(_){alert("Fichier invalide.")}});break}

    case "btn-cloud-copy":{const code=state.cloudId||cloud.id;if(!code)return alert("Pas de code cloud.");const url=location.origin+location.pathname+"?id="+encodeURIComponent(code);navigator.clipboard?.writeText(url);alert("Lien copi√© !\n"+url);break}
    case "btn-cloud-delete":{if(!isAdmin())return alert("Suppression cloud r√©serv√©e √† l‚Äôadmin.");const code=state.cloudId||cloud.id;if(!code)return alert("Aucun code actif.");if(!confirm("Supprimer d√©finitivement ce tournoi du cloud ?"))return;deleteCloud(code).then(()=>{setIndex(getIndex().filter(e=>e.id!==code));unsubscribeCloud();resetState();renderSetupRecent();renderAll();history.replaceState(null,"",location.pathname);alert("Tournoi supprim√©.");goto('setup')});break}

    /* ---- R√©initialiser scores => r√©initialise aussi BONUS + journ√©es ---- */
    case "btn-reset-scores":{
      if (!isAdmin()) return alert("R√©serv√© √† l‚Äôadmin.");
      if (!confirm("R√©initialiser les SCORES et les BONUS ?")) return;
      (state.matches || []).forEach(m=>{
        m.darts = Array(dartsTotal()).fill(null);
        m.ping  = Array(pingTotal()).fill(null);
        m.pingPts = Array(pingTotal()).fill({a:null,b:null});
        m.palet = { a:null, b:null };
      });
      state.roundCtl = {};
      state.bonusSelections = {};
      state.bonusApplied = {};
      state.bonusUsed = {};
      (state.teams||[]).forEach(t=>{ if(t) t.bonusCapitaineUsed=false; });
      saveState();
      renderAll();
      goto("calendrier");
      break}

    case "btn-unlock":{if(!isAdmin())return alert("R√©serv√© √† l‚Äôadmin.");if(!confirm("D√©verrouiller le calendrier ?"))return;state.locked=false;saveState();renderTeams();renderMatches();updateLock();break}

    case "btn-start-round":{if(!isAdmin())return;const r=CURRENT_ROUND,rs=roundState(r);if(rs.started||rs.finished)return;rs.started=true;saveState();renderMatches();alert("Journ√©e #"+r+" d√©marr√©e. Les bonus sont verrouill√©s.");break}

    /* ---- Fin de journ√©e : blocage si incomplet + bonus appliqu√©s ---- */
    case "btn-end-round": {
      if (!isAdmin()) return;
      const r  = CURRENT_ROUND;
      const rs = roundState(r);
      if (!rs.started || rs.finished) return;

      const matchesOfRound = state.matches.filter(m => m.round === r);
      const incomplets = matchesOfRound.filter(m => !isMatchComplete(m));
      if (incomplets.length) { alert(`Impossible de terminer la journ√©e #${r} : ${incomplets.length} match(s) incomplet(s).`); return; }

      
      
      const sels = state.bonusSelections[r] || {};
      Object.keys(sels).forEach(tid=>{
        const sel = sels[tid]; if (!sel) return;
        if ((state.bonusUsed?.[r]?.[tid])) { setBonusApplied(r, tid, 0); return; }
        let total = 0;

        if (sel.type === 'capitaine') {
          matchesOfRound.forEach(m=>{ total += computeCapitaineBonusForMatch(m, tid, sel.player, sel.sport); });
        } else if (sel.type === 'melon') {
          const m = matchesOfRound.find(x => x.a===tid || x.b===tid);
          if (m){
            const oppId = (m.a===tid ? m.b : m.a);
            const oppSel = sels[oppId];
            if (oppSel && oppSel.type === 'miroir') {
              // Melon se retourne : rien pour l'√©quipe Melon, Miroir prendra le total dans sa propre branche
              total = 0;
            } else {
              const sport = sel.sport || 'darts';
              total = computeMelonBonusForMatch(m, tid, sport);
            }
          }
        } else if (sel.type === 'miroir') {
          const m = matchesOfRound.find(x => x.a===tid || x.b===tid);
          if (m){
            const oppId = (m.a===tid ? m.b : m.a);
            const oppSel = sels[oppId];
            if (oppSel && oppSel.type === 'melon') {
              // Miroir r√©cup√®re le Melon d‚Äôor de l‚Äôadversaire, m√™me sport
              const sport = oppSel.sport || 'darts';
              total = computeMelonBonusForMatch(m, tid, sport);
            } else {
              total = 0;
            }
          }
        } else {
          total = 0; // autres
        }

        setBonusApplied(r, tid, total); 
        state.bonusUsed = state.bonusUsed || {}; state.bonusUsed[r] = state.bonusUsed[r] || {}; state.bonusUsed[r][tid]=true; 
        markTeamBonusUsed(tid);
      });

      rs.finished = true; saveState(); renderMatches(); renderLeaderboard();
      alert(`Journ√©e #${r} termin√©e. Les bonus sont appliqu√©s et r√©v√©l√©s.`); break;
    }
  }}
  const openBtn=e.target.closest("[data-open-id]");if(openBtn){const code=openBtn.getAttribute("data-open-id").replace(/^cloud:/,"");id("join-code").value=code;joinCloud(code);goto("equipes")}
  const delBtn=e.target.closest("[data-delete-id]");if(delBtn){if(!isAdmin())return alert("Suppression cloud r√©serv√©e √† l‚Äôadmin.");const code=delBtn.getAttribute("data-delete-id");if(!confirm("Supprimer le tournoi '"+code+"' du cloud ?"))return;deleteCloud(code).then(()=>{setIndex(getIndex().filter(e=>e.id!==code));if(state.cloudId===code||cloud.id===code){unsubscribeCloud();resetState();renderAll();history.replaceState(null,"",location.pathname);goto('setup')}alert("Supprim√©.");renderSetupRecent()})}
  const av=e.target.closest('.avatar[data-click-avatar]');if(av){const tid=av.getAttribute('data-click-avatar');if(isAdmin()||hasClaim(tid)){const input=document.querySelector('input[type="file"][data-avatar="'+tid+'"]');if(input)input.click()}return}
  const tab=e.target.closest(".tab");if(tab){let t=tab.getAttribute("data-tab");if(guardTab(t))t='setup';qsa(".tab").forEach(b=>b.setAttribute("aria-selected","false"));qs('.tab[data-tab="'+t+'"]').setAttribute("aria-selected","true");qsa("main section").forEach(s=>s.classList.remove("active"));id(t).classList.add("active")}
  const actBtn=e.target.closest("[data-act]");if(actBtn){const act=actBtn.getAttribute("data-act"),tid=actBtn.getAttribute("data-id");if(act==="del"){if(!isAdmin()||state.locked)return;if(!confirm("Supprimer cette √©quipe ?"))return;state.teams=state.teams.filter(tt=>tt.id!==tid);state.matches=state.matches.filter(m=>m.a!==tid&&m.b!==tid);if(state.protect?.teamPassHash)delete state.protect.teamPassHash[tid];saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
    if(act==="setpass"){if(!isAdmin())return alert("R√©serv√© √† l‚Äôadmin.");let pass=prompt("Mot de passe pour l‚Äô√©quipe ¬´ "+teamName(tid)+" ¬ª :");if(pass==null)return;pass=pass.trim();if(!pass)return alert("Mot de passe vide.");state.protect=state.protect||{};state.protect.teamPassHash=state.protect.teamPassHash||{};state.protect.teamPassHash[tid]=hashPass(pass);saveState();renderTeams();alert("Mot de passe d√©fini.")}
    if(act==="login"){const hashes=(state.protect&&state.protect.teamPassHash)?state.protect.teamPassHash:null;if(!hashes||!hashes[tid])return alert("Cette √©quipe n‚Äôa pas encore de mot de passe (demandez √† l‚Äôadmin).");let pass=prompt("Mot de passe de l‚Äô√©quipe ¬´ "+teamName(tid)+" ¬ª :");if(pass==null)return;pass=pass.trim();if(!pass)return alert("Mot de passe vide.");if(hashPass(pass)===hashes[tid]){ session.admin=false; session.claims={}; session.claims[tid]=true; updateWho(); renderAll(); alert("Connexion r√©ussie. Mode admin d√©sactiv√© sur cet appareil."); }
      else alert("Mot de passe incorrect.") }
    if(act==="logout"){session.claims={};updateWho();renderAll()}
    if(act==="avatar"){const input=qs('[data-avatar="'+tid+'"]');if(input)input.click()}
    if(act==="avatar-clear"){const t=teamObj(tid);if(!t)return;t.avatar=null;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
  }
});

/* ===== Modal bonus ===== */
let bonusCTX={round:null,teamId:null};



/* === Bonus categories & locks === */
function rebuildCategoryLocksFromSelections(){
  try{
    const S = state.bonusSelections || {};
    const teams = (state.teams||[]).map(t=>t.id);
    state.categoryLocks = {};
    teams.forEach(tid => { state.categoryLocks[tid] = {}; });
    Object.keys(S).forEach(r=>{
      const perTeam = S[r] || {};
      Object.keys(perTeam).forEach(tid=>{
        const type = perTeam[tid] && perTeam[tid].type;
        const cat = BONUS_CATEGORY[type];
        if (cat) { state.categoryLocks[tid] = state.categoryLocks[tid] || {}; state.categoryLocks[tid][cat] = true; }
      });
    });
  }catch(_){}
}

const BONUS_CATEGORY = { capitaine:'score', melon:'score', taupe:'physique', lefthand:'physique', miroir:'miroir' };

function markCategoryLocked(teamId, type){
  const cat = BONUS_CATEGORY[type];
  if (!cat) return;
  state.categoryLocks = state.categoryLocks || {};
  state.categoryLocks[teamId] = state.categoryLocks[teamId] || {};
  state.categoryLocks[teamId][cat] = true;
  if (typeof saveState==='function') saveState();
}

function getTeamCategoryLocks(teamId){
  // Returns a Set of categories already validated (locked) by THIS team for the whole tournament
  const locks = new Set();
  const CL = state.categoryLocks && state.categoryLocks[teamId];
  if (CL) Object.keys(CL).forEach(cat => { if (CL[cat]) locks.add(cat); });
  return locks;
}

function applyBonusLocks(teamId){
  if (typeof rebuildCategoryLocksFromSelections==='function') rebuildCategoryLocksFromSelections();
  try{
    const locks = getTeamCategoryLocks(teamId);
    const round = (window.bonusCTX && window.bonusCTX.round);
    const currentSel = (typeof getBonusSelection==='function' && round!=null) ? (getBonusSelection(round, teamId) || null) : null;

    const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
    const map   = ['capitaine','miroir','taupe','lefthand','melon'];
    cards.forEach((c,i)=>{
      const type = map[i] || 'capitaine';
      const cat = BONUS_CATEGORY[type];
      const locked = !!(cat && locks.has(cat));
      // Autoriser la carte du type d√©j√† s√©lectionn√© pour CETTE journ√©e
      const allowCurrentType = !!(currentSel && currentSel.type === type);
      const disable = locked && !allowCurrentType;

      c.classList.toggle('disabled', disable);
      c.setAttribute('aria-disabled', disable ? 'true' : 'false');
      c.title = disable ? "D√©j√† utilis√© pour cette cat√©gorie (tournoi)" : "";
    });

    // Si la s√©lection courante est d√©sormais ill√©gale (cat√©gorie lock√©e et type diff√©rent), forcer un type autoris√©
    if (window._bonusType){
      const curCat = BONUS_CATEGORY[window._bonusType];
      const curSelCat = currentSel ? BONUS_CATEGORY[currentSel.type] : null;
      if (curCat && locks.has(curCat) && (!currentSel || currentSel.type !== window._bonusType)){
        const first = map.find(t => {
          const c = BONUS_CATEGORY[t];
          const isLocked = locks.has(c);
          const isCurrent = currentSel && currentSel.type === t;
          return !isLocked || isCurrent;
        });
        if (first) selectBonusType(first);
      }
    }
  }catch(_){}
}

function openBonusModal(round, teamId){
  const rCtl = roundState(round);
  if (rCtl.started) return alert("La journ√©e a d√©marr√© : bonus verrouill√©s.");
  if (state.bonusUsed?.[round]?.[teamId]) return alert("Ce bonus a d√©j√† √©t√© utilis√© une fois.");
  if (!hasClaim(teamId)) return alert("Connectez-vous √† cette √©quipe pour choisir son bonus.");

  bonusCTX.round = round;
  bonusCTX.teamId = teamId;
  const sel = getBonusSelection(round, teamId) || {};

  // Pr√©pare et s√©lectionne la carte
  if (typeof prepareBonusOptions === 'function') {
    prepareBonusOptions();
    selectBonusType(sel.type || 'capitaine');
    if (typeof applyBonusLocks==='function') applyBonusLocks(teamId);
  }

  // Pr√©remplissage des champs sp√©cifiques si disponibles
  const sport = sel.sport || 'darts';
  if (document.getElementById('taupe-sport'))     document.getElementById('taupe-sport').value = sport;
  if (document.getElementById('lefthand-sport'))  document.getElementById('lefthand-sport').value = sport;
  if (document.getElementById('melon-sport'))     document.getElementById('melon-sport').value = sport;

  const modal = document.getElementById('bonus-modal');
  if (modal) {
    const ctx = document.getElementById('bonus-context');
    if (ctx) ctx.textContent = `√âquipe : ${teamName(teamId)} ‚Äî Journ√©e #${round}`;
    modal.classList.add('show');
  }
}

id('bonus-cancel').addEventListener('click',()=>id('bonus-modal').classList.remove('show'));
id('bonus-save').addEventListener('click',()=>{
  const r=bonusCTX.round, t=bonusCTX.teamId;
  // Block saving if category already used this season
  try{
    const locks = getTeamCategoryLocks(t);
    const cat = BONUS_CATEGORY[type];
    if (cat && locks.has(cat)) { alert("Bonus d√©j√† utilis√© pour cette cat√©gorie."); return; }
  }catch(_){}

 const type =
  (window._bonusType === 'miroir')   ? 'miroir'   :
  (window._bonusType === 'taupe')    ? 'taupe'    :
  (window._bonusType === 'lefthand') ? 'lefthand' :
  (window._bonusType === 'melon')    ? 'melon'    :
                                       'capitaine';
// Nouveau : 'capitaine' et 'melon' n'ont pas de param√®tres √† lire
if (type === 'capitaine') {
  setBonusSelection(r, t, { type });
} else if (type === 'melon') {
  const sport = document.getElementById('melon-sport')?.value || 'darts';
  setBonusSelection(r, t, { type: 'melon', sport });
} else if (type === 'taupe') {
  const sport = document.getElementById('taupe-sport')?.value || 'darts';
  setBonusSelection(r, t, { type: 'taupe', sport });
  if (typeof markCategoryLocked==='function') markCategoryLocked(t, 'taupe');
  if (typeof applyBonusLocks==='function') applyBonusLocks(t);
} else if (type === 'lefthand') {
  const sport = document.getElementById('lefthand-sport')?.value || 'darts';
  setBonusSelection(r, t, { type: 'lefthand', sport });
  if (typeof markCategoryLocked==='function') markCategoryLocked(t, 'lefthand');
  if (typeof applyBonusLocks==='function') applyBonusLocks(t);
} else if (type === 'miroir') {
  setBonusSelection(r, t, { type: 'miroir' });
  if (typeof markCategoryLocked==='function') markCategoryLocked(t, 'miroir');
  if (typeof applyBonusLocks==='function') applyBonusLocks(t);
} else {
  // garde-fou
  setBonusSelection(r, t, { type: 'capitaine' });
  if (typeof markCategoryLocked==='function') markCategoryLocked(t, 'capitaine');
  if (typeof applyBonusLocks==='function') applyBonusLocks(t);
}

  id('bonus-modal').classList.remove('show');
  if(typeof renderPills==='function') renderPills();
  if(typeof renderMatches==='function') renderMatches();
});

/* ===== Boot ===== */
function renderAll(){renderTitle();updateWho();renderSetupRecent();renderManageList();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
document.addEventListener("DOMContentLoaded",()=>{ try { renderAll(); } catch(e) {} });</script>

<script>
(function(){
  function withFallback(img, primary, fall1, fall2){
    img.src = primary;
    img.onerror = function(){
      img.onerror = function(){
        img.onerror = function(){
          img.onerror = null;
          img.src = fall2;
        };
        img.src = fall1;
      };
      // try img/ first
      img.src = 'img/' + primary.split('/').pop();
    };
  }
  function ensureBrandImages(){
    var brand = document.querySelector('header .brand') || document.querySelector('.brand');
    if(!brand) return;
    // avoid duplicates
    if(!brand.querySelector('img.brand-logo')){
      var logo = document.createElement('img');
      logo.className = 'brand-logo';
      logo.alt = 'TriSports logo';
      brand.prepend(logo);
      withFallback(logo, 'tripsort/img/logo.png', 'trisport/img/logo.png', 'img/logo.png');
    }
    if(!brand.querySelector('img.brand-title')){
      var title = document.createElement('img');
      title.className = 'brand-title';
      title.alt = 'TriSports';
      // insert after logo
      var ref = brand.querySelector('img.brand-logo');
      if(ref && ref.nextSibling){ brand.insertBefore(title, ref.nextSibling); }
      else { brand.appendChild(title); }
      withFallback(title, 'tripsort/img/titre.png', 'trisport/img/titre.png', 'img/titre.png');
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureBrandImages);
  }else{
    ensureBrandImages();
  }
})();
</script>


<script id="capitaine-teamwide-v2">
(function(){
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

  // --- Texte d'aide dans la carte Capitaine (optionnel, non bloquant) ---
  function rewriteCapitaineHelp(){
    $$('.bonus-card').forEach(card=>{
      const title = $('.bonus-title', card);
      if(!title) return;
      if((title.textContent||'').trim().toLowerCase()==='capitaine'){
        const help = card.querySelector('.help');
        if(help){
          help.innerHTML = "Bonus d‚Äô√©quipe ‚Äî aucun r√©glage.<br><b>+2 points par manche gagn√©e</b> sur fl√©chettes & ping (simples et doubles) et <b>+2</b> si <i>palet</i> gagn√©.";
        }
      }
    });
  }
  document.addEventListener('DOMContentLoaded', rewriteCapitaineHelp);
  document.addEventListener('click', ()=>setTimeout(rewriteCapitaineHelp,0), true);

  // --- Calcul : Capitaine = +2 points par manche gagn√©e, tous sports ---
  // Remplace/ajoute la fonction de calcul pour Capitaine
  /*window.computeCapitaineBonusForMatch = function(match, teamId){
    try{
      let wins = 0;
      const isA = match.a === teamId;
      const isB = match.b === teamId;
      if(!isA && !isB) return 0;

      // Fl√©chettes: tableau de vainqueurs 0(A)/1(B)
      if (Array.isArray(match.darts)){
        match.darts.forEach(v=>{
          if(v===0 && isA) wins++;
          else if(v===1 && isB) wins++;
        });
      }

      // Ping: sets via getPingPts(match) si dispo, sinon match.pingPts
      const valid = (a,b)=> a!=null && b!=null && a!=='' && b!=='' && isFinite(+a) && isFinite(+b);
      const sets = (typeof window.getPingPts==='function') ? getPingPts(match)
                    : (Array.isArray(match.pingPts) ? match.pingPts : []);
      if (Array.isArray(sets)){
        sets.forEach(s=>{
          const a = s?.a, b = s?.b;
          if(!valid(a,b)) return;
          if(+a > +b && isA) wins++;
          else if(+b > +a && isB) wins++;
        });
      }

      // Palet: victoire du match
      const R = (window.state && state.rules) || {};
      const target = +(R.paletTarget ?? 11);
      const pa = (match.palet && match.palet.a!=null) ? +match.palet.a : null;
      const pb = (match.palet && match.palet.b!=null) ? +match.palet.b : null;
      if(pa!=null && pb!=null){
        if(pa>=target && pa>pb && isA) wins++;
        else if(pb>=target && pb>pa && isB) wins++;
      }

      return 2 * wins;
    }catch(e){
      return 0;
    }
  };*/

  // --- Enregistrement : Capitaine sans param√®tres ---
  // Si la modale tente de lire joueur/sport, on intercepte pour n'envoyer que {type:'capitaine'}
  document.addEventListener('click', function(ev){
    const save = ev.target && ev.target.closest && ev.target.closest('#bonus-save');
    if(!save) return;
    const t = (window._bonusType||'').toLowerCase();
    if(t !== 'capitaine') return; // on laisse la logique existante pour les autres bonus
    try{
      if(!window.bonusCTX) return;
      const r = window.bonusCTX.round;
      const tid = window.bonusCTX.teamId;
      if (typeof window.setBonusSelection==='function'){
        window.setBonusSelection(r, tid, { type:'capitaine' });
      }
      const modal = document.getElementById('bonus-modal');
      if(modal) modal.classList.remove('show');
      try{ if(typeof renderPills==='function') renderPills(); }catch(_){}
      try{ if(typeof renderMatches==='function') renderMatches(); }catch(_){}
      try{ if(typeof updateRanking==='function') updateRanking(); }catch(_){}
      ev.stopImmediatePropagation();
      ev.preventDefault();
    }catch(_){}
  }, true);

  // --- Affichage apr√®s r√©v√©lation : ne pas afficher joueur/sport pour Capitaine ---
  if (typeof window.bonusChip === 'function'){
    const _origChip = window.bonusChip;
    window.bonusChip = function(r, mTeam, rs){
      const html = _origChip(r, mTeam, rs);
      // Si r√©v√©l√© et que le label Capitaine inclut "J1 / ..." etc., on l'√©pure
      if (typeof html === 'string' && /Capitaine\s*:?\s*J\d/i.test(html)){
        return html.replace(/Capitaine\s*:?\s*J\d\s*\/\s*(Fl√©chettes|Ping|Palet)/i, 'Capitaine');
      }
      return html;
    };
  }
})();
</script>



<script id="matchcard-animations-js">
(function(){
  function getPanel(card){
    return card && card.querySelector('.bd');
  }
  function animateOpen(card){
    const panel = getPanel(card);
    if(!panel) return;
    // Ensure visible style before measuring
    panel.style.display = 'block';
    // From current height (0 or set) to scrollHeight
    panel.style.maxHeight = panel.scrollHeight + 'px';
    panel.style.opacity = '1';
    panel.style.paddingTop = '';
    panel.style.paddingBottom = '';
    function onEnd(e){
      if(e.propertyName === 'max-height'){
        panel.style.maxHeight = 'none'; // natural height
        panel.removeEventListener('transitionend', onEnd);
      }
    }
    panel.addEventListener('transitionend', onEnd);
  }
  function animateClose(card){
    const panel = getPanel(card);
    if(!panel) return;
    // If currently 'none', set to current measured height for transition start
    if(getComputedStyle(panel).maxHeight === 'none'){
      panel.style.maxHeight = panel.scrollHeight + 'px';
    }
    // Force reflow to apply starting height
    panel.getBoundingClientRect();
    // Then animate to 0
    panel.style.maxHeight = '0px';
    panel.style.opacity = '0';
    panel.style.paddingTop = '0px';
    panel.style.paddingBottom = '0px';
  }

  // Observe aria-expanded changes to trigger animation
  const cards = Array.from(document.querySelectorAll('.match-card'));
  const obs = new MutationObserver((mutations)=>{
    mutations.forEach(m=>{
      if(m.type === 'attributes' && m.attributeName === 'aria-expanded'){
        const card = m.target;
        const isOpen = card.getAttribute('aria-expanded') === 'true';
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches){
          // No animation, just set styles minimally
          const p = getPanel(card);
          if(!p) return;
          if(isOpen){
            p.style.maxHeight = 'none'; p.style.opacity = '1'; p.style.paddingTop=''; p.style.paddingBottom=''; p.style.display='block';
          }else{
            p.style.maxHeight = '0px'; p.style.opacity = '0'; p.style.paddingTop='0'; p.style.paddingBottom='0'; p.style.display='block';
          }
          return;
        }
        if (isOpen) animateOpen(card); else animateClose(card);
      }
    });
  });
  cards.forEach(card=>{
    obs.observe(card, { attributes:true, attributeFilter:['aria-expanded'] });
    // Make header clickable/toggleable if not already
    const hd = card.querySelector('.hd');
    if(hd){
      hd.style.cursor = 'pointer';
      hd.setAttribute('tabindex','0');
      hd.setAttribute('role','button');
      const toggle = (ev)=>{
        if(ev && ev.type==='keydown' && !(ev.key==='Enter' || ev.key===' ')) return;
        const open = card.getAttribute('aria-expanded') !== 'true';
        card.setAttribute('aria-expanded', open ? 'true' : 'false');
        if(ev) ev.preventDefault();
      };
      hd.addEventListener('click', toggle);
      hd.addEventListener('keydown', toggle);
    }
    // Initialize panel style according to current state
    const isOpen = card.getAttribute('aria-expanded') === 'true';
    const p = getPanel(card);
    if(p){
      if(isOpen){
        p.style.maxHeight = 'none';
        p.style.opacity = '1';
      }else{
        p.style.maxHeight = '0px';
        p.style.opacity = '0';
        p.style.paddingTop='0';
        p.style.paddingBottom='0';
        p.style.display='block';
      }
    }
  });

  // Hook into "Tout replier" button if present
  const collapseBtn = document.getElementById('btn-collapse');
  if(collapseBtn){
    collapseBtn.addEventListener('click', ()=>{
      document.querySelectorAll('.match-card[aria-expanded="true"]').forEach(c=>c.setAttribute('aria-expanded','false'));
    });
  }
})();
</script>



<script id="standings-count-anim">
(function(){
  const TBL = document.getElementById('table-classement');
  if(!TBL) return;

  const isReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const DURATION = isReduced ? 0 : 600;

  function numFromText(t){
    if(!t) return null;
    const m = (''+t).replace(',', '.').match(/-?\d+(?:\.\d+)?/);
    return m ? parseFloat(m[0]) : null;
  }
  function formatLike(orig, n){
    const hasPlus = /^\s*\+/.test(orig);
    const s = Math.round(n).toString();
    return hasPlus ? (n>=0? '+' : '') + Math.round(n).toString() : s;
  }
  function animateCount(cell, from, to){
    if (DURATION === 0){ cell.textContent = formatLike(cell.textContent, to); return; }
    const start = performance.now();
    function step(now){
      const p = Math.min(1, (now - start) / DURATION);
      const eased = 1 - Math.pow(1 - p, 3);
      const val = from + (to - from) * eased;
      if (cell && cell.isConnected){
        cell.textContent = formatLike(cell.textContent, val);
      }
      if (p < 1 && cell && cell.isConnected) requestAnimationFrame(step);
      else if (cell && cell.isConnected) cell.textContent = formatLike(cell.textContent, to);
    }
    requestAnimationFrame(step);
  }

  const tbody = TBL.querySelector('tbody');
  if(!tbody) return;

  function initRow(tr){
    if (!tr || !tr.children) return;
    const pts = tr.children[2];
    const bon = tr.children[6];
    const mal = tr.children[7];
    if (pts) pts.dataset.prev = pts.textContent.trim();
    if (bon) bon.dataset.prev = bon.textContent.trim();
    if (mal) mal.dataset.prev = mal.textContent.trim();
  }

  Array.from(tbody.querySelectorAll('tr')).forEach(initRow);

  const mo = new MutationObserver((ms)=>{
    ms.forEach(m=>{
      if (m.type === 'characterData'){
        const parent = m.target && m.target.parentElement ? m.target.parentElement : null;
        if (!parent || !parent.parentElement) return;
        const tr = parent.parentElement;
        if (!tr || !tr.children) return;
        const colIndex = Array.from(tr.children).indexOf(parent);
        if (![2,6,7].includes(colIndex)) return;
        const prevText = parent.dataset.prev || '';
        const newText = parent.textContent.trim();
        const from = numFromText(prevText);
        const to = numFromText(newText);
        if (from==null || to==null || from===to){ parent.dataset.prev = newText; return; }
        parent.textContent = prevText;
        animateCount(parent, from, to);
        parent.dataset.prev = newText;
      }
      if (m.type === 'childList'){
        m.addedNodes.forEach(node=>{
          if(!(node && node.nodeType===1)) return;
          if (node.matches && node.matches('tr')){
            const tr = node;
            tr.style.animation = 'slideUpFade .28s ease both';
            const parent = tr.parentElement || (m.target && m.target.nodeType===1 ? m.target : null);
            if (parent && parent.children){
              const idx = Array.from(parent.children).indexOf(tr);
              tr.style.animationDelay = (Math.min(6, Math.max(0, idx)) * 0.03).toFixed(2) + 's';
            }
            initRow(tr);
          }else{
            node.querySelectorAll && node.querySelectorAll('tr').forEach(initRow);
          }
        });
      }
    });
  });
  mo.observe(tbody, { subtree:true, characterData:true, childList:true });

  function pulse(){
    TBL.style.boxShadow='0 0 0 1px rgba(122,162,255,.25) inset';
    setTimeout(()=>{ if (TBL) TBL.style.boxShadow=''; }, 250);
  }
  const r1 = document.getElementById('btn-refresh-standings');
  const r2 = document.getElementById('btn-refresh-standings-2');
  r1 && r1.addEventListener('click', pulse);
  r2 && r2.addEventListener('click', pulse);
})();
</script>


</body>
</html
<style id="scoreline-googleish">
<style id="rencontres-polish">
/* Card container */
.matches, .calendar, .journees, .games { gap: 20px; }
.scorewrap, .match, .match-card {
  background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px;
  padding: 14px 16px;
  box-shadow: 0 4px 18px rgba(0,0,0,.25);
}

/* Header line */
.scorewrap .teams-row{
  grid-template-columns: 1.2fr auto 1.2fr !important;
  gap: 20px !important;
}

/* Team cell */
.scorewrap .team{ gap: 12px !important; }
.scorewrap .team .avatar, .scorewrap .team .avatar img{
  width: 56px !important; height: 56px !important; border-radius: 50%;
}

/* Team name */
.scorewrap .team .name{ font-size: 20px; font-weight: 700; line-height: 1.1; }

/* Score core */
.scorewrap .score{
  font-weight: 900 !important;
  font-size: 36px !important;
  letter-spacing: 2px;
  min-width: 120px;
}

/* Little sport pills below */
.scorewrap .meta, .scorewrap .sub {
  display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;
}
.scorewrap .pill{
  padding: 4px 8px !important;
  font-size: 12px !important;
  opacity: .95;
  border-radius: 999px !important;
  box-shadow: 0 0 0 1px rgba(255,255,255,.08) inset;
}

/* Action row (play / expand) */
.scorewrap .actions{ display:flex; align-items:center; gap:10px; margin-top:8px; }
.scorewrap .actions .btn, .scorewrap .actions button{
  border-radius: 999px;
}

/* Collapsed details panel */
.scorewrap [aria-expanded="true"] + .details,
.match-card[aria-expanded="true"] .details {
  max-height: 600px; transition: max-height .35s ease;
}
.scorewrap [aria-expanded="false"] + .details,
.match-card[aria-expanded="false"] .details {
  max-height: 0; overflow: hidden; transition: max-height .25s ease;
}

/* Hover polish */
.scorewrap:hover{ transform: translateY(-1px); transition: transform .15s ease; }
</style>

<style id="score-entry-compact">
/* Chip √©tat Complet/Incomplet */
.state-chip{font-weight:700;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);}
.state-chip.ok{background:rgba(67,200,89,.15);box-shadow:0 0 0 1px rgba(67,200,89,.25) inset}
.state-chip.warn{background:rgba(255,170,25,.12);box-shadow:0 0 0 1px rgba(255,170,25,.25) inset}

/* Bandeau de saisie (plus compact) */
.match-two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.sport-group{background:transparent;border:0;padding:0;margin:0}
.sport-title{font-size:13px;font-weight:700;margin:0 0 6px 0;opacity:.9}
.sport-item{display:grid;grid-template-columns:auto 1fr;align-items:center;gap:8px;margin:4px 0}
.sport-item label{font-size:12px;opacity:.9;white-space:nowrap}
.sport-item select,.sport-item input{height:30px;padding:0 8px;border-radius:10px}

/* Palet ligne compacte */
.palet-inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.palet-inline input{width:52px;text-align:center}

/* R√©duire les marges globales du panneau */
.match-card .bd{padding:8px 10px}
</style>

<style id="round-head-style">
.round-head{display:flex;align-items:center;gap:10px;margin:18px 0 10px 0;padding-top:8px;border-top:1px solid rgba(255,255,255,.08)}
.round-head .round-title{font-weight:700;font-size:18px}
/* S√©paration visuelle forte entre journ√©es */
.round-grid{margin-bottom:26px;padding-bottom:8px}
/* Masquer la pastille #n dans chaque match (on ne la veut qu'en t√™te de journ√©e) */
.scorewrap .left-rail .round-chip{display:none !important;}
</style>

<style id="round-grid-divider-and-names">
/* Filet vertical entre les 2 colonnes */
.round-grid{ position:relative; }
.round-grid::before{
  content:"";
  position:absolute; top:0; bottom:0; left:50%;
  width:1px;
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.08), rgba(255,255,255,.04));
  transform: translateX(-0.5px);
  pointer-events:none;
}
@media (max-width: 900px){
  .round-grid::before{ display:none; }
}

/* Noms d'√©quipe adaptatifs + ellipsis */
.scorewrap .team{ min-width:0; }
.scorewrap .team .name{
  font-size: clamp(14px, 2vw, 18px);  /* s‚Äôadapte selon la largeur */
  max-width: 12ch;                    /* borne pour √©viter les d√©bordements */
  white-space: nowrap; max-width: calc(100vw - 32px);
  overflow: hidden;
  text-overflow: ellipsis;
}
/* Si l‚Äôespace est plus large (grand √©cran), autoriser un peu plus */
@media (min-width: 1400px){
  .scorewrap .team .name{ max-width: 16ch; font-size: clamp(14px, 1.6vw, 20px); }
}
</style>

<style id="match-cards-equalized">
/* === 1) Tailles identiques des cartes par ligne === */
.round-grid{
  /* chaque ligne prend la hauteur du match le plus grand */
  grid-auto-rows: 1fr;
  align-items: stretch;
}
.round-grid .match-card{
  height: 100%;
  display: flex;
  flex-direction: column;
}
.round-grid .match-card .hd{ /* en-t√™te */
  padding-bottom: 10px;
}
.round-grid .match-card .bd{ /* contenu extensible */
  margin-top: auto;   /* pousse le bas pour √©quilibrer */
}

/* === 2) Pilule Complet/Incomplet ne chevauche pas les scores des sports === */
.scorewrap .state-chip{
  display: inline-block;
  margin-top: 10px;   /* sous la ligne des pastilles de sports */
}
/* assure une vraie ligne pour les pastilles sport -> puis la pilule √©tat sous la ligne */
.scorewrap .meta, .scorewrap .sub{
  margin-bottom: 2px;
}

/* === 3) Densifier l'espacement entre journ√©es === */
.round-head{ margin: 12px 0 6px 0; padding-top: 6px; }
.round-grid{ margin-bottom: 14px; padding-bottom: 6px; }
</style>

<style id="match-cards-equal-width">
/* Forcer des largeurs identiques pour chaque carte dans la grille */
.round-grid{
  grid-template-columns: repeat(2, minmax(0, 1fr));
}
.round-grid > .match-card{
  width: 100%;
  min-width: 0;           /* √©vite que du contenu force la colonne */
  margin: 0 !important;   /* pas de marge parasite */
  box-sizing: border-box;
}
/* s'assurer que le contenu interne ne cr√©e pas une largeur diff√©rente */
.round-grid > .match-card .scorewrap{
  width: 100%;
  box-sizing: border-box;
}
/* Mobile: 1 colonne = pleine largeur */
@media (max-width: 900px){
  .round-grid{ grid-template-columns: 1fr; }
}
</style>

<style id="bonus-flashy-pill">
.pill.bonus-flashy{
  background: linear-gradient(180deg, rgba(80,180,255,.25), rgba(80,180,255,.15));
  border: 1px solid rgba(120,200,255,.45);
  box-shadow: 0 6px 18px rgba(0,120,255,.25), 0 0 0 1px rgba(0,120,255,.25) inset;
  font-weight: 800;
}
.pill.bonus-flashy .pos{ color: #5CF08A; font-weight: 800; margin-left: 6px; }
.pill.bonus-flashy .neg{ color: #FF6B6B; font-weight: 800; margin-left: 6px; }
.pill.bonus-flashy .mini-bonus{ width: 18px; height: 18px; border-radius: 50%; overflow: hidden; vertical-align: -3px; margin-left: 6px; }
.pill.bonus-flashy:hover{ filter: brightness(1.1); box-shadow: 0 8px 22px rgba(0,140,255,.35), 0 0 0 1px rgba(120,200,255,.6) inset; }
</style>



<style id="equal-visual-heights">
.scorewrap .teams-row{ align-items:center; min-height: 84px; }
.scorewrap .score{ font-size: clamp(28px, 3.2vw, 34px) !important; line-height:1; }
.scorewrap .team .name{ font-size: clamp(15px, 1.4vw, 18px); }
</style>

<style id="bonus-flashy-anim-tooltip">
/* Pop-in animation */
@keyframes bonusPop { 
  0% { transform: scale(.85); opacity: .0; filter: saturate(0.8) blur(.2px); } 
  60% { transform: scale(1.04); opacity: 1; } 
  100% { transform: scale(1); opacity: 1; } 
}
.pill.bonus-flashy{ animation: bonusPop .26s ease-out; position: relative; z-index: 0; }

/* Color variants */
.pill.bonus-flashy.pos{
  background: linear-gradient(180deg, rgba(40,200,120,.22), rgba(40,200,120,.14));
  border: 1px solid rgba(60,220,140,.55);
  box-shadow: 0 8px 22px rgba(40,200,120,.28), 0 0 0 1px rgba(60,220,140,.55) inset;
}
.pill.bonus-flashy.neg{
  background: linear-gradient(180deg, rgba(255,120,120,.22), rgba(255,120,120,.14));
  border: 1px solid rgba(255,110,110,.55);
  box-shadow: 0 8px 22px rgba(255,120,120,.30), 0 0 0 1px rgba(255,110,110,.55) inset;
}

/* Custom tooltip bubble */
.pill.bonus-flashy[data-tip]::after{
  content: attr(data-tip);
  position: absolute;
  left: 50%; transform: translateX(-50%);
  bottom: calc(100% + 8px);
  white-space: nowrap; max-width: calc(100vw - 32px);
  background: #0f141e; color:#fff; font-weight:700;
  border: 1px solid rgba(255,255,255,.28);
  padding: 6px 8px;
  font-size: 12px;
  border-radius: 8px;
  opacity: 0; pointer-events: none;
  transition: opacity .12s ease, transform .12s ease;
  transform-origin: bottom center;
  box-shadow: 0 10px 26px rgba(0,0,0,.55);
}
.pill.bonus-flashy[data-tip]::before{
  content: "";
  position: absolute;
  left: 50%; transform: translateX(-50%);
  bottom: 100%;
  border: 6px solid transparent;
  border-top-color: rgba(15,20,30,.95);
  opacity: 0; pointer-events: none;
  transition: opacity .12s ease;
}
.pill.bonus-flashy:hover::after,
.pill.bonus-flashy:hover::before{ opacity: 1; }
</style>

<style id="score-boxes-and-tooltip-align">
/* Score en bo√Ætes blanches */
.score{ display:flex; align-items:center; gap:10px; justify-content:center; }
.score .dash{ font-weight:900; opacity:.85; }
.score .scorebox{
  background: linear-gradient(180deg, #fff, #f1f1f1);
  color:#111;
  border-radius:12px;
  padding: 6px 14px;
  min-width: 54px;
  text-align:center;
  font-weight: 900;
  box-shadow: 0 3px 10px rgba(0,0,0,.15), 0 0 0 1px rgba(0,0,0,.05) inset;
}

/* Tooltip alignment per column */
.round-grid{ position:relative; }
.round-grid > .match-card:nth-child(odd) .pill.bonus-flashy[data-tip]::after{ left: 12px; transform: none; }
.round-grid > .match-card:nth-child(odd) .pill.bonus-flashy[data-tip]::before{ left: 22px; transform: none; }
.round-grid > .match-card:nth-child(even) .pill.bonus-flashy[data-tip]::after{ left:auto; right: 12px; transform: none; }
.round-grid > .match-card:nth-child(even) .pill.bonus-flashy[data-tip]::before{ left:auto; right: 22px; transform: none; }
/* On mobile, centre le tooltip */
@media (max-width: 900px){
  .round-grid > .match-card .pill.bonus-flashy[data-tip]::after{ left:50%; right:auto; transform: translateX(-50%); }
  .round-grid > .match-card .pill.bonus-flashy[data-tip]::before{ left:50%; right:auto; transform: translateX(-50%); }
}

/* Ajuste la taille des chiffres dans la bo√Æte */
.score .scorebox{ font-size: clamp(22px, 3.2vw, 34px); line-height:1; }
</style>

<style id="scoreboxes-tight-font">
/* Fonts proches d'un tableau de score */
@import url('https://fonts.googleapis.com/css2?family=Anton&family=Roboto+Condensed:wght@700&display=swap');

.score{ display:flex; align-items:center; gap:0; justify-content:center; }
.score .scorebox{
  background: linear-gradient(180deg, #fff, #f2f2f2);
  color:#111;
  padding: 10px 18px;
  min-width: 62px;
  text-align:center;
  font-weight: 900;
  font-family: 'Anton','Roboto Condensed','Impact','Arial Narrow',sans-serif;
  letter-spacing: .5px;
  font-size: clamp(26px, 3.6vw, 40px);
  line-height: 1;
}
.score .scorebox.a{ border-radius: 10px 0 0 10px; }
.score .scorebox.b{ border-radius: 0 10px 10px 0; }
/* couture centrale comme sur la photo */
.score .scorebox.b{ box-shadow: inset 2px 0 0 0 rgba(0,0,0,.35); }
.score .scorebox.a{ box-shadow: inset -2px 0 0 0 rgba(0,0,0,.22); }
</style>

<style id="bonus-flashy-blue-variant">
.pill.bonus-flashy{
  background: linear-gradient(180deg, rgba(60,120,255,.22), rgba(60,120,255,.14));
  border: 1px solid rgba(110,160,255,.55);
  box-shadow: 0 8px 22px rgba(60,120,255,.28), 0 0 0 1px rgba(110,160,255,.55) inset;
  font-weight: 800; position:relative;
}
/* halo/bord color√© selon pos/neg */
.pill.bonus-flashy.pos{ border-color: rgba(60,220,140,.85); box-shadow: 0 8px 22px rgba(40,200,120,.28), 0 0 0 2px rgba(60,220,140,.55) inset; }
.pill.bonus-flashy.neg{ border-color: rgba(255,110,110,.9); box-shadow: 0 8px 22px rgba(255,120,120,.30), 0 0 0 2px rgba(255,110,110,.55) inset; }
.pill.bonus-flashy .pos{ color: #5CF08A; font-weight: 900; margin-left: 6px; }
.pill.bonus-flashy .neg{ color: #FF6B6B; font-weight: 900; margin-left: 6px; }
</style>

<style id="scoreboxes-seam-stronger">
.score{ position:relative; }
.score::before{
  content:""; position:absolute; top:8%; bottom:8%; left:50%;
  width:1px; background: rgba(0,0,0,.45);
  transform: translateX(-0.5px);
  border-radius: 1px;
}
</style>

<style id="score-seam-simple">
/* Simple filet noir au centre du bloc score */
.score .scorebox.a, .score .scorebox.b{ box-shadow: none !important; }
.score{ position:relative; }
.score::before{
  content:""; position:absolute; top:10%; bottom:10%; left:50%;
  width:2px; background:#000; transform: translateX(-1px);
  border-radius: 1px;
}
</style>

<style id="bonus-sport-emoji-css">
.pill .sport-emo{ margin: 0 6px 0 4px; font-size: 14px; line-height: 0; vertical-align: -1px; }
</style>

<style id="tooltip-visibility-fix">
.match-card, .scorewrap, .round-grid { overflow: visible !important; }
.pill.bonus-flashy{ position:relative; z-index: 50; }
.pill.bonus-flashy[data-tip]::after,
.pill.bonus-flashy[data-tip]::before{ z-index: 1000; }
</style>

<style id="bonus-pill-compact">
.pill.bonus-flashy{ padding: 4px 8px; white-space: nowrap; font-size: 13px; }
.pill.bonus-flashy .mini-bonus{ width: 14px; height: 14px; margin: 0 4px; vertical-align: -2px; }
.pill .sport-emo{ margin: 0 4px 0 3px; font-size: 13px; vertical-align: -1px; }
.pill.bonus-flashy .pos, .pill.bonus-flashy .neg{ margin-left: 3px; }
</style>

<style id="bonus-pill-order-tight">
.pill.bonus-flashy, .pill.blue{ display:inline-flex; align-items:center; gap:4px; }
.pill.bonus-flashy .mini-bonus, .pill.blue .mini-bonus{ margin:0 2px; }
.pill .sport-emo{ margin:0 2px; }
</style>

<style id="chev-bottom-right">
.match-card .hd{ position: relative; }
.match-card .hd .chev{
  position: absolute; right: 14px; bottom: 12px; top: auto;
  transform: none;
}
.match-card[aria-expanded="true"] .hd .chev{ transform: rotate(90deg); }
</style>

<style id="incomplete-pulse">
@keyframes chipWarnPulse { 0%{ box-shadow:0 0 0 0 rgba(255,180,0,.0);} 50%{ box-shadow:0 0 0 6px rgba(255,180,0,.22);} 100%{ box-shadow:0 0 0 0 rgba(255,180,0,.0);} }
.chip.warn.pulse{ animation: chipWarnPulse .6s ease-out 1; }
</style>

