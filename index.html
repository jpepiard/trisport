<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tri-Sport ‚Äî D√©mo bonus compl√®te</title>
<style>
:root{
  --bg:#0f1a2b; --fg:#eaf1ff; --muted:#9db0cf; --card:#142240; --border:#2c3b5c;
  --blue:#4b8bff; --green:#56c06a; --yellow:#ffcc4b; --red:#ff6674;
}
*{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;}
h1,h2{margin:0 0 8px} h1{font-size:22px} h2{font-size:18px;color:var(--muted)}
.container{max-width:980px;margin:24px auto;padding:0 16px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
.btn{background:#1f2e55;border:1px solid var(--border);color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#4777ff,#3356d6);}
.btn:disabled{opacity:.5;cursor:not-allowed}
.pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;background:#1a2b52;border:1px solid var(--border)}
.pill.blue{background:#17315e}
.mini-bonus img{width:18px;height:18px;border-radius:4px;display:block}

.sport-chips{display:flex;gap:10px;margin-top:6px}
.chip{border-radius:999px;background:#162b4f;border:1px solid var(--border);padding:6px 10px;display:inline-flex;gap:6px;align-items:center}

.grid{display:grid;gap:8px}
.cols-2{grid-template-columns:1fr 1fr}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
select,input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0f1d3a;color:var(--fg)}

.section{padding:14px;border:1px dashed var(--border);border-radius:12px}

.bonus-dialog{position:fixed;inset:0;background:rgba(8,14,25,.72);display:none;place-items:center}
.bonus-dialog.show{display:grid}
.bonus-panel{width:min(920px,92vw);max-height:86vh;overflow:auto;background:var(--card);border:2px dashed var(--border);border-radius:14px;padding:16px 16px 12px}
.bonus-panel .hd{font-weight:800;margin:0 0 14px}
.bonus-panel .ft{display:flex;justify-content:flex-end;gap:8px;margin-top:16px}
.bonus-select{display:flex;flex-direction:column;gap:18px;margin:10px 0}
.bonus-select > .bonus-sep{height:0;border-top:1px dashed var(--border);opacity:.7;margin:0}
.bonus-card{display:grid;grid-template-columns:64px 1fr;column-gap:12px;align-items:start;border:2px dashed var(--border);border-radius:12px;padding:12px}
.bonus-card.selected{outline:2px solid var(--blue)}
.bonus-illu img{width:56px;height:56px;object-fit:cover;border-radius:10px}
.bonus-params{grid-column:1 / -1; overflow:hidden; transition:max-height .25s ease}
.help{color:var(--muted)}
.bonus-title{font-weight:800;margin-bottom:2px}

hr.sep{border:0;border-top:1px dashed var(--border);margin:12px 0}
.small{font-size:13px;color:var(--muted)}

.match{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:10px}
.team{font-weight:700}
.controls{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<div class="container">

  <h1>Tri‚ÄëSport ‚Äî D√©mo (bonus complets)</h1>
  <div class="row">
    <div class="card" style="flex:1 1 320px">
      <div class="section">
        <div class="small">Contr√¥le journ√©e</div>
        <div class="controls">
          <button id="btn-start" class="btn">D√©marrer la journ√©e</button>
          <button id="btn-finish" class="btn">Fin de journ√©e</button>
          <label style="margin-left:auto" class="small"><input type="checkbox" id="as-admin"> Admin</label>
        </div>
      </div>
      <div class="section" style="margin-top:10px">
        <div class="small">Matches (d√©mo)</div>
        <div id="matches"></div>
      </div>
    </div>

    <div class="card" style="flex:1 1 280px">
      <div class="small">Bonus (s√©lection actuelle)</div>
      <div id="bonus-pills" class="grid" style="grid-template-columns:1fr"></div>
    </div>
  </div>

</div>

<!-- MODAL BONUS -->
<div id="bonus-modal" class="bonus-dialog" aria-hidden="true">
  <div class="bonus-panel">
    <div class="hd">Choisir un bonus</div>
    <div class="bd">

      <div class="bonus-select">
        <!-- Capitaine -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/capitaine.jpg" alt=""></div>
          <div class="bonus-text">
            <div class="bonus-title">Capitaine</div>
            <div class="help">Choisissez un joueur (J1/J2) et un sport.<br/>√Ä la fin de la journ√©e : <b>+5 pts par victoire</b> du capitaine dans ce sport (les doubles comptent).</div>
          </div>
        </div>

        <div class="bonus-sep"></div>

        <!-- Miroir -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/miroir.jpg" alt=""></div>
          <div class="bonus-text">
            <div class="bonus-title">Miroir</div>
            <div class="help">Inverse le bonus adverse sur <b>tout le match</b>.<br/>Ex : si l‚Äôadversaire choisit <b>Capitaine</b>, son Capitaine s‚Äôapplique √† votre √©quipe.</div>
          </div>
        </div>

        <div class="bonus-sep"></div>

        <!-- Ren√© la taupe -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/taupe.png" alt=""></div>
          <div class="bonus-text">
            <div class="bonus-title">Ren√© la taupe</div>
            <div class="help">Impose des lunettes troublant la vision √† l‚Äôadversaire dans un sport choisi.<br/>Si l‚Äôadversaire joue <b>Miroir</b>, <i>vous</i> portez les lunettes.</div>
          </div>
        </div>

        <div class="bonus-sep"></div>

        <!-- 10 pouces 2 mains gauche -->
        <div class="bonus-card">
          <div class="bonus-illu" aria-hidden="true">
            <img src="img/main gauche.png" alt=""></div>
          <div class="bonus-text">
            <div class="bonus-title">10 pouces 2 mains gauche</div>
            <div class="help">L‚Äôadversaire doit jouer un sous‚Äëmatch avec sa <b>mauvaise main</b> (droitier ‚Üí main gauche, gaucher ‚Üí main droite).<br/>Choisissez le sport concern√©.</div>
          </div>
        </div>
      </div>

      <div class="help" id="bonus-context">Capitaine : choisissez le joueur et le sport concern√©s.</div>

      <!-- Param√®tres (ins√©r√©s sous la carte correspondante) -->
      <div id="capitaine-fields" class="grid cols-2" style="margin-top:10px">
        <div><label>Capitaine (joueur)</label>
          <select id="bonus-player"><option value="p1">Joueur 1</option><option value="p2">Joueur 2</option></select>
        </div>
        <div><label>Sport</label>
          <select id="bonus-sport"><option value="darts">Fl√©chettes</option><option value="ping">Ping</option><option value="palet">Palet</option></select>
        </div>
      </div>

      <div id="taupe-fields" class="grid cols-2" style="margin-top:10px">
        <div><label>Sport</label>
          <select id="taupe-sport"><option value="darts">Fl√©chettes</option><option value="ping">Ping</option><option value="palet">Palet</option></select>
        </div>
      </div>

      <div id="lefthand-fields" class="grid cols-2" style="margin-top:10px">
        <div><label>Sport</label>
          <select id="lefthand-sport"><option value="darts">Fl√©chettes</option><option value="ping">Ping</option><option value="palet">Palet</option></select>
        </div>
      </div>

    </div>
    <div class="ft">
      <button type="button" class="btn" id="bonus-cancel">Annuler</button>
      <button type="button" class="btn primary" id="bonus-save">Valider</button>
    </div>
  </div>
</div>

<script>
// ===== Mini utilitaires
const id = (x)=>document.getElementById(x);
const qs = (s,p=document)=>p.querySelector(s);
const qsa = (s,p=document)=>[...p.querySelectorAll(s)];
const hy = (a,b)=>`${a}-${b}`;

// ===== √âtat (d√©mo simplifi√©e)
let state = JSON.parse(localStorage.getItem('ts-state-demo')||'{}');
state.teams = state.teams || [{id:'t1',name:'√âquipe 1'},{id:'t2',name:'√âquipe 2'}];
state.roundCtl = state.roundCtl || { '1': {started:false, finished:false} };
state.matches = state.matches || [{id:'m1',round:'1',a:'t1',b:'t2', darts:[{a:0,b:0}], ping:[{a:0,b:0}], palet:{a:null,b:null}}];
state.bonusSelections = state.bonusSelections || {}; // { round: { teamId: {type,player?,sport?} } }
state.bonusApplied = state.bonusApplied || {};       // { round: { teamId: pts } }
function save(){ localStorage.setItem('ts-state-demo', JSON.stringify(state)); }

function isAdmin(){ return id('as-admin').checked; }
function roundState(r){ return state.roundCtl[r] || {started:false,finished:false}; }
function teamName(t){ return (state.teams.find(x=>x.id===t)||{}).name || t; }
function hasClaim(teamId){ return true; } // d√©mo : tout le monde peut agir

// ===== Bonus helpers
function setBonusSelection(r,t,sel){ (state.bonusSelections[r]=state.bonusSelections[r]||{})[t]=sel; save(); }
function getBonusSelection(r,t){ return (state.bonusSelections[r]||{})[t]||null; }
function teamBonusUsed(t){ return false; } // d√©mo : pas de limite
function setBonusApplied(r,t,pts){ (state.bonusApplied[r]=state.bonusApplied[r]||{})[t]=pts; save(); }
function getBonusAppliedSum(t){ const r='1'; return ((state.bonusApplied[r]||{})[t])||0; }

// ===== Calculs (tr√®s simples pour la d√©mo)
function computeCapitaineBonusForMatch(m, teamId, player, sport){
  // D√©mo: +5 si l'√©quipe a un score strictement sup√©rieur sur le sport choisi (1er set)
  let me, opp;
  if(sport==='darts'){ me = m.darts[0].a; opp = m.darts[0].b; if(teamId===m.b){ me=m.darts[0].b; opp=m.darts[0].a; } }
  else if(sport==='ping'){ me = m.ping[0].a; opp = m.ping[0].b; if(teamId===m.b){ me=m.ping[0].b; opp=m.ping[0].a; } }
  else { me = m.palet.a??0; opp=m.palet.b??0; if(teamId===m.b){ me=m.palet.b??0; opp=m.palet.a??0; } }
  return (me>opp)?5:0;
}

// ===== Rendu Matches (tr√®s simplifi√©)
function renderMatches(){
  const r='1', rs=roundState(r);
  const root = id('matches'); root.innerHTML='';
  state.matches.filter(m=>m.round===r).forEach(m=>{
    // titre + bouton bonus
    const line = document.createElement('div'); line.className='match';
    line.innerHTML = `<div class="team">${teamName(m.a)} vs ${teamName(m.b)}</div>
      <div class="controls">
        <button class="btn" data-open-bonus="${m.a}">üéñ ${teamName(m.a)}</button>
        <button class="btn" data-open-bonus="${m.b}">üéñ ${teamName(m.b)}</button>
      </div>`;
    root.appendChild(line);

    // chips
    const pal = m.palet, palScore = (pal.a!=null && pal.b!=null) ? hy(pal.a,pal.b) : "0-0";
    const chips = document.createElement('div'); chips.className='sport-chips';
    chips.innerHTML = \`
      <span class="chip">üéØ Fl√©chettes: <input type="number" min="0" value="\${m.darts[0].a}" data-darts="a" style="width:64px"> - <input type="number" min="0" value="\${m.darts[0].b}" data-darts="b" style="width:64px"></span>
      <span class="chip">üèì Ping: <input type="number" min="0" value="\${m.ping[0].a}" data-ping="a" style="width:64px"> - <input type="number" min="0" value="\${m.ping[0].b}" data-ping="b" style="width:64px"></span>
      <span class="chip">ü•è Palet: <input type="number" min="0" value="\${pal.a??0}" data-palet="a" style="width:64px"> - <input type="number" min="0" value="\${pal.b??0}" data-palet="b" style="width:64px"></span>
    \`;
    root.appendChild(chips);

    // droits d'√©dition
    qsa('input', chips).forEach(inp=>{
      let can=false;
      if(!rs.started) can = false;                 // avant d√©marrage : verrouill√©
      else if(rs.started && !rs.finished) can = true; // pendant la journ√©e : modifiable (√©quipes/admin)
      else if (rs.finished) can = isAdmin();       // fin de journ√©e : uniquement admin
      inp.disabled = !can;
      inp.addEventListener('change', ()=>{
        const v = parseInt(inp.value,10)||0;
        if (inp.hasAttribute('data-darts')) { const w=inp.getAttribute('data-darts'); if(w==='a') m.darts[0].a=v; else m.darts[0].b=v; }
        if (inp.hasAttribute('data-ping')) { const w=inp.getAttribute('data-ping'); if(w==='a') m.ping[0].a=v; else m.ping[0].b=v; }
        if (inp.hasAttribute('data-palet')){ const w=inp.getAttribute('data-palet'); if(w==='a') m.palet.a=v; else m.palet.b=v; }
        save(); renderPills();
      });
    });

    // ouvreurs modal
    qsa('[data-open-bonus]', line).forEach(btn=>{
      btn.addEventListener('click', ()=> openBonusModal(r, btn.getAttribute('data-open-bonus')));
    });
  });
}

// ===== Rendu Pilules
function renderPills(){
  const r='1', rs=roundState(r);
  const host = id('bonus-pills'); host.innerHTML='';
  state.teams.forEach(t=>{
    host.insertAdjacentHTML('beforeend', bonusChip(r, t.id, rs));
  });
}

function bonusChip(r,mTeam,rs){
  const sel = getBonusSelection(r, mTeam);
  const iAmTeam = hasClaim(mTeam);
  const roundFinished = !!rs.finished;

  if (isAdmin() && !roundFinished) return '';
  const canChoose = (!rs.started && !rs.finished && !teamBonusUsed(mTeam) && iAmTeam);
  if (!sel) {
    return canChoose ? \`<button type="button" class="btn" data-bonus data-team="\${mTeam}">üéñ Bonus (\${teamName(mTeam)})</button>\` : '';
  }
  if (!roundFinished && !iAmTeam) return '';

  // Secret (avant la fin) : montrer juste le libell√©/icone
  if (!roundFinished) {
    const __lbl = sel.type==='miroir'?'Miroir':(sel.type==='taupe'?'Ren√© la taupe':(sel.type==='lefthand'?'10 pouces 2 mains gauche':'Capitaine'));
    const __img = sel.type==='miroir'?'miroir.jpg':(sel.type==='taupe'?'taupe.png':(sel.type==='lefthand'?'main gauche.png':'capitaine.jpg'));
    return \`<span class="pill blue">\${__lbl}<span class="mini-bonus"><img src="img/\${__img}" alt=""></span></span>\`;
  }

  // R√©v√©l√© √† tout le monde
  const applied = getBonusAppliedSum(mTeam) || 0;
  if (sel.type === 'miroir') {
    return \`<span class="pill blue">Miroir : +\${applied}<span class="mini-bonus"><img src="img/miroir.jpg" alt=""></span></span>\`;
  } else if (sel.type === 'taupe') {
    const labelSport = sel.sport === 'darts' ? 'Fl√©chettes' : (sel.sport === 'ping' ? 'Ping' : 'Palet');
    // D√©mo : on ne calcule pas "qui porte", on affiche l‚Äôintention
    return \`<span class="pill blue">Ren√© la taupe / \${labelSport}<span class="mini-bonus"><img src="img/taupe.png" alt=""></span></span>\`;
  } else if (sel.type === 'lefthand') {
    const labelSport = sel.sport === 'darts' ? 'Fl√©chettes' : (sel.sport === 'ping' ? 'Ping' : 'Palet');
    return \`<span class="pill blue">Main faible / \${labelSport}<span class="mini-bonus"><img src="img/main gauche.png" alt=""></span></span>\`;
  } else {
    const labelPlayer = sel.player === 'p1' ? 'J1' : 'J2';
    const labelSport = sel.sport === 'darts' ? 'Fl√©chettes' : (sel.sport === 'ping' ? 'Ping' : 'Palet');
    return \`<span class="pill blue">Capitaine \${labelPlayer} / \${labelSport} : +\${applied}<span class="mini-bonus"><img src="img/capitaine.jpg" alt=""></span></span>\`;
  }
}

// ===== Modal bonus
const bonusCTX = {round:null, teamId:null};
function ensureParamWrapper(){
  const fields = id('capitaine-fields'); if(!fields) return null;
  let wrap=id('cap-params'); if(!wrap){wrap=document.createElement('div'); wrap.id='cap-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields);}
  return wrap;
}
function ensureTaupeWrapper(){
  const fields = id('taupe-fields'); if(!fields) return null;
  let wrap=id('taupe-params'); if(!wrap){wrap=document.createElement('div'); wrap.id='taupe-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields);}
  return wrap;
}
function ensureLeftHandWrapper(){
  const fields = id('lefthand-fields'); if(!fields) return null;
  let wrap=id('lefthand-params'); if(!wrap){wrap=document.createElement('div'); wrap.id='lefthand-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields);}
  return wrap;
}
function setParamsOpen(openCap, openTaupe, openLeft){
  const wrapC = ensureParamWrapper(); if (wrapC){ wrapC.style.maxHeight = openCap ? (wrapC.scrollHeight+'px'):'0px'; }
  const wrapT = ensureTaupeWrapper(); if (wrapT){ wrapT.style.maxHeight = openTaupe ? (wrapT.scrollHeight+'px'):'0px'; }
  const wrapL = ensureLeftHandWrapper(); if (wrapL){ wrapL.style.maxHeight = openLeft ? (wrapL.scrollHeight+'px'):'0px'; }
}
function selectBonusType(t){
  window._bonusType = (t==='miroir'||t==='taupe'||t==='lefthand') ? t : 'capitaine';
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  const cap = cards[0], mir = cards[1], tau = cards[2], leftc = cards[3];
  [cap,mir,tau,leftc].forEach(c=>c&&c.classList.remove('selected'));
  if (cap && window._bonusType==='capitaine') cap.classList.add('selected');
  if (mir && window._bonusType==='miroir') mir.classList.add('selected');
  if (tau && window._bonusType==='taupe') tau.classList.add('selected');
  if (leftc && window._bonusType==='lefthand') leftc.classList.add('selected');
  const ctx = id('bonus-context');
  ctx.textContent = window._bonusType==='miroir' ?
    "Miroir : inverse le bonus adverse sur tout le match." :
    (window._bonusType==='taupe' ? "Ren√© la taupe : choisissez le sport." :
      (window._bonusType==='lefthand' ? "10 pouces 2 mains gauche : choisissez le sport." :
        "Capitaine : choisissez le joueur et le sport."));
  setParamsOpen(window._bonusType==='capitaine', window._bonusType==='taupe', window._bonusType==='lefthand');
}
function prepareBonusOptions(){
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  cards.forEach((c, idx)=>{
    c.classList.add('selectable'); c.tabIndex=0; c.setAttribute('role','button');
    c.addEventListener('click', ()=> selectBonusType(idx===0?'capitaine':(idx===1?'miroir':(idx===2?'taupe':'lefthand'))));
    c.addEventListener('keydown', e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); selectBonusType(idx===0?'capitaine':(idx===1?'miroir':(idx===2?'taupe':'lefthand'))); } });
  });
  const cap = cards[0], tau = cards[2], leftc = cards[3];
  const wrapC = ensureParamWrapper(); if(cap && wrapC && wrapC.previousElementSibling!==cap) cap.appendChild(wrapC);
  const wrapT = ensureTaupeWrapper(); if(tau && wrapT && wrapT.previousElementSibling!==tau) tau.appendChild(wrapT);
  const wrapL = ensureLeftHandWrapper(); if(leftc && wrapL && wrapL.previousElementSibling!==leftc) leftc.appendChild(wrapL);
}

function openBonusModal(round,teamId){
  const rCtl=roundState(round);
  if(rCtl.started) return alert("La journ√©e a d√©marr√© : bonus verrouill√©s.");
  bonusCTX.round=round; bonusCTX.teamId=teamId;
  const sel=getBonusSelection(round,teamId);
  prepareBonusOptions(); selectBonusType(sel?.type||'capitaine');
  id('bonus-player').value = sel?.player || 'p1';
  id('bonus-sport').value = sel?.sport || 'darts';
  id('taupe-sport').value = sel?.sport || 'darts';
  id('lefthand-sport').value = sel?.sport || 'darts';
  id('bonus-modal').classList.add('show');
}
id('bonus-cancel').addEventListener('click',()=>id('bonus-modal').classList.remove('show'));
id('bonus-save').addEventListener('click',()=>{
  const r=bonusCTX.round, t=bonusCTX.teamId;
  const type = (window._bonusType==='miroir') ? 'miroir' : (window._bonusType==='taupe' ? 'taupe' : (window._bonusType==='lefthand'?'lefthand':'capitaine'));
  if(type==='capitaine') setBonusSelection(r,t,{type:'capitaine',player:id('bonus-player').value,sport:id('bonus-sport').value});
  else if(type==='taupe') setBonusSelection(r,t,{type:'taupe',sport:id('taupe-sport').value});
  else if(type==='lefthand') setBonusSelection(r,t,{type:'lefthand',sport:id('lefthand-sport').value});
  else setBonusSelection(r,t,{type:'miroir'});
  id('bonus-modal').classList.remove('show');
  renderPills();
});

// ===== Contr√¥les de journ√©e
id('btn-start').addEventListener('click',()=>{ state.roundCtl['1']={started:true,finished:false}; save(); renderMatches(); });
id('btn-finish').addEventListener('click',()=>{
  const r='1', matches = state.matches.filter(m=>m.round===r);
  // Applique Capitaine et Miroir sur chaque match
  const sels = state.bonusSelections[r]||{};
  let results = {};
  matches.forEach(m=>{
    const A=m.a,B=m.b, selA=sels[A], selB=sels[B];
    let capA=0, capB=0;
    if (selA && selA.type==='capitaine') capA = computeCapitaineBonusForMatch(m, A, selA.player, selA.sport);
    if (selB && selB.type==='capitaine') capB = computeCapitaineBonusForMatch(m, B, selB.player, selB.sport);
    let applyA=0, applyB=0;
    const mirrorA = !!(selA && selA.type==='miroir');
    const mirrorB = !!(selB && selB.type==='miroir');
    if (mirrorA && selB && selB.type==='capitaine') { applyA += capB; capB = 0; }
    if (mirrorB && selA && selA.type==='capitaine') { applyB += capA; capA = 0; }
    applyA += capA; applyB += capB;
    results[A]=(results[A]||0)+applyA;
    results[B]=(results[B]||0)+applyB;
  });
  Object.keys(results).forEach(t=> setBonusApplied(r,t,results[t]||0));
  state.roundCtl['1']={started:true,finished:true}; save(); renderPills(); renderMatches();
});

// ===== Boot
renderMatches();
renderPills();
</script>
</body>
</html>
