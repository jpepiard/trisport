<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TriSports ‚Äî Fl√©chettes ‚Ä¢ Ping-pong ‚Ä¢ Palet</title>
  <style>
    :root { --bg:#0f1220; --border:#2b315f; --text:#e7e9f7; --muted:#8b94b8; --chip:#242b55; --card:#1b2242; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;background:radial-gradient(1200px 800px at 20% -10%, #1c2040, transparent),radial-gradient(1000px 600px at 120% 0%, #1b2550, transparent),var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(130%) blur(8px);background:linear-gradient(180deg, rgba(15,18,32,.9), rgba(15,18,32,.6));border-bottom:1px solid var(--border)}
    .container{max-width:1100px;margin:0 auto;padding:18px 16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 210deg, #6ee7b7, #7aa2ff);display:grid;place-items:center;font-weight:900;color:#0a0d1c}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:var(--chip);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:999px;cursor:pointer}
    .tab[aria-selected="true"]{background:linear-gradient(180deg,#1d2a57,#1a2450);border-color:#3a4aa0}
    main .container{padding-top:22px}
    section{display:none} section.active{display:block}
    .card{background:linear-gradient(180deg,#171d3a,#121632);border:1px solid var(--border);border-radius:16px}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:12px}
    .card .bd{padding:16px}
    .help{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:1px solid var(--border);background:var(--chip);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#2f3da2,#25337d);border-color:#3a4aa0}
    .btn.small{padding:6px 10px;border-radius:10px;font-size:13px}
    .btn.danger{background:linear-gradient(180deg,#7a2b2b,#5c2222);border-color:#8a2b2b}
    .grid{display:grid;gap:12px} .grid.cols-2{grid-template-columns:repeat(2,1fr)} .grid.cols-3{grid-template-columns:repeat(3,1fr)} .grid.cols-4{grid-template-columns:repeat(4,1fr)} .grid.responsive{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    input[type=text],input[type=number],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1331;color:var(--text)}
    label{font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse} th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left} th{color:var(--muted);font-weight:600}
    .match-card{border-radius:14px;border:1px solid var(--border);background:var(--card);overflow:hidden}
    .chip{font-size:12px;padding:4px 8px;background:var(--chip);border:1px solid var(--border);border-radius:999px;color:var(--muted)}
    .pill{padding:4px 8px;border-radius:999px;background:#0f1331;border:1px solid var(--border);color:var(--muted);font-size:12px}
    .h2h-table th, .h2h-table td { white-space:nowrap; }
    .team-name{display:inline-flex;align-items:center;gap:8px}
    .avatar{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:#0f1331;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;color:#cbd5ff;font-weight:700;font-size:14px;flex:0 0 auto}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .avatar .avatar-initials{display:inline-block;line-height:40px}
    .avatar-lg{width:48px;height:48px;font-size:15px}
    .avatar-lg .avatar-initials{line-height:48px}
    .avatar-sm{width:32px;height:32px;font-size:12px}
    .avatar-sm .avatar-initials{line-height:32px}
    #storage-warning{position:fixed; right:12px; bottom:12px; display:none; background:#0f1331; border:1px solid var(--border); color:var(--muted); border-radius:10px; padding:8px 10px; z-index:99; box-shadow:0 6px 24px rgba(0,0,0,.35)}
    #js-ok{position:fixed;right:12px;top:12px;background:#7a2525;color:#fff;padding:6px 10px;border-radius:10px;z-index:9999;font:600 12px system-ui,Segoe UI,Roboto}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script>
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyBSxiTryd0T1Flv15LBdzu31UFvU_I2J7Q",
      authDomain: "trisport-9a7b2.firebaseapp.com",
      databaseURL: "https://trisport-9a7b2-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "trisport-9a7b2",
      messagingSenderId: "132024051367",
      appId: "1:132024051367:web:f9aa39785a3d4a43875d82"
    };
  </script>
</head>
<body>
  <!-- Badge de contr√¥le JS -->
  <div id="js-ok"><noscript>JavaScript est d√©sactiv√©.</noscript>JS non charg√©</div>
  <script>
    // Ping ultra-t√¥t : si ceci s‚Äôex√©cute, le JS est ok.
    (function(){
      var p=document.getElementById('js-ok');
      if(p){ p.textContent='JS charg√© ‚úÖ'; p.style.background='#14532d'; }
    })();
  </script>

  <header>
    <div class="container" style="display:flex;align-items:center;gap:16px;justify-content:space-between;flex-wrap:wrap">
      <div class="brand">
        <div class="logo">T</div>
        <h1 style="font-size:18px;margin:0">TriSports</h1>
      </div>

      <nav class="tabs" role="tablist" aria-label="Sections" style="flex:1;justify-content:center;display:flex;gap:8px;flex-wrap:wrap">
        <button type="button" class="tab" role="tab" aria-selected="true" data-tab="setup">Tournoi</button>
        <button type="button" class="tab" role="tab" aria-selected="false" data-tab="equipes">√âquipes</button>
        <button type="button" class="tab" role="tab" aria-selected="false" data-tab="calendrier">Rencontres</button>
        <button type="button" class="tab" role="tab" aria-selected="false" data-tab="classement">Classement</button>
        <button type="button" class="tab" role="tab" aria-selected="false" data-tab="options">Options</button>
      </nav>

      <div style="display:flex;align-items:center;gap:8px">
        <span id="tname-top" class="pill" title="Nom du tournoi" style="display:none"></span>
        <span id="whoami-top" class="pill">visiteur</span>
        <button type="button" class="btn small" id="btn-fullscreen" title="Plein √©cran (Esc pour quitter)">‚õ∂ Plein √©cran</button>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div id="storage-warning" class="help" style="display:none"></div>

      <!-- 1) Accueil Tournoi -->
      <section id="setup" class="active">
        <div class="grid cols-2">
          <div class="card">
            <div class="hd"><strong>Nouveau tournoi</strong></div>
            <div class="bd grid cols-2">
              <div>
                <label>Nom du tournoi</label>
                <input type="text" id="tname-input" placeholder="ex : Tournoi de la plage" />
              </div>
              <div>
                <label>Nombre d'√©quipes</label>
                <input type="number" id="teams-count-input" min="2" max="64" step="1" value="4" />
              </div>
              <div style="grid-column:1/-1;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <button type="button" class="btn primary" id="btn-create-tournament">Cr√©er</button>
                <span class="help">Action r√©serv√©e √† l‚Äôadministrateur.</span>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hd"><strong>Rejoindre tournoi existant</strong></div>
            <div class="bd grid">
              <label>Code du tournoi (cloud)</label>
              <input type="text" id="join-code" placeholder="ex : apero2025" />
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <button type="button" class="btn primary" id="btn-join-code">Rejoindre</button>
                <button type="button" class="btn" id="btn-copy-link">Copier lien ?id=code</button>
                <span class="help">Statut : <span id="cloud-status">hors ligne</span></span>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="hd"><strong>Tournois enregistr√©s (ce navigateur)</strong></div>
          <div class="bd" id="recent-list"><div class="help">Aucun tournoi m√©moris√© pour l‚Äôinstant.</div></div>
        </div>
      </section>

      <!-- 2) √âquipes -->
      <section id="equipes">
        <div class="card">
          <div class="hd">
            <div>
              <strong>√âquipes</strong>
              <div class="help">L‚Äô<b>administrateur</b> cr√©e et √©dite les √©quipes. Les joueurs se connectent √† leur √©quipe pour saisir <b>leurs scores</b> uniquement.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span class="pill" id="lock-pill" style="display:none">Calendrier fig√© üîí</span>
              <button type="button" class="btn" id="btn-add-team" style="display:none">+ Ajouter √©quipe (admin)</button>
              <button type="button" class="btn primary" id="btn-generate">G√©n√©rer le calendrier</button>
            </div>
          </div>
          <div class="bd"><div id="team-list" class="grid responsive"></div></div>
        </div>
      </section>

      <!-- 3) Rencontres -->
      <section id="calendrier">
        <div class="card">
          <div class="hd">
            <strong>Rencontres</strong>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span class="pill" id="stats-matches">0 / 0 matches complets</span>
              <button type="button" class="btn small" id="btn-refresh-standings">Mettre √† jour le classement</button>
              <button type="button" class="btn small" id="btn-collapse">Tout replier</button>
            </div>
          </div>
          <div class="bd"><div id="match-list" class="grid"></div></div>
        </div>
      </section>

      <!-- 4) Classement -->
      <section id="classement">
        <div class="card">
          <div class="hd">
            <strong>Classement</strong>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span class="pill" id="teams-count">0 √©quipes</span>
              <span class="pill" id="rounds-count">0 matchs par √©quipe</span>
              <button type="button" class="btn small" id="btn-toggle-h2h">Vue face-√†-face</button>
              <button type="button" class="btn small" id="btn-refresh-standings-2">Mettre √† jour</button>
            </div>
          </div>
          <div class="bd" style="overflow:auto">
            <div id="view-summary">
              <div class="help" style="margin-bottom:10px">
                R√®gles ‚Äî Fl√©chettes : 3 parties (2 simples + 1 double), <b>5 pts</b> par partie gagn√©e.
                Ping-pong : 3 parties (2 simples + 1 double), score valide si <b>11+</b> et <b>√©cart ‚â• 2</b>, victoire = <b>5 pts</b>.
                Palet : 1 double √† 11, les points marqu√©s s‚Äôajoutent au total.
              </div>
              <table id="table-classement"><thead><tr><th>#</th><th>√âquipe</th><th>Points</th><th>Fl√©chettes (G)</th><th>Ping-pong (G)</th><th>Palet (PF‚ÄìPA)</th><th>Matchs complets</th></tr></thead><tbody></tbody></table>
            </div>
            <div id="view-h2h" style="display:none">
              <div class="help" style="margin-bottom:10px">Face-√†-face : cliquez sur une cellule pour ouvrir la rencontre.</div>
              <table id="table-h2h" class="h2h-table"><thead></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </section>

      <!-- 5) Options -->
      <section id="options">
        <div class="grid cols-2">
          <div class="card">
            <div class="hd"><strong>Exporter / Importer</strong></div>
            <div class="bd grid" style="gap:10px">
              <button type="button" class="btn" id="btn-export">Exporter en JSON</button>
              <input type="file" id="file-import" accept="application/json" />
              <button type="button" class="btn" id="btn-import">Importer le fichier JSON</button>
            </div>
          </div>

          <div class="card">
            <div class="hd"><strong>Acc√®s administrateur</strong></div>
            <div class="bd" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <button type="button" class="btn" id="btn-admin-on">Activer admin</button>
              <button type="button" class="btn" id="btn-admin-off">D√©sactiver admin</button>
              <span class="pill" id="whoami">vous : visiteur (lecture seule)</span>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="hd"><strong>Cloud (partage)</strong></div>
          <div class="bd" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <span class="pill">Statut : <span id="cloud-status-2">hors ligne</span></span>
            <button type="button" class="btn primary" id="btn-publish-cloud">Publier & partager ce tournoi</button>
            <button type="button" class="btn" id="btn-cloud-copy">Copier le lien de partage</button>
            <button type="button" class="btn" id="btn-cloud-leave">Quitter le cloud (rester en local)</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="hd"><strong>R√©initialisation</strong></div>
          <div class="bd grid" style="gap:10px">
            <button type="button" class="btn danger" id="btn-reset">Nouvelle comp√©tition (tout effacer)</button>
            <button type="button" class="btn" id="btn-unlock">üîì D√©verrouiller le calendrier</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- === JS INLINE (d√©fensif + messages d‚Äôerreur visibles) === -->
  <script>
  (function () {
    // Si une erreur survient, on l‚Äôaffiche clairement
    window.onerror = function (msg, src, line, col) {
      try {
        var el = document.getElementById("storage-warning");
        if (el) {
          el.style.display = "block";
          el.textContent = "Erreur JS : " + msg + " @" + (src || "") + ":" + (line || 0) + ":" + (col || 0);
        }
        var p=document.getElementById('js-ok');
        if(p){ p.textContent='JS charg√© avec erreurs ‚ö†Ô∏è'; p.style.background='#8a2a2a'; }
      } catch(e) {}
    };

    document.addEventListener("DOMContentLoaded", function () {
      // Styles avatars (au cas o√π le CSS initial ne passe pas)
      addInlineStyle(".avatar{width:40px;height:40px;font-size:14px}.avatar .avatar-initials{line-height:40px}.avatar-lg{width:48px;height:48px;font-size:15px}.avatar-lg .avatar-initials{line-height:48px}.avatar-sm{width:32px;height:32px;font-size:12px}.avatar-sm .avatar-initials{line-height:32px}");

      /* ---------- Stockage local ---------- */
      var STORAGE_KEY="tournoi_amis_roles2c6";
      var IDX_KEY="trisports_index_v1";
      var SNAP_PREFIX="trisports_state_";
      var CURR_KEY="trisports_current_id";
      var MEMORY_ONLY=false;

      function saveRuntime(){ try{ if(!MEMORY_ONLY) localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ MEMORY_ONLY=true; warnStorage(); } }
      function loadRuntime(){ try{ var raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):null; }catch(e){ MEMORY_ONLY=true; return null; } }
      function warnStorage(){ var el=id("storage-warning"); if(el){ el.style.display="block"; el.textContent="‚ö†Ô∏è Stockage local indisponible (navigation priv√©e ?)."; } }

      function getIndex(){ try{ return JSON.parse(localStorage.getItem(IDX_KEY)||"[]"); }catch(e){ return []; } }
      function setIndex(arr){ try{ localStorage.setItem(IDX_KEY, JSON.stringify(arr||[])); }catch(e){} }
      function upsertIndex(entry){
        var idx=getIndex(); var i=-1; for(var k=0;k<idx.length;k++){ if(idx[k].id===entry.id){ i=k; break; } }
        if(i>=0) idx[i]=Object.assign({}, idx[i], entry); else idx.unshift(entry);
        setIndex(idx);
      }
      function saveSnapshot(){
        if(!state.tid) state.tid=uid();
        try{ localStorage.setItem(SNAP_PREFIX+state.tid, JSON.stringify(state)); }catch(e){}
        upsertIndex({ id:state.tid, name:state.tournamentName||"Sans titre", updatedAt:Date.now(), type: state.cloudId? "cloud":"local" });
        try{ localStorage.setItem(CURR_KEY, state.tid); }catch(e){}
      }
      function loadSnapshot(tid){
        try{
          var raw=localStorage.getItem(SNAP_PREFIX+tid);
          if(!raw) return false;
          state = JSON.parse(raw);
          normalize(); saveRuntime();
          try{ localStorage.setItem(CURR_KEY, tid); }catch(e){}
          return true;
        }catch(e){ return false; }
      }

      /* ---------- √âtat & session ---------- */
      var state = loadRuntime() || {
        version: 22,
        tid: uid(),
        cloudId: null,
        tournamentName: "",
        teams: [],
        matches: [],
        locked: false,
        createdAt: new Date().toISOString(),
        protect: { teamPassHash:{} }
      };
      normalize();

      var ui = { open:{}, h2h:false };
      var session = { admin:false, claims:{} };

      function sessionKey(){ return "tournoi_session_"+(cloud.id||"local"); }
      function loadSession(){ try{ var raw=localStorage.getItem(sessionKey()); if(raw){ var s=JSON.parse(raw); if(s) session=s; } }catch(e){} updateWho(); }
      function saveSession(){ try{ localStorage.setItem(sessionKey(), JSON.stringify(session)); }catch(e){} updateWho(); }

      /* ---------- Firebase (Cloud) ---------- */
      var cloud = { enabled:false, db:null, id:null, ref:null, lastRemoteAt:0, pushTimer:null };
      var hasFB = !!(window.firebase && window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.apiKey);
      function initFB(){
        if(!hasFB) return null;
        try{
          var apps = firebase.apps;
          if(!apps || apps.length===0) firebase.initializeApp(window.FIREBASE_CONFIG);
          return firebase.database();
        }catch(e){ console.warn("Firebase init error",e); return null; }
      }
      function setCloud(txt){
        var a=id("cloud-status"); if(a) a.textContent=txt;
        var b=id("cloud-status-2"); if(b) b.textContent=txt;
      }

      function joinCloud(code){
        if(!hasFB){ alert("Firebase non configur√©."); return; }
        if(!cloud.db){ cloud.db=initFB(); if(!cloud.db){ alert("Initialisation Firebase impossible."); return; } }
        cloud.id=(code||"").trim(); if(!cloud.id){ alert("Saisis un code tournoi."); return; }
        cloud.ref = cloud.db.ref("tournaments/"+cloud.id+"/payload");
        cloud.enabled=true; cloud.lastRemoteAt=0; setCloud("connexion‚Ä¶"); loadSession();

        var first=true;
        cloud.ref.on("value", function(snap){
          var val=snap.val();
          if(first){
            first=false;
            if(!val){
              state.cloudId = cloud.id;
              pushCloud(true);
              setCloud("connect√© (cr√©√©)");
              upsertIndex({ id:"cloud:"+cloud.id, name:"Cloud ¬∑ "+cloud.id, updatedAt:Date.now(), type:"cloud" });
              renderSetupRecent();
              return;
            }
          }
          if(!val) return;
          var remoteAt=+val.updatedAt||0;
          if(remoteAt<=cloud.lastRemoteAt) return;
          cloud.lastRemoteAt=remoteAt;
          state = val.state || state;
          state.cloudId = cloud.id;
          normalize();
          saveRuntime(); saveSnapshot();
          renderAll();
          setCloud("connect√© ("+cloud.id+")");
        });

        try{ history.replaceState(null,"", location.pathname+"?id="+encodeURIComponent(cloud.id)); }catch(e){}
      }
      function leaveCloud(){
        if(cloud.ref) cloud.ref.off();
        cloud.enabled=false; cloud.id=null; cloud.ref=null; setCloud("hors ligne");
        loadSession();
      }
      function pushCloud(immediate){
        if(!cloud.enabled||!cloud.ref) return;
        var doPush=function(){ cloud.ref.set({ state:state, updatedAt:Date.now() }); };
        clearTimeout(cloud.pushTimer);
        cloud.pushTimer=setTimeout(doPush, immediate?0:250);
      }
      function publishCurrentToCloud(){
        if(!isAdmin()){ alert("Seul l‚Äôadministrateur peut publier."); return; }
        if(!hasFB){ alert("Firebase non configur√©."); return; }
        if(!cloud.db){ cloud.db=initFB(); if(!cloud.db){ alert("Initialisation Firebase impossible."); return; } }
        var code = prompt("Choisis un code de tournoi (ex: apero2025). Tes amis rejoindront avec ce code :");
        if(!code) return;
        cloud.id = code.trim();
        cloud.ref = cloud.db.ref("tournaments/"+cloud.id+"/payload");
        cloud.enabled = true; cloud.lastRemoteAt = 0;
        state.cloudId = cloud.id;
        pushCloud(true);
        setCloud("connect√© ("+cloud.id+")");
        upsertIndex({ id:"cloud:"+cloud.id, name:"Cloud ¬∑ "+cloud.id, updatedAt:Date.now(), type:"cloud" });
        renderSetupRecent();
        try{ history.replaceState(null,"", location.pathname+"?id="+encodeURIComponent(cloud.id)); }catch(e){}
        var url = location.origin+location.pathname+"?id="+encodeURIComponent(cloud.id);
        if(navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(url);
        alert("Tournoi publi√© !\nLien copi√© :\n"+url);
      }

      // Auto-join via ?id=
      (function(){ try{ var p=new URLSearchParams(location.search); var idp=p.get("id"); if(idp){ var el=id("join-code"); if(el) el.value=idp; joinCloud(idp); } }catch(e){} })();

      /* ---------- Utils ---------- */
      function id(x){ return document.getElementById(x); }
      function qs(s){ return document.querySelector(s); }
      function qsa(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
      function qsaIn(n,s){ return Array.prototype.slice.call(n.querySelectorAll(s)); }
      function addInlineStyle(css){ var st=document.createElement("style"); st.textContent=css; document.head.appendChild(st); }
      function esc(s){ return (s==null?"":String(s)).replace(/[&<>"']/g, function(c){ return {"&":"&amp;","<":"&gt;","\"":"&quot;","'":"&#39;"}[c]; }); }
      function uid(){ return Math.random().toString(36).slice(2,10); }
      function clampInt(v,min,max){ v=parseInt(v,10); if(isNaN(v)) return null; return Math.max(min, Math.min(max, v)); }
      function help(t){ var d=document.createElement("div"); d.className="help"; d.textContent=t; return d; }
      function sha256(str){
        try{
          if(window.crypto && window.crypto.subtle){
            var enc=new TextEncoder().encode(str);
            return window.crypto.subtle.digest("SHA-256",enc).then(function(buf){
              var a=Array.from(new Uint8Array(buf)); return a.map(function(b){return b.toString(16).padStart(2,"0");}).join("");
            });
          }
        }catch(e){}
        // fallback simple hash
        var h=2166136261>>>0; for(var i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; }
        var stub=("00000000"+h.toString(16)).slice(-8); return Promise.resolve(stub+stub+stub+stub+stub+stub+stub+stub);
      }
      function salt(){ return cloud.id || "local"; }

      /* ---------- Normalisation ---------- */
      function _arr(x){ return Array.isArray(x)?x:[]; }
      function _normMatch(m){
        m=m||{};
        m.id=m.id||uid(); m.a=m.a||""; m.b=m.b||"";
        m.darts=Array.isArray(m.darts)?m.darts.slice(0,3):[null,null,null]; while(m.darts.length<3) m.darts.push(null);
        if(!Array.isArray(m.pingPts)) m.pingPts=[{a:null,b:null},{a:null,b:null},{a:null,b:null}];
        for(var i=0;i<3;i++){ m.pingPts[i]=m.pingPts[i]||{a:null,b:null}; m.pingPts[i].a=(m.pingPts[i].a==null?null:+m.pingPts[i].a); m.pingPts[i].b=(m.pingPts[i].b==null?null:+m.pingPts[i].b); }
        m.palet=m.palet||{a:null,b:null}; m.palet.a=(m.palet.a==null?null:+m.palet.a); m.palet.b=(m.palet.b==null?null:+m.palet.b);
        m.round=m.round||1; m.order=m.order||0; return m;
      }
      function normalize(){
        if(!state) state={};
        if(!state.protect) state.protect={teamPassHash:{}};
        state.teams=_arr(state.teams);
        state.matches=_arr(state.matches).map(_normMatch);
        renderTitle();
      }

      /* ---------- R√¥les & identit√© ---------- */
      function isAdmin(){ return !!session.admin; }
      function hasClaim(tid){ return !!session.claims[tid]; }
      function canEditTeam(){ return isAdmin(); }
      function canEditAvatar(tid){ return isAdmin() || hasClaim(tid); }
      function canEditMatch(m){ return isAdmin() || hasClaim(m.a) || hasClaim(m.b); }
      function teamObj(tid){ for(var i=0;i<state.teams.length;i++){ if(state.teams[i].id===tid) return state.teams[i]; } return null; }
      function teamName(tid){ var t=teamObj(tid); return t?t.name:"‚Äî"; }
      function initials(name){ var s=(name||"").trim(); if(!s) return "?"; var p=s.split(/\s+/); return (p[0][0]+(p[1]?(p[1][0]:""))).toUpperCase(); }
      function avatarHtml(tid,size){ var t=teamObj(tid)||{name:"?"}; var url=t.avatar; var cls=size==='lg'?'avatar-lg':(size==='sm'?'avatar-sm':''); var content=url?('<img src="'+esc(url)+'" alt="avatar">'):'<span class="avatar-initials">'+esc(initials(t.name))+'</span>'; return '<span class="avatar '+cls+'" title="'+esc(t.name)+'">'+content+'</span>'; }

      function identityText(){
        var ids = Object.keys(session.claims||{}); var names=[]; for(var i=0;i<ids.length;i++){ var nm=teamName(ids[i]); if(nm) names.push(nm); }
        if (isAdmin()) return names.length ? ("Admin ¬∑ "+names.join(", ")) : "Admin";
        if (names.length) return names.join(", ");
        return "visiteur";
      }
      function updateWho(){
        var who=id("whoami"); if(who) who.textContent="vous : "+identityText();
        var whoTop=id("whoami-top"); if(whoTop) whoTop.textContent=identityText();
        var addBtn=id("btn-add-team"); if(addBtn) addBtn.style.display=isAdmin()?"inline-block":"none";
      }
      function renderTitle(){
        var name = state.tournamentName && state.tournamentName.trim();
        document.title = (name?name+" ‚Äî ":"") + "TriSports ‚Äî Fl√©chettes ‚Ä¢ Ping-pong ‚Ä¢ Palet";
        var pill=id("tname-top");
        if(pill){ if(name){ pill.style.display="inline-block"; pill.textContent=name; } else { pill.style.display="none"; pill.textContent=""; } }
      }

      /* ---------- Plein √©cran ---------- */
      function fsElement(){ return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement; }
      function enterFS(el){ if(el.requestFullscreen) return el.requestFullscreen(); if(el.webkitRequestFullscreen) return el.webkitRequestFullscreen(); if(el.mozRequestFullScreen) return el.mozRequestFullScreen(); if(el.msRequestFullscreen) return el.msRequestFullscreen(); }
      function exitFS(){ if(document.exitFullscreen) return document.exitFullscreen(); if(document.webkitExitFullscreen) return document.webkitExitFullscreen(); if(document.mozCancelFullScreen) return document.mozCancelFullScreen(); if(document.msExitFullscreen) return document.msExitFullscreen(); }
      function fsSupported(){ var el=document.documentElement; return !!(el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen); }
      function updateFSBtn(){ var b=id("btn-fullscreen"); if(!b) return; b.style.display=fsSupported()?"inline-block":"none"; b.textContent=fsElement()?"Quitter plein √©cran":"‚õ∂ Plein √©cran"; b.title=fsElement()?"Quitter le plein √©cran (Esc)":"Plein √©cran (Esc pour quitter)"; }
      onClick(id("btn-fullscreen"), function(){ fsElement()?exitFS():enterFS(document.documentElement); });
      ["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","MSFullscreenChange"].forEach(function(e){ document.addEventListener(e,updateFSBtn); });
      updateFSBtn();

      /* ---------- Tabs ---------- */
      qsa(".tab").forEach(function(btn){
        btn.addEventListener("click", function(){
          qsa(".tab").forEach(function(b){ b.setAttribute("aria-selected","false"); });
          btn.setAttribute("aria-selected","true");
          qsa("main section").forEach(function(s){ s.classList.remove("active"); });
          id(btn.getAttribute("data-tab")).classList.add("active");
        });
      });
      function goto(tabId){ var b=qs('.tab[data-tab="'+tabId+'"]'); if(b && b.click) b.click(); }

      /* ---------- Admin ---------- */
      function ensureAdmin(){ if(isAdmin()) return true; var pin=prompt("PIN administrateur :"); if(pin==="30041991"){ session.admin=true; saveSession(); return true; } return false; }

      /* ---------- Cr√©er tournoi (non destructif) ---------- */
      onClick(id("btn-create-tournament"), function(){
        if(!ensureAdmin()) return;

        var name = (id("tname-input").value||"").trim() || "Tournoi entre amis";
        var n = parseInt(id("teams-count-input").value,10); if(isNaN(n)) n = 4; n = clampInt(n, 2, 64);

        saveSnapshot(); // garder l‚Äôactuel

        var newState = {
          version: 22,
          tid: uid(),
          cloudId: null,
          tournamentName: name,
          teams: Array.from({length:n}, function(_,i){ return { id:uid(), name:"√âquipe "+(i+1), p1:"", p2:"", avatar:null }; }),
          matches: [],
          locked:false,
          createdAt:new Date().toISOString(),
          protect:{ teamPassHash:{} }
        };

        state = newState;
        normalize();
        leaveCloud();
        saveState({cloud:false});
        saveSnapshot();
        renderAll();
        goto("equipes");
      });

      function renderSetupRecent(){
        var wrap=id("recent-list"); if(!wrap) return;
        wrap.innerHTML="";
        var idx=getIndex().sort(function(a,b){return (b.updatedAt||0)-(a.updatedAt||0);});
        if(!idx.length){ wrap.appendChild(help("Aucun tournoi m√©moris√© pour l‚Äôinstant.")); return; }
        var box=document.createElement("div"); box.style.display="flex"; box.style.flexWrap="wrap"; box.style.gap="8px";
        idx.forEach(function(e){
          var btn=document.createElement("button"); btn.className="btn"; btn.type="button";
          btn.textContent = (e.type==="cloud"?"‚òÅ ":"") + e.name;
          btn.addEventListener("click", function(){
            if(e.type==="cloud" && e.id.indexOf("cloud:")===0){
              var code=e.id.slice(6);
              id("join-code").value=code;
              joinCloud(code);
              goto("equipes");
              return;
            }
            var ok=loadSnapshot(e.id);
            if(!ok){ alert("Impossible d‚Äôouvrir ce tournoi (donn√©es manquantes)."); return; }
            session.claims={}; saveSession();
            renderAll(); goto("equipes");
          });
          box.appendChild(btn);
        });
        wrap.appendChild(box);
      }

      /* ---------- Cloud ‚Äì Rejoindre / Publier ---------- */
      onClick(id("btn-join-code"), function(){ var code=(id("join-code").value||"").trim(); if(!code){ alert("Renseigne un code."); return; } joinCloud(code); goto("equipes"); });
      onClick(id("btn-copy-link"), function(){
        var code=(id("join-code").value||"").trim(); if(!code){ alert("Renseigne un code."); return; }
        var url=location.origin+location.pathname+"?id="+encodeURIComponent(code);
        if(navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(url);
        alert("Lien copi√© !\n"+url);
      });

      /* ---------- √âquipes ---------- */
      var teamListEl=id("team-list");
      onClick(id("btn-add-team"), function(){
        if(!isAdmin()){ alert("R√©serv√© √† l‚Äôadmin."); return; }
        if(state.locked){ alert("Calendrier fig√©."); return; }
        state.teams.push({ id:uid(), name:"√âquipe "+(state.teams.length+1), p1:"", p2:"", avatar:null });
        saveState(); renderTeams(); updateCounts(); updateLockUI();
      });

      onClick(id("btn-generate"), function(){
        if(!isAdmin()){ alert("Seul l‚Äôadmin peut g√©n√©rer."); return; }
        if(state.locked) return;
        generateSchedule(); state.locked=true; saveState(); renderAll(); goto("calendrier");
      });

      function renderTeams(){
        teamListEl.innerHTML="";
        if(!Array.isArray(state.teams) || state.teams.length===0){
          teamListEl.appendChild(help("Aucune √©quipe. Utilisez ¬´ Tournoi ¬ª > Nouveau tournoi."));
          updateCounts(); updateLockUI(); return;
        }
        state.teams.forEach(function(t,idx){
          var iOwn=hasClaim(t.id), admin=isAdmin();
          var hasHash=!!(state.protect && state.protect.teamPassHash && state.protect.teamPassHash[t.id]);
          var dis = (!canEditTeam(t.id))?' disabled':'';
          var delBtn = (admin && !state.locked)? '<button type="button" class="btn small danger" data-act="del" data-id="'+t.id+'">Supprimer</button>' : '';
          var protectInfo = hasHash ? (iOwn? 'üîí vous √™tes connect√© √† cette √©quipe' : 'üîí prot√©g√©e par mot de passe') : 'üîì non prot√©g√©e ‚Äî demandez √† l‚Äôadmin de d√©finir un mot de passe';
          var protectBtns = (admin ? '<button type="button" class="btn small" data-act="setpass" data-id="'+t.id+'">D√©finir / changer mot de passe</button>' : '')
                           + (!iOwn ? '<button type="button" class="btn small" data-act="login" data-id="'+t.id+'">Se connecter √† cette √©quipe</button>'
                                    : '<button type="button" class="btn small" data-act="logout" data-id="'+t.id+'">Se d√©connecter</button>');
          var canAvatar = canEditAvatar(t.id);
          var avatarBtn = canAvatar ? '<button type="button" class="btn small" data-act="avatar" data-id="'+t.id+'">Changer avatar</button>' : '';
          var avatarClr = (canAvatar && t.avatar) ? '<button type="button" class="btn small" data-act="avatar-clear" data-id="'+t.id+'">Retirer avatar</button>' : '';

          var card=document.createElement("div"); card.className="match-card";
          card.innerHTML=''
            +'<div class="hd" style="border:none;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">'
            +'<div class="teams" style="width:100%"><span class="chip">#'+(idx+1)+'</span> '
            +'<span class="team-name">'+avatarHtml(t.id,'lg')+'<input type="text"'+dis+' value="'+esc(t.name)+'" data-field="name" data-id="'+t.id+'" style="min-width:0;flex:1"/></span></div>'
            +'<div>'+delBtn+'</div></div>'
            +'<div class="bd">'
            +'<input type="file" accept="image/*" data-avatar="'+t.id+'" style="display:none" />'
            +'<div class="grid cols-2">'
            +'<div><label>Joueur¬∑se 1</label><input type="text"'+dis+' value="'+esc(t.p1)+'" data-field="p1" data-id="'+t.id+'"/></div>'
            +'<div><label>Joueur¬∑se 2</label><input type="text"'+dis+' value="'+esc(t.p2)+'" data-field="p2" data-id="'+t.id+'"/></div>'
            +'</div>'
            +'<div class="help" style="margin-top:6px">'+protectInfo+'</div>'
            +'<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">'+avatarBtn+avatarClr+protectBtns+'</div>'
            +'</div>';
          teamListEl.appendChild(card);
        });

        // √âdition non bloquante
        qsa('#team-list input[data-field]').forEach(function(inp){
          var tid=inp.getAttribute("data-id"), f=inp.getAttribute("data-field");
          inp.addEventListener("input", function(){
            if(!canEditTeam(tid)) return;
            var t=teamObj(tid); if(!t) return;
            t[f]=inp.value; saveState({cloud:false});
          });
          inp.addEventListener("blur", function(){
            if(!canEditTeam(tid)) return;
            var t=teamObj(tid); if(!t) return;
            t[f]=inp.value; saveState(); renderTeams(); renderMatches(); renderLeaderboard(); renderH2H();
          });
        });

        // actions
        qsa('#team-list [data-act="del"]').forEach(function(btn){
          btn.addEventListener("click", function(){
            if(!isAdmin()||state.locked) return;
            var tid=btn.getAttribute("data-id");
            if(!confirm("Supprimer cette √©quipe ?")) return;
            state.teams=state.teams.filter(function(tt){return tt.id!==tid;});
            state.matches=state.matches.filter(function(m){return m.a!==tid&&m.b!==tid;});
            if(state.protect && state.protect.teamPassHash) delete state.protect.teamPassHash[tid];
            if(session.claims && session.claims[tid]){ delete session.claims[tid]; saveSession(); }
            saveState(); renderTeams(); renderMatches(); renderLeaderboard(); renderH2H(); updateCounts();
          });
        });

        qsa('#team-list [data-act="setpass"]').forEach(function(btn){
          btn.addEventListener("click", function(){
            if(!isAdmin()) { alert("R√©serv√© √† l‚Äôadmin."); return; }
            var tid=btn.getAttribute("data-id");
            var pass=prompt("Mot de passe pour l‚Äô√©quipe ¬´ "+teamName(tid)+" ¬ª :"); if(!pass) return;
            sha256(salt()+"|"+pass).then(function(hash){
              state.protect=state.protect||{teamPassHash:{}};
              state.protect.teamPassHash[tid]=hash; saveState(); renderTeams(); alert("Mot de passe d√©fini.");
            });
          });
        });

        qsa('#team-list [data-act="login"]').forEach(function(btn){
          btn.addEventListener("click", function(){
            var tid=btn.getAttribute("data-id");
            var hasHash=!!(state.protect && state.protect.teamPassHash && state.protect.teamPassHash[tid]);
            if(!hasHash){ alert("Cette √©quipe n‚Äôa pas encore de mot de passe."); return; }
            var pass=prompt("Mot de passe de l‚Äô√©quipe ¬´ "+teamName(tid)+" ¬ª :"); if(!pass) return;
            sha256(salt()+"|"+pass).then(function(h){
              var ok=(h===state.protect.teamPassHash[tid]);
              if(ok){ session.claims[tid]=true; saveSession(); renderTeams(); renderMatches(); renderLeaderboard(); renderH2H(); alert("Connexion r√©ussie."); }
              else alert("Mot de passe incorrect.");
            });
          });
        });
        qsa('#team-list [data-act="logout"]').forEach(function(btn){
          btn.addEventListener("click", function(){ var tid=btn.getAttribute("data-id"); delete session.claims[tid]; saveSession(); renderTeams(); renderMatches(); renderLeaderboard(); renderH2H(); });
        });

        // avatar
        qsa('#team-list [data-act="avatar"]').forEach(function(btn){
          btn.addEventListener("click", function(){
            var tid=btn.getAttribute("data-id"); if(!canEditAvatar(tid)){ alert("Acc√®s refus√©."); return; }
            var input = qs('[data-avatar="'+tid+'"]'); if(input && input.click) input.click();
          });
        });
        qsa('#team-list [data-act="avatar-clear"]').forEach(function(btn){
          btn.addEventListener("click", function(){
            var tid=btn.getAttribute("data-id"); if(!canEditAvatar(tid)) return;
            var t=teamObj(tid); if(!t) return; t.avatar=null; saveState(); renderTeams(); renderMatches(); renderLeaderboard(); renderH2H();
          });
        });
        qsa('#team-list input[type="file"][data-avatar]').forEach(function(inp){
          inp.addEventListener("change", function(){
            var tid=inp.getAttribute("data-avatar"); if(!canEditAvatar(tid)) return;
            var file=inp.files && inp.files[0]; if(!file) return;
            fileToSquareDataURL(file,160).then(function(url){
              var t=teamObj(tid); if(!t) return; t.avatar=url; saveState(); renderTeams(); renderMatches(); renderLeaderboard(); renderH2H();
            }).catch(function(){ alert("√âchec du chargement de l‚Äôavatar."); }).finally(function(){ inp.value=""; });
          });
        });

        updateCounts(); updateLockUI();
      }

      function fileToSquareDataURL(file, size){
        return new Promise(function(resolve,reject){
          var reader=new FileReader();
          reader.onerror=function(){ reject(new Error("read")); };
          reader.onload=function(){
            var img=new Image();
            img.onload=function(){
              try{
                var min=Math.min(img.width,img.height), sx=(img.width-min)/2, sy=(img.height-min)/2;
                var c=document.createElement("canvas"); c.width=size; c.height=size;
                c.getContext('2d').drawImage(img, sx, sy, min, min, 0, 0, size, size);
                resolve(c.toDataURL('image/jpeg',0.9));
              }catch(e){ reject(e); }
            };
            img.onerror=function(){ reject(new Error("img")); };
            img.src=reader.result;
          };
          reader.readAsDataURL(file);
        });
      }

      function updateCounts(){
        var el1=id("teams-count"); if(el1) el1.textContent = state.teams.length + " " + (state.teams.length>1?"√©quipes":"√©quipe");
        var perTeam=Math.max(0,state.teams.length-1); var el2=id("rounds-count"); if(el2) el2.textContent = perTeam + " " + (perTeam>1?"matchs":"match") + " par √©quipe";
      }
      function updateLockUI(){
        var pill=id("lock-pill"); if(pill) pill.style.display=state.locked?"inline-block":"none";
        var gen=id("btn-generate"); if(gen){ gen.disabled=!!state.locked; gen.textContent=state.locked?"Calendrier fig√©":"G√©n√©rer le calendrier"; }
      }

      /* ---------- Calendrier homog√®ne ---------- */
      function generateSchedule(){
        var ids=state.teams.map(function(t){return t.id;});
        if(ids.length<2){ state.matches=[]; saveState(); renderMatches(); return; }
        var BYE="__BYE__"; if(ids.length%2===1) ids.push(BYE);
        var fixed=ids[0], rest=ids.slice(1);
        for(var i=rest.length-1;i>0;i++){ var j=Math.floor(Math.random()*(i+1)); var tmp=rest[i]; rest[i]=rest[j]; rest[j]=tmp; }
        var n=ids.length, rounds=n-1; var out=[]; var order=0;
        for(var r=0;r<rounds;r++){
          var arr=[fixed].concat(rest), half=n/2, pairs=[];
          for(var k=0;k<half;k++){ var a=arr[k], b=arr[n-1-k]; if(a!==BYE&&b!==BYE) pairs.push((r%2===0)?[a,b]:[b,a]); }
          rest.unshift(rest.pop());
          if(pairs.length>1){ var shift=r%pairs.length; while(shift-->0){ pairs.unshift(pairs.pop()); } }
          for(var pi=0;pi<pairs.length;pi++){ var pr=pairs[pi];
            out.push({ id:uid(), a:pr[0], b:pr[1], darts:[null,null,null], pingPts:[{a:null,b:null},{a:null,b:null},{a:null,b:null}], palet:{a:null,b:null}, round:r+1, order:order++ });
          }
        }
        out.sort(function(x,y){ return (x.round-y.round)||(x.order-y.order); });
        state.matches=out; saveState(); renderMatches();
      }

      function getPingPts(m){ return Array.isArray(m.pingPts)?m.pingPts:[{a:null,b:null},{a:null,b:null},{a:null,b:null}]; }
      function isPingValid(a,b){ if(a==null||b==null) return false; if(isNaN(a)||isNaN(b)) return false; var max=Math.max(a,b), diff=Math.abs(a-b); return (max>=11)&&(diff>=2); }
      function computeSetWins(m){
        var darts=Array.isArray(m.darts)?m.darts:[null,null,null];
        var sets=getPingPts(m);
        var aw={darts:0,ping:0}, bw={darts:0,ping:0};
        darts.forEach(function(v){ if(v===0) aw.darts++; else if(v===1) bw.darts++; });
        sets.forEach(function(s){ var a=(typeof s.a==='number')?s.a:null, b=(typeof s.b==='number')?s.b:null; if(isPingValid(a,b)){ if(a>b) aw.ping++; else if(b>a) bw.ping++; } });
        return {aw:aw, bw:bw};
      }
      function isMatchComplete(m){
        var okD=(Array.isArray(m.darts)?m.darts:[null,null,null]).every(function(v){return v===0||v===1;});
        var okP=getPingPts(m).every(function(s){return isPingValid(s.a,s.b);});
        var pa=m.palet.a, pb=m.palet.b;
        var okL=(pa!=null&&pb!=null)&&((pa===11&&pb>=0&&pb<=10)||(pb===11&&pa>=0&&pa<=10));
        return okD&&okP&&okL;
      }

      /* ---------- Rencontres ---------- */
      var matchListEl=id("match-list"), statsMatchesEl=id("stats-matches");
      function renderMatches(){
        matchListEl.innerHTML="";
        if(!Array.isArray(state.matches) || state.matches.length===0){ matchListEl.appendChild(help("Aucune rencontre planifi√©e.")); statsMatchesEl.textContent="0 / 0 matches complets"; return; }
        var groups={}; state.matches.forEach(function(m){ (groups[m.round]=groups[m.round]||[]).push(m); });
        var rounds=Object.keys(groups).map(function(k){return +k;}).sort(function(a,b){return a-b;});
        var complete=0, idx=0;
        rounds.forEach(function(r){
          var hdr=help("Journ√©e "+r); hdr.style.fontWeight="600"; hdr.style.margin="8px 0"; matchListEl.appendChild(hdr);
          groups[r].forEach(function(m){
            var wins=computeSetWins(m), pal=m.palet, palScore=(pal.a!=null&&pal.b!=null)?(pal.a+"‚Äì"+pal.b):"‚Äî";
            var done=isMatchComplete(m); if(done) complete++;
            var can=canEditMatch(m);
            var el=document.createElement("div"); el.className="match-card"; el.dataset.id=m.id;
            var isOpen=(typeof ui.open[m.id]==="boolean")?ui.open[m.id]:false;
            el.setAttribute("aria-expanded", isOpen?"true":"false");

            el.innerHTML=''
              +'<div class="hd" data-expand style="border:none;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">'
              +'<div class="teams"><span class="chip">#'+(++idx)+'</span> '
              +'<span class="team-name">'+avatarHtml(m.a,'sm')+esc(teamName(m.a))+'</span> <span class="muted">vs</span> '
              +'<span class="team-name">'+avatarHtml(m.b,'sm')+esc(teamName(m.b))+'</span></div>'
              +'<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">'
              +'<span class="chip">Journ√©e '+(m.round||"?")+'</span>'
              +'<span class="chip">Fl√©chettes G: '+wins.aw.darts+'-'+wins.bw.darts+'</span>'
              +'<span class="chip">Ping G: '+wins.aw.ping+'-'+wins.bw.ping+'</span>'
              +'<span class="chip">Palet: '+palScore+'</span>'
              +(done?'<span class="pill" style="border-color:#2c6;color:#8fd">‚úÖ Complet</span>':'<span class="pill" style="border-color:#aa6;color:#ffc">‚è≥ Incomplet</span>')
              +'<span class="chip">‚ñ∂</span></div></div>'
              +'<div class="bd">'+renderDarts(m,can)+renderPing(m,can)+renderPalet(m,can)
              +'<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:8px">'
              +'<div class="help">'+(can?'':'Lecture seule ‚Äî connectez-vous √† une des deux √©quipes.')+'</div>'
              +'<div>'+(can?'<button type="button" class="btn small" data-clear="'+m.id+'">Effacer ce match</button>':'')+'</div></div></div>';

            var head=el.querySelector("[data-expand]"); if(head) head.addEventListener("click", function(){
              var open=el.getAttribute("aria-expanded")==="true";
              el.setAttribute("aria-expanded", open?"false":"true");
              ui.open[m.id]=!open;
            });

            // fl√©chettes
            qsaIn(el,'select[data-match][data-kind]').forEach(function(sel){
              if(!can) sel.disabled=true;
              sel.addEventListener("change", function(){
                if(!can) return;
                var k=sel.getAttribute("data-kind"), ii=parseInt(sel.getAttribute("data-index"),10);
                var v=sel.value===""?null:parseInt(sel.value,10);
                var mm=findMatch(m.id); mm[k][ii]=v; saveState(); renderLeaderboard(); renderH2H();
              });
            });

            // ping
            qsaIn(el,'input[data-ping]').forEach(function(inp){
              if(!can) inp.disabled=true;
              inp.addEventListener("input", function(){
                if(!can) return;
                var w=inp.getAttribute("data-ping"), ii=parseInt(inp.getAttribute("data-index"),10);
                var v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,99);
                var mm=findMatch(m.id); mm.pingPts[ii][w]=v; saveState(); renderLeaderboard(); renderH2H();
              });
              inp.addEventListener("keydown", function(e){ if(e.key==="Enter"){ e.preventDefault(); inp.blur(); } });
            });

            // palet
            qsaIn(el,'input[data-palet]').forEach(function(inp){
              if(!can) inp.disabled=true;
              inp.addEventListener("input", function(){
                if(!can) return;
                var w=inp.getAttribute("data-palet");
                var v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,11);
                var mm=findMatch(m.id); mm.palet[w]=v; saveState(); renderLeaderboard(); renderH2H();
              });
              inp.addEventListener("keydown", function(e){ if(e.key==="Enter"){ e.preventDefault(); inp.blur(); } });
            });

            var clr=el.querySelector("[data-clear]"); if(clr) clr.addEventListener("click", function(){ if(!can) return; clearMatch(m.id); renderLeaderboard(); renderH2H(); });

            matchListEl.appendChild(el);
          });
        });
        statsMatchesEl.textContent=complete+" / "+state.matches.length+" matches complets";
        renderLeaderboard();
      }

      function renderDarts(m,can){
        var subs=["Simple 1","Simple 2","Double"], names=[teamName(m.a),teamName(m.b)];
        var html=""; for(var i=0;i<3;i++){
          var v=m.darts[i];
          html+='<div class="grid cols-3" style="align-items:end"><div>'
            +'<label>Fl√©chettes ‚Äî '+subs[i]+'</label>'
            +'<select '+(can?'':'disabled ')+'data-match="'+m.id+'" data-kind="darts" data-index="'+i+'">'
            +'<option value="" '+(v===null?'selected':'')+'>Non jou√©</option>'
            +'<option value="0" '+(v===0?'selected':'')+'>Victoire '+esc(names[0])+'</option>'
            +'<option value="1" '+(v===1?'selected':'')+'>Victoire '+esc(names[1])+'</option>'
            +'</select></div><div></div><div></div></div>';
        }
        return html;
      }
      function renderPing(m,can){
        var labels=["Simple 1","Simple 2","Double"], sets=getPingPts(m); var html="";
        for(var i=0;i<3;i++){
          var s=sets[i]||{a:null,b:null}, note=(s.a==null||s.b==null)?'Saisissez deux scores (11+ et √©cart ‚â• 2).':(isPingValid(s.a,s.b)?'‚úîÔ∏è Score valide':'‚ö†Ô∏è 11+ et √©cart ‚â• 2 (11‚Äì9, 12‚Äì10‚Ä¶).');
          html+='<div class="grid cols-4" style="align-items:end;margin-top:6px">'
            +'<div><label>Ping ‚Äî '+labels[i]+' ‚Äî '+esc(teamName(m.a))+'</label><input '+(can?'':'disabled ')+'type="number" min="0" max="99" step="1" value="'+(s.a==null?'':s.a)+'" data-ping="a" data-index="'+i+'"/></div>'
            +'<div><label>Ping ‚Äî '+labels[i]+' ‚Äî '+esc(teamName(m.b))+'</label><input '+(can?'':'disabled ')+'type="number" min="0" max="99" step="1" value="'+(s.b==null?'':s.b)+'" data-ping="b" data-index="'+i+'"/></div>'
            +'<div class="help">'+note+'</div><div></div></div>';
        }
        return html;
      }
      function renderPalet(m,can){
        var a=m.palet.a, b=m.palet.b, note=(a==null||b==null)?'Saisissez les deux scores (l‚Äôun doit √™tre 11).':((a===11&&b>=0&&b<=10)||(b===11&&a>=0&&a<=10)?'‚úîÔ∏è Score valide':'‚ö†Ô∏è Un score doit √™tre 11, l‚Äôautre entre 0 et 10.');
        return '<div class="grid cols-4" style="align-items:end;margin-top:6px">'
          +'<div><label>Palet ‚Äî '+esc(teamName(m.a))+'</label><input '+(can?'':'disabled ')+'type="number" min="0" max="11" step="1" value="'+(a==null?'':a)+'" data-palet="a"/></div>'
          +'<div><label>Palet ‚Äî '+esc(teamName(m.b))+'</label><input '+(can?'':'disabled ')+'type="number" min="0" max="11" step="1" value="'+(b==null?'':b)+'" data-palet="b"/></div>'
          +'<div class="help">'+note+'</div><div></div></div>';
      }

      function findMatch(idv){ for(var i=0;i<state.matches.length;i++){ if(state.matches[i].id===idv) return state.matches[i]; } return null; }
      function clearMatch(idv){ var m=findMatch(idv); if(!m||!canEditMatch(m)) return; if(!confirm("Effacer tous les scores de ce match ?")) return; m.darts=[null,null,null]; m.pingPts=[{a:null,b:null},{a:null,b:null},{a:null,b:null}]; m.palet={a:null,b:null}; saveState(); renderMatches(); }

      /* ---------- Classement ---------- */
      function computeLeaderboard(){
        var stats={}; state.teams.forEach(function(t){ stats[t.id]={teamId:t.id,name:t.name,avatar:t.avatar||null,points:0,dartsW:0,pingW:0,palFor:0,palAg:0,matchesComplete:0}; });
        state.matches.forEach(function(m){
          var A=stats[m.a], B=stats[m.b];
          (Array.isArray(m.darts)?m.darts:[]).forEach(function(v){ if(v===0){A.dartsW++;A.points+=5;} else if(v===1){B.dartsW++;B.points+=5;} });
          getPingPts(m).forEach(function(s){ if(isPingValid(s.a,s.b)){ if(s.a>s.b){A.pingW++;A.points+=5;} else if(s.b>s.a){B.pingW++;B.points+=5;} } });
          var pa=m.palet.a, pb=m.palet.b; if(pa!=null&&pb!=null){ A.palFor+=pa; B.palFor+=pb; A.palAg+=pb; B.palAg+=pa; A.points+=pa; B.points+=pb; }
          if(isMatchComplete(m)){ A.matchesComplete++; B.matchesComplete++; }
        });
        var rows=Object.keys(stats).map(function(k){return stats[k];});
        rows.sort(function(x,y){
          var d=y.points-x.points;
          if(d) return d;
          d=(y.palFor-y.palAg)-(x.palFor-x.palAg); if(d) return d;
          d=(y.dartsW+y.pingW)-(x.dartsW+x.pingW); if(d) return d;
          return x.name.localeCompare(y.name);
        });
        rows.forEach(function(r,i){ r.rank=i+1; });
        return rows;
      }
      function renderLeaderboard(){
        var tbody=qs("#table-classement tbody"); if(!tbody) return; tbody.innerHTML="";
        computeLeaderboard().forEach(function(r){
          var diff=r.palFor-r.palAg; var tr=document.createElement("tr");
          tr.innerHTML='<td>'+r.rank+'</td>'
            +'<td><span class="team-name">'+(r.avatar?('<span class="avatar avatar-lg"><img src="'+esc(r.avatar)+'" alt="avatar"></span>'):( '<span class="avatar avatar-lg"><span class="avatar-initials">'+esc(initials(r.name))+'</span></span>' ))+' '+esc(r.name)+'</span></td>'
            +'<td><b>'+r.points+'</b></td><td>'+r.dartsW+'</td><td>'+r.pingW+'</td>'
            +'<td>'+r.palFor+'‚Äì'+r.palAg+' <span class="muted">('+(diff>=0?'+':'')+diff+')</span></td>'
            +'<td>'+r.matchesComplete+'</td>';
          tbody.appendChild(tr);
        });
      }

      /* ---------- H2H ---------- */
      function pointsForTeamInMatch(m,teamId){
        var isA=m.a===teamId, isB=m.b===teamId; if(!isA&&!isB) return 0;
        var pts=0; (Array.isArray(m.darts)?m.darts:[]).forEach(function(v){ if(v===0&&isA) pts+=5; else if(v===1&&isB) pts+=5; });
        getPingPts(m).forEach(function(s){ if(isPingValid(s.a,s.b)){ if(s.a>s.b&&isA) pts+=5; else if(s.b>s.a&&isB) pts+=5; } });
        if(m.palet && m.palet.a!=null && m.palet.b!=null) pts += isA? m.palet.a : m.palet.b;
        return pts;
      }
      function renderH2H(){
        var thead=qs("#table-h2h thead"), tbody=qs("#table-h2h tbody"); if(!thead||!tbody) return;
        thead.innerHTML=""; tbody.innerHTML="";
        var teams=state.teams.slice(); if(!teams.length){ tbody.appendChild(help("Ajoutez des √©quipes pour voir la matrice.")); return; }
        var trH=document.createElement("tr"); trH.appendChild(document.createElement("th")).textContent="√âquipe";
        teams.forEach(function(t){ var th=document.createElement("th"); th.innerHTML='<span class="team-name">'+avatarHtml(t.id,'sm')+esc(t.name)+'</span>'; trH.appendChild(th); });
        thead.appendChild(trH);
        var byPair={}; state.matches.forEach(function(m){ byPair[[m.a,m.b].sort().join("|")]=m; });
        teams.forEach(function(ti){
          var tr=document.createElement("tr"); var th=document.createElement("th"); th.innerHTML='<span class="team-name">'+avatarHtml(ti.id,'sm')+esc(ti.name)+'</span>'; tr.appendChild(th);
          teams.forEach(function(tj){
            var td=document.createElement("td");
            if(ti.id===tj.id){ td.textContent="‚Äî"; tr.appendChild(td); return; }
            var m=byPair[[ti.id,tj.id].sort().join("|")];
            if(!m){ td.innerHTML='<span class="chip">‚Äî</span>'; tr.appendChild(td); return; }
            var pI=pointsForTeamInMatch(m,ti.id), pJ=pointsForTeamInMatch(m,tj.id);
            if(pI===0 && pJ===0){ td.innerHTML='<span class="chip">‚Ä¢</span>'; }
            else{ var tag=(pI>pJ)?'W':(pI<pJ)?'L':'='; td.innerHTML='<span class="chip">'+tag+' '+pI+'‚Äì'+pJ+'</span>'; }
            td.style.cursor="pointer"; td.dataset.matchId=m.id; tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        tbody.addEventListener("click", function(e){
          var n=e.target; while(n && n!==tbody && !(n.tagName==="TD" && n.dataset.matchId)) n=n.parentNode;
          if(!n||n===tbody) return; goToMatch(n.dataset.matchId);
        });
      }
      function goToMatch(mid){ goto("calendrier"); ui.open[mid]=true; setTimeout(function(){ var card=qs('.match-card[data-id="'+mid+'"]'); if(card){ card.setAttribute("aria-expanded","true"); try{ card.scrollIntoView({behavior:"smooth",block:"start"}); }catch(e){ card.scrollIntoView(); } } },0); }

      /* ---------- Export / Import / Reset / Admin / Cloud ---------- */
      onClick(id("btn-export"), function(){ var data=JSON.stringify(state,null,2); var url=URL.createObjectURL(new Blob([data],{type:"application/json"})); var a=document.createElement("a"); a.href=url; a.download="tournoi-"+(state.tournamentName||"TriSports").replace(/\s+/g,'_')+".json"; a.click(); URL.revokeObjectURL(url); });
      var importFile=null; var fileImport=id("file-import"); if(fileImport) fileImport.addEventListener("change", function(e){ importFile=e.target.files[0]; });
      onClick(id("btn-import"), function(){ if(!importFile){ alert("S√©lectionnez un fichier JSON."); return; } importFile.text().then(function(t){ try{ var data=JSON.parse(t); if(!(data && Array.isArray(data.teams) && Array.isArray(data.matches))) throw 0; state=data; normalize(); saveState(); saveSnapshot(); renderAll(); alert("Import r√©ussi !"); }catch(e){ alert("Fichier invalide."); } }); });

      onClick(id("btn-admin-on"), function(){ var pin=prompt("PIN administrateur :"); if(pin==="30041991"){ session.admin=true; saveSession(); renderAll(); alert("Mode administrateur activ√©."); } else alert("PIN incorrect."); });
      onClick(id("btn-admin-off"), function(){ session.admin=false; saveSession(); renderAll(); });

      onClick(id("btn-publish-cloud"), publishCurrentToCloud);
      onClick(id("btn-cloud-copy"), function(){
        if(!cloud.id){ alert("Ce tournoi n‚Äôest pas publi√©. Utilise ¬´ Publier & partager ¬ª d‚Äôabord."); return; }
        var url=location.origin+location.pathname+"?id="+encodeURIComponent(cloud.id);
        if(navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(url);
        alert("Lien copi√© !\n"+url);
      });
      onClick(id("btn-cloud-leave"), function(){
        if(!cloud.enabled){ alert("Pas connect√© au cloud."); return; }
        if(!confirm("Quitter le cloud pour ce tournoi ? Les donn√©es restent en local.")) return;
        leaveCloud(); state.cloudId=null; saveState(); alert("Ce tournoi reste local. Vous pourrez le republier plus tard.");
      });

      onClick(id("btn-reset"), function(){
        var pin=prompt("PIN administrateur :"); if(pin!=="30041991"){ alert("PIN incorrect."); return; }
        if(!confirm("R√©-initialiser totalement ?")) return;
        state={version:22,tid:uid(),cloudId:null,tournamentName:"",teams:[],matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}}};
        normalize(); session={admin:false,claims:{}}; saveSession(); saveState(); saveSnapshot(); renderAll(); goto("setup");
      });
      onClick(id("btn-unlock"), function(){ if(!isAdmin()){ alert("R√©serv√© √† l‚Äôadmin."); return; } if(!confirm("D√©verrouiller le calendrier ?")) return; state.locked=false; saveState(); renderTeams(); renderMatches(); updateLockUI(); });

      /* ---------- Boutons utilitaires ---------- */
      onClick(id("btn-refresh-standings"), function(){ renderLeaderboard(); renderH2H(); });
      onClick(id("btn-refresh-standings-2"), function(){ renderLeaderboard(); renderH2H(); goto("classement"); });
      onClick(id("btn-toggle-h2h"), function(){
        var v1=id("view-summary"), v2=id("view-h2h");
        if(!v1||!v2) return;
        var showH2H = v2.style.display==="none";
        v1.style.display = showH2H ? "none":"block";
        v2.style.display = showH2H ? "block":"none";
      });
      onClick(id("btn-collapse"), function(){ qsa('#match-list .match-card').forEach(function(c){ c.setAttribute('aria-expanded','false'); }); ui.open={}; });

      /* ---------- Helpers ---------- */
      function onClick(el,fn){ if(el && el.addEventListener) el.addEventListener("click",fn); }
      function saveState(opts){
        saveRuntime();
        saveSnapshot();
        renderTitle(); renderLeaderboard(); renderH2H();
        if(cloud.enabled && !(opts && opts.cloud===false)) pushCloud(false);
        renderSetupRecent();
      }

      /* ---------- Init ---------- */
      loadSession();
      renderAll();
      function renderAll(){
        renderTitle(); renderSetupRecent();
        if(!state.teams.length) goto("setup");
        renderTeams(); renderMatches(); renderLeaderboard(); renderH2H(); updateCounts(); updateLockUI(); updateWho();
        setCloud(cloud.enabled?("connect√©"+(cloud.id?(" ("+cloud.id+")"):"")):"hors ligne");
      }
    });
  })();
  </script>
</body>
</html>
