<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TriSports ‚Äî Fl√©chettes ‚Ä¢ Ping-pong ‚Ä¢ Palet</title>

<!-- Garde-fou : certaines extensions injectent du React minifi√© qui loggue "Minified React error #...".
     On √©vite que √ßa remonte et perturbe l'app (√ßa n'affecte PAS ton site). -->
<script>
  window.addEventListener('error', function (e) {
    const msg = (e.message || '') + '';
    if (msg.includes('Minified React error #')) {
      e.stopImmediatePropagation?.();
      return false;
    }
  }, true);

function ensureParamWrapper(){
  const fields = id('capitaine-fields'); if(!fields) return null;
  let wrap = id('cap-params');
  if(!wrap){
    wrap = document.createElement('div');
    wrap.id = 'cap-params';
    wrap.className = 'bonus-params';
    fields.parentNode.insertBefore(wrap, fields);
    wrap.appendChild(fields);
  }
  return wrap;
}
  return wrap;
}
function ensureTaupeWrapper(){
  const fields = id('taupe-fields'); if(!fields) return null;
  let wrap = id('taupe-params');
  if(!wrap){
    wrap = document.createElement('div');
    wrap.id = 'taupe-params';
    wrap.className = 'bonus-params';
    fields.parentNode.insertBefore(wrap, fields);
    wrap.appendChild(fields);
  }
  return wrap;
}
  return wrap;
}
function ensureLeftHandWrapper(){
  const fields = id('lefthand-fields'); if(!fields) return null;
  let wrap = id('lefthand-params');
  if(!wrap){
    wrap = document.createElement('div');
    wrap.id = 'lefthand-params';
    wrap.className = 'bonus-params';
    fields.parentNode.insertBefore(wrap, fields);
    wrap.appendChild(fields);
  }
  return wrap;
}
  return wrap;
}
function setParamsOpen(openCap, openTaupe, openLeft){
  const wC = ensureParamWrapper(); if (wC){ wC.style.maxHeight = openCap ? (wC.scrollHeight+'px') : '0px'; }
  const wT = ensureTaupeWrapper(); if (wT){ wT.style.maxHeight = openTaupe ? (wT.scrollHeight+'px') : '0px'; }
  const wL = ensureLeftHandWrapper(); if (wL){ wL.style.maxHeight = openLeft ? (wL.scrollHeight+'px') : '0px'; }
}
function selectBonusType(t){
  window._bonusType = (t==='miroir'||t==='taupe'||t==='lefthand') ? t : 'capitaine';
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  const cap=cards[0], mir=cards[1], tau=cards[2], leftc=cards[3];
  [cap,mir,tau,leftc].forEach(c=>c&&c.classList.remove('selected'));
  if(cap && window._bonusType==='capitaine') cap.classList.add('selected');
  if(mir && window._bonusType==='miroir') mir.classList.add('selected');
  if(tau && window._bonusType==='taupe') tau.classList.add('selected');
  if(leftc && window._bonusType==='lefthand') leftc.classList.add('selected');
  const ctx=id('bonus-context');
  if(ctx) ctx.textContent = window._bonusType==='miroir' ?
    "Miroir : inverse le bonus adverse sur tout le match." :
    (window._bonusType==='taupe' ? "Ren√© la taupe : choisissez le sport." :
      (window._bonusType==='lefthand' ? "10 pouces 2 mains gauche : choisissez le sport." :
        "Capitaine : aucun r√©glage. +2/manche gagn√©e ; +2 si palet."));
  setParamsOpen(window._bonusType==='capitaine', window._bonusType==='taupe', window._bonusType==='lefthand');
}
function prepareBonusOptions(){
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  cards.forEach((c, i)=>{
    c.classList.add('selectable'); c.tabIndex=0; c.setAttribute('role','button');
    c.addEventListener('click', ()=>selectBonusType(i===0?'capitaine':(i===1?'miroir':(i===2?'taupe':'lefthand'))));
    c.addEventListener('keydown', ev=>{
      if(ev.key===' '||ev.key==='Enter'){ ev.preventDefault(); selectBonusType(i===0?'capitaine':(i===1?'miroir':(i===2?'taupe':'lefthand'))); }
    });
  });
  const cap=cards[0], tau=cards[2], leftc=cards[3];
  const wC=ensureParamWrapper(); if(cap && wC && wC.previousElementSibling!==cap) cap.appendChild(wC);
  const wT=ensureTaupeWrapper(); if(tau && wT && wT.previousElementSibling!==tau) tau.appendChild(wT);
  const wL=ensureLeftHandWrapper(); if(leftc && wL && wL.previousElementSibling!==leftc) leftc.appendChild(wL);
  // Init state
  selectBonusType(window._bonusType || 'capitaine');
}

function ensure(obj, key, defFactory){
  if(!obj[key]) obj[key] = defFactory();
  return obj[key];
}

const id=x=>document.getElementById(x), qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const esc=s=>(s==null?"":String(s)).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","\"":"&quot;","'":"&#39;"}[c]));
const uid=()=>Math.random().toString(36).slice(2,10);
const clampInt=(v,min,max)=>{v=parseInt(v,10);if(isNaN(v))return null;return Math.max(min,Math.min(max,v));}
const help=t=>{const d=document.createElement("div");d.className="help";d.textContent=t;return d;}
function hashPass(s){s=(s||"").trim();let h=0x811c9dc5>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,0x01000193)>>>0}return("00000000"+h.toString(16)).slice(-8)}
const hy=(a,b)=>`${a}\u2011${b}`;
const BONUS_VAL=5;

/* ===== Erreurs visibles ===== */
window.onerror=(msg,src,line,col)=>{const el=id("storage-warning");if(el){el.style.display="block";el.textContent="Erreur JS : "+msg+" @"+(src||"")+":"+(line||0)+":"+(col||0)} const p=id("js-ok");if(p){p.textContent='JS charg√© avec erreurs ‚ö†Ô∏è';p.style.background='#8a2a2a'}};

/* ===== Index Cloud (local) ===== */
const STORAGE_KEY="trisports_cloud_only_v1"; const IDX_KEY="trisports_cloud_index_v1";
function getIndex(){try{return JSON.parse(localStorage.getItem(IDX_KEY)||"[]")}catch(_){return[]}}
function setIndex(a){try{localStorage.setItem(IDX_KEY,JSON.stringify(a||[]))}catch(_){}}
function upsertIndex(e){const i=getIndex();const k=i.findIndex(x=>x.id===e.id);if(k>=0)i[k]=Object.assign({},i[k],e);else i.unshift(e);setIndex(i)}
function nameExistsLocally(n){n=(n||"").trim().toLowerCase();if(!n)return false;return getIndex().some(e=>(e.name||"").trim().toLowerCase()===n)}
function codeExistsLocally(c){return getIndex().some(e=>e.id===c)}
function renderSetupRecent(){const wrap=id("recent-list");wrap.innerHTML="";const idx=getIndex().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));if(!idx.length){wrap.appendChild(help("Aucun tournoi cloud list√© pour l‚Äôinstant."));return}const box=document.createElement("div");box.style.display="flex";box.style.flexWrap="wrap";box.style.gap="8px";idx.forEach(e=>{const btn=document.createElement("button");btn.className="btn";btn.type="button";btn.textContent="‚òÅ "+e.name+" ("+e.id+")";btn.dataset.openId="cloud:"+e.id;const del=document.createElement("button");del.className="btn danger";del.type="button";del.textContent="Supprimer du cloud";del.dataset.deleteId=e.id;const w=document.createElement("div");w.style.display="flex";w.style.gap="6px";w.append(btn,del);box.appendChild(w)});wrap.appendChild(box)}
function renderManageList(){renderSetupRecent()}

/* ===== √âtat ===== */
let state={version:40,tid:uid(),cloudId:null,tournamentName:"",rules:{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11},teams:[],matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};
let ui={open:{},h2h:false}; let session={admin:false,claims:{}};
function isAdmin(){return !!session.admin} function hasClaim(tid){return !!session.claims[tid]}
// === Droits de saisie des scores selon l'√©tat de la journ√©e ===
function _iAmTeamOf(m){ return hasClaim(m.a) || hasClaim(m.b); }
function canEditScores(m, rCtl){
  if (!rCtl.started && !rCtl.finished) return false; // pas commenc√© -> personne
  if (rCtl.finished) return isAdmin();               // termin√© -> admin seul
  return isAdmin() || _iAmTeamOf(m);                 // en cours -> admin + √©quipe du match
}

function teamObj(tid){return state.teams.find(t=>t.id===tid)||null} function teamName(tid){const t=teamObj(tid);return t?t.name:"‚Äî"}
function initials(name){const s=(name||"").trim();if(!s)return"?";const p=s.split(/\s+/);return(p[0][0]+(p[1]?.[0]||"")).toUpperCase()}
function avatarHtml(tid,size,attrs){const t=teamObj(tid)||{name:"?"};const url=t.avatar;const cls=size==='lg'?'avatar-lg':(size==='sm'?'avatar-sm':'');const extra=attrs?(' '+attrs):'';const content=url?('<img src="'+esc(url)+'" alt="avatar">'):('<span class="avatar-initials">'+esc(initials(t.name))+'</span>');return '<span class="avatar '+cls+'" title="'+esc(t.name)+'"'+extra+'>'+content+'</span>'}
function updateWho(){const names=Object.keys(session.claims||{}).map(teamName).filter(Boolean);const who=isAdmin()?(names.length?("Admin ¬∑ "+names.join(", ")):"Admin"):(names[0]||"visiteur");id("whoami").textContent="vous : "+who;id("whoami-top").textContent=who;const s=id("whoami-setup");if(s)s.textContent=who;const b=id("btn-add-team");if(b)b.style.display=isAdmin()?"inline-block":"none";const ba=id("btn-admin-on-setup");if(ba)ba.style.display=isAdmin()?"none":"inline-block"}
function renderTitle(){const name=(state.tournamentName||"").trim();document.title=(name?name+" ‚Äî ":"")+"TriSports ‚Äî Fl√©chettes ‚Ä¢ Ping-pong ‚Ä¢ Palet";const pill=id("tname-top");if(name){pill.style.display="inline-block";pill.textContent=name}else{pill.style.display="none";pill.textContent=""}}
function dartsTotal(){return (state.rules?.dartsSingles||0)+(state.rules?.dartsDoubles||0)}
function pingTotal(){return (state.rules?.pingSingles||0)+(state.rules?.pingDoubles||0)}
function ensureLengths(m){const dN=dartsTotal(),pN=pingTotal();m.darts=Array.isArray(m.darts)?m.darts.slice(0,dN):[];while(m.darts.length<dN)m.darts.push(null);if(!Array.isArray(m.pingPts))m.pingPts=[];m.pingPts=m.pingPts.slice(0,pN);while(m.pingPts.length<pN)m.pingPts.push({a:null,b:null});}
function _normMatch(m){m=m||{};m.id=m.id||uid();m.a=m.a||"";m.b=m.b||"";ensureLengths(m);m.palet=m.palet||{a:null,b:null};m.palet.a=(m.palet.a==null?null:+m.palet.a);m.palet.b=(m.palet.b==null?null:+m.palet.b);m.round=m.round||1;m.order=m.order||0;return m}
function normalize(){state.rules=state.rules||{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11};state.teams=Array.isArray(state.teams)?state.teams:[];state.matches=Array.isArray(state.matches)?state.matches.map(_normMatch):[];state.protect=state.protect||{};state.protect.teamPassHash=state.protect.teamPassHash||{};state.roundCtl=state.roundCtl||{};state.bonusSelections=state.bonusSelections||{};state.bonusApplied=state.bonusApplied||{};state.bonusUsed=state.bonusUsed||{};state.bonusUsed=state.bonusUsed||{}}

/* ===== Firebase ===== */
const cloud={enabled:false,db:null,id:null,ref:null,timer:null}; const hasFB=!!(window.firebase&&window.FIREBASE_CONFIG&&window.FIREBASE_CONFIG.apiKey);
function initFB(){try{if(!hasFB)return null;if(!firebase.apps||firebase.apps.length===0)firebase.initializeApp(window.FIREBASE_CONFIG);return firebase.database()}catch(_){return null}}
function setCloudTxt(t){id("cloud-status").textContent=t;id("cloud-status-2").textContent=t}
function unsubscribeCloud(){try{if(cloud.ref)cloud.ref.off('value')}catch(_){ }cloud.ref=null;cloud.enabled=false;cloud.id=null;setCloudTxt('hors ligne')}
function resetState(){state={version:40,tid:uid(),cloudId:null,tournamentName:"",rules:{dartsSingles:2,dartsDoubles:1,dartsWinPoints:5,pingSingles:2,pingDoubles:1,pingWinPoints:5,paletTarget:11},teams:[],matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};try{localStorage.removeItem(STORAGE_KEY)}catch(_){}} 
function joinCloud(code){if(!hasFB){alert("Firebase non configur√©.");return}if(!cloud.db){cloud.db=initFB();if(!cloud.db){alert("Init Firebase impossible.");return}}unsubscribeCloud();cloud.id=(code||"").trim();if(!cloud.id){alert("Saisis un code tournoi.");return}cloud.ref=cloud.db.ref("tournaments/"+cloud.id+"/payload");cloud.enabled=true;setCloudTxt("connexion");cloud.ref.on("value",snap=>{const val=snap.val();if(!val){setCloudTxt("connect√© (vide)");return}safeSetStateFromCloud(val);normalize();state.cloudId=cloud.id;localStorage.setItem(STORAGE_KEY,JSON.stringify(state));upsertIndex({id:cloud.id,name:state.tournamentName||"Sans titre",updatedAt:Date.now()});renderAll();setCloudTxt("connect√© ("+cloud.id+")")});try{history.replaceState(null,"",location.pathname+"?id="+encodeURIComponent(cloud.id))}catch(_){}}

function safeSetStateFromCloud(val){
  try{
    if(!val || typeof val!=="object" || !val.state || typeof val.state!=="object"){
      // pas d'√©tat valide c√¥t√© cloud : on laisse l'√©tat local tel quel
      return;
    }
    state = val.state;
  }catch(_){ /* on ignore, on garde l'√©tat local */ }
}

function pushCloud(immediate){if(!cloud.enabled||!cloud.ref)return;clearTimeout(cloud.timer);cloud.timer=setTimeout(()=>cloud.ref.set({state,updatedAt:Date.now()}),immediate?0:250)}
function deleteCloud(code){if(!cloud.db){cloud.db=initFB()}return cloud.db.ref("tournaments/"+code).remove()}
function saveState(){normalize();localStorage.setItem(STORAGE_KEY,JSON.stringify(state));upsertIndex({id:state.cloudId||cloud.id||"?",name:state.tournamentName||"Sans titre",updatedAt:Date.now()});renderTitle();renderSetupRecent();renderManageList();if(cloud.enabled)pushCloud()}

/* Plein √©cran */
document.addEventListener("fullscreenchange",()=>{const b=id("btn-fullscreen");if(!b)return;b.textContent=document.fullscreenElement?"Quitter plein √©cran":"‚õ∂ Plein √©cran"});

/* ===== Calendrier ===== */
function generateSchedule(){const ids=state.teams.map(t=>t.id);if(ids.length<2){state.matches=[];saveState();renderMatches();return}const BYE="__BYE__";if(ids.length%2===1)ids.push(BYE);const fixed=ids[0],rest=ids.slice(1);for(let i=rest.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[rest[i],rest[j]]=[rest[j],rest[i]]}const n=ids.length,rounds=n-1;const out=[];let order=0;for(let r=0;r<rounds;r++){const arr=[fixed].concat(rest),half=n/2,pairs=[];for(let k=0;k<half;k++){const a=arr[k],b=arr[n-1-k];if(a!==BYE&&b!==BYE)pairs.push((r%2===0)?[a,b]:[b,a])}rest.unshift(rest.pop());if(pairs.length>1){let shift=r%pairs.length;while(shift-->0)pairs.unshift(pairs.pop())}for(const pr of pairs){out.push(_normMatch({id:uid(),a:pr[0],b:pr[1],darts:Array(dartsTotal()).fill(null),pingPts:Array(pingTotal()).fill({a:null,b:null}),palet:{a:null,b:null},round:r+1,order:order++}))}}out.sort((x,y)=>(x.round-y.round)||(x.order-y.order));state.matches=out;ui.open={};state.roundCtl={};state.bonusSelections={};state.bonusApplied={};saveState();renderMatches()}
function renderTeams(){const el=id("team-list");el.innerHTML="";if(!state.teams.length){el.appendChild(help("Aucune √©quipe. Utilisez l‚Äôonglet ¬´ Tournoi ¬ª pour cr√©er/rejoindre un tournoi cloud."));updateCounts();updateLock();return}state.teams.forEach((t,idx)=>{const iOwn=hasClaim(t.id),admin=isAdmin(),hasHash=!!(state.protect?.teamPassHash?.[t.id]);const dis=admin?'':' disabled';const delBtn=(admin&&!state.locked)?`<button type="button" class="btn small danger" data-act="del" data-id="${t.id}">Supprimer</button>`:'';const protectInfo=hasHash?(iOwn?'üîí vous √™tes connect√© √† cette √©quipe':'üîí prot√©g√©e par mot de passe'):'üîì non prot√©g√©e ‚Äî demandez √† l‚Äôadmin de d√©finir un mot de passe';const protectBtns=(admin?`<button type="button" class="btn small" data-act="setpass" data-id="${t.id}">D√©finir / changer mot de passe</button>`:'')+(!iOwn?`<button type="button" class="btn small" data-act="login" data-id="${t.id}">Se connecter √† cette √©quipe</button>`:`<button type="button" class="btn small" data-act="logout" data-id="${t.id}">Se d√©connecter</button>`);const avatarBtn=(admin||iOwn)?`<button type="button" class="btn small" data-act="avatar" data-id="${t.id}">Changer avatar</button>`:'';const avatarClr=((admin||iOwn)&&t.avatar)?`<button type="button" class="btn small" data-act="avatar-clear" data-id="${t.id}">Retirer avatar</button>`:'';const card=document.createElement("div");card.className="match-card";card.setAttribute("aria-expanded","true");card.innerHTML=`<div class="hd team-header" style="border:none;border-bottom:1px solid var(--border)"><div class="teams"><span class="chip">#${idx+1}</span><span class="team-name">${avatarHtml(t.id,'lg','data-click-avatar="'+t.id+'"')}<input type="text"${dis} value="${esc(t.name)}" data-field="name" data-id="${t.id}"/></span></div></div><div class="bd"><input type="file" accept="image/*" data-avatar="${t.id}" style="display:none"/><div class="grid cols-2"><div><label>Joueur¬∑se 1</label><input type="text"${dis} value="${esc(t.p1)}" data-field="p1" data-id="${t.id}"/></div><div><label>Joueur¬∑se 2</label><input type="text"${dis} value="${esc(t.p2)}" data-field="p2" data-id="${t.id}"/></div></div><div class="help" style="margin-top:6px">${protectInfo}</div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${avatarBtn}${avatarClr}${protectBtns}</div><div style="display:flex;justify-content:flex-end;margin-top:10px">${delBtn}</div></div>`;el.appendChild(card)});qsa('#team-list input[data-field]').forEach(inp=>{const tid=inp.getAttribute("data-id"),f=inp.getAttribute("data-field");inp.addEventListener("input",()=>{if(!isAdmin())return;const t=teamObj(tid);if(!t)return;t[f]=inp.value;localStorage.setItem(STORAGE_KEY,JSON.stringify(state))});inp.addEventListener("blur",()=>{if(!isAdmin())return;const t=teamObj(tid);if(!t)return;t[f]=inp.value;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()})});qsa('#team-list input[type="file"][data-avatar]').forEach(inp=>{inp.addEventListener("change",async()=>{const tid=inp.getAttribute("data-avatar");if(!(isAdmin()||hasClaim(tid)))return;const file=inp.files?.[0];if(!file)return;try{const url=await fileToSquareDataURL(file,160);const t=teamObj(tid);if(!t)return;t.avatar=url;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}catch{alert("√âchec du chargement de l‚Äôavatar.")}finally{inp.value=""}})});updateCounts();updateLock()}
function fileToSquareDataURL(file,size){return new Promise((resolve,reject)=>{const r=new FileReader();r.onerror=()=>reject(new Error("read"));r.onload=()=>{const img=new Image();img.onload=()=>{try{const m=Math.min(img.width,img.height),sx=(img.width-m)/2,sy=(img.height-m)/2;const c=document.createElement("canvas");c.width=size;c.height=size;c.getContext('2d').drawImage(img,sx,sy,m,m,0,0,size,size);resolve(c.toDataURL('image/jpeg',0.9))}catch(e){reject(e)}};img.onerror=()=>reject(new Error("img"));img.src=r.result};r.readAsDataURL(file)})}
function updateCounts(){id("teams-count").textContent=state.teams.length+" "+(state.teams.length>1?"√©quipes":"√©quipe");const per=Math.max(0,state.teams.length-1);id("rounds-count").textContent=per+" "+(per>1?"matchs":"match")+" par √©quipe"}
function updateLock(){const pill=id("lock-pill");if(pill)pill.style.display=state.locked?"inline-block":"none";const gen=id("btn-generate");if(gen){gen.disabled=!!state.locked;gen.textContent=state.locked?"Calendrier fig√©":"G√©n√©rer le calendrier"}}

/* ===== Rencontres & Scores ===== */
const getPingPts=m=>Array.isArray(m.pingPts)?m.pingPts:Array(pingTotal()).fill({a:null,b:null});
const isPingValid=(a,b)=>{if(a==null||b==null)return false;if(isNaN(a)||isNaN(b))return false;const max=Math.max(a,b),diff=Math.abs(a-b);return(max>=11)&&(diff>=2)}
function computeSetWins(m){ensureLengths(m);const aw={darts:0,ping:0},bw={darts:0,ping:0};m.darts.forEach(v=>{if(v===0)aw.darts++;else if(v===1)bw.darts++});getPingPts(m).forEach(s=>{const a=(s.a==null?null:+s.a),b=(s.b==null?null:+s.b);if(isPingValid(a,b)){if(a>b)aw.ping++;else if(b>a)bw.ping++}});return{aw,bw}}
function isMatchComplete(m){ensureLengths(m);const okD=m.darts.every(v=>v===0||v===1);const okP=getPingPts(m).every(s=>isPingValid(+s.a,+s.b));const T=+state.rules.paletTarget||11,pa=(m.palet?.a==null?null:+m.palet?.a),pb=(m.palet?.b==null?null:+m.palet?.b);const okL=(pa!=null&&pb!=null)&&((pa===T&&pb>=0&&pb<=T-1)||(pb===T&&pa>=0&&pa<=T-1));return okD&&okP&&okL}
const findMatch=mid=>state.matches.find(x=>x.id===mid);
function clearMatch(mid){const m=findMatch(mid);if(!m)return;if(!(isAdmin()||hasClaim(m.a)||hasClaim(m.b)))return;if(!confirm("Effacer tous les scores de ce match ?"))return;m.darts=Array(dartsTotal()).fill(null);m.pingPts=Array(pingTotal()).fill({a:null,b:null});m.palet={a:null,b:null};saveState();renderMatches()}

/* ===== Bonus ===== */
function roundState(r){state.roundCtl[r]=state.roundCtl[r]||{started:false,finished:false};return state.roundCtl[r]}
function setBonusSelection(r,tid,sel){state.bonusSelections[r]=state.bonusSelections[r]||{};state.bonusSelections[r][tid]=sel}
function getBonusSelection(r,tid){return(state.bonusSelections[r]||{})[tid]||null}
function setBonusApplied(r,tid,pts){state.bonusApplied[r]=state.bonusApplied[r]||{};state.bonusApplied[r][tid]=pts}
function getBonusAppliedSum(tid){let s=0;for(const r in state.bonusApplied){const v=state.bonusApplied[r]?.[tid];if(v)s+=v}return s}
function teamBonusUsed(tid){const t=teamObj(tid);return !!(t&&t.bonusCapitaineUsed)}function markTeamBonusUsed(tid){const t=teamObj(tid);if(t)t.bonusCapitaineUsed=true}

/* Capitaine ‚Äî calcul robuste */
/* Capitaine ‚Äî calcul teamwide (+2/manche gagn√©e) */
function computeCapitaineBonusForMatch(m, tid, _player, _sport){
  try{
    let wins = 0;
    const isA = (m.a === tid), isB = (m.b === tid);
    if(!isA && !isB) return 0;

    // Fl√©chettes : chaque manche (0 = A gagne, 1 = B gagne)
    (m.darts || []).forEach(v=>{
      if(v===0 && isA) wins++;
      else if(v===1 && isB) wins++;
    });

    // Ping : chaque set valid√©
    const sets = (typeof getPingPts==='function') ? getPingPts(m)
                 : (Array.isArray(m.pingPts) ? m.pingPts : []);
    sets.forEach(s=>{
      const a = s?.a, b = s?.b;
      const valid = a!=null && b!=null && a!=='' && b!=='' && isFinite(+a) && isFinite(+b);
      if(!valid) return;
      if(+a > +b && isA) wins++;
      else if(+b > +a && isB) wins++;
    });

    // Palet : victoire du match
    const T  = +(state?.rules?.paletTarget ?? 11);
    const pa = (m.palet && m.palet.a!=null) ? +m.palet.a : null;
    const pb = (m.palet && m.palet.b!=null) ? +m.palet.b : null;
    if(pa!=null && pb!=null){
      if(pa>=T && pa>pb && isA) wins++;
      else if(pb>=T && pb>pa && isB) wins++;
    }

    return 2 * wins;
  }catch(_){ return 0; }
} else {
        gain += BONUS_VAL;
      }
    });
  } else if (sport === 'ping') {
    const sSingles = state.rules.pingSingles || 0;
    getPingPts(m).forEach((s,i)=>{
      const a = (s.a==null?null:+s.a);
      const b = (s.b==null?null:+s.b);
      if (!isPingValid(a,b)) return;
      const won = isA ? (a>b) : (b>a);
      if (!won) return;
      if (i < sSingles) {
        const which = (i===0 ? 'p1' : 'p2');
        if (which === player) gain += BONUS_VAL;
      } else {
        gain += BONUS_VAL;
      }
    });
  } else if (sport === 'palet') {
    const T = +state.rules.paletTarget || 11;
    const a = (m.palet?.a==null?null:+m.palet.a);
    const b = (m.palet?.b==null?null:+m.palet.b);
    if ((isA && a===T) || (isB && b===T)) gain += BONUS_VAL;
  }
  return gain;
}

/* Ic√¥nes pour titres de sport */
function sportIcon(name){
  if(name==='darts'){ return `<span class="sport-icon" role="img" aria-label="fl√©chettes">üéØ</span>`; }
  if(name==='ping'){  return `<span class="sport-icon" role="img" aria-label="ping-pong">üèì</span>`; }
  return `<span class="sport-icon" role="img" aria-label="palet">ü•è</span>`;
}

/* ===== Rendu Rencontres ===== */
let CURRENT_ROUND=null;
function setRoundStatusPillClasses(pill,rs){
  pill.classList.remove('red','yellow','green');
  if(rs.finished) pill.classList.add('green');
  else if(rs.started) pill.classList.add('yellow');
  else pill.classList.add('red');
}
function bonusChip(r,mTeam,rs){
  const sel = getBonusSelection(r, mTeam);
  const iAmTeam = hasClaim(mTeam);
  const roundFinished = !!rs.finished;

  // Admin : ne voit rien avant la fin de journ√©e
  if (isAdmin() && !roundFinished) return '';

  // Rien choisi ‚Üí afficher un bouton uniquement pour l'√©quipe concern√©e, avant le d√©but.
  const canChoose = (!rs.started && !rs.finished && !(state.bonusUsed?.[r]?.[mTeam]) && iAmTeam);
  if (!sel) {
    return canChoose ? `<button type="button" class="bonus-btn" data-bonus data-team="${mTeam}">üéñ Bonus</button>` : '';
  }

  // D√©j√† choisi : avant fin, visible UNIQUEMENT pour l'√©quipe concern√©e
  if (!roundFinished && !iAmTeam) return '';

  // Affichage
  if (!roundFinished) {
    // Secret: pilule "Capitaine" + mini image
    const __lbl = sel.type==='miroir'?'Miroir':(sel.type==='taupe'?'Ren√© la taupe':(sel.type==='lefthand'?'10 pouces 2 mains gauche':'Capitaine')); const __img = sel.type==='miroir'?'miroir.jpg':(sel.type==='taupe'?'taupe.png':(sel.type==='lefthand'?'main gauche.png':'capitaine.jpg')); return `<span class="pill blue">${lblType} : +${applied}<span class="mini-bonus"><img src="img/${img}" alt=""></span></span>`;
  } else {
    // R√©v√©l√© √† tout le monde
    const labelPlayer = sel.player === 'p1' ? 'J1' : 'J2';
    const labelSport = sel.sport === 'darts' ? 'Fl√©chettes' : (sel.sport === 'ping' ? 'Ping' : 'Palet');
    const applied = (state.bonusApplied?.[r]?.[mTeam]) || 0; const type = sel.type || 'capitaine'; const lblType = type==='miroir' ? 'Miroir' : (type==='taupe' ? 'Ren√© la taupe' : (type==='lefthand' ? 'Main gauche' : 'Capitaine')); const img = type==='miroir' ? 'miroir.jpg' : (type==='taupe' ? 'taupe.png' : (type==='lefthand' ? 'main gauche.png' : 'capitaine.jpg')); return `<span class="pill blue">${lblType} : +${applied}<span class="mini-bonus"><img src="img/${img}" alt=""></span></span>`;
  }
}


function renderMatches(){
  const list=id("match-list");list.innerHTML="";
  if(!state.matches.length){list.appendChild(help("Aucune rencontre planifi√©e."));id("stats-matches").textContent="0 / 0 matches complets";id("round-status").textContent="‚Äî";id("btn-start-round").style.display="none";id("btn-end-round").style.display="none";return}
  const groups={};state.matches.forEach(m=>(groups[m.round]=groups[m.round]||[]).push(m));
  const rounds=Object.keys(groups).map(Number).sort((a,b)=>a-b);
  CURRENT_ROUND = rounds.find(r=>!roundState(r).finished) ?? rounds[rounds.length-1];
  const rs=roundState(CURRENT_ROUND);
  const roundPill=id("round-status");
  roundPill.textContent=`Journ√©e active : #${CURRENT_ROUND} ‚Äî ${rs.finished?'Termin√©e':(rs.started?'En cours':'Pr√©paration')}`;
  roundPill.classList.remove('red','yellow','green');
  setRoundStatusPillClasses(roundPill,rs);
  id("btn-start-round").style.display=(isAdmin()&&!rs.started&&!rs.finished)?'inline-block':'none';
  id("btn-end-round").style.display  =(isAdmin()&& rs.started&&!rs.finished)?'inline-block':'none';

  let complete=0, idx=0;
  rounds.forEach(r=>{
    const hdr=help("Journ√©e "+r);hdr.style.fontWeight="600";hdr.style.margin="8px 0";list.appendChild(hdr);
    const rCtl=roundState(r);
    const badgeClass = rCtl.finished ? 'green' : (rCtl.started ? 'yellow' : 'red');

    groups[r].forEach(m=>{
      ensureLengths(m);
      const wins=computeSetWins(m),pal=m.palet,palScore=(pal.a!=null&&pal.b!=null)?hy(pal.a,pal.b):"‚Äî";
      const palChip = `<span class="chip">ü•è Palet: <span class="score-compact">${palScore}</span></span>`;
      const done=isMatchComplete(m);if(done)complete++;
      const el=document.createElement("div");el.className="match-card";el.dataset.id=m.id;const isOpen=!!ui.open[m.id];el.setAttribute("aria-expanded",isOpen?"true":"false");
      const bonusA=bonusChip(r,m.a,rCtl), bonusB=bonusChip(r,m.b,rCtl);
      el.innerHTML=`<div class="hd" data-expand style="border:none;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
        <div class="teams"><span class="chip round-chip ${badgeClass}">#${++idx}</span>
          <span class="team-name">${avatarHtml(m.a,'sm')}${esc(teamName(m.a))}</span> <span class="vs">vs</span>
          <span class="team-name">${avatarHtml(m.b,'sm')}${esc(teamName(m.b))}</span></div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <span class="chip">üéØ Fl√©chettes: <span class="score-compact">${hy(wins.aw.darts,wins.bw.darts)}</span></span>
          <span class="chip">üèì Ping: <span class="score-compact">${hy(wins.aw.ping,wins.bw.ping)}</span></span>
          ${palChip}
          ${done?'<span class="pill green">‚úÖ Complet</span>':'<span class="pill yellow">‚è≥ Incomplet</span>'}
          ${bonusA} ${bonusB}
          <span class="chip">‚ñ∂</span>
        </div></div>
        <div class="bd">
          <div class="match-two-col">
            ${renderDarts(m)}${renderPing(m)}
          </div>
          ${renderPalet(m)}
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:8px">
            <div class="help">La saisie n√©cessite d‚Äô√™tre connect√©¬∑e √† une des deux √©quipes (ou admin).</div>
            <div>${(isAdmin()||hasClaim(m.a)||hasClaim(m.b))?`<button type="button" class="btn small" data-clear="${m.id}">Effacer ce match</button>`:''}</div>
          </div>
        </div>`;
      list.appendChild(el);

      // darts
      qsa('.match-card[data-id="'+m.id+'"] select[data-kind="darts"]').forEach(sel=>{
        const can=(isAdmin()||hasClaim(m.a)||hasClaim(m.b)); sel.disabled=!(can && canEditScores(m,rCtl));
        sel.addEventListener("change",()=>{const i=parseInt(sel.getAttribute("data-index"),10),v=sel.value===""?null:parseInt(sel.value,10);const mm=findMatch(m.id);mm.darts[i]=v;saveState();renderMatches();renderLeaderboard();renderH2H()});
      });
      // ping
      qsa('.match-card[data-id="'+m.id+'"] input[data-ping]').forEach(inp=>{
        const can=(isAdmin()||hasClaim(m.a)||hasClaim(m.b)); inp.disabled=!(can && canEditScores(m,rCtl));
        const mid=m.id,idxSet=parseInt(inp.getAttribute("data-index"),10),which=inp.getAttribute("data-ping");
        const updateNote=()=>{const mm=findMatch(mid),s=mm.pingPts[idxSet],ok=isPingValid(+s.a,+s.b);const note=qs('.match-card[data-id="'+mid+'"] [data-note="ping-'+mid+'-'+idxSet+'"]');if(note)note.textContent=ok?'‚úîÔ∏è Score valide':'Saisissez deux scores (11+ et √©cart ‚â• 2).'}
        inp.addEventListener("input",()=>{const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,99);const mm=findMatch(mid);mm.pingPts[idxSet][which]=v;saveState();updateNote()});
        const commit=()=>{const mm=findMatch(mid);const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,99);mm.pingPts[idxSet][which]=v;saveState();renderMatches();renderLeaderboard();renderH2H()};
        inp.addEventListener("change",commit);inp.addEventListener("blur",commit);inp.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();inp.blur()}})
      });
      // palet
      qsa('.match-card[data-id="'+m.id+'"] input[data-palet]').forEach(inp=>{
        const can=(isAdmin()||hasClaim(m.a)||hasClaim(m.b)); inp.disabled=!(can && canEditScores(m,rCtl));
        const mid=m.id,which=inp.getAttribute("data-palet");
        const updateNote=()=>{const mm=findMatch(mid),T=+state.rules.paletTarget||11,a=(mm.palet?.a==null?null:+mm.palet?.a),b=(mm.palet?.b==null?null:+mm.palet?.b);const ok=(a!=null&&b!=null)&&((a===T&&b>=0&&b<=T-1)||(b===T&&a>=0&&a<=T-1));const note=qs('.match-card[data-id="'+mid+'"] [data-note="pal-'+mid+'"]');if(note)note.textContent=ok?'‚úîÔ∏è Score valide':`Saisissez les deux scores (l‚Äôun doit √™tre ${T}).`}
        inp.addEventListener("input",()=>{const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,state.rules.paletTarget||11);const mm=findMatch(mid);mm.palet[which]=v;saveState();updateNote()});
        const commit=()=>{const mm=findMatch(mid);const v=inp.value===""?null:clampInt(parseInt(inp.value,10),0,state.rules.paletTarget||11);mm.palet[which]=v;saveState();renderMatches();renderLeaderboard();renderH2H()};
        inp.addEventListener("change",commit);inp.addEventListener("blur",commit);inp.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();inp.blur()}})
      });

      const clr=qs('.match-card[data-id="'+m.id+'"] [data-clear]');if(clr)clr.addEventListener("click",()=>clearMatch(m.id));
      const head=qs('.match-card[data-id="'+m.id+'"] [data-expand]');if(head)head.addEventListener("click",()=>{const open=el.getAttribute("aria-expanded")==="true";el.setAttribute("aria-expanded",open?"false":"true");ui.open[m.id]=!open});
      qsa('.match-card[data-id="'+m.id+'"] [data-bonus]').forEach(b=>b.addEventListener('click',()=>openBonusModal(r,b.getAttribute('data-team'))));
    });
  });
  id("stats-matches").textContent=complete+" / "+state.matches.length+" matches complets";
  renderLeaderboard();
}

/* ---- Rendu des 3 sports (relook√©s) ---- */
function renderDarts(m){
  const s = state.rules.dartsSingles, N = dartsTotal();
  let html = `<div class="sport-group">
    <div class="sport-title"><span class="sport-icon">${sportIcon('darts')}</span> Fl√©chettes</div>`;
  for(let i=0;i<N;i++){
    const v = m.darts[i];
    const lab = (i < s ? `Simple ${i+1}` : `Double ${i-s+1}`);
    html += `<div class="sport-item">
      <label>${lab}</label>
      <select data-kind="darts" data-index="${i}">
        <option value="" ${v===null?'selected':''}>Non jou√©</option>
        <option value="0" ${v===0?'selected':''}>Victoire ${esc(teamName(m.a))}</option>
        <option value="1" ${v===1?'selected':''}>Victoire ${esc(teamName(m.b))}</option>
      </select>
    </div>`;
  }
  html += `</div>`;
  return html;
}
function renderPing(m){
  const s = state.rules.pingSingles, N = pingTotal();
  let html = `<div class="sport-group">
    <div class="sport-title"><span class="sport-icon">${sportIcon('ping')}</span> Ping-pong</div>`;
  for(let i=0;i<N;i++){
    const set = m.pingPts[i] || {a:null,b:null};
    const lab = (i < s ? `Simple ${i+1}` : `Double ${i-s+1}`);
    const ok = isPingValid(+set.a,+set.b);
    html += `<div class="sport-item">
      <label>${lab}</label>
      <div class="ping-row">
        <div>
          <input type="number" min="0" max="99" step="1"
                 value="${set.a==null?'':set.a}"
                 data-ping="a" data-index="${i}"
                 placeholder="${esc(teamName(m.a))}">
        </div>
        <div>
          <input type="number" min="0" max="99" step="1"
                 value="${set.b==null?'':set.b}"
                 data-ping="b" data-index="${i}"
                 placeholder="${esc(teamName(m.b))}">
        </div>
      </div>
      <div class="help" data-note="ping-${m.id}-${i}">${ok?'‚úîÔ∏è Score valide':'Saisissez deux scores (11+ et √©cart ‚â• 2).'}</div>
    </div>`;
  }
  html += `</div>`;
  return html;
}
function renderPalet(m){
  const T = +state.rules.paletTarget || 11;
  const a = (m.palet?.a==null?null:+m.palet?.a),
        b = (m.palet?.b==null?null:+m.palet?.b);
  const ok = (a!=null&&b!=null)&&((a===T&&b>=0&&b<=T-1)||(b===T&&a>=0&&a<=T-1));
  return `<div class="sport-group" style="margin-top:16px">
    <div class="sport-title"><span class="sport-icon">${sportIcon('palet')}</span> Palet</div>
    <div class="ping-row">
      <div>
        <label class="muted">${esc(teamName(m.a))}</label>
        <input type="number" min="0" max="${T}" step="1"
               value="${a==null?'':a}" data-palet="a">
      </div>
      <div>
        <label class="muted">${esc(teamName(m.b))}</label>
        <input type="number" min="0" max="${T}" step="1"
               value="${b==null?'':b}" data-palet="b">
      </div>
    </div>
    <div class="help" data-note="pal-${m.id}">${ok?'‚úîÔ∏è Score valide':`Saisissez les deux scores (l‚Äôun doit √™tre ${T}).`}</div>
  </div>`;
}

/* ===== Classement ===== */
function baseLeaderboardStats(){const R=state.rules,stats={};state.teams.forEach(t=>stats[t.id]={teamId:t.id,name:t.name,avatar:t.avatar||null,pointsBase:0,bonus:0,malus:0,dartsW:0,pingW:0,palFor:0,palAg:0,matchesComplete:0});state.matches.forEach(m=>{const A=stats[m.a],B=stats[m.b];ensureLengths(m);m.darts.forEach(v=>{if(v===0){A.dartsW++;A.pointsBase+=R.dartsWinPoints}else if(v===1){B.dartsW++;B.pointsBase+=R.dartsWinPoints}});getPingPts(m).forEach(s=>{const a=(s.a==null?null:+s.a),b=(s.b==null?null:+s.b);if(isPingValid(a,b)){if(a>b){A.pingW++;A.pointsBase+=R.pingWinPoints}else if(b>a){B.pingW++;B.pointsBase+=R.pingWinPoints}}});const pa=(m.palet?.a==null?null:+m.palet?.a),pb=(m.palet?.b==null?null:+m.palet?.b);if(pa!=null&&pb!=null){A.palFor+=pa;B.palFor+=pb;A.palAg+=pb;B.palAg+=pa;A.pointsBase+=pa;B.pointsBase+=pb}if(isMatchComplete(m)){A.matchesComplete++;B.matchesComplete++}});Object.keys(state.bonusApplied||{}).forEach(r=>{const per=state.bonusApplied[r];Object.keys(per).forEach(tid=>{const v=per[tid]||0;if(stats[tid])stats[tid].bonus+=v})});return stats}
function computeLeaderboard(){const stats=baseLeaderboardStats();const rows=Object.values(stats).map(x=>({teamId:x.teamId,name:x.name,avatar:x.avatar,points:x.pointsBase+x.bonus-x.malus,bonus:x.bonus,malus:x.malus,dartsW:x.dartsW,pingW:x.pingW,palFor:x.palFor,palAg:x.palAg,matchesComplete:x.matchesComplete}));rows.sort((x,y)=>(y.points-x.points)||((y.palFor-y.palAg)-(x.palFor-x.palAg))||((y.dartsW+y.pingW)-(x.dartsW+x.pingW))||x.name.localeCompare(y.name));rows.forEach((r,i)=>r.rank=i+1);return rows}
function renderLeaderboard(){const tbody=qs("#table-classement tbody");tbody.innerHTML="";computeLeaderboard().forEach(r=>{const diff=r.palFor-r.palAg;const avatar=r.avatar?(`<span class="avatar avatar-lg"><img src="${esc(r.avatar)}" alt="avatar"></span>`):(`<span class="avatar avatar-lg"><span class="avatar-initials">${esc(initials(r.name))}</span></span>`);const tr=document.createElement("tr");tr.innerHTML=`<td>${r.rank}</td><td><span class="team-name">${avatar} ${esc(r.name)}</span></td><td><b>${r.points}</b></td><td>${r.dartsW}</td><td>${r.pingW}</td><td><span class="score-compact">${hy(r.palFor,r.palAg)}</span> <span class="muted">(${diff>=0?'+':''}${diff})</span></td><td>${r.bonus}</td><td>${r.malus||0}</td><td>${r.matchesComplete}</td>`;tbody.appendChild(tr)})}

/* ===== H2H ===== */
function pointsForTeamInMatch(m,tid){const R=state.rules;ensureLengths(m);const isA=m.a===tid,isB=m.b===tid;if(!isA&&!isB)return 0;let pts=0;m.darts.forEach(v=>{if(v===0&&isA)pts+=R.dartsWinPoints;else if(v===1&&isB)pts+=R.dartsWinPoints});getPingPts(m).forEach(s=>{const a=(s.a==null?null:+s.a),b=(s.b==null?null:+s.b);if(isPingValid(a,b)){if(a>b&&isA)pts+=R.pingWinPoints;else if(b>a&&isB)pts+=R.pingWinPoints}});if(m.palet&&m.palet.a!=null&&m.palet.b!=null)pts+=isA?+m.palet.a:+m.palet.b;return pts}
function renderH2H(){const thead=qs("#table-h2h thead"),tbody=qs("#table-h2h tbody");thead.innerHTML="";tbody.innerHTML="";const teams=state.teams.slice();if(!teams.length){tbody.appendChild(help("Ajoutez des √©quipes pour voir la matrice."));return}const trH=document.createElement("tr");trH.appendChild(document.createElement("th")).textContent="√âquipe";teams.forEach(t=>{const th=document.createElement("th");th.innerHTML='<span class="team-name">'+avatarHtml(t.id,'sm')+esc(t.name)+'</span>';trH.appendChild(th)});thead.appendChild(trH);const byPair={};state.matches.forEach(m=>{byPair[[m.a,m.b].sort().join("|")]=m});teams.forEach(ti=>{const tr=document.createElement("tr");const th=document.createElement("th");th.innerHTML='<span class="team-name">'+avatarHtml(ti.id,'sm')+esc(ti.name)+'</span>';tr.appendChild(th);teams.forEach(tj=>{const td=document.createElement("td");if(ti.id===tj.id){td.textContent="‚Äî";tr.appendChild(td);return}const m=byPair[[ti.id,tj.id].sort().join("|")];if(!m){td.innerHTML='<span class="chip">‚Äî</span>';tr.appendChild(td);return}const pI=pointsForTeamInMatch(m,ti.id),pJ=pointsForTeamInMatch(m,tj.id);let cls="h2h-draw",icon="‚â°";if(pI>pJ){cls="h2h-win";icon="‚úî"}else if(pI<pJ){cls="h2h-loss";icon="‚úñ"}td.innerHTML='<span class="h2h-pill '+cls+'">'+icon+' <span class="score-compact">'+hy(pI,pJ)+'</span></span>';td.style.cursor="pointer";td.dataset.matchId=m.id;tr.appendChild(td)});tbody.appendChild(tr)});tbody.addEventListener("click",e=>{let n=e.target;while(n&&n!==tbody&&!(n.tagName==="TD"&&n.dataset.matchId))n=n.parentNode;if(!n||n===tbody)return;goto("calendrier");ui.open[n.dataset.matchId]=true;setTimeout(()=>{const card=qs('.match-card[data-id="'+n.dataset.matchId+'"]');if(card){card.setAttribute("aria-expanded","true");card.scrollIntoView({behavior:"smooth",block:"start"})}},0)})}

/* ===== Tabs & clicks ===== */
function guardTab(t){const no=(!cloud.enabled&&!state.cloudId);return(t==='equipes'||t==='calendrier'||t==='classement'||t==='options')&&(no&&state.teams.length===0)}
function goto(tabId){if(guardTab(tabId)){alert("Aucun tournoi ouvert. Cr√©ez ou rejoignez un code Cloud.");tabId='setup'}qsa(".tab").forEach(b=>b.setAttribute("aria-selected","false"));const b=qs('.tab[data-tab="'+tabId+'"]');if(b)b.setAttribute("aria-selected","true");qsa("main section").forEach(s=>s.classList.remove("active"));id(tabId).classList.add("active")}

document.addEventListener("click",async(e)=>{
  const btn=e.target.closest("button");if(btn){switch(btn.id){
    case "btn-fullscreen":(document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen())?.catch?.(()=>{});break;

    /* --- ADMIN : activation => re-render imm√©diat --- */
    case "btn-admin-on-setup":
    case "btn-admin-on":{const pin=prompt("PIN administrateur :");if(pin==="30041991"){session.admin=true;session.claims={};updateWho();renderAll();alert("Mode administrateur activ√© (d√©connexion des √©quipes sur cet appareil).")}else alert("PIN incorrect.");break}
    case "btn-admin-off":{session.admin=false;updateWho();renderAll();break}

    case "btn-create-tournament":{if(!isAdmin()){const pin=prompt("PIN administrateur :");if(pin!=="30041991")return alert("PIN incorrect.");session.admin=true;session.claims={};updateWho();renderAll()}const code=(id("tcode-input").value||"").trim();if(!code)return alert("Code cloud obligatoire.");const name=(id("tname-input").value||"").trim()||"Tournoi";if(nameExistsLocally(name))return alert("Un tournoi portant ce nom existe d√©j√† dans cette liste.");if(codeExistsLocally(code))return alert("Ce code cloud existe d√©j√† dans votre liste.");const exists=await(async()=>{try{const db=cloud.db||initFB();if(!db)return false;const ref=db.ref("tournaments/"+code+"/payload");const snap=await ref.get?.()??await new Promise(res=>ref.once('value',res));return !!(snap&&snap.exists&&snap.exists())}catch(_){return false}})();if(exists)return alert("Ce code cloud existe d√©j√† sur le serveur. Choisissez-en un autre.");const n=clampInt(id("teams-count-input").value,2,64);const R={dartsSingles:clampInt(id("rule-d-s").value,0,9),dartsDoubles:clampInt(id("rule-d-d").value,0,9),dartsWinPoints:clampInt(id("rule-d-p").value,1,50),pingSingles:clampInt(id("rule-p-s").value,0,9),pingDoubles:clampInt(id("rule-p-d").value,0,9),pingWinPoints:clampInt(id("rule-p-p").value,1,50),paletTarget:clampInt(id("rule-l-target").value,1,50)};joinCloud(code);state={version:40,tid:uid(),cloudId:code,tournamentName:name,rules:R,teams:Array.from({length:n},(_,i)=>({id:uid(),name:"√âquipe "+(i+1),p1:"",p2:"",avatar:null,bonusCapitaineUsed:false})),matches:[],locked:false,createdAt:new Date().toISOString(),protect:{teamPassHash:{}},roundCtl:{},bonusSelections:{},bonusApplied:{}};saveState();pushCloud(true);renderAll();goto("equipes");break}
    case "btn-join-code":{const code=(id("join-code").value||"").trim();if(!code)return alert("Renseigne un code.");joinCloud(code);goto("equipes");break}
    case "btn-copy-link":{const code=(id("join-code").value||id("tcode-input").value||state.cloudId||"").trim();if(!code)return alert("Aucun code.");const url=location.origin+location.pathname+"?id="+encodeURIComponent(code);navigator.clipboard?.writeText(url);alert("Lien copi√© !\n"+url);break}

    case "btn-add-team":{if(!isAdmin())return alert("R√©serv√© √† l‚Äôadmin.");if(state.locked)return alert("Calendrier fig√©.");state.teams.push({id:uid(),name:"√âquipe "+(state.teams.length+1),p1:"",p2:"",avatar:null,bonusCapitaineUsed:false});saveState();renderTeams();break}
    case "btn-generate":{if(!isAdmin())return alert("Seul l‚Äôadmin peut g√©n√©rer.");if(state.locked)return;generateSchedule();state.locked=true;saveState();renderAll();goto("calendrier");break}

    case "btn-refresh-standings":
    case "btn-refresh-standings-2":{renderLeaderboard();renderH2H();if(btn.id==="btn-refresh-standings-2")goto("classement");break}
    case "btn-show-summary":{id("view-summary").style.display="block";id("view-h2h").style.display="none";id("btn-show-summary").setAttribute("aria-pressed","true");id("btn-show-h2h").setAttribute("aria-pressed","false");break}
    case "btn-show-h2h":{id("view-summary").style.display="none";id("view-h2h").style.display="block";id("btn-show-summary").setAttribute("aria-pressed","false");id("btn-show-h2h").setAttribute("aria-pressed","true");break}
    case "btn-collapse":{qsa('#match-list .match-card').forEach(c=>c.setAttribute('aria-expanded','false'));ui.open={};break}

    case "btn-export":{const data=JSON.stringify(state,null,2);const url=URL.createObjectURL(new Blob([data],{type:"application/json"}));const a=document.createElement("a");a.href=url;a.download=("tournoi-"+(state.tournamentName||"TriSports")).replace(/\s+/g,'_')+".json";a.click();URL.revokeObjectURL(url);break}
    case "btn-import":{const f=id("file-import").files?.[0];if(!f)return alert("S√©lectionnez un fichier JSON.");f.text().then(t=>{try{const data=JSON.parse(t);state=data;normalize();saveState();renderAll();alert("Import r√©ussi !")}catch(_){alert("Fichier invalide.")}});break}

    case "btn-cloud-copy":{const code=state.cloudId||cloud.id;if(!code)return alert("Pas de code cloud.");const url=location.origin+location.pathname+"?id="+encodeURIComponent(code);navigator.clipboard?.writeText(url);alert("Lien copi√© !\n"+url);break}
    case "btn-cloud-delete":{if(!isAdmin())return alert("Suppression cloud r√©serv√©e √† l‚Äôadmin.");const code=state.cloudId||cloud.id;if(!code)return alert("Aucun code actif.");if(!confirm("Supprimer d√©finitivement ce tournoi du cloud ?"))return;deleteCloud(code).then(()=>{setIndex(getIndex().filter(e=>e.id!==code));unsubscribeCloud();resetState();renderSetupRecent();renderAll();history.replaceState(null,"",location.pathname);alert("Tournoi supprim√©.");goto('setup')});break}

    /* ---- R√©initialiser scores => r√©initialise aussi BONUS + journ√©es ---- */
    case "btn-reset-scores":{state.bonusSelections={};state.bonusApplied={};state.bonusUsed={};(state.teams||[]).forEach(t=>{if(t)t.bonusCapitaineUsed=false});if(!isAdmin())return alert("R√©serv√© √† l‚Äôadmin.");if(!confirm("R√©initialiser les SCORES et les BONUS ?"))return;state.matches.forEach(m=>{m.darts=Array(dartsTotal()).fill(null);m.pingPts=Array(pingTotal()).fill({a:null,b:null});m.palet={a:null,b:null}});state.roundCtl={};state.bonusSelections={};state.bonusApplied={};state.teams.forEach(t=>t.bonusCapitaineUsed=false);saveState();renderAll();goto("calendrier");break}

    case "btn-unlock":{if(!isAdmin())return alert("R√©serv√© √† l‚Äôadmin.");if(!confirm("D√©verrouiller le calendrier ?"))return;state.locked=false;saveState();renderTeams();renderMatches();updateLock();break}

    case "btn-start-round":{if(!isAdmin())return;const r=CURRENT_ROUND,rs=roundState(r);if(rs.started||rs.finished)return;rs.started=true;saveState();renderMatches();alert("Journ√©e #"+r+" d√©marr√©e. Les bonus sont verrouill√©s.");break}

    /* ---- Fin de journ√©e : blocage si incomplet + bonus appliqu√©s ---- */
    case "btn-end-round": {
      if (!isAdmin()) return;
      const r  = CURRENT_ROUND;
      const rs = roundState(r);
      if (!rs.started || rs.finished) return;

      const matchesOfRound = state.matches.filter(m => m.round === r);
      const incomplets = matchesOfRound.filter(m => !isMatchComplete(m));
      if (incomplets.length) { alert(`Impossible de terminer la journ√©e #${r} : ${incomplets.length} match(s) incomplet(s).`); return; }

      const sels = state.bonusSelections[r] || {};
      Object.keys(sels).forEach(tid=>{
        const sel = sels[tid]; if (!sel) return;
        if ((state.bonusUsed?.[r]?.[tid])) { setBonusApplied(r, tid, 0); return; }
        let total = 0;
        matchesOfRound.forEach(m=>{ total += computeCapitaineBonusForMatch(m, tid, sel.player, sel.sport); });
        setBonusApplied(r, tid, total); state.bonusUsed=state.bonusUsed||{}; state.bonusUsed[r]=state.bonusUsed[r]||{}; state.bonusUsed[r][tid]=true; markTeamBonusUsed(tid);
      });

      rs.finished = true; saveState(); renderMatches(); renderLeaderboard();
      alert(`Journ√©e #${r} termin√©e. Les bonus sont appliqu√©s et r√©v√©l√©s.`); break;
    }
  }}
  const openBtn=e.target.closest("[data-open-id]");if(openBtn){const code=openBtn.getAttribute("data-open-id").replace(/^cloud:/,"");id("join-code").value=code;joinCloud(code);goto("equipes")}
  const delBtn=e.target.closest("[data-delete-id]");if(delBtn){if(!isAdmin())return alert("Suppression cloud r√©serv√©e √† l‚Äôadmin.");const code=delBtn.getAttribute("data-delete-id");if(!confirm("Supprimer le tournoi '"+code+"' du cloud ?"))return;deleteCloud(code).then(()=>{setIndex(getIndex().filter(e=>e.id!==code));if(state.cloudId===code||cloud.id===code){unsubscribeCloud();resetState();renderAll();history.replaceState(null,"",location.pathname);goto('setup')}alert("Supprim√©.");renderSetupRecent()})}
  const av=e.target.closest('.avatar[data-click-avatar]');if(av){const tid=av.getAttribute('data-click-avatar');if(isAdmin()||hasClaim(tid)){const input=document.querySelector('input[type="file"][data-avatar="'+tid+'"]');if(input)input.click()}return}
  const tab=e.target.closest(".tab");if(tab){let t=tab.getAttribute("data-tab");if(guardTab(t))t='setup';qsa(".tab").forEach(b=>b.setAttribute("aria-selected","false"));qs('.tab[data-tab="'+t+'"]').setAttribute("aria-selected","true");qsa("main section").forEach(s=>s.classList.remove("active"));id(t).classList.add("active")}
  const actBtn=e.target.closest("[data-act]");if(actBtn){const act=actBtn.getAttribute("data-act"),tid=actBtn.getAttribute("data-id");if(act==="del"){if(!isAdmin()||state.locked)return;if(!confirm("Supprimer cette √©quipe ?"))return;state.teams=state.teams.filter(tt=>tt.id!==tid);state.matches=state.matches.filter(m=>m.a!==tid&&m.b!==tid);if(state.protect?.teamPassHash)delete state.protect.teamPassHash[tid];saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
    if(act==="setpass"){if(!isAdmin())return alert("R√©serv√© √† l‚Äôadmin.");let pass=prompt("Mot de passe pour l‚Äô√©quipe ¬´ "+teamName(tid)+" ¬ª :");if(pass==null)return;pass=pass.trim();if(!pass)return alert("Mot de passe vide.");state.protect=state.protect||{};state.protect.teamPassHash=state.protect.teamPassHash||{};state.protect.teamPassHash[tid]=hashPass(pass);saveState();renderTeams();alert("Mot de passe d√©fini.")}
    if(act==="login"){const hashes=(state.protect&&state.protect.teamPassHash)?state.protect.teamPassHash:null;if(!hashes||!hashes[tid])return alert("Cette √©quipe n‚Äôa pas encore de mot de passe (demandez √† l‚Äôadmin).");let pass=prompt("Mot de passe de l‚Äô√©quipe ¬´ "+teamName(tid)+" ¬ª :");if(pass==null)return;pass=pass.trim();if(!pass)return alert("Mot de passe vide.");if(hashPass(pass)===hashes[tid]){ session.admin=false; session.claims={}; session.claims[tid]=true; updateWho(); renderAll(); alert("Connexion r√©ussie. Mode admin d√©sactiv√© sur cet appareil."); }
      else alert("Mot de passe incorrect.") }
    if(act==="logout"){session.claims={};updateWho();renderAll()}
    if(act==="avatar"){const input=qs('[data-avatar="'+tid+'"]');if(input)input.click()}
    if(act==="avatar-clear"){const t=teamObj(tid);if(!t)return;t.avatar=null;saveState();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
  }
});

/* ===== Modal bonus ===== */
let bonusCTX={round:null,teamId:null};
function openBonusModal(round,teamId){
  const rCtl=roundState(round);
  if(rCtl.started) return alert("La journ√©e a d√©marr√© : bonus verrouill√©s.");
  if ((state.bonusUsed?.[round]?.[teamId])) return alert("Ce bonus a d√©j√† √©t√© utilis√© une fois.");
  if(!hasClaim(teamId)) return alert("Connectez-vous √† cette √©quipe pour choisir son bonus.");
  bonusCTX.round=round;bonusCTX.teamId=teamId;
  const sel=getBonusSelection(round,teamId);
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine'); }
  if(id('taupe-sport')) id('taupe-sport').value = (sel?.sport||'darts'); if(id('lefthand-sport')) id('lefthand-sport').value = (sel?.sport||'darts');
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine'); }
  if(id('taupe-sport')) id('taupe-sport').value = (sel?.sport||'darts'); if(id('lefthand-sport')) id('lefthand-sport').value = (sel?.sport||'darts');
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine'); }
  if(id('taupe-sport')) id('taupe-sport').value = (sel?.sport||'darts');
  if(id('lefthand-sport')) id('lefthand-sport').value = (sel?.sport||'darts');
  id('bonus-player').value=sel?.player||'p1';
  id('bonus-sport').value=sel?.sport||'darts';
  id('bonus-context').textContent=`√âquipe : ${teamName(teamId)} ‚Äî Journ√©e #${round}`;
  id('bonus-modal').classList.add('show');
}
id('bonus-cancel').addEventListener('click',()=>id('bonus-modal').classList.remove('show'));
id('bonus-save').addEventListener('click', ()=>{
  const r = bonusCTX.round, t = bonusCTX.teamId;
  const type = (window._bonusType==='miroir') ? 'miroir'
              : (window._bonusType==='taupe') ? 'taupe'
              : (window._bonusType==='lefthand') ? 'lefthand' : 'capitaine';

  if(type==='capitaine') setBonusSelection(r, t, { type:'capitaine' });
  else if(type==='taupe') setBonusSelection(r, t, { type:'taupe', sport: id('taupe-sport').value||'darts' });
  else if(type==='lefthand') setBonusSelection(r, t, { type:'lefthand', sport: id('lefthand-sport').value||'darts' });
  else setBonusSelection(r, t, { type:'miroir' });

  id('bonus-modal').classList.remove('show');
  if(typeof renderPills==='function') renderPills();
  if(typeof renderMatches==='function') renderMatches();
});



/* ===== Boot ===== */
function renderAll(){renderTitle();updateWho();renderSetupRecent();renderManageList();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
document.addEventListener("DOMContentLoaded",()=>{ try { renderAll(); } catch(e) {} });</script>

<script>
(function(){
  function withFallback(img, primary, fall1, fall2){
    img.src = primary;
    img.onerror = function(){
      img.onerror = function(){
        img.onerror = function(){
          img.onerror = null;
          img.src = fall2;
        };
        img.src = fall1;
      };
      // try img/ first
      img.src = 'img/' + primary.split('/').pop();
    };
  }
  function ensureBrandImages(){
    var brand = document.querySelector('header .brand') || document.querySelector('.brand');
    if(!brand) return;
    // avoid duplicates
    if(!brand.querySelector('img.brand-logo')){
      var logo = document.createElement('img');
      logo.className = 'brand-logo';
      logo.alt = 'TriSports logo';
      brand.prepend(logo);
      withFallback(logo, 'tripsort/img/logo.png', 'trisport/img/logo.png', 'img/logo.png');
    }
    if(!brand.querySelector('img.brand-title')){
      var title = document.createElement('img');
      title.className = 'brand-title';
      title.alt = 'TriSports';
      // insert after logo
      var ref = brand.querySelector('img.brand-logo');
      if(ref && ref.nextSibling){ brand.insertBefore(title, ref.nextSibling); }
      else { brand.appendChild(title); }
      withFallback(title, 'tripsort/img/titre.png', 'trisport/img/titre.png', 'img/titre.png');
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureBrandImages);
  }else{
    ensureBrandImages();
  }
})();
</script>




</body>
</html>
