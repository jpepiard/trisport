<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TriSports — Fléchettes • Ping-pong • Palet</title>

<!-- Garde-fou : certaines extensions injectent du React minifié qui loggue "Minified React error #...".
     On évite que ça remonte et perturbe l'app (ça n'affecte PAS ton site). -->
<script>
  window.addEventListener('error', function (e) {
    const msg = (e.message || '') + '';
    if (msg.includes('Minified React error #')) {
      e.stopImmediatePropagation?.();
      return false;
    }
  }, true);

function ensureParamWrapper(){
  const fields = id('capitaine-fields'); if(!fields) return null;
  let wrap=id('cap-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='cap-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureTaupeWrapper(){
  const fields = id('taupe-fields'); if(!fields) return null;
  let wrap=id('taupe-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='taupe-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureLeftHandWrapper(){
  const fields = id('lefthand-fields'); if(!fields) return null;
  let wrap=id('lefthand-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='lefthand-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}

function ensureMelonWrapper(){
  const fields = id('melon-fields'); if(!fields) return null;
  let wrap = id('melon-params');
  if(!wrap){
    wrap = document.createElement('div');
    wrap.id = 'melon-params';
    wrap.className = 'bonus-params';
    fields.parentNode.insertBefore(wrap, fields);
    wrap.appendChild(fields);
  }
  return wrap;
}


function setParamsOpen(openCap, openTaupe, openLeft){
  const wC = ensureParamWrapper(); if (wC){ wC.style.maxHeight = openCap ? (wC.scrollHeight+'px') : '0px'; }
  const wT = ensureTaupeWrapper(); if (wT){ wT.style.maxHeight = openTaupe ? (wT.scrollHeight+'px') : '0px'; }
  const wL = ensureLeftHandWrapper(); if (wL){ wL.style.maxHeight = openLeft ? (wL.scrollHeight+'px') : '0px'; }
}
function selectBonusType(t){
  try{
    const norm = (x)=> (x||'').toLowerCase().replace(/[’']/g,"'").trim();
    const wanted = ['capitaine','miroir','taupe','lefthand','melon'].includes(norm(t)) ? norm(t) : 'capitaine';
    window._bonusType = wanted;
    const modal = document.getElementById('bonus-modal') || document;
    const cards = Array.from(modal.querySelectorAll('.bonus-select .bonus-card'));
    const map = {};
    cards.forEach(c=>{
      const title = norm(c.querySelector('.bonus-title')?.textContent||'');
      if(/^capitaine/.test(title)) map['capitaine']=c;
      else if(/^miroir/.test(title)) map['miroir']=c;
      else if(/taupe/.test(title)) map['taupe']=c;
      else if(/10\s*pouces|main\s*gauche|mains?\s*gauche/.test(title)) map['lefthand']=c;
      else if(/melon d'or|melon/.test(title)) map['melon']=c;
    });
    Object.values(map).forEach(c=>c && c.classList.remove('selected'));
    const selCard = map[wanted] || map['capitaine'];
    if(selCard) selCard.classList.add('selected');
    if(typeof openParams==='function') openParams(wanted);
    const ctx=document.getElementById('bonus-context');
    if(ctx){
      ctx.textContent = wanted==='miroir' ? "Miroir : inverse le bonus adverse sur tout le match."
                   : wanted==='taupe' ? "René la taupe : choisissez le sport."
                   : wanted==='lefthand' ? "10 pouces 2 mains gauche : choisissez le sport."
                   : wanted==='melon' ? "Melon d’or : choisissez le sport et le sous‑match."
                   : "Capitaine : choisissez le joueur et le sport.";
    }
    if(typeof setParamsOpen==='function'){
      setParamsOpen(wanted==='capitaine', wanted==='taupe', wanted==='lefthand');
      const mel = document.getElementById('melon-params'); if(mel) mel.style.display = (wanted==='melon')?'block':'none';
    }
  }catch(e){ console.error('selectBonusType error', e); }
}

window.prepareBonusOptions = function(){
    try{
      const cards = byQS('.bonus-select .bonus-card');
      cards.forEach((c,i)=>{
        if(!c.classList.contains('selectable')){
          c.classList.add('selectable'); c.tabIndex=0; c.setAttribute('role','button');
          const sel = ()=> window.selectBonusType(i===0?'capitaine':(i===1?'miroir':(i===2?'taupe':(i===3?'lefthand':'melon'))));
          c.addEventListener('click', sel);
          c.addEventListener('keydown', ev=>{ if(ev.key===' '||ev.key==='Enter'){ ev.preventDefault(); sel(); } });
        }
      });
      const cap=cards[0], tau=cards[2], leftc=cards[3], mel=cards[4];
      const wC = (typeof ensureParamWrapper==='function') ? ensureParamWrapper() : null; if(cap && wC && wC.previousElementSibling!==cap) cap.appendChild(wC);
      const wT = (typeof ensureTaupeWrapper==='function') ? ensureTaupeWrapper() : null; if(tau && wT && wT.previousElementSibling!==tau) tau.appendChild(wT);
      const wL = (typeof ensureLeftHandWrapper==='function') ? ensureLeftHandWrapper() : null; if(leftc && wL && wL.previousElementSibling!==leftc) leftc.appendChild(wL);
      const wM = (typeof ensureMelonWrapper==='function') ? ensureMelonWrapper() : null; if(mel && wM && wM.previousElementSibling!==mel) mel.appendChild(wM);
    }catch(e){ console.error('prepareBonusOptions error', e); }
  };

  window.updateMelonOptions = function(){
    try{
      const r = window.state?.rules || {};
      const sport = document.getElementById('melon-sport')?.value || 'darts';
      const sel = document.getElementById('melon-index'); if(!sel) return;
      const opts=[];
      if(sport==='darts'){
        const N = (r.dartsSingles||2) + (r.dartsDoubles||1);
        for(let i=1;i<=N;i++) opts.push(`<option value="${i}">Sous‑match ${i}</option>`);
      }else if(sport==='ping'){
        const N = (r.pingSingles||2) + (r.pingDoubles||1);
        for(let i=1;i<=N;i++) opts.push(`<option value="${i}">Sous‑match ${i}</option>`);
      }else{
        opts.push('<option value="1">Unique sous‑match</option>');
      }
      sel.innerHTML = opts.join('');
    }catch(e){}
  };

  document.addEventListener('DOMContentLoaded', function(){
    try{ window.prepareBonusOptions(); }catch(e){}
  });

  // when the modal opens, ensure options & default selection
  document.addEventListener('click', function(ev){
    const modal = document.getElementById('bonus-modal');
    if(!modal) return;
    if(modal.classList.contains('show')){
      try{
        window.prepareBonusOptions();
        if(document.getElementById('melon-sport')){
          window.updateMelonOptions();
          if(!document.getElementById('melon-index').value) document.getElementById('melon-index').value='1';
        }
      }catch(e){}
    }
  });
})();
</script>


<script id="bonus-melon-click-fix">
(function(){
  function id(x){return document.getElementById(x)}
  function qs(s,r){return (r||document).querySelector(s)}
  function qsa(s,r){return Array.from((r||document).querySelectorAll(s))}
  function norm(t){return (t||'').toLowerCase().replace(/[’']/g,"'").trim()}
  function modalVisible(){ const m=id('bonus-modal'); return m && (m.classList.contains('show') || m.getClientRects().length) }

  function ensureMelonInsideList(){
    const modal = id('bonus-modal'); if(!modal) return null
    const list = qs('.bonus-select', modal); if(!list) return null
    const cardsAll = qsa('.bonus-card', modal)
    let melon = null
    for(const c of cardsAll){
      const t = qs('.bonus-title', c)
      if(t && /melon d'or/i.test(norm(t.textContent))){ melon = c; break }
    }
    if(melon && melon.parentElement !== list){
      list.appendChild(melon)
    }
    return melon
  }

  function ensureMelonParams(){
    let wrap = id('melon-params')
    if(!wrap){
      wrap = document.createElement('div')
      wrap.id = 'melon-params'
      wrap.className = 'bonus-params'
    }
    let fields = id('melon-fields')
    if(!fields){
      fields = document.createElement('div')
      fields.id = 'melon-fields'
    }
    // Unique champ "Sport"
    fields.innerHTML = ''
    const row = document.createElement('div')
    const lab = document.createElement('label'); lab.textContent = 'Sport'
    const sel = document.createElement('select'); sel.id='melon-sport'
    ;[['darts','Fléchettes'],['ping','Ping'],['palet','Palet']].forEach(([v,l])=>{
      const o=document.createElement('option'); o.value=v; o.textContent=l; sel.appendChild(o)
    })
    row.appendChild(lab); row.appendChild(sel)
    fields.appendChild(row)
    if(fields.parentNode !== wrap) wrap.appendChild(fields)

    const melon = ensureMelonInsideList()
    if(melon && wrap.parentNode !== melon){
      const text = qs('.bonus-text', melon)
      if(text && text.nextSibling) melon.insertBefore(wrap, text.nextSibling)
      else melon.appendChild(wrap)
    }
  }

  function setContext(t){
    const ctx=id('bonus-context'); if(!ctx) return
    ctx.textContent = t==='miroir' ? "Miroir : inverse le bonus adverse sur tout le match."
                  : t==='taupe' ? "René la taupe : choisissez le sport."
                  : t==='lefthand' ? "10 pouces 2 mains gauche : choisissez le sport."
                  : t==='melon' ? "Melon d’or : choisissez le sport."
                  : "Capitaine : choisissez le joueur et le sport."
  }

  function openParams(t){
    const cap = id('capitaine-params'), tau=id('taupe-params'), left=id('lefthand-params'), mel=id('melon-params')
    if(cap) cap.style.display = (t==='capitaine')?'block':'none'
    if(tau) tau.style.display = (t==='taupe')?'block':'none'
    if(left) left.style.display = (t==='lefthand')?'block':'none'
    if(mel) mel.style.display = (t==='melon')?'block':'none'
  }

  function selectBonusTypeSafe(t){ try{ return selectBonusType(t) }catch(e){} }
    
    function wireCards(){
    if(!modalVisible()) return
    ensureMelonInsideList()
    ensureMelonParams()
    const modal = id('bonus-modal')
    const cards = qsa('.bonus-select .bonus-card', modal)
    cards.forEach(c=>{
      // Ajoute role/keyboard et écouteurs de façon idempotente
      if(!c.dataset.bound){
        c.tabIndex = 0; c.setAttribute('role','button')
        c.addEventListener('click', function(){ 
          const t = /melon d'or/i.test(norm(qs('.bonus-title', c).textContent)) ? 'melon'
                : (/^capitaine/.test(norm(qs('.bonus-title', c).textContent)) ? 'capitaine'
                : (/^miroir/.test(norm(qs('.bonus-title', c).textContent)) ? 'miroir'
                : (/taupe/.test(norm(qs('.bonus-title', c).textContent)) ? 'taupe' : 'lefthand')))
          selectBonusTypeSafe(t)
        })
        c.addEventListener('keydown', function(ev){
          if(ev.key===' '||ev.key==='Enter'){ ev.preventDefault(); c.click() }
        })
        c.dataset.bound = "1"
      }
    })
  }

  document.addEventListener('click', wireCards, true)
  document.addEventListener('DOMContentLoaded', wireCards)
})();
</script>

</body>
</html>
