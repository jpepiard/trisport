<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TriSports — Fléchettes • Ping-pong • Palet</title>

<!-- Garde-fou : certaines extensions injectent du React minifié qui loggue "Minified React error #...".
     On évite que ça remonte et perturbe l'app (ça n'affecte PAS ton site). -->
<script>
  window.addEventListener('error', function (e) {
    const msg = (e.message || '') + '';
    if (msg.includes('Minified React error #')) {
      e.stopImmediatePropagation?.();
      return false;
    }
  }, true);

function ensureParamWrapper(){
  const fields = id('capitaine-fields'); if(!fields) return null;
  let wrap=id('cap-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='cap-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureTaupeWrapper(){
  const fields = id('taupe-fields'); if(!fields) return null;
  let wrap=id('taupe-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='taupe-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function ensureLeftHandWrapper(){
  const fields = id('lefthand-fields'); if(!fields) return null;
  let wrap=id('lefthand-params'); if(!wrap){ wrap=document.createElement('div'); wrap.id='lefthand-params'; wrap.className='bonus-params'; fields.parentNode.insertBefore(wrap, fields); wrap.appendChild(fields); }
  return wrap;
}
function setParamsOpen(openCap, openTaupe, openLeft){
  const wC = ensureParamWrapper(); if (wC){ wC.style.maxHeight = openCap ? (wC.scrollHeight+'px') : '0px'; }
  const wT = ensureTaupeWrapper(); if (wT){ wT.style.maxHeight = openTaupe ? (wT.scrollHeight+'px') : '0px'; }
  const wL = ensureLeftHandWrapper(); if (wL){ wL.style.maxHeight = openLeft ? (wL.scrollHeight+'px') : '0px'; }
}
function selectBonusType(t){
  window._bonusType = (t==='miroir'||t==='taupe'||t==='lefthand'||t==='melon') ? t : 'capitaine';
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  const cap=cards[0], mir=cards[1], melon=cards[2], tau=cards[3], leftc=cards[4];
  [cap,mir,melon,tau,leftc].forEach(c=>c&&c.classList.remove('selected'));
  if(cap && window._bonusType==='capitaine') cap.classList.add('selected');
  if(mir && window._bonusType==='miroir') mir.classList.add('selected');
  if(melon && window._bonusType==='melon') melon.classList.add('selected');
  if(tau && window._bonusType==='taupe') tau.classList.add('selected');
  if(leftc && window._bonusType==='lefthand') leftc.classList.add('selected');
  const ctx=id('bonus-context');
  if(ctx) ctx.textContent = window._bonusType==='miroir' ? "Miroir : inverse le bonus adverse sur tout le match." : (window._bonusType==='taupe' ? "René la taupe : choisissez le sport." : (window._bonusType==='lefthand' ? "10 pouces 2 mains gauche : choisissez le sport." : (window._bonusType==='melon' ? "Melon d’or : double si gagné ; malus 2× l’écart si perdu." : "Capitaine : choisissez le joueur et le sport")));
  setParamsOpen(window._bonusType==='capitaine', window._bonusType==='taupe', window._bonusType==='lefthand');
}
function prepareBonusOptions(){
  const cards = [...document.querySelectorAll('.bonus-select .bonus-card')];
  cards.forEach((c, i)=>{
    c.classList.add('selectable'); c.tabIndex=0; c.setAttribute('role','button');
    c.addEventListener('click', ()=>selectBonusType(i===0?'capitaine':(i===1?'miroir':(i===2?'taupe':'lefthand'))));
    c.addEventListener('keydown', ev=>{ if(ev.key===' '||ev.key==='Enter'){ ev.preventDefault(); selectBonusType(i===0?'capitaine':(i===1?'miroir':(i===2?'melon':(i===3?'taupe':'lefthand')))); } }); if(id('lefthand-sport')) id('lefthand-sport').value = (sel?.sport||'darts');
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine'); }
  if(id('taupe-sport')) id('taupe-sport').value = (sel?.sport||'darts'); if(id('lefthand-sport')) id('lefthand-sport').value = (sel?.sport||'darts');
  if(typeof prepareBonusOptions==='function'){ prepareBonusOptions(); selectBonusType(sel?.type||'capitaine'); }
  if(id('taupe-sport')) id('taupe-sport').value = (sel?.sport||'darts');
  if(id('lefthand-sport')) id('lefthand-sport').value = (sel?.sport||'darts');
  id('bonus-player').value=sel?.player||'p1';
  id('bonus-sport').value=sel?.sport||'darts';
  id('bonus-context').textContent=`Équipe : ${teamName(teamId)} — Journée #${round}`;
  id('bonus-modal').classList.add('show');
}
id('bonus-cancel').addEventListener('click',()=>id('bonus-modal').classList.remove('show'));
id('bonus-save').addEventListener('click',()=>{
  const r=bonusCTX.round, t=bonusCTX.teamId;
  const type=(window._bonusType==='miroir')?'miroir':(window._bonusType==='taupe'?'taupe':(window._bonusType==='lefthand'?'lefthand':'capitaine'));
  if(type==='capitaine') setBonusSelection(r,t,{type:'capitaine',player:id('bonus-player').value,sport:id('bonus-sport').value});
  else if(type==='taupe') setBonusSelection(r,t,{type:'taupe',sport:id('taupe-sport').value||'darts'});
  else if(type==='lefthand') setBonusSelection(r,t,{type:'lefthand',sport:id('lefthand-sport').value||'darts'});
  else if(type==='melon') setBonusSelection(r,t,{type:'melon'});
  else setBonusSelection(r,t,{type:'miroir'});
  id('bonus-modal').classList.remove('show');
  if(typeof renderPills==='function') renderPills();
  if(typeof renderMatches==='function') renderMatches();
});

/* ===== Boot ===== */
function renderAll(){renderTitle();updateWho();renderSetupRecent();renderManageList();renderTeams();renderMatches();renderLeaderboard();renderH2H()}
document.addEventListener("DOMContentLoaded",()=>{ try { renderAll(); } catch(e) {} });</script>

<script>
(function(){
  function withFallback(img, primary, fall1, fall2){
    img.src = primary;
    img.onerror = function(){
      img.onerror = function(){
        img.onerror = function(){
          img.onerror = null;
          img.src = fall2;
        };
        img.src = fall1;
      };
      // try img/ first
      img.src = 'img/' + primary.split('/').pop();
    };
  }
  function ensureBrandImages(){
    var brand = document.querySelector('header .brand') || document.querySelector('.brand');
    if(!brand) return;
    // avoid duplicates
    if(!brand.querySelector('img.brand-logo')){
      var logo = document.createElement('img');
      logo.className = 'brand-logo';
      logo.alt = 'TriSports logo';
      brand.prepend(logo);
      withFallback(logo, 'tripsort/img/logo.png', 'trisport/img/logo.png', 'img/logo.png');
    }
    if(!brand.querySelector('img.brand-title')){
      var title = document.createElement('img');
      title.className = 'brand-title';
      title.alt = 'TriSports';
      // insert after logo
      var ref = brand.querySelector('img.brand-logo');
      if(ref && ref.nextSibling){ brand.insertBefore(title, ref.nextSibling); }
      else { brand.appendChild(title); }
      withFallback(title, 'tripsort/img/titre.png', 'trisport/img/titre.png', 'img/titre.png');
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureBrandImages);
  }else{
    ensureBrandImages();
  }
})();
</script>

</body>
</html>


function computeMelonBonusForMatch(m, tid){
  const R = state.rules;
  let gain = 0;
  const isA = (m.a === tid), isB = (m.b === tid);
  if (!isA && !isB) return 0;

  // Fléchettes : +R.dartsWinPoints si gagné, -2*R.dartsWinPoints si perdu
  if (Array.isArray(m.darts)) {
    m.darts.forEach(v=>{
      if (v!==0 && v!==1) return;
      const won = isA ? (v===0) : (v===1);
      gain += won ? R.dartsWinPoints : (-2 * R.dartsWinPoints);
    });
  }

  // Ping : par set
  try{
    const sets = (typeof getPingPts==='function' ? (getPingPts(m)||[]) : []);
    sets.forEach(s=>{
      const a = (s && s.a!=null) ? +s.a : null;
      const b = (s && s.b!=null) ? +s.b : null;
      if (typeof isPingValid==='function' && !isPingValid(a,b)) return;
      if (a==null || b==null) return;
      const my = isA ? a : b, opp = isA ? b : a;
      if (my > opp) gain += R.pingWinPoints;
      else if (my < opp) gain -= 2 * Math.abs(my - opp);
    });
  }catch(_){}

  // Palet : si gagné (atteint la cible), bonus = +score ; si perdu, malus = 2×écart
  try{
    const T = +( (state && state.rules && state.rules.paletTarget) || 11 );
    const a = (m.palet && m.palet.a!=null) ? +m.palet.a : null;
    const b = (m.palet && m.palet.b!=null) ? +m.palet.b : null;
    if (a!=null && b!=null){
      const my = isA ? a : b, opp = isA ? b : a;
      if (my === T && opp < T) gain += my;
      else if (my < T && opp === T) gain -= 2 * Math.abs(my - opp);
    }
  }catch(_){}

  return gain;
}
